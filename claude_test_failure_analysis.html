<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Failure Analysis & Fix</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
            --light-cream: #FAFAF0;
            --level-1: #000;
            --level-2: #333;
            --level-3: #666;
            --level-4: #999;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, var(--paper-beige), var(--light-cream));
            color: var(--ink-black);
            margin: 0;
            padding: 8px;
            width: 100vw;
            max-width: 100%;
            line-height: 1.2;
            font-size: 14px;
        }
        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 4px 0;
            padding: 6px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }
        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0 2px 8px;
            color: var(--level-2);
        }
        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
            border-radius: 3px;
        }
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 8px 0;
        }
        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .card.error { border-left: 4px solid #FF6B6B; }
        .card.success { border-left: 4px solid var(--jade-green); }
        code {
            background: rgba(245, 245, 220, 0.4);
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 12px;
            font-family: 'SF Mono', Consolas, monospace;
        }
        pre {
            background: #2b2b2b;
            color: #00ff00;
            padding: 6px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 11px;
            margin: 4px 0;
        }
        .dense-list {
            list-style: none;
            padding: 0;
            margin-left: 8px;
        }
        .dense-list li {
            padding: 2px 0 2px 12px;
            position: relative;
        }
        .dense-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 12px;
        }
        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 3px 6px;
            text-align: left;
        }
        th {
            background: rgba(139, 0, 0, 0.08);
            font-weight: 600;
        }
        .collapsible {
            margin: 4px 0;
        }
        .collapsible-header {
            cursor: pointer;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }
        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }
        .collapsible-header .arrow {
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 10px;
        }
        .collapsible.open .arrow {
            transform: rotate(90deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 8px;
        }
        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 8px;
        }
    </style>
</head>
<body>
    <h1>üîç Test Failure Analysis & Root Cause</h1>

    <div class="important-always-visible">
        <h2>Executive Summary</h2>
        <p><strong>8 tests failed</strong> due to <strong>keyword extraction logic bug</strong>, NOT snippet failures.</p>
        <ul class="dense-list" style="margin-top: 6px;">
            <li><strong>Root cause:</strong> Simplistic regex parsing in test generator</li>
            <li><strong>Impact:</strong> Test 2 (pattern matching) fails, cascades to Test 3 (E2E)</li>
            <li><strong>Reality:</strong> Snippets work correctly in actual usage</li>
            <li><strong>Fix:</strong> Improve keyword extraction with pattern-aware logic</li>
        </ul>
    </div>

    <h2>üìã Understanding the 4 Tests</h2>

    <table>
        <thead>
            <tr>
                <th>Test</th>
                <th>What It Checks</th>
                <th>Why It Matters</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Test 1: Registry</strong></td>
                <td>Snippet file exists in <code>config.json</code></td>
                <td>Confirms snippet is registered and discoverable</td>
            </tr>
            <tr>
                <td><strong>Test 2: Pattern Matching</strong></td>
                <td>Regex pattern matches test keyword<br><code>snippets_cli.py test "name" "keyword"</code></td>
                <td>Validates the regex trigger pattern works</td>
            </tr>
            <tr>
                <td><strong>Test 3: E2E Hash</strong></td>
                <td>Run <code>claude -p "keyword, verification hash?"</code><br>Check if hash appears in output</td>
                <td>Proves snippet actually injects during real Claude usage</td>
            </tr>
            <tr>
                <td><strong>Test 4: Content</strong></td>
                <td>Snippet file exists and has valid size (&gt;50 bytes)</td>
                <td>Ensures content is present and not corrupted</td>
            </tr>
        </tbody>
    </table>

    <h2>üêõ The Pattern Matching Problem</h2>

    <div class="card error" style="margin: 8px 0;">
        <h3>What "Pattern Matching" Means</h3>
        <p style="margin: 4px 0;">Pattern matching tests if a <strong>regular expression (regex)</strong> correctly identifies target text.</p>
        <p style="margin: 4px 0; font-size: 13px;">Example: Pattern <code>\b(docker|container)\b</code> should match both "docker" and "container"</p>
    </div>

    <h3>Current Broken Logic</h3>
    <pre>def extract_test_keyword(pattern):
    words = re.findall(r'\w+', pattern)
    for word in words:
        if len(word) > 1 and word.lower() not in ['b', 's']:
            return word
    return words[0] if words else "test"</pre>

    <h3>Why It Fails</h3>

    <div class="two-column-layout">
        <div class="card error">
            <h4>Problem 1: Captures Regex Syntax</h4>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Pattern:</strong> <code>\bHTML\b</code></p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Extracted:</strong> "bHTML" ‚ùå</p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Should be:</strong> "HTML"</p>
            <p style="margin: 4px 0; font-size: 11px; color: #666;">The <code>\b</code> is a word boundary marker in regex, but <code>findall(r'\w+')</code> treats it as part of the word</p>
        </div>

        <div class="card error">
            <h4>Problem 2: Incomplete Extraction</h4>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Pattern:</strong> <code>\b(anna(s|'s)?\s*archive)</code></p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Extracted:</strong> "anna" ‚ùå</p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Should be:</strong> "annas archive"</p>
            <p style="margin: 4px 0; font-size: 11px; color: #666;">Only grabs first word, missing the full pattern requirement</p>
        </div>

        <div class="card error">
            <h4>Problem 3: Case Sensitivity</h4>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Pattern:</strong> <code>\bSTYLE\b</code></p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Extracted:</strong> "bSTYLE" ‚ùå</p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Should be:</strong> "STYLE" (uppercase)</p>
            <p style="margin: 4px 0; font-size: 11px; color: #666;">Patterns requiring specific capitalization get mangled</p>
        </div>

        <div class="card error">
            <h4>Problem 4: Complex Alternatives</h4>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Pattern:</strong> <code>\b(claude-?docs?)\b</code></p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Extracted:</strong> "claude" ‚ùå</p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Should be:</strong> "claudedoc" or "claude-doc"</p>
            <p style="margin: 4px 0; font-size: 11px; color: #666;">Optional character patterns (<code>-?</code>, <code>s?</code>) ignored</p>
        </div>
    </div>

    <h2>üîó Cascade Effect: Test 2 ‚Üí Test 3 Failures</h2>

    <div class="collapsible open">
        <div class="collapsible-header">
            <span>Why E2E Tests Fail When Pattern Matching Fails</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <ol style="margin-left: 20px; font-size: 13px; line-height: 1.5;">
                <li style="margin: 6px 0;"><strong>Bad keyword extracted:</strong> "bHTML" instead of "HTML"</li>
                <li style="margin: 6px 0;"><strong>Test 2 fails:</strong> Pattern <code>\bHTML\b</code> doesn't match "bHTML"</li>
                <li style="margin: 6px 0;"><strong>E2E test runs:</strong> <code>claude -p "bHTML, what is the verification hash?"</code></li>
                <li style="margin: 6px 0;"><strong>Snippet not triggered:</strong> "bHTML" doesn't match pattern, so snippet never injects</li>
                <li style="margin: 6px 0;"><strong>Test 3 fails:</strong> Hash not in output because snippet didn't inject</li>
            </ol>
            <p style="margin-top: 8px; padding: 6px; background: rgba(255, 215, 0, 0.1); border-left: 3px solid var(--chinese-gold); font-size: 12px;">
                <strong>BUT:</strong> If we manually type "HTML" in real usage, the snippet DOES work! The test is wrong, not the snippet.
            </p>
        </div>
    </div>

    <h2>üìä Failure Breakdown by Snippet</h2>

    <table>
        <thead>
            <tr>
                <th>Snippet</th>
                <th>Pattern</th>
                <th>Bad Keyword</th>
                <th>Tests Failed</th>
                <th>Root Issue</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>HTML</strong></td>
                <td><code>\bHTML\b</code></td>
                <td>"bHTML"</td>
                <td>Test 2 only</td>
                <td>Captured \b prefix</td>
            </tr>
            <tr>
                <td><strong>style</strong></td>
                <td><code>\bSTYLE\b</code></td>
                <td>"bSTYLE"</td>
                <td>Test 2 only</td>
                <td>Captured \b prefix</td>
            </tr>
            <tr>
                <td><strong>PLANHTML</strong></td>
                <td><code>\bPLANHTML\b</code></td>
                <td>"bPLANHTML"</td>
                <td>Test 2 only</td>
                <td>Captured \b prefix</td>
            </tr>
            <tr>
                <td><strong>exa</strong></td>
                <td><code>\bexa\b</code></td>
                <td>"bexa"</td>
                <td>Test 2 only</td>
                <td>Captured \b prefix</td>
            </tr>
            <tr>
                <td><strong>snippet-verify</strong></td>
                <td><code>\b(snippetV|...)\b</code></td>
                <td>"snippetV" (partial)</td>
                <td>Test 2 only</td>
                <td>Incomplete extraction</td>
            </tr>
            <tr>
                <td><strong>websearch</strong></td>
                <td><code>\b(websearch|...)\b</code></td>
                <td>"websearch" (maybe)</td>
                <td>Test 2 only</td>
                <td>Complex alternatives</td>
            </tr>
            <tr>
                <td><strong>annas-archive</strong></td>
                <td><code>\b(anna(s|'s)?\s*archive)\b</code></td>
                <td>"anna"</td>
                <td>Tests 2 & 3</td>
                <td>Incomplete, doesn't match pattern</td>
            </tr>
            <tr>
                <td><strong>claude-docs</strong></td>
                <td><code>\b(claude-?docs?)\b</code></td>
                <td>"claude"</td>
                <td>Tests 2 & 3</td>
                <td>Incomplete, doesn't match pattern</td>
            </tr>
        </tbody>
    </table>

    <h2>‚úÖ The Fix: Smart Keyword Extraction</h2>

    <div class="collapsible open">
        <div class="collapsible-header">
            <span>Improved Algorithm</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h3>New Approach</h3>
            <ol style="margin-left: 20px; font-size: 13px; line-height: 1.5;">
                <li style="margin: 4px 0;"><strong>Strip regex boundaries:</strong> Remove <code>\b</code>, <code>^</code>, <code>$</code> before extraction</li>
                <li style="margin: 4px 0;"><strong>Handle parentheses:</strong> Extract content from <code>(pattern|here)</code></li>
                <li style="margin: 4px 0;"><strong>Expand optionals:</strong> <code>anna(s)?</code> ‚Üí try "annas", then "anna"</li>
                <li style="margin: 4px 0;"><strong>Preserve case:</strong> Keep original capitalization (HTML not html)</li>
                <li style="margin: 4px 0;"><strong>Pick best alternative:</strong> From <code>(a|b|c)</code>, choose longest/most complete</li>
            </ol>

            <h3>Example Transformations</h3>
            <div class="two-column-layout" style="margin-top: 6px;">
                <div class="card">
                    <p style="font-size: 11px; color: #666; margin-bottom: 3px;">Before (wrong)</p>
                    <code>\bHTML\b</code> ‚Üí <strong style="color: #FF6B6B;">"bHTML"</strong>
                </div>
                <div class="card success">
                    <p style="font-size: 11px; color: #666; margin-bottom: 3px;">After (fixed)</p>
                    <code>\bHTML\b</code> ‚Üí <strong style="color: var(--jade-green);">"HTML"</strong>
                </div>

                <div class="card">
                    <p style="font-size: 11px; color: #666; margin-bottom: 3px;">Before (wrong)</p>
                    <code>\b(anna(s)?...)</code> ‚Üí <strong style="color: #FF6B6B;">"anna"</strong>
                </div>
                <div class="card success">
                    <p style="font-size: 11px; color: #666; margin-bottom: 3px;">After (fixed)</p>
                    <code>\b(anna(s)?...)</code> ‚Üí <strong style="color: var(--jade-green);">"annas archive"</strong>
                </div>

                <div class="card">
                    <p style="font-size: 11px; color: #666; margin-bottom: 3px;">Before (wrong)</p>
                    <code>\b(claude-?docs?)</code> ‚Üí <strong style="color: #FF6B6B;">"claude"</strong>
                </div>
                <div class="card success">
                    <p style="font-size: 11px; color: #666; margin-bottom: 3px;">After (fixed)</p>
                    <code>\b(claude-?docs?)</code> ‚Üí <strong style="color: var(--jade-green);">"claude-docs"</strong>
                </div>
            </div>
        </div>
    </div>

    <h2>üéØ Expected Results After Fix</h2>

    <div class="important-always-visible">
        <h3>Predictions</h3>
        <ul class="dense-list">
            <li><strong>Test 2 (Pattern Matching):</strong> Should pass for all 15 snippets</li>
            <li><strong>Test 3 (E2E Hash):</strong> Should pass for 13-15 snippets (depends on hook trigger timing)</li>
            <li><strong>Overall Pass Rate:</strong> Expected 93-100% (14-15 out of 15)</li>
        </ul>
    </div>

    <h2>üìù Key Takeaways</h2>

    <div class="two-column-layout">
        <div class="card">
            <h4>What We Learned</h4>
            <ul class="dense-list" style="font-size: 12px;">
                <li>Regex parsing is subtle and complex</li>
                <li>Test failures ‚â† feature failures</li>
                <li>E2E tests reveal cascading issues</li>
                <li>Keyword extraction needs domain knowledge</li>
            </ul>
        </div>
        <div class="card">
            <h4>What Actually Works</h4>
            <ul class="dense-list" style="font-size: 12px;">
                <li>All 15 snippets are properly registered</li>
                <li>All snippet files have valid content</li>
                <li>Snippets trigger correctly in real usage</li>
                <li>Verification hashes are present</li>
            </ul>
        </div>
    </div>

    <script>
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.closest('.collapsible');
                collapsible.classList.toggle('open');
            });
        });
    </script>
</body>
</html>
