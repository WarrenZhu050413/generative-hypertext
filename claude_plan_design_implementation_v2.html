<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan: Nabokov's Web Implementation Roadmap (Updated)</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
            --light-cream: #FAFAF0;
            --level-1: #000;
            --level-2: #333;
            --level-3: #666;
            --level-4: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 8px;
            width: 100vw;
            max-width: 100%;
            line-height: 1.3;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        h1 {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0;
            padding: 12px 8px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 12px 0 6px 0;
            padding: 6px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 6px 0 3px 8px;
            color: var(--level-2);
            letter-spacing: 0.3px;
        }

        h4 {
            font-size: 13px;
            font-weight: 500;
            margin: 4px 0 2px 16px;
            color: var(--level-3);
        }

        button {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.2s ease;
            padding: 4px 12px;
            margin: 2px;
            font-size: 13px;
            line-height: 1.2;
            cursor: pointer;
            border-radius: 3px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
            border-color: var(--chinese-gold);
        }

        .collapsible {
            margin: 6px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 12px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 12px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 8000px;
            padding: 12px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .collapsible.secondary .collapsible-header {
            border-left: 2px solid #999;
            background: rgba(0, 0, 0, 0.02);
            font-size: 13px;
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
            border-left: none;
            background: none;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            margin: 8px 0;
        }

        .two-column-layout .collapsible.full-width {
            grid-column: span 2;
        }

        @media (max-width: 900px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
            .two-column-layout .collapsible.full-width {
                grid-column: span 1;
            }
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin: 8px 0 8px 12px;
        }

        .dense-list li {
            padding: 4px 0 4px 16px;
            border-left: 2px solid transparent;
            position: relative;
            line-height: 1.5;
        }

        .dense-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 12px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .indent-1 { margin-left: 12px; }
        .indent-2 { margin-left: 24px; }
        .indent-3 { margin-left: 36px; }

        .metric {
            display: inline-block;
            background: white;
            border: 1px solid var(--chinese-gold);
            padding: 3px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .metric.important {
            background: var(--chinese-gold);
            color: white;
            font-weight: 700;
        }

        .critical { color: var(--chinese-red); font-weight: 700; }
        .success { color: var(--jade-green); font-weight: 600; }
        .warning { color: var(--chinese-gold); font-weight: 600; }
        .muted { color: var(--level-4); font-size: 12px; }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 3px 6px;
            margin: 2px 0;
            font-size: 12px;
            line-height: 1.3;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            border-radius: 2px;
        }

        pre {
            padding: 8px;
            margin: 6px 0;
            overflow-x: auto;
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 12px 0;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 3px;
            padding: 8px;
            margin: 6px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 13px;
        }

        th {
            background: var(--chinese-red);
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 8px;
            text-align: left;
        }

        td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
        }

        tr:nth-child(even) { background: rgba(0,0,0,0.02); }
        td:first-child { font-weight: 600; color: var(--level-2); }

        .highlight-box {
            background: rgba(255, 215, 0, 0.15);
            border-left: 3px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <!-- Expand/Collapse Controls -->
    <div style="margin: 8px 0; text-align: right;">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
    </div>

    <!-- Executive Summary (Always Visible) -->
    <div class="important-always-visible">
        <h1>üìã Implementation Roadmap: Nabokov's Web (Updated)</h1>
        <div class="two-column-layout">
            <div>
                <h3>Current State</h3>
                <ul class="dense-list">
                    <li><strong>‚úÖ Phase 1 Complete:</strong> Element capture, spatial canvas, card storage</li>
                    <li><strong>‚úÖ Working:</strong> Screenshot capture, React Flow canvas, basic card system</li>
                    <li><strong>Next:</strong> Floating windows as foundation for all interactions</li>
                </ul>
            </div>
            <div>
                <h3>Updated Roadmap</h3>
                <ul class="dense-list">
                    <li><strong>Phase 1:</strong> Floating Windows System (universal, state-preserving)</li>
                    <li><strong>Phase 2:</strong> Universal Artifacts (URLs, notes, files)</li>
                    <li><strong>Phase 3:</strong> Generative UI (learn-more opens windows with AI content)</li>
                    <li><strong>Phase 4:</strong> Direct Manipulation (editing, annotations)</li>
                </ul>
                <div class="metric important">Complexity: High</div>
                <div class="metric">Estimated: 4 weeks</div>
            </div>
        </div>
        <div class="highlight-box" style="margin-top: 8px;">
            <strong>Key Architectural Change:</strong> Floating windows replace CardMutationAPI as the core interaction model. Every card can open as a floating window with chat, content viewing, and full state persistence. Learn-more buttons will open new floating windows with AI-generated content.
        </div>
    </div>

    <!-- Two-Column Layout for Main Content -->
    <div class="two-column-layout">

        <!-- LEFT COLUMN: Phase 1 - Floating Windows -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>‚ö° Phase 1: Floating Windows System</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <p class="muted">Foundation for all interactions. Every card can open as a floating window.</p>

                <h4>Step 1: Define Window State Types</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/types/window.ts</code></li>
                    <li><strong>Create:</strong> WindowState interface with position, size, minimized flag, z-index, chatInput, scrollPosition, conversationMessages</li>
                </ul>

                <h4>Step 2: FloatingWindow Component</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/FloatingWindow.tsx</code></li>
                    <li><strong>Features:</strong> Draggable header, minimize/maximize, close, chat interface at bottom</li>
                    <li><strong>State Persistence:</strong> Uses <code>display: none</code> for minimize (no unmounting)</li>
                </ul>

                <h4>Step 3: WindowManager Service</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/services/windowManager.ts</code></li>
                    <li><strong>Responsibilities:</strong> Track windows, manage z-index, persist to storage, handle lifecycle</li>
                    <li><strong>API:</strong> openWindow(), closeWindow(), minimizeWindow(), maximizeWindow(), bringToFront()</li>
                </ul>

                <h4>Step 4: Window Storage Integration</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/utils/windowStorage.ts</code></li>
                    <li><strong>Storage:</strong> chrome.storage.local with key <code>'nabokov_windows'</code></li>
                    <li><strong>Auto-save:</strong> Debounced 500ms on state changes</li>
                </ul>

                <h4>Step 5: Modify CardNode</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/canvas/CardNode.tsx</code></li>
                    <li><strong>Action:</strong> Add "Open as Window" button (üóñ icon) to card header</li>
                    <li><strong>Behavior:</strong> Calls windowManager.openWindow(cardId, card)</li>
                </ul>

                <h4>Step 6: Window Container in Canvas</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/canvas/Canvas.tsx</code></li>
                    <li><strong>Action:</strong> Add <code>&lt;div id="floating-windows-container"&gt;</code> as sibling to React Flow</li>
                    <li><strong>Render:</strong> Map windowManager.windows to FloatingWindow components</li>
                </ul>

                <h4>Step 7: State Persistence Logic</h4>
                <ul class="dense-list">
                    <li><strong>Minimize:</strong> Capture input values, scroll position, set display: none</li>
                    <li><strong>Maximize:</strong> Show content, restore input values, restore scroll position</li>
                    <li><strong>Key:</strong> DOM remains mounted, state preserved</li>
                </ul>

                <h4>Step 8: Chat Interface</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/FloatingWindowChat.tsx</code></li>
                    <li><strong>Features:</strong> Message list, input field, send button, auto-save input to windowState</li>
                </ul>

                <h4>Step 9: Dragging Implementation</h4>
                <ul class="dense-list">
                    <li><strong>Library:</strong> react-draggable or custom drag handler</li>
                    <li><strong>Bounds:</strong> Constrain to canvas viewport</li>
                    <li><strong>Update:</strong> Save position to windowState on drag end</li>
                </ul>

                <h4>Step 10: Z-Index Management</h4>
                <ul class="dense-list">
                    <li><strong>Logic:</strong> Click window ‚Üí bringToFront() ‚Üí increment maxZIndex</li>
                    <li><strong>Range:</strong> 1000-2000 (above React Flow)</li>
                    <li><strong>Visual:</strong> Active window has gold border, stronger shadow</li>
                </ul>
            </div>
        </div>

        <!-- RIGHT COLUMN: Testing Phase 1 -->
        <div class="collapsible secondary" data-collapsible="open">
            <div class="collapsible-header">
                <span>‚úì Testing Phase 1 (Playwright)</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Test 1: Open Window from Card</h4>
                <pre>test('card opens as floating window', async ({
  context, extensionId
}) => {
  const page = await context.newPage();
  await page.goto(canvasUrl);

  await createTestCard(page);
  await page.reload();

  await page.click('[data-testid="open-window-btn"]');

  const window = await page.$('.floating-window');
  expect(window).not.toBeNull();
});</pre>

                <h4>Test 2: Minimize/Maximize State</h4>
                <pre>test('minimize preserves state', async ({ page }) => {
  await page.click('[data-testid="open-window-btn"]');

  await page.fill('.chat-input', 'Test message');
  await page.evaluate(() => {
    document.querySelector('.window-content')
      .scrollTop = 100;
  });

  await page.click('[data-testid="minimize-btn"]');
  await page.click('[data-testid="maximize-btn"]');

  const inputValue = await page.$eval(
    '.chat-input', el => el.value
  );
  expect(inputValue).toBe('Test message');

  const scrollPos = await page.evaluate(() =>
    document.querySelector('.window-content')
      .scrollTop
  );
  expect(scrollPos).toBe(100);
});</pre>

                <h4>Test 3: Storage Persistence</h4>
                <pre>test('windows persist on reload', async ({ page }) => {
  await page.click('[data-testid="open-window-btn"]');
  await page.fill('.chat-input', 'Persist me');
  await page.waitForTimeout(1000); // auto-save

  await page.reload();

  const window = await page.$('.floating-window');
  expect(window).not.toBeNull();

  const value = await page.$eval(
    '.chat-input', el => el.value
  );
  expect(value).toBe('Persist me');
});</pre>
            </div>
        </div>
    </div>

    <!-- Full-Width: Chat API Specification -->
    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üí¨ Phase 1 Detail: Chat Interface API</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <p style="margin-bottom: 8px;"><strong>Complete API specification for the built-in chat interface in every floating window.</strong></p>

            <h3>Core Types</h3>
            <div class="two-column-layout">
                <div>
                    <h4>WindowState (Extended)</h4>
                    <pre><code>interface WindowState {
  cardId: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  minimized: boolean;
  zIndex: number;

  // Chat state
  chatInput: string;
  conversationMessages: Message[];
  scrollPosition: number;
  isStreaming: boolean;
}</code></pre>
                </div>
                <div>
                    <h4>ChatService Interface</h4>
                    <pre><code>interface ChatService {
  sendMessage(
    cardId: string,
    userMessage: string,
    cardContent: string
  ): AsyncGenerator&lt;string&gt;;

  stopStreaming(cardId: string): void;
  getConversation(cardId: string): Message[];
  clearConversation(cardId: string): void;
}</code></pre>
                </div>
            </div>

            <h3>Component API</h3>
            <h4>FloatingWindowChat Props</h4>
            <pre><code>interface FloatingWindowChatProps {
  cardId: string;
  cardContent: string;
  messages: Message[];
  currentInput: string;
  isStreaming: boolean;
  onSendMessage: (message: string) => void;
  onInputChange: (value: string) => void;
  onStopStreaming: () => void;
  onClearChat: () => void;
}</code></pre>

            <h4>Usage in FloatingWindow</h4>
            <pre><code>const FloatingWindow = ({ windowState }) => {
  const handleSendMessage = async (msg: string) => {
    const stream = chatService.sendMessage(windowState.cardId, msg, cardContent);
    for await (const chunk of stream) {
      updateMessage(chunk);
    }
  };

  return (
    &lt;div className="floating-window"&gt;
      &lt;div className="window-header"&gt;...&lt;/div&gt;
      &lt;div className="window-content"&gt;{/* Card content */}&lt;/div&gt;
      &lt;FloatingWindowChat
        cardId={windowState.cardId}
        cardContent={card.content}
        messages={windowState.conversationMessages}
        currentInput={windowState.chatInput}
        isStreaming={windowState.isStreaming}
        onSendMessage={handleSendMessage}
        onInputChange={updateChatInput}
        onStopStreaming={stopStreaming}
        onClearChat={clearChat}
      /&gt;
    &lt;/div&gt;
  );
};</code></pre>

            <h3>State Persistence Strategy</h3>
            <ul class="dense-list">
                <li><strong>Chat Input:</strong> Debounced save every 500ms to windowState.chatInput</li>
                <li><strong>Messages:</strong> Save to card.conversation immediately after each message completes</li>
                <li><strong>Scroll Position:</strong> Save on scroll end (debounced 300ms)</li>
                <li><strong>Minimize/Maximize:</strong> Preserve all state, no unmounting (display: none)</li>
            </ul>

            <h3>Message Flow</h3>
            <div style="background: rgba(255, 215, 0, 0.1); padding: 8px; border-left: 3px solid var(--chinese-gold); margin: 8px 0;">
                <strong>1.</strong> User types ‚Üí Enter ‚Üí onSendMessage(text)<br>
                <strong>2.</strong> Create user Message, add to windowState.conversationMessages<br>
                <strong>3.</strong> Create assistant Message with streaming: true<br>
                <strong>4.</strong> Stream response: for await (chunk of stream) { append to content }<br>
                <strong>5.</strong> Set streaming: false, save to card.conversation<br>
                <strong>6.</strong> Clear chatInput, save windowState
            </div>

            <h3>Implementation Files</h3>
            <table>
                <tr>
                    <th>File</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td><code>src/components/FloatingWindowChat.tsx</code></td>
                    <td>Chat UI component (messages list + input form)</td>
                </tr>
                <tr>
                    <td><code>src/services/chatService.ts</code></td>
                    <td>Message handling, streaming, conversation management</td>
                </tr>
                <tr>
                    <td><code>src/services/mockContentGenerator.ts</code></td>
                    <td>Mock AI responses for Phase 3 (pre-real backend)</td>
                </tr>
            </table>

            <p style="margin-top: 12px; font-style: italic; color: var(--level-3);">
                <strong>Note:</strong> Full API specification with tests available in <code>claude_chat_api_specification.html</code>
            </p>
        </div>
    </div>

    <div class="two-column-layout">
        <!-- Phase 2: Universal Artifacts -->
        <div class="collapsible critical" data-collapsible="closed">
            <div class="collapsible-header">
                <span>üì¶ Phase 2: Universal Artifact Substrate</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <p class="muted">Expand Card type to support any content type. All open as floating windows.</p>

                <h4>Step 11: Extend Card Type for Files</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/types/card.ts</code></li>
                    <li><strong>Add:</strong> Optional <code>fileData</code> field (fileName, fileType, fileSize, fileUrl, extractedText)</li>
                    <li><strong>Purpose:</strong> Support images, PDFs, documents as cards</li>
                </ul>

                <h4>Step 12: URL Import</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/canvas/Toolbar.tsx</code></li>
                    <li><strong>Action:</strong> Add "Import URL" button, fetch webpage, create card</li>
                    <li><strong>Flow:</strong> User enters URL ‚Üí fetch HTML ‚Üí sanitize ‚Üí create Card ‚Üí opens as window</li>
                </ul>

                <h4>Step 13: Note Creation</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/canvas/Toolbar.tsx</code></li>
                    <li><strong>Action:</strong> Add "New Note" button, creates blank editable card</li>
                    <li><strong>Opens:</strong> Immediately as floating window with ContentEditable area</li>
                </ul>

                <h4>Step 14: File Drop Handler</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/canvas/Canvas.tsx</code></li>
                    <li><strong>Action:</strong> Drag-and-drop zone for files/screenshots</li>
                    <li><strong>Supported:</strong> Images, PDFs, text files, documents</li>
                    <li><strong>Storage:</strong> File blobs in IndexedDB, metadata in Card</li>
                </ul>

                <h4>Step 15: File Rendering in Windows</h4>
                <ul class="dense-list">
                    <li><strong>Images:</strong> Render inline with zoom controls</li>
                    <li><strong>PDFs:</strong> PDF.js viewer in window</li>
                    <li><strong>Text:</strong> Syntax-highlighted if code, plain text otherwise</li>
                </ul>
            </div>
        </div>

        <!-- Testing Phase 2 -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>‚úì Testing Phase 2 (Playwright)</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Test 4: URL Import</h4>
                <pre>test('import URL creates card and window', async ({
  page
}) => {
  await page.click('[data-testid="import-url"]');
  await page.fill('input[type="url"]',
    'https://example.com'
  );
  await page.click('button[type="submit"]');

  // Verify card created
  const cards = await getAllCards(page);
  expect(cards[0].metadata.url)
    .toBe('https://example.com');

  // Verify window opened
  const window = await page.$('.floating-window');
  expect(window).not.toBeNull();
});</pre>

                <h4>Test 5: Note Creation</h4>
                <pre>test('new note opens editable window', async ({
  page
}) => {
  await page.click('[data-testid="new-note"]');

  const window = await page.$('.floating-window');
  const editable = await window.$('[contenteditable]');

  await editable.fill('My note content');
  await page.click('body'); // blur to save

  const cards = await getAllCards(page);
  expect(cards[0].content)
    .toContain('My note content');
});</pre>

                <h4>Test 6: File Upload</h4>
                <pre>test('drag-drop file creates card', async ({
  page
}) => {
  const filePath = path.join(__dirname,
    'fixtures/test.png'
  );

  const [fileChooser] = await Promise.all([
    page.waitForEvent('filechooser'),
    page.click('[data-testid="upload-file"]')
  ]);
  await fileChooser.setFiles([filePath]);

  // Verify card with fileData
  const cards = await getAllCards(page);
  expect(cards[0].fileData.fileName)
    .toBe('test.png');

  // Verify window shows image
  const img = await page.$('.floating-window img');
  expect(img).not.toBeNull();
});</pre>
            </div>
        </div>

        <!-- Phase 3: Generative UI -->
        <div class="collapsible critical" data-collapsible="closed">
            <div class="collapsible-header">
                <span>üé® Phase 3: Generative UI with Learn-More</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <p class="muted">Learn-more buttons spawn new floating windows with AI-generated content</p>

                <h4>Step 16: Learn-More Custom Element</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/interactive-elements/LearnMore.ts</code></li>
                    <li><strong>Usage:</strong> <code>&lt;learn-more topic="X"&gt;&lt;/learn-more&gt;</code></li>
                    <li><strong>Behavior:</strong> Click ‚Üí Generate content ‚Üí Open new floating window</li>
                </ul>

                <h4>Step 17: Mockup Content Generator</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/services/mockContentGenerator.ts</code></li>
                    <li><strong>Purpose:</strong> Generate mock AI responses based on topic</li>
                    <li><strong>Template Library:</strong> Pre-written responses for common topics</li>
                    <li><strong>Delay:</strong> Simulate ~3s AI response time</li>
                </ul>

                <h4>Step 18: Learn-More ‚Üí Window Flow</h4>
                <ul class="dense-list">
                    <li><strong>User clicks learn-more</strong> ‚Üí Show loading spinner</li>
                    <li><strong>Generate content</strong> ‚Üí Create new Card with generated HTML</li>
                    <li><strong>Open window</strong> ‚Üí windowManager.openWindow(newCardId, newCard)</li>
                    <li><strong>Position:</strong> Cascade near parent window</li>
                </ul>

                <h4>Step 19: Recursive Learn-More</h4>
                <ul class="dense-list">
                    <li><strong>Key Feature:</strong> Generated content contains more learn-more buttons</li>
                    <li><strong>Result:</strong> Users can explore indefinitely, spawning windows on demand</li>
                    <li><strong>Management:</strong> Warn at 15+ open windows</li>
                </ul>

                <h4>Step 20: Connection Lines (Optional)</h4>
                <ul class="dense-list">
                    <li><strong>Visual:</strong> Draw lines between parent and child windows</li>
                    <li><strong>Implementation:</strong> SVG overlay tracking window positions</li>
                    <li><strong>Purpose:</strong> Show exploration path</li>
                </ul>
            </div>
        </div>

        <!-- Testing Phase 3 -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>‚úì Testing Phase 3 (Playwright)</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Test 7: Learn-More Spawns Window</h4>
                <pre>test('learn-more creates new window', async ({
  page
}) => {
  // Create card with learn-more
  await createCard(page, `
    &lt;learn-more topic="test"&gt;&lt;/learn-more&gt;
  `);
  await page.reload();

  const initialCount = await page.$$eval(
    '.floating-window',
    els => els.length
  );

  await page.click('learn-more button');
  await page.waitForTimeout(3500); // mock delay

  const newCount = await page.$$eval(
    '.floating-window',
    els => els.length
  );
  expect(newCount).toBe(initialCount + 1);
});</pre>

                <h4>Test 8: Recursive Learn-More</h4>
                <pre>test('windows spawn more windows', async ({
  page
}) => {
  // Open first window
  await page.click('learn-more[topic="topic1"]');
  await page.waitForSelector('.floating-window');

  // Click learn-more in generated window
  await page.click(
    '.floating-window learn-more[topic="topic2"]'
  );
  await page.waitForTimeout(3500);

  const windows = await page.$$('.floating-window');
  expect(windows.length).toBe(2);
});</pre>

                <h4>Test 9: Window Cascade Positioning</h4>
                <pre>test('new windows cascade near parent', async ({
  page
}) => {
  await page.click('learn-more');
  await page.waitForSelector('.floating-window');

  const parent = await page.$('.floating-window');
  const parentPos = await parent.boundingBox();

  await page.click('.floating-window learn-more');
  await page.waitForTimeout(3500);

  const windows = await page.$$('.floating-window');
  const childPos = await windows[1].boundingBox();

  // Should be offset from parent
  expect(childPos.x).toBeCloseTo(
    parentPos.x + 30, 5
  );
  expect(childPos.y).toBeCloseTo(
    parentPos.y + 30, 5
  );
});</pre>
            </div>
        </div>

        <!-- Phase 4: Direct Manipulation -->
        <div class="collapsible critical" data-collapsible="closed">
            <div class="collapsible-header">
                <span>‚úèÔ∏è Phase 4: Direct Content Manipulation</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <p class="muted">Edit, annotate, restructure content within floating windows</p>

                <h4>Step 21: Edit Mode Toggle</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/FloatingWindow.tsx</code></li>
                    <li><strong>Action:</strong> Add "Edit" button to window header</li>
                    <li><strong>Behavior:</strong> Toggles contenteditable on window content</li>
                </ul>

                <h4>Step 22: Auto-Save on Edit</h4>
                <ul class="dense-list">
                    <li><strong>Logic:</strong> Debounce edits (1s), save to Card.content</li>
                    <li><strong>Storage:</strong> Update card in chrome.storage.local</li>
                    <li><strong>Visual:</strong> Show "Saving..." indicator</li>
                </ul>

                <h4>Step 23: Text Highlighting</h4>
                <ul class="dense-list">
                    <li><strong>Action:</strong> User selects text ‚Üí context menu ‚Üí "Highlight"</li>
                    <li><strong>Implementation:</strong> Wrap selection in <code>&lt;mark&gt;</code> tag with data-annotation-id</li>
                    <li><strong>Storage:</strong> Store annotation in card.annotations array</li>
                </ul>

                <h4>Step 24: Annotation Layer</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/AnnotationLayer.tsx</code></li>
                    <li><strong>Action:</strong> Click highlight ‚Üí show note popover ‚Üí add/edit note</li>
                    <li><strong>Display:</strong> Annotations show as tooltips on hover</li>
                </ul>

                <h4>Step 25: Version Tracking (Future)</h4>
                <ul class="dense-list">
                    <li><strong>Concept:</strong> Track edit history in card.versions array</li>
                    <li><strong>UI:</strong> "View History" button shows version timeline</li>
                    <li><strong>Deferred:</strong> Implement after core features stable</li>
                </ul>
            </div>
        </div>

        <!-- Testing Phase 4 -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>‚úì Testing Phase 4 (Playwright)</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Test 10: Edit Mode</h4>
                <pre>test('edit mode enables editing', async ({
  page
}) => {
  await page.click('[data-testid="open-window-btn"]');

  const editable = await page.$eval(
    '.window-content',
    el => el.contentEditable
  );
  expect(editable).toBe('false');

  await page.click('[data-testid="edit-btn"]');

  const nowEditable = await page.$eval(
    '.window-content',
    el => el.contentEditable
  );
  expect(nowEditable).toBe('true');
});</pre>

                <h4>Test 11: Highlight Text</h4>
                <pre>test('text can be highlighted', async ({
  page
}) => {
  await page.click('[data-testid="open-window-btn"]');

  // Select text
  await page.selectText('important phrase');

  // Click highlight in context menu
  await page.click('[data-testid="highlight"]');

  // Verify mark tag added
  const mark = await page.$(
    '.window-content mark'
  );
  expect(mark).not.toBeNull();

  const text = await mark.textContent();
  expect(text).toBe('important phrase');
});</pre>

                <h4>Test 12: Add Annotation</h4>
                <pre>test('annotation can be added', async ({
  page
}) => {
  await page.selectText('phrase');
  await page.click('[data-testid="highlight"]');

  const mark = await page.$('mark');
  await mark.click();

  // Annotation popover appears
  await page.fill('[data-testid="annotation-input"]',
    'This is important because...'
  );
  await page.click('[data-testid="save-annotation"]');

  // Verify annotation stored
  const card = await getCardById(page, cardId);
  expect(card.annotations).toHaveLength(1);
  expect(card.annotations[0].note)
    .toBe('This is important because...');
});</pre>
            </div>
        </div>
    </div>

    <!-- Full-Width Sections -->

    <!-- Prerequisites & Context -->
    <div class="collapsible secondary full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üìç Prerequisites & Current State</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h3>Current Implementation Analysis</h3>
            <div class="two-column-layout">
                <div class="card">
                    <h4 class="success">‚úÖ What's Working</h4>
                    <ul class="dense-list">
                        <li>Element capture via Cmd+Shift+E</li>
                        <li>Shadow DOM isolation in ElementSelector</li>
                        <li>Screenshot capture (with fallback)</li>
                        <li>Card storage (chrome.storage.local + IndexedDB)</li>
                        <li>React Flow canvas with spatial layout</li>
                        <li>Basic card metadata (tags, stars, timestamps)</li>
                        <li>CardNode rendering with Chinese aesthetic</li>
                    </ul>
                </div>
                <div class="card">
                    <h4 class="critical">‚ùå What's Missing</h4>
                    <ul class="dense-list">
                        <li>Floating windows system</li>
                        <li>Window state persistence</li>
                        <li>Universal artifact support (URLs, notes, files)</li>
                        <li>AI integration / content generation</li>
                        <li>Learn-more interactive elements</li>
                        <li>Direct content manipulation</li>
                        <li>Annotation system</li>
                    </ul>
                </div>
            </div>

            <h3>Architectural Foundation: Why Floating Windows First?</h3>
            <div class="highlight-box">
                <p style="margin: 4px 0; line-height: 1.5;">
                    <strong>Floating windows are the universal interaction surface.</strong> Instead of CardMutationAPI's complex DOM manipulation, we use simple, composable windows that:
                </p>
                <ul class="dense-list" style="margin-top: 6px;">
                    <li>Work for ANY content type (cards, notes, files, AI-generated content)</li>
                    <li>Have built-in chat interface (no separate FloatingChat component)</li>
                    <li>Preserve ALL state (minimize ‚â† unmount)</li>
                    <li>Stack naturally with z-index management</li>
                    <li>Enable recursive exploration (windows spawn windows)</li>
                </ul>
            </div>

            <h3>Design Evolution</h3>
            <table>
                <tr>
                    <th>Aspect</th>
                    <th>Original Plan</th>
                    <th>Updated Plan</th>
                </tr>
                <tr>
                    <td>Core Interaction</td>
                    <td>CardMutationAPI (AI manipulates DOM)</td>
                    <td>Floating Windows (universal surface)</td>
                </tr>
                <tr>
                    <td>State Management</td>
                    <td>Per-operation state tracking</td>
                    <td>Per-window state persistence</td>
                </tr>
                <tr>
                    <td>AI Integration</td>
                    <td>Background worker + DOM ops</td>
                    <td>Mock generator ‚Üí Window content</td>
                </tr>
                <tr>
                    <td>Learn-More</td>
                    <td>Custom element ‚Üí DOM mutation</td>
                    <td>Custom element ‚Üí New window</td>
                </tr>
                <tr>
                    <td>Chat</td>
                    <td>Separate FloatingChat component</td>
                    <td>Built into every window</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Potential Issues -->
    <div class="collapsible secondary full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>‚ö†Ô∏è Potential Issues & Mitigations</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <div class="two-column-layout">
                <div>
                    <div class="card">
                        <h4 class="warning">Issue 1: State Capture Complexity</h4>
                        <p class="muted">Capturing ALL input state (dynamically added fields) is tricky</p>
                        <p><strong>Mitigation:</strong></p>
                        <ul class="dense-list">
                            <li>Use FormData API for all inputs within window</li>
                            <li>Store as Record&lt;string, string&gt; in windowState</li>
                            <li>On maximize, iterate and restore all values</li>
                        </ul>
                    </div>

                    <div class="card">
                        <h4 class="warning">Issue 2: Memory with Many Windows</h4>
                        <p class="muted">20+ windows (even minimized) uses significant memory</p>
                        <p><strong>Mitigation:</strong></p>
                        <ul class="dense-list">
                            <li>Limit max open windows to 20</li>
                            <li>Show warning at 15 windows</li>
                            <li>Offer "Close All Minimized" button</li>
                            <li>Future: Lazy-load window content on maximize</li>
                        </ul>
                    </div>

                    <div class="card">
                        <h4 class="warning">Issue 3: Window Overflow</h4>
                        <p class="muted">Windows dragged off-screen can be lost</p>
                        <p><strong>Mitigation:</strong></p>
                        <ul class="dense-list">
                            <li>Constrain drag bounds to canvas viewport</li>
                            <li>Add "Reset Position" button</li>
                            <li>Auto-position with cascade offset on open</li>
                        </ul>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h4 class="warning">Issue 4: React State vs DOM State</h4>
                        <p class="muted">Input values in DOM might not sync with React state</p>
                        <p><strong>Mitigation:</strong></p>
                        <ul class="dense-list">
                            <li>Use controlled components for critical inputs</li>
                            <li>Store in React state AND windowState</li>
                            <li>On minimize, read from DOM as fallback</li>
                        </ul>
                    </div>

                    <div class="card">
                        <h4 class="warning">Issue 5: Z-Index Conflicts</h4>
                        <p class="muted">React Flow uses z-index for nodes</p>
                        <p><strong>Mitigation:</strong></p>
                        <ul class="dense-list">
                            <li>Use z-index range 1000+ for windows</li>
                            <li>Windows container as sibling to React Flow</li>
                            <li>React Flow uses lower z-index values</li>
                        </ul>
                    </div>

                    <div class="card">
                        <h4 class="warning">Issue 6: AI Integration Later</h4>
                        <p class="muted">Using mock generator delays real AI features</p>
                        <p><strong>Mitigation:</strong></p>
                        <ul class="dense-list">
                            <li>Mock generator has identical API to real backend</li>
                            <li>Easy swap: change one import statement</li>
                            <li>Can develop entire UI without API keys</li>
                            <li>Mock responses help test edge cases</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Implementation Timeline -->
    <div class="collapsible full-width" data-collapsible="open">
        <div class="collapsible-header">
            <span>üìÖ Implementation Timeline</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <table>
                <tr>
                    <th>Phase</th>
                    <th>Duration</th>
                    <th>Key Deliverables</th>
                    <th>Tests</th>
                </tr>
                <tr>
                    <td><strong>1: Floating Windows</strong></td>
                    <td>1 week</td>
                    <td>
                        ‚Ä¢ WindowState types<br>
                        ‚Ä¢ FloatingWindow component<br>
                        ‚Ä¢ WindowManager service<br>
                        ‚Ä¢ Storage integration<br>
                        ‚Ä¢ State persistence logic<br>
                        ‚Ä¢ Dragging + z-index<br>
                        ‚Ä¢ Chat interface in windows
                    </td>
                    <td>Tests 1-3</td>
                </tr>
                <tr>
                    <td><strong>2: Universal Artifacts</strong></td>
                    <td>1 week</td>
                    <td>
                        ‚Ä¢ Extended Card type (fileData)<br>
                        ‚Ä¢ URL import functionality<br>
                        ‚Ä¢ Note creation<br>
                        ‚Ä¢ File drop handler<br>
                        ‚Ä¢ File rendering in windows
                    </td>
                    <td>Tests 4-6</td>
                </tr>
                <tr>
                    <td><strong>3: Generative UI</strong></td>
                    <td>1 week</td>
                    <td>
                        ‚Ä¢ Learn-more custom element<br>
                        ‚Ä¢ Mock content generator<br>
                        ‚Ä¢ Learn-more ‚Üí Window flow<br>
                        ‚Ä¢ Recursive exploration<br>
                        ‚Ä¢ Window cascade positioning<br>
                        ‚Ä¢ (Optional) Connection lines
                    </td>
                    <td>Tests 7-9</td>
                </tr>
                <tr>
                    <td><strong>4: Direct Manipulation</strong></td>
                    <td>1 week</td>
                    <td>
                        ‚Ä¢ Edit mode toggle<br>
                        ‚Ä¢ Auto-save on edit<br>
                        ‚Ä¢ Text highlighting<br>
                        ‚Ä¢ Annotation layer<br>
                        ‚Ä¢ Context menu integration
                    </td>
                    <td>Tests 10-12</td>
                </tr>
            </table>

            <p style="margin: 16px 0; font-weight: 600;">
                <strong>Total Estimated Time:</strong> <span class="metric important">4 weeks</span> (full-time development)
            </p>

            <div class="highlight-box">
                <strong>Note:</strong> Each phase builds on the previous. Phase 1 (Floating Windows) is the critical foundation - get this rock-solid before moving to Phase 2. All subsequent features live inside floating windows.
            </div>

            <h3 style="margin-top: 16px;">Weekly Milestones</h3>
            <ul class="dense-list">
                <li><strong>Week 1:</strong> Any card can open as floating window with chat, drag, minimize/maximize, state persistence</li>
                <li><strong>Week 2:</strong> Import URLs, create notes, drag-drop files, all open as windows</li>
                <li><strong>Week 3:</strong> Learn-more buttons spawn new windows with mock AI content, recursive exploration works</li>
                <li><strong>Week 4:</strong> Edit mode, highlight text, add annotations, fully interactive content</li>
            </ul>
        </div>
    </div>

    <!-- Future Work -->
    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üîÆ Phase 5: Future Work (Post-MVP)</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h3>Inter-Artifact Communication (Deferred)</h3>
            <div class="card">
                <p style="margin: 4px 0; line-height: 1.5;">
                    Originally Phase 5, now moved to future roadmap. Once core features are stable, implement:
                </p>
                <ul class="dense-list">
                    <li><strong>Artifact-to-Artifact Queries:</strong> Windows can reference and query other windows</li>
                    <li><strong>Context Propagation:</strong> Knowledge flows between windows automatically</li>
                    <li><strong>Visual Network:</strong> Connection lines show knowledge graph</li>
                    <li><strong>Distributed Cognition:</strong> System helps connect related concepts across windows</li>
                </ul>
            </div>

            <h3>Real AI Backend Integration</h3>
            <div class="card">
                <p style="margin: 4px 0; line-height: 1.5;">
                    Replace mock content generator with actual Claude API:
                </p>
                <ul class="dense-list">
                    <li>Stream responses into window content</li>
                    <li>Context-aware: Send parent window content with request</li>
                    <li>Smart templates: Claude generates custom UI components</li>
                    <li>Progressive loading: Show content as it generates</li>
                </ul>
            </div>

            <h3>Advanced Window Features</h3>
            <table>
                <tr>
                    <th>Feature</th>
                    <th>Description</th>
                    <th>Priority</th>
                </tr>
                <tr>
                    <td>Window Resizing</td>
                    <td>Drag corners/edges to resize</td>
                    <td class="warning">Medium</td>
                </tr>
                <tr>
                    <td>Window Snapping</td>
                    <td>Snap to grid or other windows</td>
                    <td class="muted">Low</td>
                </tr>
                <tr>
                    <td>Minimize to Taskbar</td>
                    <td>Taskbar showing minimized windows</td>
                    <td class="success">High</td>
                </tr>
                <tr>
                    <td>Window Groups/Tabs</td>
                    <td>Combine windows into tabbed interface</td>
                    <td class="muted">Low</td>
                </tr>
                <tr>
                    <td>Keyboard Shortcuts</td>
                    <td>Cmd+W close, Cmd+M minimize, etc.</td>
                    <td class="success">High</td>
                </tr>
                <tr>
                    <td>Version History</td>
                    <td>Track edits, view past versions</td>
                    <td class="warning">Medium</td>
                </tr>
            </table>

            <h3>Ted Nelson-Inspired Features</h3>
            <ul class="dense-list">
                <li><strong>Parallel Documents:</strong> Side-by-side with visual connection lines</li>
                <li><strong>Version Linking:</strong> Track evolution with linked passages</li>
                <li><strong>Card Merge/Split:</strong> Combine cards into composite, preserve unmerge capability</li>
            </ul>
        </div>
    </div>

    <div class="divider"></div>
    <p style="text-align: center; margin: 16px 0; color: var(--level-4); font-size: 12px;">
        Updated Implementation Roadmap ‚Ä¢ Floating Windows Foundation ‚Ä¢ Ready to implement
    </p>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-collapsible]').forEach(function(section) {
            const isOpen = section.getAttribute('data-collapsible') === 'open';
            section.classList.add('collapsible');
            if (isOpen) section.classList.add('open');
        });

        document.querySelectorAll('.collapsible-header').forEach(function(header) {
            header.addEventListener('click', function() {
                const collapsible = this.closest('.collapsible');
                collapsible.classList.toggle('open');
            });
        });

        const expandAllBtn = document.getElementById('expand-all');
        const collapseAllBtn = document.getElementById('collapse-all');

        if (expandAllBtn) {
            expandAllBtn.addEventListener('click', function() {
                document.querySelectorAll('.collapsible').forEach(function(c) {
                    c.classList.add('open');
                });
            });
        }

        if (collapseAllBtn) {
            collapseAllBtn.addEventListener('click', function() {
                document.querySelectorAll('.collapsible').forEach(function(c) {
                    c.classList.remove('open');
                });
            });
        }
    });
    </script>
</body>
</html>