<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nabokov Inline-Style Tooltip Mockup</title>
<style>
  :root {
    --deep-red-start: #b23232;
    --deep-red-end: #a32020;
    --paper: #fdf8f6;
    --panel: #f7efed;
    --border: rgba(178, 60, 60, 0.55);
    --shadow: 0 18px 38px rgba(170, 34, 34, 0.16);
    --ink: #2c1f1f;
    --muted: rgba(255, 240, 240, 0.85);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f2d8c2 0%, #fff1dd 100%);
    color: var(--ink);
  }

  .context-card {
    width: min(92vw, 760px);
    background: white;
    border-radius: 22px;
    padding: 32px;
    box-shadow: var(--shadow);
    display: grid;
    gap: 24px;
  }

  .context-card p {
    background: rgba(178, 50, 50, 0.08);
    border-radius: 14px;
    padding: 22px;
    line-height: 1.6;
  }

  mark {
    background: rgba(178, 50, 50, 0.16);
    color: #8b0000;
    padding: 2px 4px;
    border-radius: 6px;
    cursor: pointer;
  }

  .tooltip {
    width: 320px;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-size: 14px;
  }

  .tooltip[data-size="large"] {
    font-size: 16px;
  }

  .tooltip header {
    background: linear-gradient(135deg, var(--deep-red-start), var(--deep-red-end));
    color: #fff8f6;
    padding: 12px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .header-text {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
  }

  .header-text strong {
    font-size: 14px;
    letter-spacing: -0.18px;
  }

  .header-text span {
    font-size: 11px;
    color: var(--muted);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .size-toggle {
    border: 1px solid rgba(255, 230, 230, 0.35);
    border-radius: 6px;
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.18);
    color: #fff6f4;
    font-size: 12px;
    cursor: pointer;
  }

  .size-toggle:hover {
    background: rgba(255, 255, 255, 0.26);
  }

  .content {
    padding: 14px;
    background: var(--panel);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .messages {
    padding: 14px;
    background: #ffffff;
    border: 1px solid rgba(177, 60, 60, 0.2);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 186px;
    overflow-y: auto;
  }

  .bubble {
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(161, 44, 44, 0.22);
    background: rgba(161, 44, 44, 0.06);
    line-height: 1.5;
    color: var(--ink);
  }

  .bubble.user {
    align-self: flex-end;
    border-color: rgba(177, 50, 50, 0.35);
    background: linear-gradient(135deg, rgba(177, 50, 50, 0.12), rgba(177, 50, 50, 0.04));
  }

  .bubble::before {
    content: attr(data-role);
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.45px;
    color: #a12323;
    margin-bottom: 6px;
  }

  .composer {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .composer textarea {
    flex: 1;
    min-height: 48px;
    border-radius: 10px;
    border: 1px solid rgba(139, 0, 0, 0.25);
    padding: 8px 10px;
    font-size: 1em;
    line-height: 1.45;
    resize: vertical;
  }

  .composer button {
    border: 1px solid rgba(177, 50, 50, 0.45);
    border-radius: 10px;
    padding: 9px 16px;
    background: linear-gradient(135deg, rgba(177, 50, 50, 0.18), rgba(177, 50, 50, 0.28));
    color: #6b1a1a;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.18s ease;
  }

  .composer button:hover {
    transform: translateY(-1px);
  }

  .hint-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #7a4d4d;
    margin-top: -4px;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }
</style>
</head>
<body>
  <section class="context-card">
    <p>
      Nabokov lets <mark tabindex="0" id="highlight">inline commentary</mark> repaint the narrative rhythm. When we mirror the inline chat styling, the tooltip feels native to Nabokov's Web: gradient header, warm paper body, and ruby-tinted bubbles.
    </p>
    <article class="tooltip" id="tooltip" data-size="normal" role="dialog" aria-modal="true" aria-labelledby="tooltip-title" tabindex="-1">
      <header>
        <div class="header-text">
          <strong id="tooltip-title">Inline chat · Kinbote</strong>
          <span>Context captured 5s ago</span>
        </div>
        <div class="header-actions">
          <button class="size-toggle" id="size-toggle" type="button" aria-label="Toggle text size" aria-pressed="false">A⇵</button>
        </div>
      </header>
      <div class="content">
        <div class="messages" id="message-list">
          <div class="bubble assistant" data-role="Assistant" id="assistant-msg">
            The assassin pauses so Kinbote's gloss can command the tempo; the poem obeys the commentary.
          </div>
          <div class="bubble user" data-role="You" id="user-msg">
            List one marginal note where the commentary outweighs the stanza.
          </div>
        </div>
        <label class="sr-only" for="composer">Compose message</label>
        <div class="composer">
          <textarea id="composer" placeholder="Continue in the same tone…" aria-label="Compose follow-up"></textarea>
          <button type="button" id="send-button">Send</button>
        </div>
        <div class="hint-row">
          <span>Enter send · Shift+Enter newline</span>
          <span>Esc closes tooltip</span>
        </div>
      </div>
    </article>
  </section>

  <script>
    const SIZE_PREF_KEY = 'hypertext:inlineSize';
    const PAYLOAD_KEY = 'hypertext:handoff';
    const tooltip = document.getElementById('tooltip');
    const toggle = document.getElementById('size-toggle');
    const textarea = document.getElementById('composer');
    const userBubble = document.getElementById('user-msg');
    const assistantBubble = document.getElementById('assistant-msg');
    const highlight = document.getElementById('highlight');

    function applySize() {
      const stored = localStorage.getItem(SIZE_PREF_KEY) || 'normal';
      tooltip.dataset.size = stored;
      const isLarge = stored === 'large';
      toggle.setAttribute('aria-pressed', String(isLarge));
      toggle.textContent = isLarge ? 'A⇳' : 'A⇵';
    }

    applySize();

    toggle.addEventListener('click', () => {
      const isLarge = tooltip.dataset.size === 'large';
      const next = isLarge ? 'normal' : 'large';
      tooltip.dataset.size = next;
      localStorage.setItem(SIZE_PREF_KEY, next);
      toggle.setAttribute('aria-pressed', String(!isLarge));
      toggle.textContent = isLarge ? 'A⇵' : 'A⇳';
    });

    function inlineSend() {
      const value = textarea.value.trim();
      if (!value) return;
      userBubble.textContent = value;
      userBubble.setAttribute('data-role', 'You');
      textarea.value = '';
      assistantBubble.textContent = 'Thinking…';
      setTimeout(() => {
        assistantBubble.textContent = 'Mock inline response following inline chat styling.';
      }, 700);
    }

    document.getElementById('send-button').addEventListener('click', inlineSend);

    textarea.addEventListener('keydown', event => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        inlineSend();
      }
    });

    function buildPayload() {
      const rect = highlight.getBoundingClientRect();
      return {
        subject: document.getElementById('tooltip-title').textContent,
        summary: assistantBubble.textContent,
        latestUserPrompt: userBubble.textContent,
        pendingFollowup: textarea.value.trim(),
        textSize: tooltip.dataset.size,
        sourceUrl: window.location.href,
        timestamp: new Date().toISOString(),
        viewport: { x: rect.left + window.scrollX, y: rect.top + window.scrollY }
      };
    }

    function handoff(event) {
      try {
        sessionStorage.setItem(PAYLOAD_KEY, JSON.stringify(buildPayload()));
      } catch (error) {
        console.warn('Failed to store payload', error);
      }
      const target = event.shiftKey ? '_self' : '_blank';
      window.open('chat-spec.html', target, 'noopener');
    }

    highlight.addEventListener('click', handoff);
    highlight.addEventListener('keydown', event => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        handoff(event);
      }
    });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape') {
        tooltip.setAttribute('hidden', '');
        highlight.focus();
      }
    });

    tooltip.focus();
  </script>
</body>
</html>
