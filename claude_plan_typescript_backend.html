<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan: TypeScript Claude Code Backend with CardMutationAPI</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
            --light-cream: #FAFAF0;
            --level-1: #000;
            --level-2: #333;
            --level-3: #666;
            --level-4: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 4px;
            width: 100vw;
            max-width: 100%;
            line-height: 1.3;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 8px 0;
            padding: 8px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 6px 0 3px 0;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 13px;
            font-weight: 500;
            margin: 4px 0 2px 0;
            color: var(--level-3);
        }

        button {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.2s ease;
            padding: 4px 8px;
            margin: 2px;
            font-size: 12px;
            line-height: 1.2;
            cursor: pointer;
            border-radius: 2px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
            border-color: var(--chinese-gold);
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
            border-left: none;
            background: none;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin: 8px 0;
        }

        .collapsible {
            margin: 6px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 8px 10px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 12px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 10px;
        }

        .collapsible.open .collapsible-content {
            max-height: 10000px;
            padding: 10px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .collapsible.secondary .collapsible-header {
            border-left: 2px solid #999;
            background: rgba(0, 0, 0, 0.02);
            font-size: 13px;
        }

        .collapsible.full-width {
            grid-column: span 2;
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 6px 10px;
        }

        .dense-list li {
            padding: 3px 0 3px 14px;
            position: relative;
            line-height: 1.4;
        }

        .dense-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 11px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .metric {
            display: inline-block;
            background: white;
            border: 1px solid var(--chinese-gold);
            padding: 3px 8px;
            margin: 2px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 500;
        }

        .metric.important {
            background: var(--chinese-gold);
            color: white;
            font-weight: 700;
        }

        .critical { color: var(--chinese-red); font-weight: 700; }
        .success { color: var(--jade-green); font-weight: 600; }
        .warning { color: var(--chinese-gold); font-weight: 600; }
        .muted { color: var(--level-4); font-size: 12px; }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            margin: 2px 0;
            font-size: 12px;
            line-height: 1.3;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        }

        pre {
            padding: 6px 8px;
            margin: 4px 0;
            overflow-x: auto;
        }

        .indent-1 { margin-left: 16px; }
        .indent-2 { margin-left: 32px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 6px 0;
            font-size: 12px;
        }

        th {
            background: var(--chinese-red);
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            text-align: left;
        }

        td {
            border: 1px solid #ddd;
            padding: 4px 8px;
        }

        tr:nth-child(even) { background: rgba(0,0,0,0.02); }

        @media (max-width: 800px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
            .collapsible.full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div style="margin: 8px 0; text-align: right;">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
    </div>

    <div class="important-always-visible">
        <h1>üìã Plan: TypeScript Claude Code Backend with CardMutationAPI</h1>
        <div class="two-column-layout">
            <div>
                <h3>üéØ Objective</h3>
                <p>Create a TypeScript backend using Claude Agent SDK that implements the CardMutationAPI infrastructure for Nabokov's Web. The backend will enable:</p>
                <ul class="dense-list">
                    <li><strong>Card Querying:</strong> Retrieve cards from chrome.storage.local</li>
                    <li><strong>Card Creation:</strong> Create new cards with Claude's assistance</li>
                    <li><strong>DOM Manipulation:</strong> Post-creation artifact manipulation via CardMutationAPI</li>
                    <li><strong>Custom Elements:</strong> Handle <code>&lt;learn-more&gt;</code>, <code>&lt;artifact-ref&gt;</code> interactions</li>
                </ul>
            </div>
            <div>
                <h3>üîß Approach</h3>
                <p>Build a Node.js backend using the Claude Agent SDK with Express.js for REST API endpoints. Implement CardMutationAPI as specified in DESIGN.md Phase 1.5, treating AI as architectural infrastructure that operates the artifact network through surgical DOM manipulations.</p>
                <div class="metric important">Complexity: High</div>
                <div class="metric">Estimated Time: 6-8 hours</div>
            </div>
        </div>
    </div>

    <div class="two-column-layout">
        <!-- Left Column: Implementation Steps -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>‚ö° Implementation Steps</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <ol class="dense-list" style="list-style: decimal; margin-left: 20px;">
                    <li><strong>Step 1: Project Setup</strong>
                        <div class="indent-1 muted">Create backend/ directory with TypeScript configuration</div>
                        <div class="indent-1">
                            <code>mkdir backend && cd backend</code><br>
                            <code>npm init -y</code><br>
                            <code>npm install @anthropic-ai/claude-agent-sdk express cors dotenv</code><br>
                            <code>npm install -D typescript @types/node @types/express @types/cors ts-node nodemon</code>
                        </div>
                    </li>

                    <li><strong>Step 2: TypeScript Configuration</strong>
                        <div class="indent-1 muted">File: backend/tsconfig.json</div>
                        <div class="indent-1">Configure strict mode, ES modules, path aliases</div>
                    </li>

                    <li><strong>Step 3: Type Definitions</strong>
                        <div class="indent-1 muted">File: backend/src/types/index.ts</div>
                        <div class="indent-1">Import Card types from ../src/types/card.ts, define CardMutationAPI interface</div>
                    </li>

                    <li><strong>Step 4: CardMutationAPI Implementation</strong>
                        <div class="indent-1 muted">File: backend/src/api/cardMutation.ts</div>
                        <div class="indent-1">Implement all operations:</div>
                        <div class="indent-2">
                            ‚Ä¢ Core DOM: replaceContent(), appendSection(), setAttribute()<br>
                            ‚Ä¢ Knowledge: highlight(), annotate(), collapse(), expand()<br>
                            ‚Ä¢ Inter-artifact: injectReference(), createConnection()
                        </div>
                    </li>

                    <li><strong>Step 5: Claude Agent Integration</strong>
                        <div class="indent-1 muted">File: backend/src/services/claudeAgent.ts</div>
                        <div class="indent-1">Initialize Claude Agent SDK with tools, system prompt, MCP servers</div>
                    </li>

                    <li><strong>Step 6: Storage Adapter</strong>
                        <div class="indent-1 muted">File: backend/src/storage/adapter.ts</div>
                        <div class="indent-1">Bridge to chrome.storage.local via native messaging or shared filesystem</div>
                    </li>

                    <li><strong>Step 7: Card Query Endpoints</strong>
                        <div class="indent-1 muted">File: backend/src/routes/cards.ts</div>
                        <div class="indent-1">
                            GET /api/cards - List all cards<br>
                            GET /api/cards/:id - Get single card<br>
                            POST /api/cards/query - Query with filters
                        </div>
                    </li>

                    <li><strong>Step 8: Card Creation Endpoints</strong>
                        <div class="indent-1 muted">File: backend/src/routes/cards.ts</div>
                        <div class="indent-1">
                            POST /api/cards - Create new card<br>
                            POST /api/cards/generate - Generate card with Claude
                        </div>
                    </li>

                    <li><strong>Step 9: Custom Element Handlers</strong>
                        <div class="indent-1 muted">File: backend/src/handlers/customElements.ts</div>
                        <div class="indent-1">
                            Handle <code>&lt;learn-more&gt;</code> ‚Üí trigger Claude to generate new artifact<br>
                            Handle <code>&lt;artifact-ref&gt;</code> ‚Üí query other artifacts for context
                        </div>
                    </li>

                    <li><strong>Step 10: Express Server Setup</strong>
                        <div class="indent-1 muted">File: backend/src/server.ts</div>
                        <div class="indent-1">Initialize Express, register routes, error handling, CORS</div>
                    </li>

                    <li><strong>Step 11: Environment Configuration</strong>
                        <div class="indent-1 muted">File: backend/.env.example</div>
                        <div class="indent-1">ANTHROPIC_API_KEY, PORT, CHROME_EXTENSION_ID</div>
                    </li>

                    <li><strong>Step 12: npm Scripts</strong>
                        <div class="indent-1 muted">File: backend/package.json</div>
                        <div class="indent-1">
                            <code>"dev": "nodemon src/server.ts"</code><br>
                            <code>"build": "tsc"</code><br>
                            <code>"start": "node dist/server.js"</code>
                        </div>
                    </li>
                </ol>
            </div>
        </div>

        <!-- Right Column: Testing & Validation -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>‚úì Testing & Validation</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Unit Tests</h4>
                <ul class="dense-list">
                    <li><strong>CardMutationAPI Operations:</strong> Test each method in isolation</li>
                    <li><strong>Storage Adapter:</strong> Mock chrome.storage.local interactions</li>
                    <li><strong>Custom Element Handlers:</strong> Verify parsing and execution</li>
                </ul>

                <h4>Integration Tests</h4>
                <ul class="dense-list">
                    <li><strong>Card Query Flow:</strong> GET /api/cards returns valid Card[]</li>
                    <li><strong>Card Creation Flow:</strong> POST /api/cards persists to storage</li>
                    <li><strong>Claude Generation:</strong> POST /api/cards/generate produces valid HTML</li>
                </ul>

                <h4>E2E Tests</h4>
                <ul class="dense-list">
                    <li><strong>Custom Element Interaction:</strong> Click &lt;learn-more&gt; ‚Üí new artifact created</li>
                    <li><strong>Inter-Artifact Query:</strong> &lt;artifact-ref&gt; ‚Üí fetches context from other card</li>
                    <li><strong>DOM Manipulation:</strong> CardMutationAPI operations update card content</li>
                </ul>

                <h4>Manual Testing</h4>
                <ul class="dense-list">
                    <li>Start server: <code>npm run dev</code></li>
                    <li>Test endpoints with curl/Postman</li>
                    <li>Verify Claude responses with real API key</li>
                    <li>Check CORS with Chrome extension</li>
                </ul>
            </div>
        </div>

        <!-- Prerequisites & Context -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>üìç Prerequisites & Context</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Required Knowledge</h4>
                <ul class="dense-list">
                    <li><strong>DESIGN.md Phase 1.5:</strong> CardMutationAPI specification ‚úì</li>
                    <li><strong>Card Data Structure:</strong> src/types/card.ts ‚úì</li>
                    <li><strong>Storage Architecture:</strong> chrome.storage.local + IndexedDB ‚úì</li>
                    <li><strong>Claude Agent SDK:</strong> TypeScript API reference ‚úì</li>
                </ul>

                <h4>Files to Reference</h4>
                <ul class="dense-list">
                    <li><code>src/types/card.ts</code> - Card interface definition</li>
                    <li><code>src/utils/storage.ts</code> - Existing storage utilities</li>
                    <li><code>DESIGN.md</code> - CardMutationAPI spec (lines 375-397)</li>
                    <li><code>src/manifest.json</code> - Extension permissions</li>
                </ul>

                <h4>Dependencies</h4>
                <ul class="dense-list">
                    <li><code>@anthropic-ai/claude-agent-sdk</code> - Core agent framework</li>
                    <li><code>express</code> - REST API server</li>
                    <li><code>cors</code> - Chrome extension communication</li>
                    <li><code>dotenv</code> - Environment variables</li>
                </ul>
            </div>
        </div>

        <!-- Potential Issues & Mitigations -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>‚ö†Ô∏è Potential Issues</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h4>Issue 1: Chrome Extension Storage Access</h4>
                <div class="indent-1">
                    <strong class="warning">Problem:</strong> Backend can't directly access chrome.storage.local<br>
                    <strong class="success">Solution:</strong> Use native messaging protocol or shared filesystem JSON dump
                </div>

                <h4>Issue 2: CORS Restrictions</h4>
                <div class="indent-1">
                    <strong class="warning">Problem:</strong> Chrome extension may block backend requests<br>
                    <strong class="success">Solution:</strong> Configure CORS to allow extension ID, use manifest v3 permissions
                </div>

                <h4>Issue 3: Screenshot Access</h4>
                <div class="indent-1">
                    <strong class="warning">Problem:</strong> Screenshots in IndexedDB not accessible from Node.js<br>
                    <strong class="success">Solution:</strong> Return screenshotId reference, let extension fetch from IndexedDB
                </div>

                <h4>Issue 4: DOM Manipulation Timing</h4>
                <div class="indent-1">
                    <strong class="warning">Problem:</strong> CardMutationAPI operations may be slow (~3s)<br>
                    <strong class="success">Solution:</strong> Use async/await, show loading states in frontend
                </div>

                <h4>Issue 5: Custom Element Parsing</h4>
                <div class="indent-1">
                    <strong class="warning">Problem:</strong> Need to extract attributes from custom elements in HTML<br>
                    <strong class="success">Solution:</strong> Use jsdom or cheerio to parse HTML, extract data attributes
                </div>
            </div>
        </div>
    </div>

    <!-- Full Width Sections -->
    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üèóÔ∏è Detailed CardMutationAPI Specification</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <p><strong>Source:</strong> DESIGN.md lines 375-432</p>

            <h3>Interface Definition</h3>
            <pre><code>interface CardMutationAPI {
  // Core DOM operations (Claude Imagine-style)
  replaceContent(selector: string, html: string): void;
  appendSection(html: string): void;
  setAttribute(selector: string, attr: string, value: string): void;

  // Knowledge construction operations
  highlight(text: string, note?: string): void;
  annotate(selector: string, annotation: string): void;
  collapse(selector: string): void;
  expand(selector: string): void;

  // Inter-artifact operations
  injectReference(sourceArtifactId: string, excerpt: string): void;
  createConnection(targetArtifactId: string): void;
}</code></pre>

            <h3>Custom Elements Handled by Background Worker</h3>
            <pre><code>&lt;learn-more topic="distributed cognition" context="artifact-id"&gt;
&lt;artifact-ref target="artifact-456" query="What does this say about X?"&gt;
&lt;expand-section section="details"&gt;</code></pre>

            <h3>Key Insight from DESIGN.md</h3>
            <p class="indent-1"><em>"AI is not just a content generator but architectural infrastructure that operates the artifact network through surgical DOM manipulations (~3s response time sufficient for knowledge construction)"</em></p>

            <h3>Implementation Strategy</h3>
            <div class="two-column-layout">
                <div>
                    <h4>Phase 1: Core Operations</h4>
                    <ul class="dense-list">
                        <li>replaceContent() using jsdom</li>
                        <li>appendSection() for new content</li>
                        <li>setAttribute() for metadata updates</li>
                    </ul>
                </div>
                <div>
                    <h4>Phase 2: Knowledge Operations</h4>
                    <ul class="dense-list">
                        <li>highlight() wraps text in &lt;mark&gt;</li>
                        <li>annotate() adds data-annotation attributes</li>
                        <li>collapse()/expand() toggle visibility</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üìä API Test Plan</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h3>Endpoint Testing Matrix</h3>
            <table>
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Request Body</th>
                        <th>Expected Response</th>
                        <th>Test Coverage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>/api/cards</td>
                        <td>GET</td>
                        <td>None</td>
                        <td>200, Card[]</td>
                        <td>Empty list, 1 card, many cards</td>
                    </tr>
                    <tr>
                        <td>/api/cards/:id</td>
                        <td>GET</td>
                        <td>None</td>
                        <td>200, Card | 404</td>
                        <td>Valid ID, invalid ID, malformed ID</td>
                    </tr>
                    <tr>
                        <td>/api/cards/query</td>
                        <td>POST</td>
                        <td>{tags: [], starred: boolean}</td>
                        <td>200, Card[]</td>
                        <td>No filters, tag filter, starred filter, combined</td>
                    </tr>
                    <tr>
                        <td>/api/cards</td>
                        <td>POST</td>
                        <td>{content, metadata}</td>
                        <td>201, Card</td>
                        <td>Valid card, missing fields, invalid HTML</td>
                    </tr>
                    <tr>
                        <td>/api/cards/generate</td>
                        <td>POST</td>
                        <td>{prompt: string}</td>
                        <td>201, Card</td>
                        <td>Simple prompt, complex prompt, empty prompt</td>
                    </tr>
                    <tr>
                        <td>/api/cards/:id/mutate</td>
                        <td>POST</td>
                        <td>{operation, params}</td>
                        <td>200, Card</td>
                        <td>All CardMutationAPI operations</td>
                    </tr>
                    <tr>
                        <td>/api/elements/learn-more</td>
                        <td>POST</td>
                        <td>{topic, context}</td>
                        <td>201, Card</td>
                        <td>Valid topic, missing context</td>
                    </tr>
                    <tr>
                        <td>/api/elements/artifact-ref</td>
                        <td>POST</td>
                        <td>{target, query}</td>
                        <td>200, {excerpt}</td>
                        <td>Valid ref, invalid target ID</td>
                    </tr>
                </tbody>
            </table>

            <h3>Test Scenarios</h3>
            <div class="two-column-layout">
                <div>
                    <h4>Scenario 1: Query Cards by Tag</h4>
                    <pre><code>POST /api/cards/query
{
  "tags": ["research", "ai"],
  "starred": true
}

Expected: 200 with filtered Card[]</code></pre>
                </div>
                <div>
                    <h4>Scenario 2: Generate Card with Claude</h4>
                    <pre><code>POST /api/cards/generate
{
  "prompt": "Create a card about distributed cognition"
}

Expected: 201 with new Card containing Claude-generated HTML</code></pre>
                </div>
            </div>

            <div class="two-column-layout">
                <div>
                    <h4>Scenario 3: DOM Mutation</h4>
                    <pre><code>POST /api/cards/abc123/mutate
{
  "operation": "highlight",
  "params": {
    "text": "important concept",
    "note": "Key insight"
  }
}

Expected: 200 with updated Card.content</code></pre>
                </div>
                <div>
                    <h4>Scenario 4: Inter-Artifact Query</h4>
                    <pre><code>POST /api/elements/artifact-ref
{
  "target": "card-456",
  "query": "What does this say about X?"
}

Expected: 200 with relevant excerpt from target card</code></pre>
                </div>
            </div>

            <h3>Performance Tests</h3>
            <ul class="dense-list">
                <li><strong>Load Test:</strong> 100 concurrent card queries, &lt;100ms p95</li>
                <li><strong>Generation Test:</strong> Claude card generation, &lt;5s p95</li>
                <li><strong>Mutation Test:</strong> CardMutationAPI operations, &lt;3s p95</li>
                <li><strong>Storage Test:</strong> 1000 cards in chrome.storage.local, query performance</li>
            </ul>

            <h3>Error Handling Tests</h3>
            <ul class="dense-list">
                <li>Invalid card ID ‚Üí 404 Not Found</li>
                <li>Malformed request body ‚Üí 400 Bad Request</li>
                <li>Claude API failure ‚Üí 503 Service Unavailable</li>
                <li>Storage adapter failure ‚Üí 500 Internal Server Error</li>
                <li>CORS violation ‚Üí 403 Forbidden</li>
            </ul>
        </div>
    </div>

    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üìÅ Project Structure</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <pre><code>backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ server.ts                    # Express server entry point
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                 # Type definitions (import from ../src/types/card.ts)
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cardMutation.ts          # CardMutationAPI implementation
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ claudeAgent.ts           # Claude Agent SDK integration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ domParser.ts             # HTML parsing utilities (jsdom/cheerio)
‚îÇ   ‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapter.ts               # Storage adapter interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chromeAdapter.ts         # chrome.storage.local bridge (native messaging)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ indexedDBAdapter.ts      # IndexedDB screenshot access
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cards.ts                 # Card CRUD endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mutation.ts              # CardMutationAPI endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ elements.ts              # Custom element handlers
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customElements.ts        # &lt;learn-more&gt;, &lt;artifact-ref&gt; handlers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts            # Express middleware (auth, CORS, error)
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ sanitization.ts          # HTML sanitization (DOMPurify)
‚îÇ       ‚îî‚îÄ‚îÄ logger.ts                # Logging utilities
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cardMutation.test.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ storageAdapter.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cardRoutes.test.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ claudeAgent.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ e2e/
‚îÇ       ‚îî‚îÄ‚îÄ customElements.test.ts
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ .env.example
‚îî‚îÄ‚îÄ README.md</code></pre>
        </div>
    </div>

    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üìö Post-Implementation</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h3>Documentation Needs</h3>
            <ul class="dense-list">
                <li><strong>API Reference:</strong> OpenAPI/Swagger spec for all endpoints</li>
                <li><strong>Integration Guide:</strong> How to use backend from Chrome extension</li>
                <li><strong>CardMutationAPI Examples:</strong> Code samples for each operation</li>
                <li><strong>Custom Element Guide:</strong> How to create new interactive elements</li>
            </ul>

            <h3>Frontend Integration</h3>
            <ul class="dense-list">
                <li>Update background worker to call backend instead of direct storage access</li>
                <li>Add loading states for async CardMutationAPI operations</li>
                <li>Implement retry logic for failed backend requests</li>
                <li>Cache frequently accessed cards to reduce API calls</li>
            </ul>

            <h3>Performance Optimization</h3>
            <ul class="dense-list">
                <li><strong>Caching:</strong> Redis for frequently accessed cards</li>
                <li><strong>Batch Operations:</strong> Support multiple mutations in single request</li>
                <li><strong>Pagination:</strong> Limit card list responses to 50 per page</li>
                <li><strong>Compression:</strong> gzip response bodies for large card lists</li>
            </ul>

            <h3>Security Considerations</h3>
            <ul class="dense-list">
                <li><strong>API Key Validation:</strong> Verify ANTHROPIC_API_KEY on startup</li>
                <li><strong>Extension Origin:</strong> Whitelist Chrome extension ID for CORS</li>
                <li><strong>HTML Sanitization:</strong> Always sanitize card content before storage</li>
                <li><strong>Rate Limiting:</strong> Prevent abuse of Claude API (10 req/min per extension)</li>
            </ul>

            <h3>Deployment</h3>
            <ul class="dense-list">
                <li><strong>Docker:</strong> Create Dockerfile for containerized deployment</li>
                <li><strong>Environment:</strong> Production .env with secure API keys</li>
                <li><strong>Monitoring:</strong> Add logging (Winston), error tracking (Sentry)</li>
                <li><strong>CI/CD:</strong> GitHub Actions for automated testing and deployment</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-create collapsibles for sections marked with data-collapsible
            document.querySelectorAll('[data-collapsible]').forEach(function(section) {
                const isOpen = section.getAttribute('data-collapsible') === 'open';
                section.classList.add('collapsible');
                if (isOpen) section.classList.add('open');
            });

            // Handle collapsible clicks
            document.querySelectorAll('.collapsible-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    const collapsible = this.closest('.collapsible');
                    collapsible.classList.toggle('open');
                });
            });

            // Expand/Collapse all buttons
            const expandAllBtn = document.getElementById('expand-all');
            const collapseAllBtn = document.getElementById('collapse-all');

            if (expandAllBtn) {
                expandAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('.collapsible').forEach(function(c) {
                        c.classList.add('open');
                    });
                });
            }

            if (collapseAllBtn) {
                collapseAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('.collapsible').forEach(function(c) {
                        c.classList.remove('open');
                    });
                });
            }
        });
    </script>
</body>
</html>