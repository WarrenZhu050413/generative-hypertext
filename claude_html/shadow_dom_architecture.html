<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow DOM Architecture - Nabokov Content Script</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --ink-black: #2C3E50;
            --paper-beige: #FDF6E3;
            --light-cream: #F8F4E8;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #666;
            --level-4: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            font-size: 14px;
            line-height: 1.2;
            margin: 0;
            padding: 0;
            width: 100vw;
            max-width: 100%;
        }

        .container {
            width: 100%;
            padding: 0;
            margin: 0;
        }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 4px 0;
            padding: 6px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0 2px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 12px;
            font-weight: 500;
            margin: 2px 0 1px 16px;
            color: var(--level-3);
        }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 11px;
            line-height: 1.3;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            border-radius: 2px;
        }

        pre {
            padding: 4px 6px;
            margin: 2px 0;
            overflow-x: auto;
        }

        .collapsible {
            margin: 4px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 10px;
            margin-right: 6px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 8px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 8px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
            border-radius: 3px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 8px 0;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin-left: 8px;
        }

        .dense-list li {
            padding: 2px 0 2px 12px;
            border-left: 2px solid transparent;
            position: relative;
        }

        .dense-list li:before {
            content: "▸";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 10px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 8px 0;
        }

        .indent-1 { margin-left: 12px; }
        .indent-2 { margin-left: 24px; }
        .indent-3 { margin-left: 36px; }

        .flow-diagram {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 8px;
            margin: 6px 0;
            font-family: 'SF Mono', monospace;
            font-size: 11px;
        }

        .code-reference {
            color: var(--chinese-red);
            font-weight: 600;
            font-size: 11px;
            font-family: 'SF Mono', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shadow DOM in Content Script: Complete Architecture</h1>

        <div class="important-always-visible">
            <h2>Core Purpose</h2>
            <p><strong>Style Isolation:</strong> Shadow DOM creates an isolated DOM tree that prevents CSS conflicts between your extension UI (ElementSelector, FloatingChat) and the host webpage's styles. The page cannot affect your extension's appearance, and your extension cannot accidentally break the page's layout.</p>
            <p><strong>Files:</strong> <code class="code-reference">src/content/index.tsx:124-127</code> → <code class="code-reference">src/utils/shadowDOM.ts:267-320</code></p>
        </div>

        <div class="collapsible critical open">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span><strong>Activation Flow: User Presses Cmd+Shift+E</strong></span>
            </div>
            <div class="collapsible-content">
                <div class="flow-diagram">
1. Background worker detects Cmd+Shift+E
   ↓
2. chrome.runtime.sendMessage({ type: 'ACTIVATE_SELECTOR' })
   ↓
3. Content script receives message (src/content/index.tsx:301)
   ↓
4. activateSelector() called (line 110)
   ↓
5. createContainer() → fixed-position div appended to body (line 67-88)
   ↓
6. createShadowRoot(container) → Shadow DOM attached (line 124-127)
   ↓
7. mountReactInShadow() → ElementSelector rendered inside shadow (line 150-154)
   ↓
8. User sees overlay with Chinese aesthetic styles
                </div>
                <p class="indent-1"><strong>Critical Detail:</strong> Container has <code>pointer-events: none</code> (line 81) to avoid blocking page interaction, but ElementSelector enables pointer events for its own UI.</p>
            </div>
        </div>

        <div class="two-column-layout">
            <div class="collapsible">
                <div class="collapsible-header">
                    <span><span class="arrow">▶</span>Container Creation</span>
                </div>
                <div class="collapsible-content">
                    <h4>src/content/index.tsx:67-88</h4>
                    <pre>const container = document.createElement('div');
container.id = 'nabokov-clipper-root';
container.setAttribute('data-nabokov-container', 'true');

container.style.cssText = \`
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 2147483647; /* Max z-index */
  pointer-events: none; /* Transparent to clicks */
\`;

document.body.appendChild(container);</pre>
                    <ul class="dense-list">
                        <li><strong>Fixed positioning:</strong> Overlays entire viewport</li>
                        <li><strong>Max z-index:</strong> Always on top of page content</li>
                        <li><strong>Pointer-events none:</strong> Doesn't block page interaction</li>
                        <li><strong>Data attribute:</strong> Easy identification for debugging</li>
                    </ul>
                </div>
            </div>

            <div class="collapsible">
                <div class="collapsible-header">
                    <span><span class="arrow">▶</span>Shadow Root Attachment</span>
                </div>
                <div class="collapsible-content">
                    <h4>src/utils/shadowDOM.ts:295-298</h4>
                    <pre>shadowRoot = host.attachShadow({
  mode: 'open'
});</pre>
                    <ul class="dense-list">
                        <li><strong>Mode 'open':</strong> Allows JavaScript access via <code>container.shadowRoot</code></li>
                        <li><strong>Style isolation:</strong> Page CSS cannot penetrate shadow boundary</li>
                        <li><strong>DOM isolation:</strong> <code>querySelector</code> from page cannot find shadow content</li>
                        <li><strong>Event propagation:</strong> Events still bubble to page (retargeted)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="collapsible critical">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span><strong>Emotion CSS-in-JS Integration</strong></span>
            </div>
            <div class="collapsible-content">
                <h3>Why Emotion Needs Special Setup</h3>
                <p class="indent-1">Emotion normally injects styles into <code>&lt;head&gt;</code> of main document. Inside Shadow DOM, there is no <code>&lt;head&gt;</code>, so styles would be lost. Solution: Create custom Emotion cache targeting the shadow root.</p>

                <div class="two-column-layout">
                    <div class="card">
                        <h4>Cache Creation (shadowDOM.ts:301-307)</h4>
                        <pre>const styleCache = createCache({
  key: 'shadow',
  container: shadowRoot as HTMLElement,
  nonce,
  prepend: true, // User styles override
});</pre>
                    </div>
                    <div class="card">
                        <h4>React Mounting (shadowDOM.ts:374-382)</h4>
                        <pre>root.render(
  &lt;CacheProvider value={styleCache}&gt;
    {component}
  &lt;/CacheProvider&gt;
);</pre>
                    </div>
                </div>

                <p class="indent-1"><strong>Result:</strong> All Emotion styles from <code>css={...}</code> props in ElementSelector, FloatingChat, etc. are injected into shadow root as <code>&lt;style data-emotion="shadow"&gt;</code> tags.</p>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span>Chinese Aesthetic Styles Injection</span>
            </div>
            <div class="collapsible-content">
                <h4>src/utils/shadowDOM.ts:59-232 (CHINESE_AESTHETIC_STYLES)</h4>
                <p class="indent-1">232 lines of CSS defining custom properties, typography, colors, and component styles. Injected as global <code>&lt;style&gt;</code> tag in shadow root.</p>

                <div class="card priority">
                    <h4>Key CSS Custom Properties</h4>
                    <div class="two-column-layout">
                        <div>
                            <pre>--color-ink: #2C3E50
--color-rice: #FDF6E3
--color-cinnabar: #C23B22
--color-gold: #D4AF37</pre>
                        </div>
                        <div>
                            <pre>--spacing-md: 16px
--font-size-base: 14px
--shadow-md: 0 2px 8px
--transition-base: 250ms</pre>
                        </div>
                    </div>
                </div>

                <h4 class="indent-1">Injection Process (shadowDOM.ts:315-317)</h4>
                <pre class="indent-2">if (injectBaseStyles && shadowRoot.childNodes.length === 1) {
  injectGlobalStyles(shadowRoot, CHINESE_AESTHETIC_STYLES);
}</pre>
                <p class="indent-2">Creates <code>&lt;style id="shadow-global-styles"&gt;</code> prepended to shadow root, so component-specific Emotion styles can override.</p>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span>React Component Lifecycle</span>
            </div>
            <div class="collapsible-content">
                <div class="flow-diagram">
<strong>Mount Phase:</strong>
mountReactInShadow(shadowRoot, &lt;ElementSelector /&gt;, { styleCache })
  ↓
ReactDOM.createRoot(reactContainer) // React 18 API
  ↓
root.render(&lt;CacheProvider&gt;&lt;ElementSelector /&gt;&lt;/CacheProvider&gt;)
  ↓
Component renders, Emotion styles inject into shadow root
  ↓
Returns cleanup function: () =&gt; { root.unmount(); }

<strong>Unmount Phase (ESC or element captured):</strong>
deactivateSelector() called (src/content/index.tsx:215)
  ↓
state.cleanup() → root.unmount() (line 226)
  ↓
removeContainer() → container.parentNode.removeChild() (line 233)
  ↓
State reset (line 237-244)
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span>State Management During Capture</span>
            </div>
            <div class="collapsible-content">
                <h4>ContentScriptState Interface (src/content/index.tsx:31-44)</h4>
                <pre>interface ContentScriptState {
  isActive: boolean;              // Selector mounted?
  selectedElement: HTMLElement | null;
  capturedCard: Card | null;
  showFloatingChat: boolean;      // Chat visible?
  containerElement: HTMLElement | null;
  cleanup: (() => void) | null;   // Unmount function
}</pre>

                <h4 class="indent-1">Capture Flow (line 130-141)</h4>
                <pre class="indent-2">const handleCapture = (card: Card) => {
  state.capturedCard = card;
  state.showFloatingChat = true;

  if (state.selectedElement) {
    remountWithChat(shadowRoot, styleCache);
  }
};</pre>
                <p class="indent-2"><strong>Note:</strong> <code>remountWithChat()</code> currently a placeholder (line 189-210). ElementSelector handles FloatingChat internally, so no remount needed.</p>
            </div>
        </div>

        <div class="two-column-layout">
            <div class="collapsible">
                <div class="collapsible-header">
                    <span><span class="arrow">▶</span>Why Not iframe?</span>
                </div>
                <div class="collapsible-content">
                    <ul class="dense-list">
                        <li><strong>Performance:</strong> iframe creates separate document, window, rendering context (heavy)</li>
                        <li><strong>Communication:</strong> postMessage required for cross-iframe communication (complex)</li>
                        <li><strong>Layout:</strong> iframe has built-in border, sizing quirks</li>
                        <li><strong>Access:</strong> CORS restrictions make DOM access difficult</li>
                        <li><strong>Shadow DOM:</strong> Lightweight, same JavaScript context, direct DOM access, perfect isolation</li>
                    </ul>
                </div>
            </div>

            <div class="collapsible">
                <div class="collapsible-header">
                    <span><span class="arrow">▶</span>Common Pitfalls</span>
                </div>
                <div class="collapsible-content">
                    <ul class="dense-list">
                        <li><strong>Font inheritance:</strong> Fonts don't inherit into shadow, must redeclare</li>
                        <li><strong>Global selectors:</strong> <code>body</code> selector won't work, use <code>:host</code> instead</li>
                        <li><strong>Event listeners:</strong> <code>document.addEventListener</code> from page won't capture shadow events</li>
                        <li><strong>querySelector:</strong> Page's <code>querySelector</code> cannot find shadow content</li>
                        <li><strong>CSS reset:</strong> Shadow needs its own reset/normalize</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="collapsible critical">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span><strong>Architecture Decision Summary</strong></span>
            </div>
            <div class="collapsible-content">
                <div class="card priority">
                    <h3>Key Decisions & Rationale</h3>
                    <ul class="dense-list">
                        <li><strong>Fixed positioning container:</strong> Ensures overlay works on all pages regardless of scroll position or layout</li>
                        <li><strong>Max z-index (2147483647):</strong> Guarantees extension UI appears above all page content</li>
                        <li><strong>pointer-events: none on container:</strong> Allows page interaction while selector inactive, individual components enable pointer events as needed</li>
                        <li><strong>Shadow DOM mode 'open':</strong> Allows extension code to access shadow root for React mounting while maintaining isolation from page</li>
                        <li><strong>Emotion cache targeting shadow root:</strong> Enables full CSS-in-JS capabilities inside isolated environment</li>
                        <li><strong>Prepended global styles:</strong> Base styles load first, component styles override, provides sensible defaults</li>
                        <li><strong>React 18 createRoot:</strong> Modern concurrent rendering, better performance than legacy render()</li>
                        <li><strong>Cleanup function pattern:</strong> Ensures proper unmounting, prevents memory leaks in long-running content scripts</li>
                        <li><strong>State management outside React:</strong> Content script state managed in module scope for persistence across component remounts</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span>Utility Functions Reference</span>
            </div>
            <div class="collapsible-content">
                <h4>shadowDOM.ts Exports</h4>
                <div class="two-column-layout">
                    <div class="card">
                        <pre>createShadowRoot(host, options)
→ { shadowRoot, styleCache, container }

mountReactInShadow(shadowRoot, component, options)
→ cleanup: () => void

injectGlobalStyles(shadowRoot, styles, options)
→ void</pre>
                    </div>
                    <div class="card">
                        <pre>isolateStyles(Component, options)
→ IsolatedComponent

isInShadowRoot(element)
→ boolean

getShadowRoot(element)
→ ShadowRoot | null</pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span>Testing Considerations</span>
            </div>
            <div class="collapsible-content">
                <ul class="dense-list">
                    <li><strong>jsdom limitations:</strong> jsdom doesn't fully support shadow DOM, use Playwright for E2E</li>
                    <li><strong>Accessing shadow content in tests:</strong> Use <code>container.shadowRoot.querySelector()</code></li>
                    <li><strong>Style verification:</strong> Check <code>shadowRoot.querySelectorAll('style')</code> for injected styles</li>
                    <li><strong>Event testing:</strong> Dispatch events on elements inside shadow root directly</li>
                    <li><strong>Development exports:</strong> <code>window.__nabokobClipper__</code> available in dev mode (line 453-459)</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        // Collapsible functionality
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.parentElement;
                collapsible.classList.toggle('open');
            });
        });

        // Open critical sections by default
        document.querySelectorAll('.collapsible.critical, .collapsible.open').forEach(el => {
            el.classList.add('open');
        });
    </script>
</body>
</html>