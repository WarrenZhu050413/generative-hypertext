<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floating Window System - Improvement Plan</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #F5F5DC;
            --light-cream: #FFFEF0;
            --ink-black: #2C2416;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #8B7355;
            --level-4: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.2;
            font-size: 14px;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            padding: 0;
            margin: 0;
        }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 4px 0;
            padding: 6px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0 2px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 12px;
            font-weight: 500;
            margin: 2px 0 1px 16px;
            color: var(--level-3);
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 4px 0;
        }

        .full-width {
            grid-column: span 2;
        }

        .collapsible {
            margin: 4px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 10px;
            margin-right: 8px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 8px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 8px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
            border-radius: 3px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin-left: 8px;
        }

        .dense-list li {
            padding: 2px 0 2px 12px;
            border-left: 2px solid transparent;
            position: relative;
        }

        .dense-list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 10px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .indent-1 { margin-left: 12px; }
        .indent-2 { margin-left: 24px; }
        .indent-3 { margin-left: 36px; }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 8px 0;
        }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 12px;
            line-height: 1.1;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        pre {
            padding: 4px 6px;
            margin: 2px 0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2px 0;
            font-size: 12px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 2px 4px;
            text-align: left;
            line-height: 1.1;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
        }

        .status-good {
            color: #2E7D32;
            font-weight: 600;
        }

        .status-bad {
            color: #C62828;
            font-weight: 600;
        }

        .status-warning {
            color: #F57C00;
            font-weight: 600;
        }

        button {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.2s ease;
            padding: 2px 6px;
            margin: 1px;
            font-size: 12px;
            line-height: 1.1;
            cursor: pointer;
            border-radius: 2px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
            border-color: var(--chinese-gold);
        }

        .expand-all, .collapse-all {
            position: fixed;
            top: 8px;
            right: 8px;
            z-index: 1000;
            padding: 4px 8px;
            font-size: 11px;
        }

        .collapse-all {
            right: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="collapse-all" onclick="collapseAll()">Collapse All</button>
        <button class="expand-all" onclick="expandAll()">Expand All</button>

        <h1>ü™ü Floating Window System - Comprehensive Improvement Plan</h1>

        <div class="important-always-visible">
            <h2>üìå Critical Requirements Summary</h2>
            <ul class="dense-list">
                <li><strong>Draggable:</strong> <span class="status-good">‚úÖ Already Works</span> - Uses react-draggable</li>
                <li><strong>Resizable:</strong> <span class="status-bad">‚ùå Missing</span> - Fixed 600√ó500px size, no resize handles</li>
                <li><strong>Collapsible:</strong> <span class="status-warning">‚ö†Ô∏è Partial</span> - Has minimize (hides completely), needs collapse to header only</li>
                <li><strong>Multiple Windows:</strong> <span class="status-warning">‚ö†Ô∏è Partial</span> - Canvas windows work, but element-attached windows limited</li>
                <li><strong>Save to Canvas/Stash:</strong> <span class="status-good">‚úÖ Already Works</span> - FloatingWindow can save conversations</li>
            </ul>
        </div>

        <div class="divider"></div>

        <h2>üîç Current Architecture Analysis</h2>

        <div class="two-column-layout">
            <div class="collapsible critical open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>FloatingWindow.tsx</strong> (Canvas)</span>
                </div>
                <div class="collapsible-content">
                    <h4>Location</h4>
                    <code>src/components/FloatingWindow.tsx</code>

                    <h4>Current Capabilities</h4>
                    <ul class="dense-list indent-1">
                        <li><strong>Draggable:</strong> ‚úÖ Via react-draggable with header handle</li>
                        <li><strong>Resizable:</strong> ‚ùå Fixed 600√ó500px</li>
                        <li><strong>Collapsible:</strong> ‚ö†Ô∏è Only minimize (display: none)</li>
                        <li><strong>Z-index:</strong> ‚úÖ Managed by windowManager</li>
                        <li><strong>State:</strong> ‚úÖ Persisted via windowManager</li>
                    </ul>

                    <h4>Key Code Patterns</h4>
                    <pre><code>// Draggable setup
&lt;Draggable
  handle=".window-header"
  position={windowState.position}
  onStop={handleDragStop}
  bounds="parent"
&gt;

// Size (hardcoded)
width: 600px;
height: 500px;</code></pre>

                    <h4>Issues</h4>
                    <ul class="dense-list indent-1">
                        <li>No resize handles or resizing logic</li>
                        <li>Minimize hides completely (not header-only collapse)</li>
                        <li>Only works on Canvas page, not in content scripts</li>
                    </ul>
                </div>
            </div>

            <div class="collapsible critical open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>InlineChatWindow.tsx</strong> (Content)</span>
                </div>
                <div class="collapsible-content">
                    <h4>Location</h4>
                    <code>src/components/InlineChatWindow.tsx</code>

                    <h4>Current Capabilities</h4>
                    <ul class="dense-list indent-1">
                        <li><strong>Draggable:</strong> ‚úÖ Via react-draggable</li>
                        <li><strong>Resizable:</strong> ‚ùå Fixed 420√ó550px</li>
                        <li><strong>Collapsible:</strong> ‚ùå No collapse/minimize</li>
                        <li><strong>Context:</strong> ‚úÖ Page or element context</li>
                        <li><strong>Save:</strong> ‚úÖ Can save to canvas</li>
                    </ul>

                    <h4>Key Code Patterns</h4>
                    <pre><code>// Draggable with nodeRef
&lt;Draggable
  nodeRef={nodeRef}
  handle=".drag-handle"
  bounds="parent"
  defaultPosition={defaultPosition}
&gt;

// Size (hardcoded)
width: 420px;
height: 550px;</code></pre>

                    <h4>Issues</h4>
                    <ul class="dense-list indent-1">
                        <li>No resize capability</li>
                        <li>No collapse/minimize button</li>
                        <li>Single instance only (toggle on/off)</li>
                        <li>Cannot attach to multiple elements simultaneously</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="collapsible open full-width">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∏</span><strong>WindowManager Service</strong></span>
            </div>
            <div class="collapsible-content">
                <h4>Location</h4>
                <code>src/services/windowManager.ts</code>

                <h4>Current State Management</h4>
                <pre><code>interface WindowState {
  cardId: string;
  position: WindowPosition;    // {x, y}
  size: WindowSize;            // {width, height}
  minimized: boolean;          // Hide window completely
  zIndex: number;              // Stacking order
  chatInput: string;           // Preserved input
  conversationMessages: Message[];
  scrollPosition: number;
  isStreaming: boolean;
}</code></pre>

                <h4>Key Methods</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Purpose</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>openWindow(card)</code></td>
                            <td>Create/restore window</td>
                            <td>Cascade positioning</td>
                        </tr>
                        <tr>
                            <td><code>minimizeWindow(id)</code></td>
                            <td>Set minimized flag</td>
                            <td>Display: none (not header-only)</td>
                        </tr>
                        <tr>
                            <td><code>updatePosition(id, x, y)</code></td>
                            <td>Update position</td>
                            <td>Debounced save</td>
                        </tr>
                        <tr>
                            <td><code>updateSize(id, w, h)</code></td>
                            <td>Update size</td>
                            <td>‚ö†Ô∏è Not currently used</td>
                        </tr>
                        <tr>
                            <td><code>bringToFront(id)</code></td>
                            <td>Update z-index</td>
                            <td>Works well</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Strengths</h4>
                <ul class="dense-list indent-1">
                    <li>Centralized state management</li>
                    <li>Debounced persistence to storage</li>
                    <li>Subscriber pattern for reactive updates</li>
                    <li>Z-index management works well</li>
                </ul>

                <h4>Limitations</h4>
                <ul class="dense-list indent-1">
                    <li>Only works on Canvas (not content scripts)</li>
                    <li><code>updateSize</code> method exists but unused</li>
                    <li>No collapse state (only minimize)</li>
                    <li>One window per card (no multi-element support)</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üéØ Implementation Plan</h2>

        <div class="two-column-layout">
            <div class="collapsible critical open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>1. Add Resize Capability</strong></span>
                </div>
                <div class="collapsible-content">
                    <h3>Solution: react-rnd Library</h3>
                    <p><strong>Package:</strong> <code>react-rnd</code> (combines draggable + resizable)</p>

                    <h4>Installation</h4>
                    <pre><code>npm install react-rnd</code></pre>

                    <h4>Replace Draggable</h4>
                    <pre><code>import { Rnd } from 'react-rnd';

&lt;Rnd
  position={{ x: windowState.position.x, y: windowState.position.y }}
  size={{ width: windowState.size.width, height: windowState.size.height }}
  onDragStop={(e, d) => {
    windowManager.updatePosition(card.id, d.x, d.y);
  }}
  onResizeStop={(e, dir, ref, delta, position) => {
    windowManager.updateSize(
      card.id,
      parseInt(ref.style.width),
      parseInt(ref.style.height)
    );
    windowManager.updatePosition(card.id, position.x, position.y);
  }}
  minWidth={300}
  minHeight={200}
  bounds="parent"
  dragHandleClassName="window-header"
  enableResizing={{
    bottom: true,
    bottomRight: true,
    bottomLeft: true,
    right: true,
    left: true,
    top: false,
    topRight: false,
    topLeft: false
  }}
&gt;
  {/* Window content */}
&lt;/Rnd&gt;</code></pre>

                    <h4>Benefits</h4>
                    <ul class="dense-list indent-1">
                        <li>Drag + resize in one component</li>
                        <li>Configurable resize handles (sides, corners)</li>
                        <li>Min/max size constraints</li>
                        <li>Same API as Draggable</li>
                    </ul>

                    <h4>WindowState Updates</h4>
                    <p>Already has <code>size: WindowSize</code> - just need to use it!</p>
                    <pre><code>// WindowManager already supports this
updateSize(cardId: string, width: number, height: number) {
  const window = this.windows.get(cardId);
  if (window) {
    window.size = { width, height };
    this.notifyListeners();
    this.debouncedSave();
  }
}</code></pre>
                </div>
            </div>

            <div class="collapsible critical open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>2. Add Collapse Capability</strong></span>
                </div>
                <div class="collapsible-content">
                    <h3>Solution: Collapsed State</h3>
                    <p>Add <code>collapsed: boolean</code> to WindowState (different from minimize)</p>

                    <h4>WindowState Extension</h4>
                    <pre><code>interface WindowState {
  // ... existing fields
  collapsed: boolean;  // NEW: Header-only mode
  collapsedHeight: number; // Height when collapsed (e.g., 40px)
}</code></pre>

                    <h4>WindowManager Methods</h4>
                    <pre><code>collapseWindow(cardId: string): void {
  const window = this.windows.get(cardId);
  if (window) {
    window.collapsed = true;
    window.collapsedHeight = 40; // Header height
    this.notifyListeners();
    this.debouncedSave();
  }
}

expandWindow(cardId: string): void {
  const window = this.windows.get(cardId);
  if (window) {
    window.collapsed = false;
    this.notifyListeners();
    this.debouncedSave();
  }
}</code></pre>

                    <h4>UI Implementation</h4>
                    <pre><code>// In FloatingWindow.tsx header
&lt;button
  onClick={handleCollapse}
  css={controlButtonStyles}
  title={windowState.collapsed ? "Expand" : "Collapse"}
&gt;
  {windowState.collapsed ? '‚ñº' : '‚ñ≤'}
&lt;/button&gt;

// Dynamic styling
const windowStyles = (collapsed: boolean, ...) => css\`
  height: ${collapsed ? '40px' : windowState.size.height + 'px'};
  overflow: hidden;
  transition: height 0.3s ease;
\`;

// Hide content when collapsed
&lt;div css={contentStyles} style={{
  display: windowState.collapsed ? 'none' : 'flex'
}}&gt;
  {/* content */}
&lt;/div&gt;</code></pre>

                    <h4>Difference from Minimize</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Result</th>
                                <th>Use Case</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Minimize</strong></td>
                                <td>Display: none (gone)</td>
                                <td>Temporarily hide window</td>
                            </tr>
                            <tr>
                                <td><strong>Collapse</strong></td>
                                <td>Header only (40px)</td>
                                <td>Save space, keep visible</td>
                            </tr>
                            <tr>
                                <td><strong>Close</strong></td>
                                <td>Remove from manager</td>
                                <td>Done with window</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="collapsible open full-width">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∏</span><strong>3. Multiple Element-Attached Windows</strong></span>
            </div>
            <div class="collapsible-content">
                <h3>Problem: Current Limitations</h3>
                <ul class="dense-list">
                    <li><strong>InlineChatWindow:</strong> Single global instance (toggle on/off)</li>
                    <li><strong>Content Script State:</strong> One <code>inlineChatState</code> only</li>
                    <li><strong>No Element Tracking:</strong> Cannot attach to multiple elements</li>
                </ul>

                <h3>Solution: Multi-Window Content Script Architecture</h3>

                <h4>1. New ElementWindowManager (Content Script)</h4>
                <pre><code>// src/services/elementWindowManager.ts
interface ElementWindowState {
  id: string;              // Unique window ID
  element: HTMLElement;    // Attached element
  position: { x: number; y: number };
  size: { width: number; height: number };
  collapsed: boolean;
  minimized: boolean;
  zIndex: number;
  containerElement: HTMLElement;
  cleanup: () => void;
}

class ElementWindowManager {
  private windows = new Map&lt;string, ElementWindowState&gt;();
  private maxZIndex = 999999;

  openWindow(elementId: string, element: HTMLElement) {
    // Create unique window for this element
    const windowState = {
      id: elementId,
      element,
      position: this.calculatePositionNearElement(element),
      size: { width: 420, height: 550 },
      collapsed: false,
      minimized: false,
      zIndex: ++this.maxZIndex,
      // ... mount InlineChatWindow in shadow DOM
    };

    this.windows.set(elementId, windowState);
  }

  closeWindow(elementId: string) {
    const window = this.windows.get(elementId);
    if (window) {
      window.cleanup();
      this.windows.delete(elementId);
    }
  }

  private calculatePositionNearElement(element: HTMLElement) {
    const rect = element.getBoundingClientRect();
    return {
      x: rect.right + 20,
      y: rect.top
    };
  }
}</code></pre>

                <h4>2. Update Content Script to Support Multiple Windows</h4>
                <pre><code>// src/content/index.tsx
let elementWindowManager = new ElementWindowManager();

function openElementChat(element: HTMLElement) {
  // Generate unique ID for element
  const elementId = element.getAttribute('data-nabokov-id') ||
                    generateUniqueId(element);

  // Check if window already exists
  if (elementWindowManager.hasWindow(elementId)) {
    elementWindowManager.bringToFront(elementId);
    return;
  }

  // Open new window attached to this element
  elementWindowManager.openWindow(elementId, element);
}</code></pre>

                <h4>3. Context Menu Integration</h4>
                <pre><code>// Track all right-clicked elements
const rightClickedElements = new Map&lt;string, HTMLElement&gt;();

function handleContextMenu(event: MouseEvent) {
  const element = event.target as HTMLElement;
  const elementId = assignElementId(element);

  rightClickedElements.set(elementId, element);
  lastRightClickPosition = { x: event.clientX, y: event.clientY };
}

// Background script context menu
chrome.contextMenus.create({
  id: 'open-element-window',
  title: 'Chat with This Element',
  contexts: ['all']
});

chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === 'open-element-window') {
    chrome.tabs.sendMessage(tab.id, {
      type: 'OPEN_ELEMENT_WINDOW',
      payload: { elementId: lastElementId }
    });
  }
});</code></pre>

                <h4>Benefits</h4>
                <ul class="dense-list indent-1">
                    <li><strong>Multiple Windows:</strong> One per element</li>
                    <li><strong>Element Tracking:</strong> Unique ID per element</li>
                    <li><strong>Independent State:</strong> Each window has own position, size, collapse state</li>
                    <li><strong>Z-index Management:</strong> Proper stacking</li>
                </ul>
            </div>
        </div>

        <div class="two-column-layout">
            <div class="collapsible open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>4. Enhanced Save to Canvas/Stash</strong></span>
                </div>
                <div class="collapsible-content">
                    <h3>Current Capability</h3>
                    <p>FloatingWindow already has <code>handleSaveConversation</code> that creates a new card</p>

                    <h3>Enhancement: Add Stash Option</h3>
                    <pre><code>// Add button in FloatingWindow header
&lt;button
  onClick={() => handleSaveConversation('canvas')}
  title="Save to Canvas"
&gt;
  üé®
&lt;/button&gt;
&lt;button
  onClick={() => handleSaveConversation('stash')}
  title="Save to Stash"
&gt;
  üì•
&lt;/button&gt;

// Update save handler
const handleSaveConversation = async (destination: 'canvas' | 'stash') => {
  // ... create card
  const newCard: Card = {
    // ... existing fields
    stashed: destination === 'stash'  // Set stashed flag
  };

  await saveCard(newCard);

  if (destination === 'canvas') {
    alert('Conversation saved to canvas!');
  } else {
    alert('Conversation saved to stash!');
  }
};</code></pre>
                </div>
            </div>

            <div class="collapsible open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>5. Unified Window Component</strong></span>
                </div>
                <div class="collapsible-content">
                    <h3>Goal: Single Component for All Contexts</h3>

                    <h4>Create BaseFloatingWindow</h4>
                    <pre><code>// src/components/BaseFloatingWindow.tsx
interface BaseFloatingWindowProps {
  id: string;
  title: string;
  icon: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  collapsed: boolean;
  minimized: boolean;
  zIndex: number;
  onDrag: (x: number, y: number) => void;
  onResize: (w: number, h: number) => void;
  onCollapse: () => void;
  onMinimize: () => void;
  onClose: () => void;
  children: React.ReactNode;
}

export const BaseFloatingWindow: React.FC&lt;Props&gt; = ({
  // Use react-rnd for drag+resize
  // Implement collapse/minimize logic
  // Render children in content area
});</code></pre>

                    <h4>Usage</h4>
                    <pre><code>// FloatingWindow becomes wrapper
&lt;BaseFloatingWindow
  id={card.id}
  title={card.metadata.title}
  // ... all window props
&gt;
  &lt;CardContent card={card} /&gt;
  &lt;FloatingWindowChat ... /&gt;
&lt;/BaseFloatingWindow&gt;

// InlineChatWindow uses same base
&lt;BaseFloatingWindow
  id={`element-${elementId}`}
  title="Chat with Element"
  // ... window props
&gt;
  &lt;ChatMessages messages={messages} /&gt;
  &lt;ChatInput onSend={handleSend} /&gt;
&lt;/BaseFloatingWindow&gt;</code></pre>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üìã Implementation Checklist</h2>

        <div class="card priority">
            <h3>Phase 1: Core Window Improvements</h3>
            <ul class="dense-list">
                <li><strong>[ ]</strong> Install <code>react-rnd</code> package</li>
                <li><strong>[ ]</strong> Add <code>collapsed</code> and <code>collapsedHeight</code> to WindowState</li>
                <li><strong>[ ]</strong> Create <code>BaseFloatingWindow</code> component with react-rnd</li>
                <li><strong>[ ]</strong> Add collapse/expand button to window header</li>
                <li><strong>[ ]</strong> Update windowManager with collapse/expand methods</li>
                <li><strong>[ ]</strong> Test resize + collapse on Canvas windows</li>
            </ul>
        </div>

        <div class="card priority">
            <h3>Phase 2: Multi-Element Windows</h3>
            <ul class="dense-list">
                <li><strong>[ ]</strong> Create ElementWindowManager service</li>
                <li><strong>[ ]</strong> Assign unique IDs to HTML elements (data-nabokov-id)</li>
                <li><strong>[ ]</strong> Update content script to track multiple windows</li>
                <li><strong>[ ]</strong> Implement element-relative positioning</li>
                <li><strong>[ ]</strong> Add z-index management for content script windows</li>
                <li><strong>[ ]</strong> Update context menu to open per-element windows</li>
            </ul>
        </div>

        <div class="card">
            <h3>Phase 3: Polish & Features</h3>
            <ul class="dense-list">
                <li><strong>[ ]</strong> Add stash destination option for save</li>
                <li><strong>[ ]</strong> Implement minimize taskbar (show minimized windows)</li>
                <li><strong>[ ]</strong> Add keyboard shortcuts (e.g., Cmd+M to minimize)</li>
                <li><strong>[ ]</strong> Window snap-to-edges behavior</li>
                <li><strong>[ ]</strong> Save window states to storage (persist across reloads)</li>
                <li><strong>[ ]</strong> Add animations (smooth collapse/expand)</li>
            </ul>
        </div>

        <div class="divider"></div>

        <h2>üé® UI/UX Mockups</h2>

        <div class="collapsible open">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∏</span><strong>Window States Visual Guide</strong></span>
            </div>
            <div class="collapsible-content">
                <table>
                    <thead>
                        <tr>
                            <th>State</th>
                            <th>Appearance</th>
                            <th>Height</th>
                            <th>Button</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Normal</strong></td>
                            <td>Full window with content + chat</td>
                            <td>200-1000px (resizable)</td>
                            <td>‚ñ≤ (collapse)</td>
                        </tr>
                        <tr>
                            <td><strong>Collapsed</strong></td>
                            <td>Header bar only</td>
                            <td>40px fixed</td>
                            <td>‚ñº (expand)</td>
                        </tr>
                        <tr>
                            <td><strong>Minimized</strong></td>
                            <td>Hidden (display: none)</td>
                            <td>0px</td>
                            <td>Show in taskbar</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Header Controls Layout</h4>
                <pre><code>[Favicon] Card Title                [üíæ] [‚ñ≤] [‚àí] [√ó]
                                      Save  ^    Min Close
                                           Collapse</code></pre>

                <h4>Resize Handles</h4>
                <pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Header [‚ñ≤][‚àí][√ó]    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                     ‚îÇ ‚Üê Resize handle (right)
‚îÇ   Content Area      ‚îÇ
‚îÇ                     ‚îÇ ‚Üì Resize handle (bottom)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üò Corner resize handle (bottom-right)</code></pre>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üîß Technical Considerations</h2>

        <div class="two-column-layout">
            <div class="collapsible open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>Performance</strong></span>
                </div>
                <div class="collapsible-content">
                    <h4>Concerns</h4>
                    <ul class="dense-list indent-1">
                        <li>Multiple windows = multiple shadow DOMs</li>
                        <li>Resize events can be frequent</li>
                        <li>Z-index updates trigger re-renders</li>
                    </ul>

                    <h4>Optimizations</h4>
                    <ul class="dense-list indent-1">
                        <li><strong>Debounce:</strong> Debounce resize save (already done for drag)</li>
                        <li><strong>Virtualization:</strong> Unmount minimized windows (keep state)</li>
                        <li><strong>RAF:</strong> Use requestAnimationFrame for smooth animations</li>
                        <li><strong>Memoization:</strong> Memo window components with React.memo</li>
                    </ul>
                </div>
            </div>

            <div class="collapsible open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><span class="arrow">‚ñ∏</span><strong>Storage Limits</strong></span>
                </div>
                <div class="collapsible-content">
                    <h4>chrome.storage.local Limits</h4>
                    <ul class="dense-list indent-1">
                        <li><strong>Total:</strong> ~5MB after JSON serialization</li>
                        <li><strong>Per Key:</strong> 8KB recommended</li>
                    </ul>

                    <h4>Mitigation</h4>
                    <ul class="dense-list indent-1">
                        <li>Don't save content (already in cards)</li>
                        <li>Only save position, size, collapsed, minimized</li>
                        <li>Use SerializedWindowState (minimal fields)</li>
                        <li>Limit max open windows (e.g., 10 simultaneous)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üß™ Testing Strategy</h2>

        <div class="collapsible open">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∏</span><strong>Manual Testing Checklist</strong></span>
            </div>
            <div class="collapsible-content">
                <h3>Window Operations</h3>
                <ul class="dense-list">
                    <li><strong>[ ]</strong> Drag window by header - position updates</li>
                    <li><strong>[ ]</strong> Resize from right edge - width changes</li>
                    <li><strong>[ ]</strong> Resize from bottom edge - height changes</li>
                    <li><strong>[ ]</strong> Resize from corner - both dimensions change</li>
                    <li><strong>[ ]</strong> Collapse window - shows header only</li>
                    <li><strong>[ ]</strong> Expand collapsed window - restores full size</li>
                    <li><strong>[ ]</strong> Minimize window - hides completely</li>
                    <li><strong>[ ]</strong> Restore minimized window - shows at last position/size</li>
                    <li><strong>[ ]</strong> Close window - removes from manager</li>
                </ul>

                <h3>Multiple Windows</h3>
                <ul class="dense-list">
                    <li><strong>[ ]</strong> Open 3+ element windows simultaneously</li>
                    <li><strong>[ ]</strong> Click window brings to front (z-index)</li>
                    <li><strong>[ ]</strong> Each window maintains independent state</li>
                    <li><strong>[ ]</strong> Close one window doesn't affect others</li>
                    <li><strong>[ ]</strong> Reopen element window restores last state</li>
                </ul>

                <h3>Persistence</h3>
                <ul class="dense-list">
                    <li><strong>[ ]</strong> Resize + refresh page - size persists</li>
                    <li><strong>[ ]</strong> Move + refresh page - position persists</li>
                    <li><strong>[ ]</strong> Collapse + refresh page - collapsed state persists</li>
                    <li><strong>[ ]</strong> Check chrome.storage.local data structure</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üì¶ Dependencies</h2>

        <div class="card">
            <h3>New Packages Required</h3>
            <pre><code>npm install react-rnd</code></pre>

            <h4>Package Info</h4>
            <ul class="dense-list">
                <li><strong>Name:</strong> react-rnd</li>
                <li><strong>Purpose:</strong> Draggable + Resizable component</li>
                <li><strong>Size:</strong> ~50KB minified</li>
                <li><strong>Docs:</strong> https://github.com/bokuweb/react-rnd</li>
            </ul>
        </div>

        <div class="divider"></div>

        <h2>üöÄ Quick Start Implementation</h2>

        <div class="important-always-visible">
            <h3>Start Here: Minimal Working Example</h3>
            <p>To quickly test resize functionality, update FloatingWindow.tsx:</p>

            <pre><code>// 1. Install package
npm install react-rnd

// 2. Replace import
import { Rnd } from 'react-rnd';

// 3. Replace Draggable with Rnd
&lt;Rnd
  position={{ x: windowState.position.x, y: windowState.position.y }}
  size={{ width: windowState.size.width, height: windowState.size.height }}
  onDragStop={(e, d) => {
    windowManager.updatePosition(card.id, d.x, d.y);
  }}
  onResizeStop={(e, dir, ref, delta, position) => {
    const newWidth = parseInt(ref.style.width);
    const newHeight = parseInt(ref.style.height);
    windowManager.updateSize(card.id, newWidth, newHeight);
    windowManager.updatePosition(card.id, position.x, position.y);
  }}
  minWidth={300}
  minHeight={200}
  bounds="parent"
  dragHandleClassName="window-header"
&gt;
  &lt;div css={windowStyles(...)}&gt;
    {/* Existing content */}
  &lt;/div&gt;
&lt;/Rnd&gt;

// 4. Update windowStyles to use props
const windowStyles = (minimized, zIndex, width, height) => css\`
  width: ${width}px;
  height: ${height}px;
  // ... rest of styles
\`;</code></pre>

            <p><strong>Result:</strong> Draggable + resizable windows with persisted size!</p>
        </div>
    </div>

    <script>
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('open');
        }

        function expandAll() {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.classList.add('open');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.classList.remove('open');
            });
        }

        // Open all critical sections by default
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.collapsible.critical').forEach(el => {
                el.classList.add('open');
            });
        });
    </script>
</body>
</html>