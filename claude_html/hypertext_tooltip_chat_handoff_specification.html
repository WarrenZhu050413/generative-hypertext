<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nabokov's Web — Hypertext Tooltip & Chat Handoff Specification</title>
<style>
:root {
  --chinese-red: #8B0000;
  --chinese-gold: #FFD700;
  --paper-beige: #F5F5DC;
  --light-cream: #FFFEF0;
  --ink-black: #1a1a1a;
  --level-1: #8B0000;
  --level-2: #CD5C5C;
  --level-3: #666;
  --level-4: #999;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
  color: var(--ink-black);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.2;
  padding: 0;
  margin: 0;
  width: 100vw;
  max-width: 100%;
}

.container { width: 100%; padding: 8px; }

h1 {
  font-size: 24px;
  font-weight: 900;
  margin: 4px 0 8px 0;
  padding: 8px 4px;
  background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

h2 {
  font-size: 18px;
  font-weight: 700;
  margin: 12px 0 4px 0;
  padding: 6px 8px;
  border-left: 4px solid var(--chinese-red);
  background: rgba(139, 0, 0, 0.03);
  color: var(--level-1);
}

h3 {
  font-size: 14px;
  font-weight: 600;
  margin: 8px 0 4px 8px;
  color: var(--level-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

h4 {
  font-size: 12px;
  font-weight: 600;
  margin: 4px 0 2px 16px;
  color: var(--level-3);
}

.two-column {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin: 4px 0;
}

.card {
  background: white;
  border: 1px solid rgba(139, 0, 0, 0.2);
  border-radius: 3px;
  padding: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card.priority {
  border: 2px solid var(--chinese-gold);
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
}

.dense-list {
  list-style: none;
  padding: 0;
  margin-left: 8px;
}

.dense-list li {
  padding: 3px 0 3px 14px;
  position: relative;
  line-height: 1.3;
}

.dense-list li:before {
  content: "▸";
  position: absolute;
  left: 0;
  color: var(--chinese-red);
  font-size: 10px;
}

.dense-list li strong {
  color: var(--level-2);
  font-weight: 600;
}

code {
  background: rgba(245, 245, 220, 0.4);
  border: 1px solid rgba(139, 0, 0, 0.15);
  padding: 2px 5px;
  font-size: 12px;
  border-radius: 2px;
  font-family: 'SF Mono', Monaco, 'Courier New', monospace;
}

pre {
  background: rgba(245, 245, 220, 0.3);
  border: 1px solid rgba(139, 0, 0, 0.2);
  padding: 8px;
  margin: 4px 0;
  overflow-x: auto;
  border-radius: 2px;
  font-size: 12px;
  line-height: 1.3;
}

.spec-table {
  width: 100%;
  border-collapse: collapse;
  margin: 6px 0;
  font-size: 12px;
}

.spec-table th, .spec-table td {
  border: 1px solid rgba(139, 0, 0, 0.2);
  padding: 4px 6px;
  text-align: left;
  line-height: 1.2;
}

.spec-table th {
  background: rgba(139, 0, 0, 0.1);
  font-weight: 600;
  color: var(--level-1);
}

.divider {
  height: 1px;
  background: linear-gradient(90deg, var(--chinese-red), transparent);
  margin: 12px 0;
}

.indent-1 { margin-left: 12px; }
.indent-2 { margin-left: 24px; }

.highlight {
  background: rgba(255, 215, 0, 0.15);
  border-left: 3px solid var(--chinese-gold);
  padding: 6px 8px;
  margin: 6px 0;
}

.collapsible {
  margin: 6px 0;
}

.collapsible-header {
  cursor: pointer;
  padding: 6px 8px;
  background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
  border-left: 3px solid var(--chinese-gold);
  display: flex;
  align-items: center;
  justify-content: space-between;
  user-select: none;
  transition: all 0.2s ease;
  font-weight: 600;
  font-size: 13px;
}

.collapsible-header:hover {
  background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
}

.collapsible-header .arrow {
  display: inline-block;
  transition: transform 0.3s ease;
  color: var(--chinese-red);
  font-size: 10px;
  margin-right: 6px;
}

.collapsible.open .arrow {
  transform: rotate(90deg);
}

.collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  padding: 0 8px;
  margin-left: 12px;
}

.collapsible.open .collapsible-content {
  max-height: 5000px;
  padding: 8px;
}

@media (max-width: 768px) {
  .two-column { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">

<h1>Hypertext Tooltip & Chat Handoff Specification</h1>

<div class="highlight">
<strong>Purpose:</strong> Define the inline tooltip UX for hypertext link previews and seamless handoff to dedicated chat interface in Nabokov's Web.
</div>

<h2>I. Tooltip Visual Specification</h2>

<div class="two-column">
<div class="card priority">
<h3>Dimensions & Layout</h3>
<ul class="dense-list">
<li><strong>Width:</strong> 300px fixed (desktop)</li>
<li><strong>Background:</strong> <code>#F5F5DC</code> (warm paper beige)</li>
<li><strong>Border:</strong> 1px solid <code>#8B0000</code> (deep red)</li>
<li><strong>Shadow:</strong> <code>0 4px 16px rgba(139,0,0,0.2)</code></li>
<li><strong>Corner radius:</strong> 4px</li>
<li><strong>Z-index:</strong> 9999</li>
</ul>
</div>

<div class="card">
<h3>Color Palette</h3>
<ul class="dense-list">
<li><strong>Primary accent:</strong> <code>#8B0000</code> (Chinese red)</li>
<li><strong>Hover accent:</strong> <code>#FFD700</code> (subtle gold)</li>
<li><strong>Text:</strong> <code>#1a1a1a</code> (ink black)</li>
<li><strong>Muted text:</strong> <code>#666</code></li>
<li><strong>Link text:</strong> <code>#CD5C5C</code> (lighter red)</li>
</ul>
</div>
</div>

<h3>Component Breakdown</h3>

<table class="spec-table">
<tr>
<th>Component</th>
<th>Specification</th>
</tr>
<tr>
<td><strong>Header Bar</strong></td>
<td>
• Title: truncate at 28ch, font-size 13px, weight 600<br>
• Single text-size toggle button (right-aligned)<br>
• Padding: 8px 10px; border-bottom: 1px solid rgba(139,0,0,0.15)
</td>
</tr>
<tr>
<td><strong>Message Preview</strong></td>
<td>
• Display: latest assistant message only<br>
• Normal: 13px / 1.4 line-height; Large: 15px / 1.5<br>
• Max-height: 180px; overflow-y: auto<br>
• Padding: 10px; background: white
</td>
</tr>
<tr>
<td><strong>User Prompt Display</strong></td>
<td>
• Show: latest user prompt (read-only, muted)<br>
• Font-size: 11px; color: #666; font-style: italic<br>
• Padding: 6px 10px; border-top: 1px dashed #ccc
</td>
</tr>
<tr>
<td><strong>Composer Textarea</strong></td>
<td>
• Font-size: matches preview (13px normal / 15px large)<br>
• Line-height: matches preview (1.4 / 1.5)<br>
• Min-height: 40px; max-height: 80px; auto-resize<br>
• Border-top: 1px solid rgba(139,0,0,0.2)<br>
• Placeholder: "Ask follow-up… (Enter to send)"<br>
• Padding: 8px 10px
</td>
</tr>
<tr>
<td><strong>Interaction Zones</strong></td>
<td>
• Click header/preview body → navigate to chat page<br>
• Textarea focus → prevent navigation delegation<br>
• Hover → subtle gold border glow (<code>#FFD700</code>)
</td>
</tr>
</table>

<div class="collapsible open">
<div class="collapsible-header">
<span><span class="arrow">▶</span> Text-Size Toggle Behavior</span>
</div>
<div class="collapsible-content">
<ul class="dense-list">
<li><strong>States:</strong> "Normal" (default) ↔ "Large"</li>
<li><strong>Scope:</strong> Controls both message preview text AND composer textarea simultaneously</li>
<li><strong>Persistence:</strong> Saved in <code>sessionStorage['nabokov.tooltipTextSize']</code></li>
<li><strong>Visual indicator:</strong> Icon toggle (e.g., "A" → "A⁺") with aria-pressed state</li>
<li><strong>Transition:</strong> Smooth font-size change over 0.15s ease</li>
</ul>
</div>
</div>

<div class="divider"></div>

<h2>II. Handoff Flow Specification</h2>

<div class="card priority">
<h3>Trigger Events</h3>
<ul class="dense-list">
<li><strong>Click tooltip body</strong> (header or message preview) → open dedicated chat</li>
<li><strong>Submit composer</strong> → send message + immediate navigation</li>
<li><strong>Modifier key:</strong> Shift-click → same-tab navigation; default → new tab</li>
</ul>
</div>

<h3>Payload Construction</h3>

<div class="collapsible open">
<div class="collapsible-header">
<span><span class="arrow">▶</span> sessionStorage Schema</span>
</div>
<div class="collapsible-content">
<pre>sessionStorage.setItem('nabokov.chatHandoff', JSON.stringify({
  subject: string,              // Link title / hypertext subject
  summary: string,              // Brief context (max 200 chars)
  latestMessages: [
    { role: 'user', content: string, timestamp: ISO8601 },
    { role: 'assistant', content: string, timestamp: ISO8601 }
  ],
  textSizePreference: 'normal' | 'large',
  viewportPosition: { x: number, y: number },  // Scroll position
  sourceURL: string,            // Page URL where tooltip appeared
  timestamp: ISO8601,           // Handoff time
  tooltipOpenDuration: number   // Milliseconds tooltip was visible
}))</pre>
</div>
</div>

<h3>Navigation Logic</h3>

<div class="two-column">
<div class="card">
<h4>New Tab (Default)</h4>
<pre>window.open(
  '/chat.html',
  '_blank'
)</pre>
</div>

<div class="card">
<h4>Same Tab (Shift-Click)</h4>
<pre>if (event.shiftKey) {
  window.location.href = '/chat.html';
}</pre>
</div>
</div>

<div class="collapsible">
<div class="collapsible-header">
<span><span class="arrow">▶</span> Chat Page Hydration</span>
</div>
<div class="collapsible-content">
<ul class="dense-list">
<li><strong>On load:</strong> Check <code>sessionStorage['nabokov.chatHandoff']</code></li>
<li><strong>If found:</strong> Parse payload → populate chat history → apply text-size preference → clear storage</li>
<li><strong>If missing:</strong> Start fresh conversation</li>
<li><strong>Focus behavior:</strong> Auto-focus composer textarea after hydration</li>
<li><strong>Breadcrumb:</strong> Display source URL as "From: [page title]" link in header</li>
</ul>
</div>
</div>

<div class="divider"></div>

<h2>III. Accessibility Checklist</h2>

<table class="spec-table">
<tr>
<th>Requirement</th>
<th>Implementation</th>
</tr>
<tr>
<td><strong>ARIA Role</strong></td>
<td><code>role="dialog"</code> on tooltip container</td>
</tr>
<tr>
<td><strong>Modal State</strong></td>
<td><code>aria-modal="true"</code> (traps focus, dims background)</td>
</tr>
<tr>
<td><strong>Live Region</strong></td>
<td><code>aria-live="polite"</code> on assistant message preview for screen readers</td>
</tr>
<tr>
<td><strong>Toggle Button</strong></td>
<td><code>aria-pressed="false|true"</code><br><code>aria-label="Toggle text size: Normal/Large"</code></td>
</tr>
<tr>
<td><strong>Keyboard Nav</strong></td>
<td>
• Esc → close tooltip + return focus to highlighted link<br>
• Tab → cycle through: textarea → toggle → close button<br>
• Shift+Tab → reverse
</td>
</tr>
<tr>
<td><strong>Focus Trap</strong></td>
<td>Prevent Tab from escaping tooltip while visible; restore focus on close</td>
</tr>
<tr>
<td><strong>Color Contrast</strong></td>
<td>Text on <code>#F5F5DC</code>: minimum 4.5:1 ratio (WCAG AA)</td>
</tr>
<tr>
<td><strong>Touch Targets</strong></td>
<td>All interactive elements ≥ 44×44px (mobile)</td>
</tr>
</table>

<div class="highlight">
<strong>Focus Restoration:</strong> Store <code>document.activeElement</code> on tooltip open; call <code>.focus()</code> on close to return user to hypertext link.
</div>

<div class="divider"></div>

<h2>IV. Responsive & Validation Notes</h2>

<h3>Responsive Breakpoints</h3>

<table class="spec-table">
<tr>
<th>Viewport</th>
<th>Behavior</th>
</tr>
<tr>
<td><strong>Desktop (>768px)</strong></td>
<td>
• Width: 300px fixed<br>
• Anchor: adjacent to hypertext link (smart positioning: flip if near edge)<br>
• Preview: full 180px max-height
</td>
</tr>
<tr>
<td><strong>Tablet/Mobile (≤768px)</strong></td>
<td>
• Width: 90vw (max 320px)<br>
• Anchor: bottom-right of viewport (fixed position)<br>
• Preview: still single message, but reduces max-height to 120px<br>
• Text-toggle persists
</td>
</tr>
<tr>
<td><strong>High Zoom (>150%)</strong></td>
<td>
• Clamp width: min 260px, max 320px<br>
• Composer max-height: 60px (ensure scrollability)<br>
• Preview max-height: 100px
</td>
</tr>
</table>

<h3>Validation Metrics</h3>

<div class="two-column">
<div class="card">
<h4>Quantitative</h4>
<ul class="dense-list">
<li><strong>Tooltip open duration:</strong> Track median/95th percentile</li>
<li><strong>Handoff rate:</strong> % of tooltip opens → chat navigation</li>
<li><strong>Composer usage:</strong> % of tooltips with message sent</li>
<li><strong>Text-size toggle:</strong> Frequency of state changes</li>
<li><strong>Same-tab vs new-tab:</strong> Ratio tracking</li>
</ul>
</div>

<div class="card">
<h4>Qualitative</h4>
<ul class="dense-list">
<li><strong>Readability test:</strong> User feedback on font sizes (especially "large" mode)</li>
<li><strong>Navigation intuitiveness:</strong> Do users understand click-to-chat?</li>
<li><strong>Composer discoverability:</strong> Do users notice inline reply option?</li>
<li><strong>Accessibility audit:</strong> Screen reader testing (NVDA/JAWS)</li>
</ul>
</div>
</div>

<div class="collapsible">
<div class="collapsible-header">
<span><span class="arrow">▶</span> Implementation Telemetry</span>
</div>
<div class="collapsible-content">
<pre>// Example tracking code
window.nabokovAnalytics.track('tooltip.opened', {
  subject: string,
  textSize: 'normal' | 'large',
  viewportWidth: number
});

window.nabokovAnalytics.track('tooltip.handoff', {
  method: 'click' | 'compose',
  targetWindow: 'new' | 'same',
  openDuration: milliseconds,
  messagesExchanged: number
});</pre>
</div>
</div>

<div class="divider"></div>

<h2>V. Edge Cases & Constraints</h2>

<ul class="dense-list indent-1">
<li><strong>No assistant message yet:</strong> Show "Loading…" skeleton in preview area</li>
<li><strong>Very long messages:</strong> Preview truncates at max-height; full content available in chat page</li>
<li><strong>Rapid link hovering:</strong> Debounce tooltip open by 200ms to prevent flicker</li>
<li><strong>sessionStorage quota:</strong> Payload limited to 4KB; truncate message content if needed</li>
<li><strong>Browser back button:</strong> If user navigates back from chat, do NOT restore tooltip (clear state)</li>
<li><strong>Multiple tooltips:</strong> Only one visible at a time; opening new tooltip closes previous</li>
</ul>

<div class="highlight">
<strong>Enter Key Behavior:</strong> Enter → send message + navigate; Shift+Enter → newline in composer (standard chat UX).
</div>

</div>

<script>
// Collapsible sections
document.querySelectorAll('.collapsible-header').forEach(header => {
  header.addEventListener('click', () => {
    const collapsible = header.parentElement;
    collapsible.classList.toggle('open');
  });
});
</script>
</body>
</html>