<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hypertext Extension: Simplified URL Architecture</title>
<style>
:root {
    --chinese-red: #8B0000;
    --chinese-gold: #FFD700;
    --jade-green: #00A86B;
    --ink-black: #2B2B2B;
    --paper-beige: #F5F5DC;
    --light-cream: #FAFAF0;
    --level-1: #000;
    --level-2: #333;
    --level-3: #666;
    --level-4: #999;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
    color: var(--ink-black);
    width: 100vw;
    max-width: 100%;
    line-height: 1.3;
    font-size: 14px;
    font-family: "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
}

.container { width: 100%; padding: 8px; margin: 0; }

h1 {
    font-size: 26px; font-weight: 900; margin: 6px 0; padding: 8px;
    background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
}

h2 {
    font-size: 18px; font-weight: 700; margin: 10px 0 5px 0; padding: 5px;
    border-left: 4px solid var(--chinese-red);
    background: rgba(139, 0, 0, 0.03); color: var(--level-1);
}

h3 {
    font-size: 15px; font-weight: 600; margin: 6px 0 3px 8px;
    color: var(--level-2); text-transform: uppercase; letter-spacing: 0.5px;
}

h4 { font-size: 13px; font-weight: 500; margin: 3px 0 2px 16px; color: var(--level-3); }

.critical-box {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(255, 215, 0, 0.08));
    border: 3px solid var(--chinese-red);
    padding: 12px; margin: 10px 0; border-radius: 4px;
}

.critical-box h2 { color: var(--chinese-red); margin-top: 0; }

.highlight-box {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
    border: 2px solid var(--chinese-gold);
    padding: 10px; margin: 8px 0; border-radius: 3px;
}

.card {
    background: white;
    border: 1px solid rgba(139, 0, 0, 0.2);
    border-radius: 2px; padding: 8px; margin: 6px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card.priority {
    border: 2px solid var(--chinese-gold);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
}

pre, code {
    background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
    border: 1px solid rgba(139, 0, 0, 0.15);
    padding: 4px 6px; font-size: 12px; font-family: 'SF Mono', Monaco, monospace;
    line-height: 1.4; overflow-x: auto; border-radius: 2px;
}

pre { padding: 10px; margin: 6px 0; }
code { padding: 2px 5px; }

.dense-list { list-style: none; padding: 0; margin-left: 10px; }
.dense-list li {
    padding: 3px 0 3px 14px; border-left: 2px solid transparent; position: relative;
}
.dense-list li:before {
    content: "‚ñ∏"; position: absolute; left: 0;
    color: var(--chinese-red); font-size: 11px;
}

ol.dense-list li { list-style: decimal; margin-left: 20px; }
ol.dense-list li:before { content: none; }

.divider {
    height: 1px;
    background: linear-gradient(90deg, var(--chinese-red), transparent);
    margin: 12px 0;
}

.mermaid-container {
    background: white;
    border: 2px solid var(--chinese-gold);
    border-radius: 4px;
    padding: 16px;
    margin: 10px 0;
}

.status-good { color: var(--jade-green); font-weight: 600; }
.status-bad { color: var(--chinese-red); font-weight: 600; }
.status-warn { color: #ff8c00; font-weight: 600; }

table {
    border-collapse: collapse; width: 100%; margin: 6px 0;
    background: white; font-size: 12px;
}

th, td {
    border: 1px solid rgba(139, 0, 0, 0.2);
    padding: 5px 8px; text-align: left;
}

th {
    background: rgba(139, 0, 0, 0.08);
    font-weight: 600; color: var(--level-1);
}

.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 8px 0;
}

.em {
    background: rgba(255, 215, 0, 0.2);
    padding: 1px 4px;
    border-radius: 2px;
    font-weight: 600;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
<div class="container">

<h1>üéØ Hypertext Extension: Simplified URL Architecture</h1>

<div class="critical-box">
    <h2>Core Design Principle: Simplicity</h2>
    <p><strong>Clean URL structure</strong> makes the extension more maintainable and professional:</p>
    <ul class="dense-list">
        <li>Instead of <code class="status-bad">chrome-extension://abc/demo/simple_chat_page.html</code></li>
        <li>Use <code class="status-good">chrome-extension://abc/extension/chat.html</code></li>
        <li>Single source of truth: All extension resources under <code>extension/</code></li>
        <li>Clear separation: <code>demo/</code> for standalone testing, <code>extension/</code> for production</li>
    </ul>
</div>

<div class="divider"></div>

<h2>Architecture Overview</h2>

<div class="mermaid-container">
    <div class="mermaid">
flowchart TB
    subgraph "Host Page (any website)"
        User[üë§ User]
        Content[Content Script<br/>hypertext-experience.js]
    end

    subgraph "Extension Background"
        BG[Background Script<br/>background.js]
        Storage[chrome.storage.session]
    end

    subgraph "Extension UI"
        Chat[Chat Page<br/>extension/chat.html]
    end

    User -->|1. Click hypertext link| Content
    Content -->|2. sendMessage<br/>+ payload| BG
    BG -->|3. Store with key| Storage
    BG -->|4. Open tab with<br/>chrome://[id]/extension/chat.html?s=key| Chat
    Chat -->|5. Read payload| Storage
    Storage -->|6. Return data| Chat
    Chat -->|7. Delete key| Storage

    style Chat fill:#cfc,stroke:#0c0,stroke-width:3px
    style BG fill:#ffc,stroke:#fa0,stroke-width:2px
    style Storage fill:#cef,stroke:#06c,stroke-width:2px
    </div>
</div>

<div class="divider"></div>

<h2>Why This Approach Wins</h2>

<div class="two-column">
    <div class="card priority">
        <h3>‚úÖ Solves Both Problems</h3>
        <ul class="dense-list">
            <li><strong>URL Resolution:</strong> Background uses <code>chrome.runtime.getURL()</code></li>
            <li><strong>Payload Transport:</strong> Cross-context <code>chrome.storage.session</code></li>
            <li><strong>No sessionStorage issues:</strong> Different origins handled properly</li>
            <li><strong>Shift-key support:</strong> Update tab vs. new tab</li>
        </ul>
    </div>

    <div class="card priority">
        <h3>üîí Enhanced Security</h3>
        <ul class="dense-list">
            <li><strong>No web_accessible_resources:</strong> Chat page not exposed to web</li>
            <li><strong>Isolated storage:</strong> Only extension can access payloads</li>
            <li><strong>Auto-cleanup:</strong> Keys deleted after single use</li>
            <li><strong>Time-limited:</strong> Session storage clears on browser restart</li>
        </ul>
    </div>
</div>

<div class="divider"></div>

<h2>Project Structure Changes</h2>

<div class="card">
    <h3>New File Organization</h3>
    <pre>NabokovsWeb-hypertext-module/
‚îú‚îÄ‚îÄ extension/
‚îÇ   ‚îú‚îÄ‚îÄ <span class="em">chat.html</span>              ‚Üê NEW: Simplified chat page (replaces demo/simple_chat_page.html)
‚îÇ   ‚îú‚îÄ‚îÄ <span class="em">chat.js</span>                ‚Üê NEW: Chat page logic (extracted from inline script)
‚îÇ   ‚îú‚îÄ‚îÄ background.js           ‚Üê UPDATE: Add OPEN_CHAT_PAGE handler
‚îÇ   ‚îî‚îÄ‚îÄ hypertext-loader.js     ‚Üê UPDATE: Pass openChatPage function
‚îÇ
‚îú‚îÄ‚îÄ hypertext/
‚îÇ   ‚îî‚îÄ‚îÄ hypertext-experience.js ‚Üê UPDATE: Add openChatPage option
‚îÇ
‚îú‚îÄ‚îÄ demo/                        ‚Üê KEEP: For standalone testing only
‚îÇ   ‚îú‚îÄ‚îÄ hypertext_navigation_demo.html
‚îÇ   ‚îî‚îÄ‚îÄ simple_chat_page.html   ‚Üê KEEP: Standalone demo fallback
‚îÇ
‚îî‚îÄ‚îÄ manifest.json                ‚Üê UPDATE: Add "tabs" permission</pre>
</div>

<div class="divider"></div>

<h2>Implementation Steps</h2>

<div class="card priority">
    <h3>Step 1: Update manifest.json</h3>
    <pre>{
  "manifest_version": 3,
  "name": "Hypertext Navigator",
  "description": "Inline hypertext annotations with floating chat tooltips.",
  "version": "0.2.0",

  "permissions": [
    "storage",
    <span class="em">"tabs"</span>          <span class="status-good">// ADD: Required for chrome.tabs.create()</span>
  ],

  "host_permissions": [
    "&lt;all_urls&gt;"
  ],

  "background": {
    "service_worker": "extension/background.js",
    "type": "module"
  },

  "content_scripts": [
    {
      "matches": ["&lt;all_urls&gt;"],
      "js": [
        "hypertext/hypertext-experience.js",
        "extension/hypertext-loader.js"
      ],
      "run_at": "document_idle"
    }
  ]

  <span class="status-good">// NOTE: No web_accessible_resources needed!</span>
}</pre>
</div>

<div class="card priority">
    <h3>Step 2: Create extension/background.js</h3>
    <pre>/**
 * Background service worker for Hypertext Navigator
 * Handles chat page opening with secure payload transport
 */

chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'OPEN_CHAT_PAGE') {
    handleOpenChatPage(message, sender, sendResponse);
    return true; // Keep message channel open for async response
  }
});

async function handleOpenChatPage(message, sender, sendResponse) {
  const { payload, shiftKey } = message;

  try {
    // Generate unique session key
    const sessionKey = `hx:${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Store payload in chrome.storage.session
    await chrome.storage.session.set({ [sessionKey]: payload });

    // Build clean extension URL
    <span class="em">const chatUrl = chrome.runtime.getURL('extension/chat.html');</span>
    const fullUrl = `${chatUrl}?s=${encodeURIComponent(sessionKey)}`;

    // Handle shift-key behavior
    if (shiftKey && sender.tab) {
      // Replace current tab
      await chrome.tabs.update(sender.tab.id, { url: fullUrl });
    } else {
      // Open new tab
      await chrome.tabs.create({ url: fullUrl, active: true });
    }

    sendResponse({ success: true, sessionKey });

  } catch (error) {
    console.error('[Hypertext] Failed to open chat page:', error);
    sendResponse({
      success: false,
      error: error.message || 'Unknown error'
    });
  }
}</pre>
</div>

<div class="card priority">
    <h3>Step 3: Create extension/chat.html</h3>
    <pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;Hypertext Chat&lt;/title&gt;
  &lt;style&gt;
    /* Compact, readable chat UI */
    :root {
      --bg: #fafafa;
      --text: #1a1a1a;
      --border: #e0e0e0;
      --user-bg: #e3f2fd;
      --assistant-bg: #f5f5f5;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 20px;
    }

    header {
      max-width: 800px;
      margin: 0 auto 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
    }

    h1 { font-size: 20px; margin-bottom: 4px; }
    .meta { font-size: 13px; color: #666; }

    main {
      max-width: 800px;
      margin: 0 auto;
    }

    .message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 6px;
    }

    .message.user { background: var(--user-bg); }
    .message.assistant { background: var(--assistant-bg); }

    .role {
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 600;
      color: #888;
      margin-bottom: 4px;
    }

    .content { font-size: 14px; white-space: pre-wrap; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;header&gt;
    &lt;h1 id="subject"&gt;Loading...&lt;/h1&gt;
    &lt;div class="meta"&gt;
      &lt;div id="summary"&gt;&lt;/div&gt;
      &lt;div id="focus"&gt;&lt;/div&gt;
      &lt;div id="source"&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/header&gt;

  &lt;main id="conversation"&gt;&lt;/main&gt;

  &lt;script src="chat.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>

<div class="card priority">
    <h3>Step 4: Create extension/chat.js</h3>
    <pre>/**
 * Chat page logic - loads payload and renders conversation
 */

(async function initChatPage() {
  const payload = await loadPayload();
  renderChat(payload);
})();

async function loadPayload() {
  // Get session key from URL parameter
  const params = new URLSearchParams(window.location.search);
  const sessionKey = params.get('s');

  if (!sessionKey) {
    console.warn('[Chat] No session key in URL');
    return getFallbackPayload();
  }

  // Try to load from chrome.storage.session
  if (typeof chrome !== 'undefined' && chrome.storage?.session) {
    try {
      const result = await chrome.storage.session.get(sessionKey);

      if (result[sessionKey]) {
        const payload = result[sessionKey];

        // Clean up - delete key after reading (one-time use)
        chrome.storage.session.remove(sessionKey).catch(err => {
          console.warn('[Chat] Failed to cleanup session key:', err);
        });

        return payload;
      } else {
        console.warn('[Chat] Session key not found:', sessionKey);
      }
    } catch (error) {
      console.error('[Chat] Failed to load from chrome.storage.session:', error);
    }
  }

  return getFallbackPayload();
}

function renderChat(payload) {
  // Populate header
  document.getElementById('subject').textContent = payload.subject || 'Untitled';
  document.getElementById('summary').textContent = payload.summary || '';
  document.getElementById('focus').textContent = payload.focus ? `Focus: ${payload.focus}` : '';
  document.getElementById('source').textContent = payload.sourceUrl ? `From: ${payload.sourceUrl}` : '';

  // Render conversation
  const container = document.getElementById('conversation');
  container.innerHTML = '';

  if (payload.transcript && payload.transcript.length > 0) {
    payload.transcript.forEach(msg => {
      const div = document.createElement('div');
      div.className = `message ${msg.role}`;

      const roleLabel = document.createElement('div');
      roleLabel.className = 'role';
      roleLabel.textContent = msg.role;

      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = msg.content || '';

      div.appendChild(roleLabel);
      div.appendChild(content);
      container.appendChild(div);
    });
  } else {
    container.innerHTML = '&lt;p style="color: #999; font-style: italic;"&gt;No conversation history.&lt;/p&gt;';
  }

  // Apply text size preference
  if (payload.textSize) {
    document.body.style.fontSize = payload.textSize === 'large' ? '16px' : '14px';
  }
}

function getFallbackPayload() {
  return {
    subject: 'Example Hypertext Conversation',
    summary: 'This is a fallback payload for demonstration.',
    focus: 'Testing chat page rendering',
    transcript: [
      { role: 'assistant', content: 'This is an example assistant message.' },
      { role: 'user', content: 'This is an example user message.' }
    ],
    sourceUrl: window.location.href,
    timestamp: new Date().toISOString(),
    textSize: 'normal'
  };
}</pre>
</div>

<div class="card priority">
    <h3>Step 5: Update extension/hypertext-loader.js</h3>
    <pre>// extension/hypertext-loader.js

window.createHypertextExperience({
  backendUrl: 'http://localhost:3100',
  <span class="em">chatPageUrl: 'extension/chat.html',</span>  // Will be resolved by background script

  // Custom chat page opener using background script
  openChatPage: (payload, options) => {
    const { shiftKey } = options || {};

    return new Promise((resolve, reject) => {
      chrome.runtime.sendMessage(
        {
          type: 'OPEN_CHAT_PAGE',
          payload,
          shiftKey: Boolean(shiftKey)
        },
        (response) => {
          if (chrome.runtime.lastError) {
            reject(new Error(chrome.runtime.lastError.message));
            return;
          }

          if (response?.success) {
            resolve(response);
          } else {
            reject(new Error(response?.error || 'Failed to open chat page'));
          }
        }
      );
    });
  }
});</pre>
</div>

<div class="card priority">
    <h3>Step 6: Update hypertext/hypertext-experience.js</h3>

    <h4>A. Add openChatPage to options (line ~798)</h4>
    <pre>function createHypertextExperience(options = {}) {
  const {
    document: customDocument,
    backendUrl = 'http://localhost:3100',
    contextProvider,
    hotkey = defaultHotkey,
    selectionValidator,
    autoOpenTooltipOnHover = true,
    registerExternalTrigger,
    chatPageUrl = 'demo/simple_chat_page.html',
    <span class="em">openChatPage,  // NEW: Custom function to open chat (for extension)</span>
  } = options;

  // ... rest of function
}</pre>

    <h4>B. Update openChatPageFromSession (line ~1453)</h4>
    <pre>function openChatPageFromSession(session, event) {
  const payload = buildChatPayload(session);
  if (!payload) return;

  closeChat({ force: true });

  <span class="em">// NEW: Use custom opener if provided (Chrome extension path)</span>
  if (typeof openChatPage === 'function') {
    try {
      openChatPage(payload, {
        shiftKey: event?.shiftKey,
        session,
        event
      });
      return;
    } catch (error) {
      console.warn('[Hypertext] Custom openChatPage failed:', error);
      // Fall through to default behavior
    }
  }

  <span class="status-good">// Fallback: Standalone demo behavior (sessionStorage)</span>
  try {
    win.sessionStorage?.setItem('hypertext:handoff', JSON.stringify(payload));
  } catch (error) {
    console.warn('[Hypertext] Failed to persist chat payload:', error);
  }

  const target = event?.shiftKey ? '_self' : '_blank';
  let resolvedUrl = chatPageUrl;

  try {
    resolvedUrl = new URL(chatPageUrl, win.location.href).toString();
  } catch (error) {
    /* ignore resolution errors */
  }

  try {
    win.open(resolvedUrl, target, 'noopener,noreferrer');
  } catch (error) {
    console.warn('[Hypertext] Failed to open chat page:', error);
  }
}</pre>
</div>

<div class="divider"></div>

<h2>Security Benefits</h2>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>Security Aspect</th>
                <th>Old Approach (sessionStorage)</th>
                <th>New Approach (chrome.storage.session)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Cross-origin access</strong></td>
                <td><span class="status-bad">‚ùå Blocked - different origins can't share</span></td>
                <td><span class="status-good">‚úÖ Works - extension-wide storage</span></td>
            </tr>
            <tr>
                <td><strong>Chat page exposure</strong></td>
                <td><span class="status-warn">‚ö†Ô∏è Requires web_accessible_resources</span></td>
                <td><span class="status-good">‚úÖ Private - extension-only access</span></td>
            </tr>
            <tr>
                <td><strong>Data persistence</strong></td>
                <td><span class="status-warn">‚ö†Ô∏è Manual cleanup needed</span></td>
                <td><span class="status-good">‚úÖ Auto-cleanup + session scope</span></td>
            </tr>
            <tr>
                <td><strong>Key uniqueness</strong></td>
                <td><span class="status-warn">‚ö†Ô∏è Single key 'hypertext:handoff'</span></td>
                <td><span class="status-good">‚úÖ Unique key per conversation</span></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="divider"></div>

<h2>Testing Strategy</h2>

<div class="two-column">
    <div class="card">
        <h3>Test 1: Basic Flow</h3>
        <ol class="dense-list">
            <li>Load extension in Chrome</li>
            <li>Navigate to any website</li>
            <li>Select text, press Cmd+Shift+K</li>
            <li>Wait for tooltip to appear</li>
            <li>Click hypertext link in tooltip</li>
            <li><strong>Verify:</strong> New tab opens with <code>extension/chat.html</code></li>
            <li><strong>Verify:</strong> Subject matches selected text</li>
            <li><strong>Verify:</strong> Conversation renders correctly</li>
        </ol>
    </div>

    <div class="card">
        <h3>Test 2: Shift-Click</h3>
        <ol class="dense-list">
            <li>Create hypertext tooltip</li>
            <li>Hold Shift key</li>
            <li>Click hypertext link</li>
            <li><strong>Verify:</strong> Current tab navigates (no new tab)</li>
            <li><strong>Verify:</strong> Chat page loads with correct data</li>
        </ol>
    </div>

    <div class="card">
        <h3>Test 3: Payload Cleanup</h3>
        <ol class="dense-list">
            <li>Open chat page from hypertext link</li>
            <li>Open DevTools ‚Üí Application ‚Üí Storage</li>
            <li>Expand "Session Storage"</li>
            <li><strong>Verify:</strong> No session key visible (auto-deleted)</li>
            <li>Open new hypertext conversation</li>
            <li><strong>Verify:</strong> Previous payload not reused</li>
        </ol>
    </div>

    <div class="card">
        <h3>Test 4: Standalone Demo</h3>
        <ol class="dense-list">
            <li>Open <code>demo/hypertext_navigation_demo.html</code> directly</li>
            <li>Generate hypertext link</li>
            <li>Click link</li>
            <li><strong>Verify:</strong> Opens <code>demo/simple_chat_page.html</code></li>
            <li><strong>Verify:</strong> Uses sessionStorage fallback</li>
            <li><strong>Verify:</strong> No console errors</li>
        </ol>
    </div>
</div>

<div class="divider"></div>

<h2>Implementation Checklist</h2>

<div class="card priority">
    <h3>‚úÖ Complete Task List</h3>
    <ul class="dense-list">
        <li>‚òê Update <code>manifest.json</code> - add "tabs" permission</li>
        <li>‚òê Create <code>extension/background.js</code> with OPEN_CHAT_PAGE handler</li>
        <li>‚òê Create <code>extension/chat.html</code> - simplified chat UI</li>
        <li>‚òê Create <code>extension/chat.js</code> - payload loading and rendering</li>
        <li>‚òê Update <code>extension/hypertext-loader.js</code> - add openChatPage function</li>
        <li>‚òê Update <code>hypertext/hypertext-experience.js</code>:
            <ul class="dense-list">
                <li>‚òê Add <code>openChatPage</code> parameter to options</li>
                <li>‚òê Update <code>openChatPageFromSession</code> to use custom opener</li>
                <li>‚òê Add <code>noopener,noreferrer</code> to fallback window.open</li>
            </ul>
        </li>
        <li>‚òê Test all 4 test cases above</li>
        <li>‚òê Update <code>tests/hypertext-demo.spec.mjs</code> for new flow</li>
        <li>‚òê Build extension: <code>npm run build</code></li>
        <li>‚òê Load unpacked extension in Chrome</li>
        <li>‚òê Final verification on multiple websites</li>
    </ul>
</div>

<div class="divider"></div>

<h2>Comparison: Before vs. After</h2>

<div class="mermaid-container">
    <div class="mermaid">
graph LR
    subgraph "Before (Broken)"
        A1[Content Script] -->|sessionStorage| B1[Host Storage]
        A1 -->|window.open<br/>demo/...| C1[‚ùå URL error]
        C1 -.->|even if fixed| D1[‚ùå Can't read<br/>sessionStorage]
        style C1 fill:#fcc
        style D1 fill:#fcc
    end

    subgraph "After (Working)"
        A2[Content Script] -->|sendMessage| B2[Background]
        B2 -->|chrome.storage.session| C2[Extension Storage]
        B2 -->|chrome.tabs.create<br/>extension/chat.html?s=key| D2[‚úÖ Chat Page]
        D2 -->|read + delete| C2
        style D2 fill:#cfc
        style C2 fill:#cef
    end
    </div>
</div>

<div class="highlight-box">
    <h3>üéØ Key Improvements</h3>
    <ul class="dense-list">
        <li><strong>Simpler URLs:</strong> <code>extension/chat.html</code> vs. <code>demo/simple_chat_page.html</code></li>
        <li><strong>Clean architecture:</strong> All extension files under <code>extension/</code></li>
        <li><strong>Actually works:</strong> Payload transport solved with chrome.storage.session</li>
        <li><strong>More secure:</strong> No web_accessible_resources, auto-cleanup, unique keys</li>
        <li><strong>Backwards compatible:</strong> Standalone demos still work with sessionStorage</li>
    </ul>
</div>

<div class="divider"></div>

<h2>Next Steps After Implementation</h2>

<div class="card">
    <h3>Immediate Follow-ups</h3>
    <ul class="dense-list">
        <li><strong>Polish chat UI:</strong> Add message input, streaming responses, etc.</li>
        <li><strong>Error handling:</strong> Show user-friendly errors if background fails</li>
        <li><strong>Loading states:</strong> Show spinner while opening chat page</li>
        <li><strong>Back navigation:</strong> Add button to return to source page</li>
    </ul>
</div>

<div class="card">
    <h3>Future Enhancements</h3>
    <ul class="dense-list">
        <li><strong>Multiple chat windows:</strong> Track multiple conversations simultaneously</li>
        <li><strong>Conversation history:</strong> Persist past chats in chrome.storage.local</li>
        <li><strong>Export/share:</strong> Allow users to export conversations</li>
        <li><strong>Keyboard shortcuts:</strong> Navigate chat with keyboard</li>
    </ul>
</div>

</div>

<script>
mermaid.initialize({
    startOnLoad: true,
    theme: 'neutral',
    flowchart: { curve: 'basis' }
});
</script>
</body>
</html>
