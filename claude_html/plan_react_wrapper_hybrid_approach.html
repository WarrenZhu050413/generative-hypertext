<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan: Optional React Wrapper (Hybrid Approach)</title>
<style>
:root {
    --chinese-red: #8B0000;
    --chinese-gold: #FFD700;
    --jade-green: #00A86B;
    --ink-black: #2B2B2B;
    --paper-beige: #F5F5DC;
    --light-cream: #FAFAF0;
    --level-1: #000;
    --level-2: #333;
    --level-3: #666;
    --level-4: #999;
}

body {
    background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
    color: var(--ink-black);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-size: 13px;
    line-height: 1.3;
    padding: 12px;
    max-width: 1200px;
    margin: 0 auto;
}

h1 {
    font-size: 24px;
    font-weight: 900;
    margin: 8px 0;
    padding: 8px;
    background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

h2 {
    font-size: 16px;
    font-weight: 700;
    margin: 10px 0 6px 0;
    padding: 6px;
    border-left: 4px solid var(--chinese-red);
    background: rgba(139, 0, 0, 0.03);
    color: var(--level-1);
}

h3 {
    font-size: 13px;
    font-weight: 600;
    margin: 6px 0 3px 0;
    color: var(--level-2);
}

h4 {
    font-size: 12px;
    font-weight: 500;
    margin: 4px 0 2px 8px;
    color: var(--level-3);
}

.important-always-visible {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
    border: 2px solid var(--chinese-gold);
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}

.two-column-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 10px 0;
}

.collapsible {
    margin: 6px 0;
    border: 1px solid rgba(139, 0, 0, 0.15);
    border-radius: 3px;
    overflow: hidden;
}

.collapsible-header {
    cursor: pointer;
    padding: 8px 10px;
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
    transition: all 0.2s ease;
    font-weight: 600;
    font-size: 13px;
}

.collapsible-header:hover {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
}

.collapsible-header .arrow {
    display: inline-block;
    transition: transform 0.3s ease;
    color: var(--chinese-red);
    font-size: 11px;
}

.collapsible.open .arrow {
    transform: rotate(90deg);
}

.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding: 0 10px;
}

.collapsible.open .collapsible-content {
    max-height: 10000px;
    padding: 10px;
}

.collapsible.critical .collapsible-header {
    border-left: 4px solid var(--chinese-red);
    background: rgba(139, 0, 0, 0.08);
    font-weight: 700;
}

.collapsible.secondary .collapsible-header {
    border-left: 2px solid #999;
    background: rgba(0, 0, 0, 0.02);
}

.collapsible.full-width {
    grid-column: span 2;
}

.metric {
    display: inline-block;
    background: white;
    border: 1px solid var(--chinese-gold);
    padding: 3px 8px;
    margin: 2px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
}

.metric.important {
    background: var(--jade-green);
    color: white;
    border-color: var(--jade-green);
}

code {
    background: rgba(139, 0, 0, 0.05);
    padding: 2px 5px;
    border-radius: 2px;
    font-family: Monaco, Menlo, monospace;
    font-size: 11px;
}

pre {
    background: rgba(139, 0, 0, 0.03);
    border: 1px solid rgba(139, 0, 0, 0.15);
    border-radius: 3px;
    padding: 8px;
    overflow-x: auto;
    font-size: 11px;
    line-height: 1.4;
}

ul, ol {
    margin: 6px 0 6px 20px;
    padding: 0;
}

li {
    margin: 3px 0;
    line-height: 1.4;
}

.dense-list {
    list-style: none;
    padding: 0;
    margin: 4px 0;
}

.dense-list li {
    padding: 4px 0;
    border-bottom: 1px dashed rgba(139, 0, 0, 0.1);
}

.dense-list li:last-child {
    border-bottom: none;
}

.indent-1 {
    margin-left: 16px;
}

.indent-2 {
    margin-left: 32px;
}

.muted {
    color: var(--level-3);
    font-size: 11px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 8px 0;
    font-size: 12px;
}

th {
    background: var(--chinese-red);
    color: white;
    padding: 6px 8px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
}

td {
    border: 1px solid #ddd;
    padding: 5px 8px;
    vertical-align: top;
}

tr:nth-child(even) {
    background: rgba(0,0,0,0.02);
}

.info-box {
    background: rgba(0, 168, 107, 0.05);
    border-left: 3px solid var(--jade-green);
    padding: 8px;
    margin: 8px 0;
}

.warning {
    background: rgba(255, 165, 0, 0.1);
    border-left: 3px solid orange;
    padding: 6px;
    margin: 6px 0;
}

button {
    background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
    color: white;
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 3px;
    padding: 4px 10px;
    margin: 4px 2px;
    cursor: pointer;
    font-size: 12px;
}

button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
}
</style>
</head>
<body>

<div style="margin: 8px 0; text-align: right;">
    <button id="expand-all">Expand All</button>
    <button id="collapse-all">Collapse All</button>
</div>

<div class="important-always-visible">
    <h1>üîó Optional React Wrapper (Hybrid Approach)</h1>
    <div class="two-column-layout">
        <div>
            <h3>Objective</h3>
            <p>Create an optional React wrapper that allows NabokovsWeb and other React apps to use the vanilla JS hypertext module with React-native patterns, while keeping the core module framework-agnostic.</p>
            <div class="metric">Vanilla Core: Unchanged</div>
            <div class="metric">New: React Hook + Component</div>
        </div>
        <div>
            <h3>Approach</h3>
            <p>Add TypeScript types ‚Üí Create useHypertextExperience hook ‚Üí Build HypertextProvider component ‚Üí Maintain full backward compatibility</p>
            <div class="metric important">Complexity: MEDIUM</div>
            <div class="metric">Duration: 2-3 days</div>
        </div>
    </div>
</div>

<div class="info-box">
    <strong>üéØ Key Principle:</strong> The vanilla JS module remains the source of truth. The React wrapper is a thin adapter layer that manages lifecycle, not a reimplementation of functionality.
</div>

<div class="two-column-layout">
    <!-- Phase 1: Type Definitions -->
    <div class="collapsible critical" data-collapsible="open">
        <div class="collapsible-header">
            <span>‚ö° Phase 1: TypeScript Declarations</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <ol class="dense-list">
                <li><strong>1.1 Create Type Definition File</strong>
                    <div class="indent-1 muted">New file: hypertext/hypertext-experience.d.ts</div>
                    <div class="indent-1">Define interfaces for vanilla JS API</div>
                    <div class="indent-1">Export all configuration types</div>
                    <div class="indent-1">Document with JSDoc comments</div>
                </li>
                <li><strong>1.2 Define Core Interfaces</strong>
                    <div class="indent-1">HypertextConfig (initialization options)</div>
                    <div class="indent-1">HypertextExperienceAPI (return value)</div>
                    <div class="indent-1">HypertextSession (session data)</div>
                    <div class="indent-1">HypertextResult (LLM response)</div>
                </li>
                <li><strong>1.3 Update package.json</strong>
                    <div class="indent-1 muted">File: package.json</div>
                    <div class="indent-1">Add "types" field pointing to .d.ts file</div>
                    <div class="indent-1">Add "exports" for ESM/CJS/types</div>
                </li>
            </ol>
        </div>
    </div>

    <!-- Phase 2: React Hook -->
    <div class="collapsible critical" data-collapsible="open">
        <div class="collapsible-header">
            <span>ü™ù Phase 2: useHypertextExperience Hook</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <ol class="dense-list">
                <li><strong>2.1 Create Hook File</strong>
                    <div class="indent-1 muted">New: ../NabokovsWeb/src/shared/hooks/useHypertextExperience.ts</div>
                    <div class="indent-1">Manages vanilla module lifecycle</div>
                    <div class="indent-1">Handles initialization & cleanup</div>
                    <div class="indent-1">Returns API object</div>
                </li>
                <li><strong>2.2 Implement Core Logic</strong>
                    <div class="indent-1">useRef to store experience instance</div>
                    <div class="indent-1">useEffect for init/destroy</div>
                    <div class="indent-1">Memoize config to prevent re-init</div>
                    <div class="indent-1">Return stable API reference</div>
                </li>
                <li><strong>2.3 Add Error Handling</strong>
                    <div class="indent-1">Catch initialization errors</div>
                    <div class="indent-1">Provide fallback state</div>
                    <div class="indent-1">Emit React-friendly error events</div>
                </li>
            </ol>
        </div>
    </div>

    <!-- Phase 3: React Component -->
    <div class="collapsible critical" data-collapsible="open">
        <div class="collapsible-header">
            <span>üß© Phase 3: HypertextProvider Component</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <ol class="dense-list">
                <li><strong>3.1 Create Component File</strong>
                    <div class="indent-1 muted">New: ../NabokovsWeb/src/components/HypertextProvider.tsx</div>
                    <div class="indent-1">Wrapper around useHypertextExperience</div>
                    <div class="indent-1">Accepts config via props</div>
                    <div class="indent-1">Renders children with context</div>
                </li>
                <li><strong>3.2 Create Context API</strong>
                    <div class="indent-1">HypertextContext for sharing API</div>
                    <div class="indent-1">useHypertext consumer hook</div>
                    <div class="indent-1">Type-safe context value</div>
                </li>
                <li><strong>3.3 Add Prop Validation</strong>
                    <div class="indent-1">TypeScript prop types</div>
                    <div class="indent-1">Required vs optional props</div>
                    <div class="indent-1">Default values</div>
                </li>
            </ol>
        </div>
    </div>

    <!-- Phase 4: Integration Example -->
    <div class="collapsible secondary" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üìñ Phase 4: Usage Examples</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <ol class="dense-list">
                <li><strong>4.1 Hook Usage Example</strong>
                    <div class="indent-1 muted">New: demo/react-hook-example.tsx</div>
                    <div class="indent-1">Show direct hook usage</div>
                    <div class="indent-1">Document cleanup patterns</div>
                </li>
                <li><strong>4.2 Component Usage Example</strong>
                    <div class="indent-1 muted">New: demo/react-component-example.tsx</div>
                    <div class="indent-1">Show HypertextProvider usage</div>
                    <div class="indent-1">Demonstrate context consumption</div>
                </li>
                <li><strong>4.3 Side-by-Side Comparison</strong>
                    <div class="indent-1 muted">New: demo/vanilla-vs-react.html</div>
                    <div class="indent-1">Same page, both approaches</div>
                    <div class="indent-1">Highlight usage differences</div>
                </li>
            </ol>
        </div>
    </div>

    <!-- Phase 5: Testing -->
    <div class="collapsible secondary" data-collapsible="closed">
        <div class="collapsible-header">
            <span>‚úì Phase 5: Testing Strategy</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h4>5.1 Hook Tests (Vitest + React Testing Library)</h4>
            <ul class="dense-list">
                <li><code>tests/unit/hooks/useHypertextExperience.test.ts</code></li>
                <li>Test initialization</li>
                <li>Test cleanup on unmount</li>
                <li>Test config changes trigger re-init</li>
                <li>Test error handling</li>
            </ul>

            <h4>5.2 Component Tests</h4>
            <ul class="dense-list">
                <li><code>tests/unit/components/HypertextProvider.test.tsx</code></li>
                <li>Test context provision</li>
                <li>Test children rendering</li>
                <li>Test prop updates</li>
            </ul>

            <h4>5.3 Integration Tests (Playwright)</h4>
            <ul class="dense-list">
                <li><code>tests/e2e/react-wrapper-integration.spec.ts</code></li>
                <li>Test React wrapper in real browser</li>
                <li>Verify functionality matches vanilla</li>
                <li>Test cleanup doesn't leave artifacts</li>
            </ul>
        </div>
    </div>

    <!-- Phase 6: Documentation -->
    <div class="collapsible secondary" data-collapsible="closed">
        <div class="collapsible-header">
            <span>üìö Phase 6: Documentation</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <ol class="dense-list">
                <li><strong>6.1 API Documentation</strong>
                    <div class="indent-1 muted">New: docs/REACT_WRAPPER.md</div>
                    <div class="indent-1">Hook API reference</div>
                    <div class="indent-1">Component props reference</div>
                    <div class="indent-1">Context API reference</div>
                </li>
                <li><strong>6.2 Migration Guide</strong>
                    <div class="indent-1 muted">Update: README.md</div>
                    <div class="indent-1">When to use vanilla vs React</div>
                    <div class="indent-1">Code examples for both</div>
                    <div class="indent-1">Performance implications</div>
                </li>
                <li><strong>6.3 JSDoc Comments</strong>
                    <div class="indent-1">Add to all exported functions</div>
                    <div class="indent-1">Document all props</div>
                    <div class="indent-1">Include usage examples</div>
                </li>
            </ol>
        </div>
    </div>
</div>

<div class="collapsible full-width critical" data-collapsible="open">
    <div class="collapsible-header">
        <span>üíª Detailed Implementation: Type Definitions</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <h3>hypertext/hypertext-experience.d.ts</h3>
        <pre><code>/**
 * Configuration options for creating a hypertext experience
 */
export interface HypertextConfig {
  /** Custom document to operate on (defaults to window.document) */
  document?: Document;

  /** Backend URL for LLM API (defaults to http://localhost:3100) */
  backendUrl?: string;

  /** Custom context provider function */
  contextProvider?: (
    session: HypertextSession,
    opts: { truncateContext: boolean }
  ) => string;

  /** Custom hotkey detector function */
  hotkey?: (event: KeyboardEvent) => boolean;

  /** Selection validation function */
  selectionValidator?: (range: Range, text: string) => boolean;

  /** Auto-open tooltip on hover (defaults to true) */
  autoOpenTooltipOnHover?: boolean;

  /** URL for full chat page (defaults to demo/simple_chat_page.html) */
  chatPageUrl?: string;

  /** Register external trigger function */
  registerExternalTrigger?: (trigger: () => void) => void;
}

/**
 * Hypertext session data structure
 */
export interface HypertextSession {
  id: string;
  subject: string;
  context: string;
  wrapper: HTMLElement | null;
  messages: HypertextMessage[];
  lastResult: HypertextResult | null;
  lastUserMessage: string | null;
  lastInstructions: string;
  isStreaming: boolean;
  draft: string;
  isPinned: boolean;
  tooltipPosition: { left: number; top: number } | null;
  tooltipSize: { width: number; height: number } | null;
  lastUpdatedAt: number;
}

/**
 * Message in a hypertext conversation
 */
export interface HypertextMessage {
  role: 'user' | 'assistant';
  content: string;
  display?: string | { explanation: string; url?: string };
  timestamp: number;
}

/**
 * Result from LLM hypertext generation
 */
export interface HypertextResult {
  pillText: string;
  mode: 'inline' | 'reference';
  explanation?: string;
  url?: string;
}

/**
 * API returned by createHypertextExperience
 */
export interface HypertextExperienceAPI {
  /** Apply hypertext to current selection */
  applyHypertext: (instructions?: string) => void;

  /** Destroy the experience and clean up */
  destroy: () => void;

  /** Get all active sessions */
  getSessions: () => Map<string, HypertextSession>;

  /** Get palette DOM element */
  getPaletteElement: () => HTMLElement;

  /** Get tooltip DOM element */
  getTooltipElement: () => HTMLElement;

  /** Trigger hypertext from external code */
  triggerFromExternal: () => boolean;
}

/**
 * Create a hypertext experience on a document
 *
 * @example
 * ```javascript
 * const experience = createHypertextExperience({
 *   backendUrl: 'http://localhost:3100',
 *   autoOpenTooltipOnHover: true
 * });
 *
 * // Later, clean up
 * experience.destroy();
 * ```
 */
export function createHypertextExperience(
  options?: HypertextConfig
): HypertextExperienceAPI;</code></pre>
    </div>
</div>

<div class="collapsible full-width critical" data-collapsible="open">
    <div class="collapsible-header">
        <span>üíª Detailed Implementation: useHypertextExperience Hook</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <h3>../NabokovsWeb/src/shared/hooks/useHypertextExperience.ts</h3>
        <pre><code>import { useEffect, useRef, useMemo } from 'react';
import type {
  HypertextConfig,
  HypertextExperienceAPI,
} from 'hypertext-experience';

/**
 * React hook to manage hypertext experience lifecycle
 *
 * @example
 * ```tsx
 * function MyComponent() {
 *   const hypertext = useHypertextExperience({
 *     backendUrl: 'http://localhost:3100',
 *     autoOpenTooltipOnHover: true,
 *   });
 *
 *   return (
 *     &lt;div&gt;
 *       {hypertext && (
 *         &lt;button onClick={() => hypertext.triggerFromExternal()}&gt;
 *           Trigger Hypertext
 *         &lt;/button&gt;
 *       )}
 *     &lt;/div&gt;
 *   );
 * }
 * ```
 */
export function useHypertextExperience(
  config: HypertextConfig = {}
): HypertextExperienceAPI | null {
  const experienceRef = useRef&lt;HypertextExperienceAPI | null&gt;(null);

  // Memoize config to prevent unnecessary re-initialization
  // Only re-initialize if config object identity changes
  const stableConfig = useMemo(() => config, [
    config.backendUrl,
    config.autoOpenTooltipOnHover,
    config.chatPageUrl,
    config.contextProvider,
    config.hotkey,
    config.selectionValidator,
  ]);

  useEffect(() => {
    // Dynamically import vanilla module
    // This prevents bundling issues if vanilla module isn't present
    let experience: HypertextExperienceAPI | null = null;

    const initializeExperience = async () => {
      try {
        // Import the vanilla module
        const { createHypertextExperience } = await import(
          'hypertext-experience'
        );

        // Create experience instance with custom document
        // This ensures the experience operates on the current React app's document
        experience = createHypertextExperience({
          document: document,
          ...stableConfig,
        });

        experienceRef.current = experience;
      } catch (error) {
        console.error('[useHypertextExperience] Failed to initialize:', error);
        experienceRef.current = null;
      }
    };

    initializeExperience();

    // Cleanup function: destroy experience on unmount
    return () => {
      if (experience) {
        try {
          experience.destroy();
        } catch (error) {
          console.error('[useHypertextExperience] Cleanup error:', error);
        }
      }
      experienceRef.current = null;
    };
  }, [stableConfig]);

  return experienceRef.current;
}

/**
 * Hook variant that throws if experience fails to initialize
 * Useful for components that require hypertext to function
 */
export function useHypertextExperienceOrThrow(
  config: HypertextConfig = {}
): HypertextExperienceAPI {
  const experience = useHypertextExperience(config);

  if (!experience) {
    throw new Error(
      'Hypertext experience failed to initialize. Ensure hypertext-experience module is available.'
    );
  }

  return experience;
}</code></pre>
    </div>
</div>

<div class="collapsible full-width critical" data-collapsible="open">
    <div class="collapsible-header">
        <span>üíª Detailed Implementation: HypertextProvider Component</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <h3>../NabokovsWeb/src/components/HypertextProvider.tsx</h3>
        <pre><code>import React, { createContext, useContext, ReactNode } from 'react';
import type {
  HypertextConfig,
  HypertextExperienceAPI,
} from 'hypertext-experience';
import { useHypertextExperience } from '@/shared/hooks/useHypertextExperience';

/**
 * Context for sharing hypertext experience API
 */
const HypertextContext = createContext&lt;HypertextExperienceAPI | null&gt;(null);

export interface HypertextProviderProps {
  /** Configuration for hypertext experience */
  config?: HypertextConfig;

  /** Child components that can access hypertext via context */
  children: ReactNode;

  /** Optional fallback to render while initializing */
  fallback?: ReactNode;

  /** Optional error boundary component */
  onError?: (error: Error) => void;
}

/**
 * Provider component that initializes hypertext and shares API via context
 *
 * @example
 * ```tsx
 * function App() {
 *   return (
 *     &lt;HypertextProvider
 *       config={{
 *         backendUrl: 'http://localhost:3100',
 *         autoOpenTooltipOnHover: true,
 *       }}
 *     &gt;
 *       &lt;MyComponent /&gt;
 *     &lt;/HypertextProvider&gt;
 *   );
 * }
 *
 * function MyComponent() {
 *   const hypertext = useHypertext();
 *
 *   return (
 *     &lt;button onClick={() => hypertext?.triggerFromExternal()}&gt;
 *       Trigger Hypertext
 *     &lt;/button&gt;
 *   );
 * }
 * ```
 */
export function HypertextProvider({
  config = {},
  children,
  fallback = null,
  onError,
}: HypertextProviderProps) {
  const experience = useHypertextExperience(config);

  // Handle initialization errors
  React.useEffect(() => {
    if (!experience && onError) {
      onError(new Error('Hypertext experience failed to initialize'));
    }
  }, [experience, onError]);

  // Show fallback while initializing
  if (!experience && fallback) {
    return &lt;&gt;{fallback}&lt;/&gt;;
  }

  return (
    &lt;HypertextContext.Provider value={experience}&gt;
      {children}
    &lt;/HypertextContext.Provider&gt;
  );
}

/**
 * Hook to consume hypertext context
 * Returns null if provider is not mounted or experience failed to initialize
 *
 * @example
 * ```tsx
 * function MyComponent() {
 *   const hypertext = useHypertext();
 *
 *   if (!hypertext) {
 *     return &lt;div&gt;Hypertext not available&lt;/div&gt;;
 *   }
 *
 *   return (
 *     &lt;button onClick={() => hypertext.triggerFromExternal()}&gt;
 *       Open Hypertext Palette
 *     &lt;/button&gt;
 *   );
 * }
 * ```
 */
export function useHypertext(): HypertextExperienceAPI | null {
  return useContext(HypertextContext);
}

/**
 * Hook variant that throws if context is not available
 * Use this when hypertext is required for component to function
 *
 * @throws {Error} If HypertextProvider is not mounted
 */
export function useHypertextOrThrow(): HypertextExperienceAPI {
  const context = useContext(HypertextContext);

  if (!context) {
    throw new Error(
      'useHypertextOrThrow must be used within a HypertextProvider'
    );
  }

  return context;
}</code></pre>
    </div>
</div>

<div class="collapsible full-width secondary" data-collapsible="closed">
    <div class="collapsible-header">
        <span>üìñ Usage Examples: How The Wrapper Works</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <h3>Example 1: Direct Hook Usage (No Context)</h3>
        <pre><code>// In a React component that wants hypertext functionality
import { useHypertextExperience } from '@/shared/hooks/useHypertextExperience';

function ContentEditor() {
  // Initialize hypertext with custom config
  const hypertext = useHypertextExperience({
    backendUrl: 'http://localhost:3100',
    autoOpenTooltipOnHover: true,
    contextProvider: (session, opts) => {
      // Custom context logic for this component
      return `Editor content: ${editorContent}`;
    },
  });

  return (
    &lt;div&gt;
      &lt;textarea /&gt;
      {hypertext && (
        &lt;button onClick={() => hypertext.triggerFromExternal()}&gt;
          Add Hypertext (Cmd+Shift+K)
        &lt;/button&gt;
      )}
    &lt;/div&gt;
  );
}</code></pre>

        <h3>Example 2: Provider + Context (Shared Instance)</h3>
        <pre><code>// App.tsx - Top-level provider
import { HypertextProvider } from '@/components/HypertextProvider';

function App() {
  return (
    &lt;HypertextProvider
      config={{
        backendUrl: import.meta.env.VITE_HYPERTEXT_BACKEND,
        autoOpenTooltipOnHover: true,
      }}
      fallback={&lt;div&gt;Initializing hypertext...&lt;/div&gt;}
    &gt;
      &lt;ArticleReader /&gt;
      &lt;NotesTaker /&gt;
    &lt;/HypertextProvider&gt;
  );
}

// ArticleReader.tsx - Consumer component
import { useHypertext } from '@/components/HypertextProvider';

function ArticleReader() {
  const hypertext = useHypertext();
  const sessions = hypertext?.getSessions();

  return (
    &lt;article&gt;
      &lt;p&gt;Select any text and press Cmd+Shift+K...&lt;/p&gt;
      {sessions && (
        &lt;aside&gt;
          Active hyperlinks: {sessions.size}
        &lt;/aside&gt;
      )}
    &lt;/article&gt;
  );
}</code></pre>

        <h3>Example 3: Side Panel Integration (NabokovsWeb Extension)</h3>
        <pre><code>// In NabokovsWeb side panel
import { useHypertextExperience } from '@/shared/hooks/useHypertextExperience';

function SidePanel() {
  const [currentTab, setCurrentTab] = useState&lt;chrome.tabs.Tab | null&gt;(null);

  // Initialize hypertext to operate on the active tab's document
  const hypertext = useHypertextExperience({
    // Note: In a Chrome extension, you'd inject the vanilla script
    // into the content script, not use React here directly.
    // This is just for illustration.
    backendUrl: 'http://localhost:3100',
  });

  return (
    &lt;div className="side-panel"&gt;
      &lt;h2&gt;Hypertext Controls&lt;/h2&gt;
      &lt;button
        onClick={() => {
          // Send message to content script to trigger hypertext
          chrome.tabs.sendMessage(currentTab?.id!, {
            type: 'TRIGGER_HYPERTEXT',
          });
        }}
      &gt;
        Activate Hypertext on Page
      &lt;/button&gt;
    &lt;/div&gt;
  );
}</code></pre>

        <h3>How It Works Internally</h3>
        <div class="info-box">
            <strong>Lifecycle Flow:</strong>
            <ol style="margin: 8px 0 0 20px; line-height: 1.6;">
                <li><strong>Mount:</strong> useHypertextExperience calls vanilla <code>createHypertextExperience()</code></li>
                <li><strong>Store:</strong> API object stored in useRef (doesn't trigger re-renders)</li>
                <li><strong>Expose:</strong> API returned to component (or provided via context)</li>
                <li><strong>Use:</strong> Component calls methods like <code>triggerFromExternal()</code></li>
                <li><strong>Unmount:</strong> useEffect cleanup calls <code>experience.destroy()</code></li>
            </ol>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> The React wrapper does NOT re-implement hypertext functionality. It simply manages the lifecycle of the vanilla JS module. All the actual hypertext logic (selection, palette, tooltip, LLM streaming) happens in the vanilla JS code.
        </div>
    </div>
</div>

<div class="collapsible full-width secondary" data-collapsible="closed">
    <div class="collapsible-header">
        <span>‚ö†Ô∏è Potential Issues & Mitigations</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <table>
            <tr>
                <th>Issue</th>
                <th>Risk</th>
                <th>Mitigation</th>
            </tr>
            <tr>
                <td><strong>Config Changes Trigger Re-init</strong><br/>If config props change on every render, experience will destroy/recreate constantly</td>
                <td><span class="metric">HIGH</span></td>
                <td>Use useMemo to memoize config object; check for actual value changes, not object identity</td>
            </tr>
            <tr>
                <td><strong>Cleanup Race Conditions</strong><br/>Component unmounts before async init completes</td>
                <td><span class="metric">MEDIUM</span></td>
                <td>Track cleanup flag in useEffect; check flag before setting state; cancel pending operations</td>
            </tr>
            <tr>
                <td><strong>Multiple Instances on Same Page</strong><br/>Two React components both create hypertext experiences</td>
                <td><span class="metric">MEDIUM</span></td>
                <td>Document that only ONE instance should exist per document; add warning if multiple detected; use singleton pattern in vanilla module</td>
            </tr>
            <tr>
                <td><strong>TypeScript Type Mismatches</strong><br/>.d.ts file doesn't match actual vanilla JS API</td>
                <td><span class="metric">MEDIUM</span></td>
                <td>Add runtime type validation; write integration tests that verify types match; keep .d.ts next to .js file</td>
            </tr>
            <tr>
                <td><strong>Import Path Resolution</strong><br/>React app can't find vanilla module</td>
                <td><span class="metric">HIGH</span></td>
                <td>Document setup in README; provide Vite alias config example; add helpful error messages</td>
            </tr>
            <tr>
                <td><strong>Event Listener Leaks</strong><br/>Vanilla module adds global listeners that aren't cleaned up</td>
                <td><span class="metric">LOW</span></td>
                <td>Verify destroy() method removes all listeners; add tests for cleanup; check DevTools for listener count</td>
            </tr>
        </table>
    </div>
</div>

<div class="collapsible full-width secondary" data-collapsible="closed">
    <div class="collapsible-header">
        <span>üìä Success Criteria</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <div class="two-column-layout">
            <div>
                <h3>Functional Requirements</h3>
                <ul class="dense-list">
                    <li>‚úì Hook initializes vanilla module correctly</li>
                    <li>‚úì Hook cleans up on unmount (no leaks)</li>
                    <li>‚úì Config changes trigger re-initialization</li>
                    <li>‚úì API methods work identically to vanilla</li>
                    <li>‚úì Context provides stable API reference</li>
                    <li>‚úì Multiple consumers share same instance</li>
                    <li>‚úì Error handling works gracefully</li>
                    <li>‚úì TypeScript types are accurate</li>
                </ul>
            </div>
            <div>
                <h3>Non-Functional Requirements</h3>
                <ul class="dense-list">
                    <li>‚úì Zero runtime overhead vs vanilla</li>
                    <li>‚úì No additional bundle size (dev-only)</li>
                    <li>‚úì TypeScript autocomplete works</li>
                    <li>‚úì Documentation is comprehensive</li>
                    <li>‚úì Examples cover common use cases</li>
                    <li>‚úì Tests cover edge cases</li>
                    <li>‚úì No breaking changes to vanilla</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="collapsible full-width secondary" data-collapsible="closed">
    <div class="collapsible-header">
        <span>üóÇÔ∏è File Structure</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <pre><code>NabokovsWeb-hypertext-module/
‚îú‚îÄ‚îÄ hypertext/
‚îÇ   ‚îú‚îÄ‚îÄ hypertext-experience.js        # Vanilla JS module (unchanged)
‚îÇ   ‚îî‚îÄ‚îÄ hypertext-experience.d.ts      # NEW: TypeScript declarations
‚îú‚îÄ‚îÄ package.json                       # Updated with "types" field
‚îî‚îÄ‚îÄ demo/
    ‚îú‚îÄ‚îÄ react-hook-example.tsx         # NEW: Hook usage example
    ‚îî‚îÄ‚îÄ react-component-example.tsx    # NEW: Component usage example

NabokovsWeb/
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ components/
    ‚îÇ   ‚îî‚îÄ‚îÄ HypertextProvider.tsx      # NEW: React provider component
    ‚îú‚îÄ‚îÄ shared/
    ‚îÇ   ‚îî‚îÄ‚îÄ hooks/
    ‚îÇ       ‚îî‚îÄ‚îÄ useHypertextExperience.ts  # NEW: React hook
    ‚îî‚îÄ‚îÄ types/
        ‚îî‚îÄ‚îÄ hypertext.ts               # Re-export types from vanilla module</code></pre>
    </div>
</div>

<div class="collapsible full-width secondary" data-collapsible="closed">
    <div class="collapsible-header">
        <span>üìö Documentation Checklist</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <ul style="margin: 8px 0; line-height: 1.6;">
            <li><strong>README.md</strong>: Add "React Usage" section with hook and component examples</li>
            <li><strong>docs/REACT_WRAPPER.md</strong>: Comprehensive guide to React wrapper</li>
            <li><strong>JSDoc Comments</strong>: Add to all exported functions, hooks, and components</li>
            <li><strong>Type Documentation</strong>: Document all interfaces with examples</li>
            <li><strong>Migration Guide</strong>: How to integrate into existing React apps</li>
            <li><strong>Troubleshooting</strong>: Common issues and solutions</li>
            <li><strong>Performance Guide</strong>: Best practices for React integration</li>
        </ul>
    </div>
</div>

<div class="info-box" style="margin-top: 16px;">
    <strong>üéØ Key Takeaway:</strong> The React wrapper is a thin lifecycle adapter, not a reimplementation. The vanilla JS module remains the source of truth. React apps get the convenience of hooks and components, while vanilla consumers remain unaffected.
</div>

<script>
// Collapsible functionality
document.addEventListener('DOMContentLoaded', () => {
    const collapsibles = document.querySelectorAll('.collapsible');

    collapsibles.forEach(col => {
        const header = col.querySelector('.collapsible-header');
        const initialState = col.dataset.collapsible;

        if (initialState === 'open') {
            col.classList.add('open');
        }

        header.addEventListener('click', () => {
            col.classList.toggle('open');
        });
    });

    document.getElementById('expand-all').addEventListener('click', () => {
        collapsibles.forEach(col => col.classList.add('open'));
    });

    document.getElementById('collapse-all').addEventListener('click', () => {
        collapsibles.forEach(col => col.classList.remove('open'));
    });
});
</script>

</body>
</html>
