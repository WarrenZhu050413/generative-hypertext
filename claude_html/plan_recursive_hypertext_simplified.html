<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan: Recursive Hypertext (Simplified)</title>
<style>
:root {
    --chinese-red: #8B0000;
    --chinese-gold: #FFD700;
    --jade-green: #00A86B;
    --ink-black: #2B2B2B;
    --paper-beige: #F5F5DC;
    --light-cream: #FAFAF0;
    --level-1: #000;
    --level-2: #333;
    --level-3: #666;
    --level-4: #999;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
    color: var(--ink-black);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.3;
    padding: 8px;
}

h1 {
    font-size: 22px;
    font-weight: 900;
    margin: 6px 0;
    padding: 6px;
    background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

h2 {
    font-size: 16px;
    font-weight: 700;
    margin: 10px 0 4px 0;
    padding: 4px;
    border-left: 4px solid var(--chinese-red);
    background: rgba(139, 0, 0, 0.03);
    color: var(--level-1);
}

h3 {
    font-size: 13px;
    font-weight: 600;
    margin: 6px 0 3px 0;
    color: var(--level-2);
}

h4 {
    font-size: 12px;
    font-weight: 500;
    margin: 4px 0 2px 8px;
    color: var(--level-3);
}

.two-column-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    width: 100%;
}

.full-width { grid-column: span 2; }

button {
    background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
    color: white;
    border: 1px solid rgba(255, 215, 0, 0.3);
    padding: 4px 8px;
    margin: 2px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 2px;
}

button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
}

.important-always-visible {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
    border: 2px solid var(--chinese-gold);
    padding: 10px;
    margin: 8px 0;
    border-radius: 3px;
}

.metric {
    display: inline-block;
    background: white;
    border: 1px solid var(--chinese-gold);
    padding: 2px 6px;
    margin: 2px;
    border-radius: 2px;
    font-size: 11px;
    font-weight: 600;
}

.metric.important {
    background: var(--chinese-gold);
    color: white;
    font-weight: 700;
}

.collapsible { margin: 4px 0; width: 100%; }
.collapsible-header {
    cursor: pointer;
    padding: 6px 8px;
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
    border-left: 3px solid var(--chinese-gold);
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: all 0.2s ease;
}

.collapsible.critical .collapsible-header {
    border-left: 4px solid var(--chinese-red);
    background: rgba(139, 0, 0, 0.08);
    font-weight: 700;
}

.collapsible.secondary .collapsible-header {
    border-left: 2px solid #999;
    background: rgba(0, 0, 0, 0.02);
    font-size: 13px;
}

.collapsible-header:hover {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
}

.collapsible-header .arrow {
    display: inline-block;
    transition: transform 0.3s ease;
    color: var(--chinese-red);
    font-size: 10px;
}

.collapsible.open .arrow {
    transform: rotate(90deg);
}

.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding: 0 8px;
    margin-left: 8px;
}

.collapsible.open .collapsible-content {
    max-height: 5000px;
    padding: 8px;
}

.dense-list {
    list-style: none;
    padding: 0;
    margin-left: 8px;
}

.dense-list li {
    padding: 3px 0 3px 12px;
    position: relative;
    line-height: 1.4;
}

.dense-list li:before {
    content: "‚ñ∏";
    position: absolute;
    left: 0;
    color: var(--chinese-red);
    font-size: 10px;
}

ol.dense-list {
    list-style: decimal;
    padding-left: 20px;
}

ol.dense-list li:before {
    content: none;
}

.indent-1 { margin-left: 12px; }
.indent-2 { margin-left: 24px; }
.indent-3 { margin-left: 36px; }

.muted { color: var(--level-4); font-size: 12px; }
.critical { color: var(--chinese-red); font-weight: 700; }
.success { color: var(--jade-green); font-weight: 600; }
.warning { color: var(--chinese-gold); font-weight: 600; }

code {
    background: rgba(139, 0, 0, 0.05);
    padding: 1px 4px;
    border-radius: 2px;
    font-size: 12px;
    font-family: "Monaco", "Courier New", monospace;
}

pre {
    background: rgba(245, 245, 220, 0.3);
    border: 1px solid rgba(139, 0, 0, 0.1);
    padding: 6px;
    margin: 4px 0;
    overflow-x: auto;
    font-size: 11px;
    line-height: 1.3;
}

.step-box {
    background: white;
    border-left: 3px solid var(--chinese-gold);
    padding: 6px;
    margin: 4px 0;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.phase-header {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
    padding: 6px;
    margin: 8px 0 4px 0;
    font-weight: 700;
    border-left: 4px solid var(--chinese-red);
}
</style>
</head>
<body>

<div style="margin: 8px 0; text-align: right;">
    <button id="expand-all">Expand All</button>
    <button id="collapse-all">Collapse All</button>
</div>

<div class="important-always-visible">
    <h1>üìã Recursive Hypertext (Simplified Approach)</h1>
    <div class="two-column-layout">
        <div>
            <h3>Objective</h3>
            <p>Enable hypertext tooltips to work within other hypertext tooltips by simply calculating correct z-index from parent.</p>
        </div>
        <div>
            <h3>Key Insight</h3>
            <p><strong>Same document = existing infrastructure works!</strong> Just need to detect parent tooltip and set z-index = parent z-index + 1.</p>
            <div style="margin-top: 4px;">
                <span class="metric important">Complexity: Low</span>
                <span class="metric">Time: 2-3 hours</span>
                <span class="metric">Impact: Very High</span>
            </div>
        </div>
    </div>
</div>

<div style="background: rgba(0, 168, 107, 0.1); border: 2px solid var(--jade-green); padding: 10px; margin: 8px 0; border-radius: 3px;">
    <h2 style="color: var(--jade-green); margin-top: 0;">‚úÖ Why This is Simple</h2>
    <div class="two-column-layout">
        <div>
            <h4>Already Works</h4>
            <ul class="dense-list">
                <li>Event listeners (same document)</li>
                <li>Text selection (same document)</li>
                <li>Markdown rendering (reuses existing)</li>
                <li>Positioning logic (viewport-relative)</li>
                <li>Lifecycle cleanup (existing controllers)</li>
            </ul>
        </div>
        <div>
            <h4>Only Need to Add</h4>
            <ul class="dense-list">
                <li>Detect parent tooltip</li>
                <li>Calculate z-index = parent + 1</li>
                <li>Limit nesting depth to 5</li>
                <li>Done!</li>
            </ul>
        </div>
    </div>
</div>

<div class="two-column-layout">
    <!-- Implementation Steps -->
    <div class="collapsible critical" data-collapsible="open">
        <div class="collapsible-header">
            <span>‚ö° Implementation (3 Simple Steps)</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">

            <div class="phase-header">Step 1: Detect Parent Tooltip</div>
            <div class="step-box">
                <h4>When Creating Tooltip</h4>
                <p><strong>File:</strong> hypertext/hypertext-experience.js, line 631 (buildTooltip function)</p>
                <p><strong>Add helper function:</strong></p>
                <pre>function getParentTooltip(element) {
  // Walk up DOM to find if we're inside a tooltip
  let el = element;
  while (el && el !== document.body) {
    if (el.classList?.contains('hx-chat-tooltip')) {
      return el;
    }
    el = el.parentElement;
  }
  return null;
}

function getTooltipZIndex(tooltip) {
  if (!tooltip) return TOOLTIP_BASE_Z_INDEX;
  const computed = window.getComputedStyle(tooltip);
  const zIndex = parseInt(computed.zIndex, 10);
  return isNaN(zIndex) ? TOOLTIP_BASE_Z_INDEX : zIndex;
}</pre>
            </div>

            <div class="phase-header">Step 2: Set Z-Index Based on Parent</div>
            <div class="step-box">
                <h4>In buildTooltip Function</h4>
                <p><strong>File:</strong> hypertext/hypertext-experience.js, after creating tooltip element</p>
                <pre>function buildTooltip(doc, idSuffix = '') {
  const tooltip = doc.createElement('div');
  tooltip.className = 'hx-chat-tooltip';
  // ... existing innerHTML setup

  // NEW: Check if we're nested
  const parentTooltip = getParentTooltip(doc.body);
  if (parentTooltip) {
    const parentZ = getTooltipZIndex(parentTooltip);
    tooltip.style.zIndex = String(parentZ + 1);
    tooltip.dataset.nested = 'true';
    tooltip.dataset.parentId = parentTooltip.dataset.tooltipId;
  } else {
    tooltip.style.zIndex = String(TOOLTIP_BASE_Z_INDEX);
  }

  return { tooltip, ... };
}</pre>
            </div>

            <div class="phase-header">Step 3: Add Nesting Depth Limit</div>
            <div class="step-box">
                <h4>Prevent Infinite Nesting</h4>
                <p><strong>Add to applyHypertext function:</strong></p>
                <pre>function applyHypertext(instructions) {
  // Check nesting depth
  const nestingDepth = countNestingDepth();
  if (nestingDepth >= 5) {
    console.warn('[Hypertext] Max nesting depth (5) reached');
    alert('Maximum nesting depth reached. Please open in new chat page.');
    return;
  }

  // ... existing logic
}

function countNestingDepth() {
  let depth = 0;
  let el = doc.body;

  // Count parent tooltips
  while (el && el !== document.documentElement) {
    if (el.classList?.contains('hx-chat-tooltip')) {
      depth++;
    }
    el = el.parentElement;
  }

  return depth;
}</pre>
            </div>

        </div>
    </div>

    <!-- Testing -->
    <div class="collapsible secondary" data-collapsible="closed">
        <div class="collapsible-header">
            <span>‚úì Testing</span>
            <span class="arrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content">
            <h3>Manual Test Steps</h3>
            <ol class="dense-list">
                <li>Open demo/hypertext_navigation_demo.html</li>
                <li>Select text, generate hypertext</li>
                <li>Hover pill, tooltip opens (z-index: 2147483000)</li>
                <li>Select text inside tooltip, generate nested hypertext</li>
                <li>Verify nested tooltip has z-index: 2147483001</li>
                <li>Verify nested tooltip appears above parent</li>
                <li>Repeat 3 more times to reach depth 5</li>
                <li>Try to generate level 6, verify warning appears</li>
            </ol>

            <h3>Playwright Test</h3>
            <pre>test('nested hypertext z-index stacking', async ({ page }) => {
  await page.goto('demo/hypertext_navigation_demo.html');

  // Level 1
  await page.evaluate(() => {
    const range = new Range();
    range.selectNodeContents(document.body.querySelector('p'));
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
  });
  await page.keyboard.press('Meta+Shift+K');
  await page.click('button:has-text("Generate")');

  const tooltip1 = await page.locator('.hx-chat-tooltip').first();
  const z1 = await tooltip1.evaluate(el =>
    parseInt(window.getComputedStyle(el).zIndex)
  );
  expect(z1).toBe(2147483000);

  // Level 2 (inside tooltip)
  await tooltip1.hover();
  await page.evaluate(() => {
    const tooltip = document.querySelector('.hx-chat-tooltip');
    const textNode = tooltip.querySelector('.hx-chat-tooltip__content p');
    const range = new Range();
    range.selectNodeContents(textNode);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
  });
  await page.keyboard.press('Meta+Shift+K');
  await page.click('button:has-text("Generate")');

  const tooltip2 = await page.locator('.hx-chat-tooltip').nth(1);
  const z2 = await tooltip2.evaluate(el =>
    parseInt(window.getComputedStyle(el).zIndex)
  );
  expect(z2).toBe(2147483001);
  expect(z2).toBeGreaterThan(z1);
});</pre>
        </div>
    </div>
</div>

<!-- Edge Cases -->
<div class="collapsible secondary full-width" data-collapsible="closed">
    <div class="collapsible-header">
        <span>‚ö†Ô∏è Edge Cases to Handle</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <div class="two-column-layout">
            <div>
                <h3>Case 1: Z-Index Overflow</h3>
                <p><strong>Problem:</strong> Base is 2147483000, max is 2147483647, only 647 room</p>
                <p><strong>Solution:</strong> Depth limit of 5 levels means max z-index = 2147483005 ‚úì</p>
            </div>

            <div>
                <h3>Case 2: Tooltip Closed While Nested Open</h3>
                <p><strong>Problem:</strong> Parent closes, what happens to child?</p>
                <p><strong>Solution:</strong> Existing destroy() cascade already handles this (lines 1386-1393)</p>
            </div>

            <div>
                <h3>Case 3: Selection Spans Parent and Child</h3>
                <p><strong>Problem:</strong> User selects text across tooltip boundaries</p>
                <p><strong>Solution:</strong> Existing selection logic already clamps to single range ‚úì</p>
            </div>

            <div>
                <h3>Case 4: Positioning Off-Screen</h3>
                <p><strong>Problem:</strong> Nested tooltip positioned outside viewport</p>
                <p><strong>Solution:</strong> Existing clampToViewport() already handles this ‚úì</p>
            </div>
        </div>
    </div>
</div>

<!-- What Changed from Complex Plan -->
<div style="background: rgba(139, 0, 0, 0.05); border: 2px solid var(--chinese-red); padding: 10px; margin: 8px 0; border-radius: 3px;">
    <h2>üî• Why Previous Plan Was Overcomplicated</h2>
    <div class="two-column-layout">
        <div>
            <h4>Assumptions I Made (Wrong)</h4>
            <ul class="dense-list">
                <li><strong>Separate document contexts:</strong> Thought nested tooltips needed isolation</li>
                <li><strong>Event conflicts:</strong> Thought same-document listeners would clash</li>
                <li><strong>State collisions:</strong> Thought global state would clobber</li>
                <li><strong>Complex positioning:</strong> Thought parent-relative bounds needed</li>
            </ul>
        </div>
        <div>
            <h4>Reality (Simple)</h4>
            <ul class="dense-list">
                <li><strong>Same document:</strong> Everything just works!</li>
                <li><strong>Events fine:</strong> Bubbling handles naturally</li>
                <li><strong>State fine:</strong> Each session already isolated</li>
                <li><strong>Positioning fine:</strong> Viewport-relative already works</li>
            </ul>
        </div>
    </div>
    <div style="margin-top: 8px; padding: 6px; background: white;">
        <strong>Key realization:</strong> Injecting palette into same document means existing infrastructure handles everything. Only delta is z-index calculation.
    </div>
</div>

<!-- Complete Code Changes -->
<div class="collapsible critical full-width" data-collapsible="open">
    <div class="collapsible-header">
        <span>üìù Complete Code Diff</span>
        <span class="arrow">‚ñ∂</span>
    </div>
    <div class="collapsible-content">
        <h3>File: hypertext/hypertext-experience.js</h3>

        <div class="step-box">
            <h4>1. Add helper functions (before createHypertextExperience)</h4>
            <pre>// Add after line 1462 (before createHyperlinkSpan)

function getParentTooltip(doc) {
  // Check if document.body is inside a tooltip
  let el = doc.body;
  while (el && el !== doc.documentElement) {
    const parent = el.parentElement;
    if (parent?.classList?.contains('hx-chat-tooltip__content')) {
      // Found parent tooltip content, return the tooltip itself
      return parent.closest('.hx-chat-tooltip');
    }
    el = parent;
  }
  return null;
}

function getTooltipZIndex(tooltip) {
  if (!tooltip) return TOOLTIP_BASE_Z_INDEX;
  const computed = tooltip.ownerDocument.defaultView.getComputedStyle(tooltip);
  const zIndex = parseInt(computed.zIndex, 10);
  return isNaN(zIndex) ? TOOLTIP_BASE_Z_INDEX : zIndex;
}

function countNestingDepth(doc) {
  let depth = 0;
  let el = doc.body;

  while (el && el !== doc.documentElement) {
    const parent = el.parentElement;
    if (parent?.classList?.contains('hx-chat-tooltip')) {
      depth++;
    }
    el = parent;
  }

  return depth;
}</pre>
        </div>

        <div class="step-box">
            <h4>2. Update buildTooltip function (line 631)</h4>
            <pre>function buildTooltip(doc, idSuffix = '') {
  const inputId = idSuffix ? `hx-chat-input-${idSuffix}` : 'hx-chat-input';
  const tooltip = doc.createElement('div');
  tooltip.className = 'hx-chat-tooltip';
  tooltip.setAttribute('role', 'dialog');
  tooltip.setAttribute('aria-hidden', 'true');
  tooltip.setAttribute('data-tooltip-id', idSuffix);

  // NEW: Set z-index based on parent nesting
  const parentTooltip = getParentTooltip(doc);
  if (parentTooltip) {
    const parentZ = getTooltipZIndex(parentTooltip);
    tooltip.style.zIndex = String(parentZ + 1);
    tooltip.dataset.nested = 'true';
    tooltip.dataset.nestingLevel = String(countNestingDepth(doc));
  }

  tooltip.innerHTML = `
    ... (rest unchanged)
  `;

  // ... rest unchanged
}</pre>
        </div>

        <div class="step-box">
            <h4>3. Update applyHypertext function (line 2206)</h4>
            <pre>function applyHypertext(instructions) {
  if (!activeRange || !activeSelection) return;
  if (selectionValidator && !selectionValidator(activeRange, activeSelection)) {
    return;
  }

  // NEW: Check nesting depth limit
  const nestingDepth = countNestingDepth(doc);
  if (nestingDepth >= 5) {
    console.warn('[Hypertext] Maximum nesting depth (5) reached');
    const shouldContinue = win.confirm(
      'Maximum nesting depth reached. Open in new chat page instead?'
    );
    if (shouldContinue) {
      // Open chat page with current context
      const payload = {
        subject: activeSelection,
        sourceUrl: doc.defaultView?.location?.href || ''
      };
      win.sessionStorage?.setItem('hypertext:handoff', JSON.stringify(payload));
      win.open(chatPageUrl, '_blank', 'noopener');
    }
    return;
  }

  // ... rest unchanged
}</pre>
        </div>

    </div>
</div>

<div style="margin: 16px 0; padding: 10px; background: white; border: 2px solid var(--jade-green); border-radius: 3px;">
    <h3 style="margin: 0 0 6px 0; color: var(--jade-green);">‚úÖ Ready to Implement</h3>
    <p><strong>Total changes:</strong> ~40 lines of code (3 helper functions + 2 small modifications)</p>
    <p><strong>Time estimate:</strong> 2-3 hours including testing</p>
    <p><strong>Risk:</strong> Very low (minimal changes to existing code)</p>
    <div style="margin-top: 6px;">
        <button style="background: var(--jade-green); border-color: var(--jade-green);">Proceed with Implementation</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-collapsible]').forEach(function(section) {
        const isOpen = section.getAttribute('data-collapsible') === 'open';
        section.classList.add('collapsible');
        if (isOpen) section.classList.add('open');
    });

    document.querySelectorAll('.collapsible-header').forEach(function(header) {
        header.addEventListener('click', function() {
            const collapsible = this.closest('.collapsible');
            collapsible.classList.toggle('open');
        });
    });

    const expandAllBtn = document.getElementById('expand-all');
    const collapseAllBtn = document.getElementById('collapse-all');

    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.collapsible').forEach(function(c) {
                c.classList.add('open');
            });
        });
    }

    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.collapsible').forEach(function(c) {
                c.classList.remove('open');
            });
        });
    }
});
</script>

</body>
</html>