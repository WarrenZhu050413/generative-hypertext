<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan: Fix Image Drop for InlineChatWindow & FloatingWindow</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
            --light-cream: #FAFAF0;
            --level-1: #000;
            --level-2: #333;
            --level-3: #666;
            --level-4: #999;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.2;
            font-size: 14px;
            margin: 0;
            padding: 2px;
            width: 100vw;
            max-width: 100%;
        }

        .container { width: 100%; padding: 0; margin: 0; }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 4px 0;
            padding: 6px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0 2px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 12px;
            font-weight: 500;
            margin: 2px 0 1px 16px;
            color: var(--level-3);
        }

        button {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.2s ease;
            padding: 2px 6px;
            margin: 1px;
            font-size: 12px;
            line-height: 1.1;
            cursor: pointer;
            border-radius: 3px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
            border-color: var(--chinese-gold);
        }

        .collapsible { margin: 4px 0; width: 100%; }

        .collapsible-header {
            cursor: pointer;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 10px;
        }

        .collapsible.open .arrow { transform: rotate(90deg); }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 8px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 10000px;
            padding: 8px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .collapsible.secondary .collapsible-header {
            border-left: 2px solid #999;
            background: rgba(0, 0, 0, 0.02);
            font-size: 13px;
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.1);
        }

        .metric {
            display: inline-block;
            background: rgba(139, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 11px;
            margin: 2px;
        }

        .metric.important {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(139, 0, 0, 0.1));
            border: 1px solid var(--chinese-gold);
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 4px 0;
            border-left: 3px solid var(--chinese-gold);
        }

        .indent-1 { margin-left: 16px; font-size: 12px; }
        .indent-2 { margin-left: 32px; font-size: 11px; }
        .muted { color: var(--level-3); }

        ul, ol {
            margin: 4px 0;
            padding-left: 24px;
        }

        li {
            margin: 2px 0;
            padding: 1px 0;
            line-height: 1.3;
        }

        .dense-list li { margin: 1px 0; padding: 0; }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 4px 0;
        }

        @media (max-width: 1200px) {
            .two-column-layout { grid-template-columns: 1fr; }
        }

        .warning {
            background: rgba(255, 140, 0, 0.1);
            border-left: 4px solid #FF8C00;
            padding: 6px;
            margin: 4px 0;
        }

        .success {
            background: rgba(0, 168, 107, 0.1);
            border-left: 4px solid var(--jade-green);
            padding: 6px;
            margin: 4px 0;
        }

        .error {
            background: rgba(220, 20, 60, 0.1);
            border-left: 4px solid #DC143C;
            padding: 6px;
            margin: 4px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        strong { color: var(--chinese-red); font-weight: 700; }
        code {
            background: rgba(139, 0, 0, 0.05);
            padding: 1px 4px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 12px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            text-align: left;
        }

        th {
            background: rgba(139, 0, 0, 0.08);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Expand/Collapse Controls -->
        <div style="margin: 8px 0; text-align: right;">
            <button id="expand-all">Expand All</button>
            <button id="collapse-all">Collapse All</button>
        </div>

        <!-- Executive Summary -->
        <div class="important-always-visible">
            <h1>üêõ Fix Image Drop for Chat Windows</h1>
            <div class="two-column-layout">
                <div>
                    <h3>Problem</h3>
                    <p>Dropping images into InlineChatWindow triggers browser's default "display image" behavior instead of uploading to chat.</p>
                    <div class="metric important">Severity: HIGH</div>
                    <div class="metric important">User Impact: MAJOR</div>
                </div>
                <div>
                    <h3>Root Cause</h3>
                    <p><strong>react-rnd</strong> (Rnd component) intercepts drag events for window dragging, preventing ImageUploadZone's event handlers from preventing default browser behavior.</p>
                    <div class="metric">Components: 2 (InlineChatWindow, FloatingWindow)</div>
                </div>
            </div>
        </div>

        <!-- Root Cause Analysis -->
        <div class="collapsible critical open">
            <div class="collapsible-header">
                <span>üîç Root Cause Analysis</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h3>Current Architecture (Broken)</h3>

                <div class="error">
                    <strong>InlineChatWindow.tsx</strong> - Line 241-442
                    <pre class="code-block">
return (
  &lt;ImageUploadZone onImageUpload={handleImageDrop}&gt;
    &lt;Rnd
      dragHandleClassName="window-drag-handle"
      {...props}
    &gt;
      {/* Window content */}
    &lt;/Rnd&gt;
  &lt;/ImageUploadZone&gt;
);</pre>
                </div>

                <h3>Why It Fails</h3>
                <ol>
                    <li><strong>Event Capture Order:</strong>
                        <div class="indent-1">Browser ‚Üí ImageUploadZone ‚Üí Rnd ‚Üí Window Content</div>
                    </li>
                    <li><strong>Rnd Interference:</strong>
                        <div class="indent-1">Rnd has internal drag handlers for window movement that may stop event propagation</div>
                    </li>
                    <li><strong>dragHandleClassName Limitation:</strong>
                        <div class="indent-1">Even with drag handle, Rnd still captures ALL drag events on its root element</div>
                    </li>
                    <li><strong>Result:</strong>
                        <div class="indent-1 error">ImageUploadZone's <code>preventDefault()</code> never executes ‚Üí Browser opens image in new tab</div>
                    </li>
                </ol>

                <h3>Why Canvas.tsx Works</h3>
                <div class="success">
                    <pre class="code-block">
return (
  &lt;div
    style={styles.container}
    onDragOver={handleDragOver}   // ‚Üê Direct event handlers
    onDragLeave={handleDragLeave}
    onDrop={handleDrop}
  &gt;
    {/* Canvas content */}
  &lt;/div&gt;
);</pre>
                    <p><strong>Key difference:</strong> Drag handlers attached DIRECTLY to root div, no intermediate component interference.</p>
                </div>

                <h3>Why Tests Didn't Catch This</h3>
                <table>
                    <tr>
                        <th>Test Type</th>
                        <th>What Was Tested</th>
                        <th>What Was Missed</th>
                    </tr>
                    <tr>
                        <td><strong>Unit Tests</strong></td>
                        <td>‚úÖ Image validation logic<br>‚úÖ Message structure<br>‚úÖ API transformation</td>
                        <td>‚ùå Real browser drag events<br>‚ùå Event propagation<br>‚ùå preventDefault effectiveness</td>
                    </tr>
                    <tr>
                        <td><strong>E2E Tests</strong></td>
                        <td>‚úÖ Component rendering<br>‚úÖ Data structures</td>
                        <td>‚ùå File drag-drop (Playwright security)<br>‚ùå Browser default behavior</td>
                    </tr>
                </table>

                <div class="warning">
                    <strong>Lesson:</strong> Tests explicitly noted: "Full drag-drop testing is limited by Playwright security restrictions" but we didn't add manual testing checklist for this critical UX flow.
                </div>
            </div>
        </div>

        <!-- Solution -->
        <div class="collapsible critical open">
            <div class="collapsible-header">
                <span>‚ú® Solution: Direct Event Handlers + Content Area Wrapper</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h3>Strategy</h3>
                <p>Remove ImageUploadZone wrapper and add drag event handlers DIRECTLY to the window content area (not the drag handle).</p>

                <h3>Key Principles</h3>
                <ol>
                    <li><strong>Separation of Concerns:</strong> Drag handle for moving window, content area for file drops</li>
                    <li><strong>Event Priority:</strong> Prevent default on ALL drag events to block browser behavior</li>
                    <li><strong>Visual Feedback:</strong> Show overlay when dragging files over window</li>
                    <li><strong>Type Detection:</strong> Only activate for file drags, not text/other data</li>
                </ol>

                <h3>Implementation Pattern</h3>
                <div class="success">
                    <pre class="code-block">
// State
const [isDraggingFile, setIsDraggingFile] = useState(false);

// Handlers
const handleDragOver = useCallback((e: React.DragEvent) =&gt; {
  // Check if dragging files
  if (e.dataTransfer.types.includes('Files')) {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = 'copy';
    setIsDraggingFile(true);
  }
}, []);

const handleDragLeave = useCallback((e: React.DragEvent) =&gt; {
  e.preventDefault();
  e.stopPropagation();
  if (e.currentTarget === e.target) {
    setIsDraggingFile(false);
  }
}, []);

const handleDrop = useCallback(async (e: React.DragEvent) =&gt; {
  e.preventDefault();
  e.stopPropagation();
  setIsDraggingFile(false);

  const files = Array.from(e.dataTransfer.files);
  const imageFiles = files.filter(f =&gt; f.type.startsWith('image/'));

  if (imageFiles.length &gt; 0) {
    await handleImageDrop(imageFiles[0]);
  }
}, [handleImageDrop]);

// JSX
&lt;Rnd dragHandleClassName="window-drag-handle" {...props}&gt;
  {/* Header with drag handle */}
  &lt;div className="window-drag-handle"&gt;...&lt;/div&gt;

  {/* Content area with file drop */}
  &lt;div
    onDragOver={handleDragOver}
    onDragLeave={handleDragLeave}
    onDrop={handleDrop}
    style={{ position: 'relative', flex: 1 }}
  &gt;
    {/* Drag overlay */}
    {isDraggingFile && (
      &lt;div style={dragOverlayStyle}&gt;
        üìÅ Drop image to upload
      &lt;/div&gt;
    )}

    {/* Actual content */}
    {...content}
  &lt;/div&gt;
&lt;/Rnd&gt;</pre>
                </div>

                <h3>Benefits</h3>
                <ul>
                    <li>‚úÖ Drag handlers execute BEFORE browser default behavior</li>
                    <li>‚úÖ Window dragging via header still works (separate drag handle)</li>
                    <li>‚úÖ Clear visual feedback when dragging files</li>
                    <li>‚úÖ No wrapper component interference</li>
                    <li>‚úÖ Consistent with Canvas.tsx pattern</li>
                </ul>
            </div>
        </div>

        <!-- Implementation Steps -->
        <div class="two-column-layout">
            <!-- InlineChatWindow -->
            <div class="collapsible critical open">
                <div class="collapsible-header">
                    <span>üîß Step 1: Fix InlineChatWindow</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <p><strong>File:</strong> <code>src/components/InlineChatWindow.tsx</code></p>

                    <h4>1.1 Add State</h4>
                    <pre class="code-block">
const [isDraggingFile, setIsDraggingFile] = useState(false);</pre>

                    <h4>1.2 Add Event Handlers</h4>
                    <pre class="code-block">
const handleDragOver = useCallback((e: React.DragEvent) =&gt; {
  if (e.dataTransfer.types.includes('Files')) {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = 'copy';
    setIsDraggingFile(true);
  }
}, []);

const handleDragLeave = useCallback((e: React.DragEvent) =&gt; {
  e.preventDefault();
  e.stopPropagation();
  if (e.currentTarget === e.target) {
    setIsDraggingFile(false);
  }
}, []);

const handleDrop = useCallback(async (e: React.DragEvent) =&gt; {
  e.preventDefault();
  e.stopPropagation();
  setIsDraggingFile(false);

  const files = Array.from(e.dataTransfer.files);
  const imageFiles = files.filter(f =&gt; f.type.startsWith('image/'));

  if (imageFiles.length === 0) return;

  await handleImageDrop(imageFiles[0]);
}, [handleImageDrop]);</pre>

                    <h4>1.3 Remove ImageUploadZone Wrapper</h4>
                    <div class="warning">
                        <strong>Remove:</strong>
                        <pre class="code-block">
import { ImageUploadZone } from '@/shared/components/ImageUpload/ImageUploadZone';

return (
  &lt;ImageUploadZone onImageUpload={handleImageDrop}&gt;
    &lt;Rnd ...&gt;
  &lt;/ImageUploadZone&gt;
);</pre>
                    </div>

                    <h4>1.4 Add Drag Handlers to Content Area</h4>
                    <div class="success">
                        <strong>Add:</strong>
                        <pre class="code-block">
return (
  &lt;Rnd
    dragHandleClassName="window-drag-handle"
    {...props}
  &gt;
    {/* Header - drag handle for window movement */}
    &lt;div className="window-drag-handle" css={styles.header}&gt;
      ...
    &lt;/div&gt;

    {/* Content area - file drop zone */}
    &lt;div
      css={styles.content}
      onDragOver={handleDragOver}
      onDragLeave={handleDragLeave}
      onDrop={handleDrop}
      style={{ position: 'relative' }}
    &gt;
      {/* Drag overlay */}
      {isDraggingFile && (
        &lt;div css={styles.dragOverlay}&gt;
          &lt;div css={styles.dragOverlayContent}&gt;
            &lt;div style={{ fontSize: 48 }}&gt;üìÅ&lt;/div&gt;
            &lt;div&gt;Drop image to upload&lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      )}

      {/* Messages */}
      ...
    &lt;/div&gt;
  &lt;/Rnd&gt;
);</pre>
                    </div>

                    <h4>1.5 Add Overlay Styles</h4>
                    <pre class="code-block">
dragOverlay: {
  position: 'absolute',
  top: 0,
  left: 0,
  right: 0,
  bottom: 0,
  background: 'rgba(44, 62, 80, 0.95)',
  backdropFilter: 'blur(4px)',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  zIndex: 999,
  pointerEvents: 'none',
},
dragOverlayContent: {
  display: 'flex',
  flexDirection: 'column',
  alignItems: 'center',
  gap: '16px',
  color: '#FFD700',
  fontSize: '20px',
  fontWeight: 600,
}</pre>
                </div>
            </div>

            <!-- FloatingWindow -->
            <div class="collapsible critical open">
                <div class="collapsible-header">
                    <span>üîß Step 2: Add Image Drop to FloatingWindow</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <p><strong>File:</strong> <code>src/components/FloatingWindow.tsx</code></p>

                    <h4>2.1 Import Image Utilities</h4>
                    <pre class="code-block">
import { fileToBase64, getImageDimensions, isImageFile } from '@/utils/imageUpload';</pre>

                    <h4>2.2 Add State</h4>
                    <pre class="code-block">
const [isDraggingFile, setIsDraggingFile] = useState(false);
const [pendingImages, setPendingImages] = useState&lt;Array&lt;{
  dataURL: string;
  width: number;
  height: number;
}&gt;&gt;([]);</pre>

                    <h4>2.3 Add Image Drop Handler</h4>
                    <pre class="code-block">
const handleImageDrop = async (file: File) =&gt; {
  try {
    console.log('[FloatingWindow] Processing image:', file.name);

    if (!isImageFile(file)) {
      console.error('[FloatingWindow] Invalid file type:', file.type);
      return;
    }

    const dataURL = await fileToBase64(file);
    const dimensions = await getImageDimensions(dataURL);

    setPendingImages(prev =&gt; [...prev, {
      dataURL,
      width: dimensions.width,
      height: dimensions.height
    }]);

    console.log('[FloatingWindow] Image added to pending:', dimensions);
  } catch (error) {
    console.error('[FloatingWindow] Image processing failed:', error);
  }
};</pre>

                    <h4>2.4 Add Drag Event Handlers</h4>
                    <p>(Same as InlineChatWindow - see Step 1.2)</p>

                    <h4>2.5 Update Message Sending</h4>
                    <div class="warning">
                        <strong>Note:</strong> FloatingWindow uses chatService which may need to be updated to support images. This is a larger refactor.
                        <br><br>
                        <strong>For now:</strong> Just add the drop handlers and pending images UI. The actual sending can be Phase 2.
                    </div>

                    <h4>2.6 Add Image Preview UI</h4>
                    <pre class="code-block">
{pendingImages.length &gt; 0 && (
  &lt;div css={styles.pendingImages}&gt;
    {pendingImages.map((img, idx) =&gt; (
      &lt;div key={idx} css={styles.imagePreview}&gt;
        &lt;img src={img.dataURL} alt="Preview" /&gt;
        &lt;button
          onClick={() =&gt; setPendingImages(prev =&gt;
            prev.filter((_, i) =&gt; i !== idx)
          )}
        &gt;
          ‚úï
        &lt;/button&gt;
      &lt;/div&gt;
    ))}
  &lt;/div&gt;
)}</pre>
                </div>
            </div>
        </div>

        <!-- Testing Strategy -->
        <div class="collapsible critical open full-width">
            <div class="collapsible-header">
                <span>üß™ Testing Strategy</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h3>Why Automated Tests Aren't Sufficient</h3>
                <div class="error">
                    <p><strong>Playwright Limitation:</strong> Cannot simulate actual file drag-drop due to browser security restrictions.</p>
                    <p><strong>What We Can Test:</strong> Data structures, handlers, logic</p>
                    <p><strong>What We Can't Test:</strong> Real browser drag-drop behavior, preventDefault effectiveness</p>
                </div>

                <h3>Testing Approach</h3>
                <table>
                    <tr>
                        <th>Test Type</th>
                        <th>Coverage</th>
                        <th>Purpose</th>
                    </tr>
                    <tr>
                        <td><strong>Unit Tests</strong></td>
                        <td>‚úÖ handleImageDrop logic<br>‚úÖ Image validation<br>‚úÖ State updates<br>‚úÖ Event handler presence</td>
                        <td>Verify logic correctness</td>
                    </tr>
                    <tr>
                        <td><strong>E2E Tests</strong></td>
                        <td>‚úÖ Window renders<br>‚úÖ Drag handlers attached<br>‚úÖ Overlay visibility (mock)</td>
                        <td>Integration verification</td>
                    </tr>
                    <tr>
                        <td><strong>Manual Tests</strong></td>
                        <td>‚ö†Ô∏è REQUIRED<br>‚úÖ Actual file drag-drop<br>‚úÖ Browser default prevented<br>‚úÖ Image upload works<br>‚úÖ Window drag still works</td>
                        <td>Real-world UX validation</td>
                    </tr>
                </table>

                <h3>Manual Testing Checklist</h3>
                <div class="success">
                    <h4>InlineChatWindow</h4>
                    <ol>
                        <li>Open any webpage</li>
                        <li>Trigger inline chat (Ctrl+Shift+C)</li>
                        <li><strong>Drag image file into CHAT CONTENT area</strong>
                            <ul>
                                <li>‚úÖ Should show "Drop image to upload" overlay</li>
                                <li>‚úÖ Should NOT open image in browser</li>
                                <li>‚úÖ Should add image to pending images</li>
                            </ul>
                        </li>
                        <li><strong>Drag window by HEADER</strong>
                            <ul>
                                <li>‚úÖ Window should move</li>
                                <li>‚úÖ Dragging image during this should NOT trigger upload</li>
                            </ul>
                        </li>
                        <li><strong>Send message with image</strong>
                            <ul>
                                <li>‚úÖ Should send to Claude Vision API</li>
                                <li>‚úÖ Should display in message history</li>
                            </ul>
                        </li>
                    </ol>

                    <h4>FloatingWindow (Phase 2)</h4>
                    <ol>
                        <li>Open Canvas with cards</li>
                        <li>Open chat on a card (click chat icon)</li>
                        <li>Repeat same tests as InlineChatWindow</li>
                    </ol>
                </div>

                <h3>Update Tests</h3>
                <div class="warning">
                    <p><strong>Existing tests need minor updates:</strong></p>
                    <ul>
                        <li>Remove ImageUploadZone import from tests</li>
                        <li>Update tests to check for drag handlers on content div instead</li>
                        <li>Add tests for isDraggingFile state</li>
                        <li>Add tests for overlay rendering</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Edge Cases -->
        <div class="collapsible secondary">
            <div class="collapsible-header">
                <span>‚ö†Ô∏è Edge Cases & Considerations</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h3>Potential Issues</h3>
                <table>
                    <tr>
                        <th>Issue</th>
                        <th>Mitigation</th>
                    </tr>
                    <tr>
                        <td>Dragging image FROM chat content</td>
                        <td>Check <code>e.dataTransfer.types.includes('Files')</code> to distinguish file drops from image drags</td>
                    </tr>
                    <tr>
                        <td>Nested content catching events</td>
                        <td>Use <code>e.stopPropagation()</code> and check <code>e.currentTarget === e.target</code></td>
                    </tr>
                    <tr>
                        <td>Multiple windows open</td>
                        <td>Each window has independent state - no conflict</td>
                    </tr>
                    <tr>
                        <td>Very large images</td>
                        <td>Already handled by existing <code>getImageDimensions</code> logic</td>
                    </tr>
                    <tr>
                        <td>Non-image files</td>
                        <td>Filter with <code>file.type.startsWith('image/')</code></td>
                    </tr>
                </table>

                <h3>Browser Compatibility</h3>
                <ul>
                    <li>‚úÖ Chrome: Fully supported (target browser)</li>
                    <li>‚úÖ DataTransfer API: Standard, widely supported</li>
                    <li>‚úÖ preventDefault: Works in all modern browsers</li>
                </ul>
            </div>
        </div>

        <!-- Success Criteria -->
        <div class="collapsible secondary open full-width">
            <div class="collapsible-header">
                <span>üéØ Success Criteria</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h3>Functional Requirements</h3>
                <ul>
                    <li>‚úÖ Dropping image into InlineChatWindow content area uploads image (not browser default)</li>
                    <li>‚úÖ Dragging window by header still works</li>
                    <li>‚úÖ Visual overlay shows when dragging files</li>
                    <li>‚úÖ Only image files are accepted</li>
                    <li>‚úÖ Pending images preview with remove buttons</li>
                    <li>‚úÖ Messages with images send to Vision API</li>
                </ul>

                <h3>Code Quality</h3>
                <ul>
                    <li>‚úÖ No ImageUploadZone wrapper dependency</li>
                    <li>‚úÖ Consistent with Canvas.tsx pattern</li>
                    <li>‚úÖ Clean separation: drag handle for move, content for files</li>
                    <li>‚úÖ Proper event handler cleanup</li>
                </ul>

                <h3>Testing</h3>
                <ul>
                    <li>‚úÖ Unit tests updated and passing</li>
                    <li>‚úÖ E2E tests updated (what's possible)</li>
                    <li>‚úÖ Manual testing checklist completed</li>
                    <li>‚úÖ Zero TypeScript errors</li>
                    <li>‚úÖ Zero build warnings</li>
                </ul>
            </div>
        </div>

        <!-- Post-Implementation -->
        <div class="collapsible secondary full-width">
            <div class="collapsible-header">
                <span>üìã Post-Implementation Tasks</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="collapsible-content">
                <h3>Documentation Updates</h3>
                <ul>
                    <li>Update CLAUDE.md with manual testing requirement for drag-drop features</li>
                    <li>Add comment in code explaining why ImageUploadZone isn't used</li>
                    <li>Document the pattern for future draggable windows</li>
                </ul>

                <h3>Future Enhancements</h3>
                <ul>
                    <li>Support multiple image drops at once</li>
                    <li>Add image compression for large files</li>
                    <li>Add paste (Ctrl+V) image support</li>
                    <li>Add image editing (crop, rotate) before sending</li>
                </ul>

                <h3>FloatingWindow Phase 2</h3>
                <ul>
                    <li>Extend chatService to support images</li>
                    <li>Update message persistence with image data</li>
                    <li>Test integration with card conversation history</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        // Collapsible functionality
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.parentElement;
                collapsible.classList.toggle('open');
            });
        });

        // Expand/Collapse all
        document.getElementById('expand-all').addEventListener('click', () => {
            document.querySelectorAll('.collapsible').forEach(c => c.classList.add('open'));
        });

        document.getElementById('collapse-all').addEventListener('click', () => {
            document.querySelectorAll('.collapsible').forEach(c => c.classList.remove('open'));
        });
    </script>
</body>
</html>
