<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Plan: Side Panel Chat with Shared Components</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
            --light-cream: #FAFAF0;
            --level-1: #000;
            --level-2: #333;
            --level-3: #666;
            --level-4: #999;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.4;
            font-size: 14px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 8px 0;
            padding: 8px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 12px 0 6px 0;
            padding: 6px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0 4px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 13px;
            font-weight: 500;
            margin: 6px 0 3px 16px;
            color: var(--level-3);
        }

        button {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 4px;
            padding: 6px 12px;
            margin: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
            border-color: var(--chinese-gold);
        }

        .collapsible {
            margin: 8px 0;
            border: 1px solid rgba(139, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 12px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 12px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .collapsible.secondary .collapsible-header {
            border-left: 2px solid #999;
            background: rgba(0, 0, 0, 0.02);
            font-size: 13px;
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 8px 0;
        }

        .two-column-layout .full-width {
            grid-column: span 2;
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .dense-list li {
            padding: 4px 0 4px 16px;
            position: relative;
            line-height: 1.5;
        }

        .dense-list li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 12px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .metric {
            display: inline-block;
            background: white;
            border: 1px solid var(--chinese-gold);
            padding: 4px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .metric.important {
            background: var(--chinese-gold);
            color: white;
            font-weight: 700;
        }

        .critical { color: var(--chinese-red); font-weight: 700; }
        .success { color: var(--jade-green); font-weight: 600; }
        .warning { color: var(--chinese-gold); font-weight: 600; }
        .muted { color: var(--level-4); font-size: 12px; }

        code {
            background: rgba(245, 245, 220, 0.5);
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            border-radius: 2px;
            font-family: Monaco, Menlo, monospace;
            font-size: 12px;
        }

        pre {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .indent-1 { margin-left: 16px; }
        .indent-2 { margin-left: 32px; }
        .indent-3 { margin-left: 48px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 12px;
        }

        th {
            background: var(--chinese-red);
            color: white;
            font-weight: 600;
            padding: 6px;
            text-align: left;
        }

        td {
            border: 1px solid #ddd;
            padding: 6px;
        }

        tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        @media (max-width: 800px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Expand/Collapse Controls -->
    <div style="margin: 8px 0; text-align: right;">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
    </div>

    <!-- Executive Summary (Always Visible) -->
    <div class="important-always-visible">
        <h1>ğŸ“‹ Task Plan: Side Panel Chat with Shared Components</h1>
        <div class="two-column-layout">
            <div>
                <h3>Objective</h3>
                <p>Implement chat functionality in the Side Panel while extracting shared chat logic into reusable components. This will enable users to chat with web pages directly from the side panel and ensure consistency across all three chat contexts (Floating Windows, Inline Chat, Side Panel).</p>
            </div>
            <div>
                <h3>Approach</h3>
                <p>Create a <strong>shared base chat component</strong> (<code>BaseChatUI</code>) that handles message display, input, and common logic. Use this component in all three contexts with context-specific wrappers. Add a collapsible chat section to the Side Panel UI.</p>
                <div class="metric important">Complexity: Medium-High</div>
                <div class="metric">Estimated Time: 3-4 hours</div>
                <div class="metric">Files Affected: 6 new, 3 modified</div>
            </div>
        </div>
    </div>

    <!-- Two-Column Layout for Main Content -->
    <div class="two-column-layout">
        <!-- Left Column: Architecture Analysis -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>ğŸ—ï¸ Current Architecture Analysis</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Existing Chat Implementations</h3>

                <h4>1. FloatingWindowChat (Reusable UI Component)</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/FloatingWindowChat.tsx</code></li>
                    <li><strong>Type:</strong> Stateless presentation component</li>
                    <li><strong>Props:</strong> messages, currentInput, isStreaming, callbacks</li>
                    <li><strong>Features:</strong> Message display, input form, save/auto-save controls</li>
                    <li><strong>Used by:</strong> FloatingWindow component</li>
                    <li><strong>State Management:</strong> External (windowManager + chatService)</li>
                </ul>

                <h4>2. InlineChatWindow (Self-Contained Component)</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/components/InlineChatWindow.tsx</code></li>
                    <li><strong>Type:</strong> Stateful component with window management</li>
                    <li><strong>Features:</strong> Full chat UI + react-rnd window management</li>
                    <li><strong>Context Support:</strong> PageContext and ElementContext</li>
                    <li><strong>Image Upload:</strong> Drag & drop support via ImageUploadZone</li>
                    <li><strong>State Management:</strong> Internal useState hooks</li>
                </ul>

                <h4>3. SidePanel (No Chat Yet)</h4>
                <ul class="dense-list">
                    <li><strong>File:</strong> <code>src/sidepanel/SidePanel.tsx</code></li>
                    <li><strong>Current Function:</strong> Displays stashed cards only</li>
                    <li><strong>Needs:</strong> Inline chat section for page conversations</li>
                    <li><strong>Should Support:</strong> Page context chat, image upload, save to canvas/stash</li>
                </ul>
            </div>
        </div>

        <!-- Right Column: Design Decisions -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>ğŸ¯ Design Decisions</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Shared vs. Context-Specific</h3>

                <h4>âœ… Shared Components (Extract)</h4>
                <ul class="dense-list">
                    <li><strong>BaseChatUI:</strong> Message display + input form</li>
                    <li><strong>useChatMessages:</strong> Hook for message state management</li>
                    <li><strong>Message Rendering:</strong> Consistent styling across all contexts</li>
                    <li><strong>Streaming Logic:</strong> Common streaming state and display</li>
                    <li><strong>Image Attachments:</strong> Shared image handling logic</li>
                </ul>

                <h4>ğŸ”§ Context-Specific Wrappers</h4>
                <ul class="dense-list">
                    <li><strong>FloatingWindowChat:</strong> Keep existing (already shared), refactor to use BaseChatUI</li>
                    <li><strong>InlineChatWindow:</strong> Keep existing (unique window management), refactor to use BaseChatUI</li>
                    <li><strong>SidePanelChat:</strong> NEW - Simple inline chat using BaseChatUI</li>
                </ul>

                <h4>âš¡ Key Benefits</h4>
                <ul class="dense-list">
                    <li><strong>Consistency:</strong> Same UI/UX across all chat contexts</li>
                    <li><strong>Maintainability:</strong> Single source of truth for chat logic</li>
                    <li><strong>Code Reuse:</strong> Reduce duplication (~400 lines)</li>
                    <li><strong>Testing:</strong> Test shared component once, benefits all contexts</li>
                </ul>
            </div>
        </div>

        <!-- Implementation Steps (Full Width) -->
        <div class="collapsible critical full-width" data-collapsible="open">
            <div class="collapsible-header">
                <span>âš¡ Implementation Steps</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Phase 1: Extract Shared Chat Components</h3>

                <h4>Step 1.1: Create BaseChatUI Component</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/shared/components/Chat/BaseChatUI.tsx</code></p>
                    <p><strong>Purpose:</strong> Pure UI component for message display and input</p>
                    <p><strong>Props:</strong></p>
                    <pre>interface BaseChatUIProps {
  messages: Message[];
  currentInput: string;
  isStreaming: boolean;
  streamingContent?: string;
  pendingImages?: ImageAttachment[];
  onSendMessage: () => void;
  onInputChange: (value: string) => void;
  onStopStreaming: () => void;
  onClearChat: () => void;
  onRemoveImage?: (index: number) => void;
  placeholder?: string;
  showSaveControls?: boolean;
  onSaveConversation?: () => void;
  autoSaveOnClose?: boolean;
  onToggleAutoSave?: (enabled: boolean) => void;
}</pre>
                    <p><strong>Features:</strong></p>
                    <ul class="dense-list">
                        <li>Message list with auto-scroll</li>
                        <li>Streaming indicator with cursor animation</li>
                        <li>Input form (textarea with Enter to send, Shift+Enter for newline)</li>
                        <li>Send/Stop/Clear buttons</li>
                        <li>Optional save controls</li>
                        <li>Pending images preview with remove buttons</li>
                        <li>Empty state with custom placeholder</li>
                    </ul>
                </div>

                <h4>Step 1.2: Create useChatMessages Hook</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/shared/hooks/useChatMessages.ts</code></p>
                    <p><strong>Purpose:</strong> Manage chat message state and streaming</p>
                    <pre>interface UseChatMessagesOptions {
  initialContext: string; // System prompt
  onError?: (error: Error) => void;
}

function useChatMessages(options: UseChatMessagesOptions) {
  return {
    messages: Message[],
    inputValue: string,
    isStreaming: boolean,
    streamingContent: string,
    pendingImages: ImageAttachment[],
    setInputValue: (value: string) => void,
    sendMessage: () => Promise&lt;void&gt;,
    stopStreaming: () => void,
    clearChat: () => void,
    addPendingImage: (image: ImageAttachment) => void,
    removePendingImage: (index: number) => void,
  }
}</pre>
                    <p><strong>Features:</strong></p>
                    <ul class="dense-list">
                        <li>Message state management</li>
                        <li>Streaming state and content</li>
                        <li>Image attachment management</li>
                        <li>Integration with claudeAPIService</li>
                        <li>Support for both text-only and multimodal messages</li>
                    </ul>
                </div>

                <h4>Step 1.3: Create Shared Types</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/shared/types/chat.ts</code></p>
                    <pre>export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
  streaming?: boolean;
  images?: ImageAttachment[];
}

export interface ImageAttachment {
  dataURL: string;
  width: number;
  height: number;
}</pre>
                </div>

                <h3>Phase 2: Refactor Existing Components</h3>

                <h4>Step 2.1: Refactor FloatingWindowChat to Use BaseChatUI</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/components/FloatingWindowChat.tsx</code></p>
                    <p><strong>Changes:</strong></p>
                    <ul class="dense-list">
                        <li>Import and use BaseChatUI</li>
                        <li>Remove duplicated message display and input UI</li>
                        <li>Keep save controls (unique to floating windows)</li>
                        <li>Pass through all props to BaseChatUI</li>
                        <li>Maintain existing callback structure</li>
                    </ul>
                </div>

                <h4>Step 2.2: Refactor InlineChatWindow to Use BaseChatUI</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/components/InlineChatWindow.tsx</code></p>
                    <p><strong>Changes:</strong></p>
                    <ul class="dense-list">
                        <li>Replace message display and input UI with BaseChatUI</li>
                        <li>Keep window management (Rnd wrapper)</li>
                        <li>Keep header controls (collapse, close, save, recapture)</li>
                        <li>Use useChatMessages hook for state management</li>
                        <li>Maintain ImageUploadZone wrapper</li>
                    </ul>
                </div>

                <h3>Phase 3: Implement Side Panel Chat</h3>

                <h4>Step 3.1: Create SidePanelChat Component</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/sidepanel/SidePanelChat.tsx</code></p>
                    <p><strong>Purpose:</strong> Inline chat component for side panel</p>
                    <pre>interface SidePanelChatProps {
  onSaveToCanvas?: (messages: Message[]) => void;
  onSaveToStash?: (messages: Message[]) => void;
}</pre>
                    <p><strong>Features:</strong></p>
                    <ul class="dense-list">
                        <li>Collapsible section (expand/collapse)</li>
                        <li>Page context capture (automatic)</li>
                        <li>Image upload support (drag & drop + file picker)</li>
                        <li>Save to Canvas or Stash buttons</li>
                        <li>Compact design (fits in side panel layout)</li>
                        <li>Uses BaseChatUI for consistency</li>
                        <li>Uses useChatMessages hook for state</li>
                    </ul>
                </div>

                <h4>Step 3.2: Integrate Chat into SidePanel</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/sidepanel/SidePanel.tsx</code></p>
                    <p><strong>Changes:</strong></p>
                    <ul class="dense-list">
                        <li>Import SidePanelChat component</li>
                        <li>Add collapsible chat section below header</li>
                        <li>Implement save handlers (saveToCanvas, saveToStash)</li>
                        <li>Format conversation as card content (similar to FloatingWindow)</li>
                        <li>Create card with cardType: 'generated'</li>
                        <li>Dispatch appropriate events (nabokov:cards-updated, nabokov:stash-updated)</li>
                    </ul>
                    <p><strong>Layout:</strong></p>
                    <pre>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (Title + Canvas Btn) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¬ Chat with Page [â–¼]      â”‚  &lt;-- Collapsible
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Chat messages           â”‚ â”‚
â”‚ â”‚ ...                     â”‚ â”‚
â”‚ â”‚ [Input] [Send] [Clear]  â”‚ â”‚
â”‚ â”‚ [Save to Canvas/Stash]  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Upload Images Section       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Search Bar                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Card List (Stashed Cards)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                </div>

                <h4>Step 3.3: Add Chat State Persistence (Optional)</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>src/services/sidePanelChatService.ts</code></p>
                    <p><strong>Purpose:</strong> Persist side panel chat messages across sessions</p>
                    <ul class="dense-list">
                        <li>Store messages in chrome.storage.local</li>
                        <li>Key: <code>'nabokov_sidepanel_chat_messages'</code></li>
                        <li>Load on mount, save on change</li>
                        <li>Clear on conversation save</li>
                    </ul>
                </div>

                <h3>Phase 4: Testing & Validation</h3>

                <h4>Step 4.1: Unit Tests</h4>
                <div class="indent-1">
                    <p><strong>Files:</strong></p>
                    <ul class="dense-list">
                        <li><code>tests/unit/shared/components/BaseChatUI.test.tsx</code></li>
                        <li><code>tests/unit/shared/hooks/useChatMessages.test.ts</code></li>
                    </ul>
                    <p><strong>Test Coverage:</strong></p>
                    <ul class="dense-list">
                        <li>Message display rendering</li>
                        <li>Input form submission</li>
                        <li>Streaming state display</li>
                        <li>Image attachment handling</li>
                        <li>Save controls functionality</li>
                    </ul>
                </div>

                <h4>Step 4.2: Integration Tests</h4>
                <div class="indent-1">
                    <p><strong>File:</strong> <code>tests/e2e/side-panel-chat.spec.ts</code></p>
                    <p><strong>Test Scenarios:</strong></p>
                    <ul class="dense-list">
                        <li>Open side panel and expand chat section</li>
                        <li>Send text message and verify response</li>
                        <li>Upload image and send with message</li>
                        <li>Save conversation to canvas</li>
                        <li>Save conversation to stash</li>
                        <li>Clear conversation</li>
                        <li>Verify chat persists across side panel reopen</li>
                    </ul>
                </div>

                <h4>Step 4.3: Manual Testing Checklist</h4>
                <div class="indent-1">
                    <ul class="dense-list">
                        <li>âœ“ Side panel chat displays correctly</li>
                        <li>âœ“ Messages send and stream properly</li>
                        <li>âœ“ Image upload works (drag & drop + file picker)</li>
                        <li>âœ“ Save to Canvas creates card with conversation</li>
                        <li>âœ“ Save to Stash creates stashed card</li>
                        <li>âœ“ Floating window chat still works (refactored)</li>
                        <li>âœ“ Inline chat window still works (refactored)</li>
                        <li>âœ“ All three chats have consistent styling</li>
                        <li>âœ“ No console errors or warnings</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Left Column: Technical Details -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>ğŸ”§ Technical Details</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Component Hierarchy</h3>
                <pre>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BaseChatUI (Shared UI Component)   â”‚
â”‚  - Message Display                 â”‚
â”‚  - Input Form                      â”‚
â”‚  - Streaming Indicator             â”‚
â”‚  - Image Preview                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–²
              â”‚ (uses)
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚         â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â” â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”Œâ”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Floating   â”‚ â”‚ Inline  â”‚ â”‚ SidePanelâ”‚  â”‚
â”‚ WindowChat â”‚ â”‚ Chat    â”‚ â”‚ Chat     â”‚  â”‚
â”‚            â”‚ â”‚ Window  â”‚ â”‚          â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ useChatMessages Hook (Shared Logic)
â”‚  - Message State
â”‚  - Streaming Logic
â”‚  - Image Management
â”‚  - API Integration
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</pre>

                <h3>Data Flow</h3>
                <pre>User Input (in SidePanel)
    â†“
SidePanelChat captures page context
    â†“
useChatMessages manages state
    â†“
claudeAPIService.chatWithPage (streaming)
    â†“
BaseChatUI displays messages
    â†“
User clicks "Save to Canvas"
    â†“
SidePanel.handleSaveToCanvas
    â†“
Format as HTML, create Card
    â†“
saveCard() + addConnection()
    â†“
Dispatch 'nabokov:cards-updated'
    â†“
Canvas refreshes to show new card</pre>

                <h3>Styling Approach</h3>
                <ul class="dense-list">
                    <li><strong>BaseChatUI:</strong> Use Emotion CSS with Chinese aesthetic</li>
                    <li><strong>Colors:</strong> Red gradients (#8B0000), Gold borders (#FFD700)</li>
                    <li><strong>Compact Design:</strong> Minimal padding, tight spacing for side panel</li>
                    <li><strong>Responsive:</strong> Adapts to container width (side panel vs. floating window)</li>
                    <li><strong>Consistent:</strong> Same message styles across all contexts</li>
                </ul>

                <h3>State Management Strategy</h3>
                <table>
                    <tr>
                        <th>Context</th>
                        <th>State Location</th>
                        <th>Persistence</th>
                    </tr>
                    <tr>
                        <td>Floating Window</td>
                        <td>windowManager + chatService</td>
                        <td>In-memory (per card)</td>
                    </tr>
                    <tr>
                        <td>Inline Chat</td>
                        <td>Component useState</td>
                        <td>None (ephemeral)</td>
                    </tr>
                    <tr>
                        <td>Side Panel</td>
                        <td>Component useState</td>
                        <td>chrome.storage.local (optional)</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Right Column: Edge Cases & Considerations -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>âš ï¸ Edge Cases & Considerations</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Potential Issues</h3>

                <h4>1. Context Capture Timing</h4>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> Page content may change after side panel opens</li>
                    <li><strong>Solution:</strong> Add "Refresh Context" button (like inline chat)</li>
                    <li><strong>Alternative:</strong> Capture context on first message send</li>
                </ul>

                <h4>2. Message History Persistence</h4>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> Should side panel chat persist across sessions?</li>
                    <li><strong>Options:</strong></li>
                    <li class="indent-1">A. Ephemeral (clear on close) - simpler, less clutter</li>
                    <li class="indent-1">B. Persistent (save to storage) - better UX, more complex</li>
                    <li><strong>Recommendation:</strong> Start ephemeral, add persistence if requested</li>
                </ul>

                <h4>3. Image Upload Conflicts</h4>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> Side panel already has image upload for creating cards</li>
                    <li><strong>Solution:</strong> Two separate upload zones:</li>
                    <li class="indent-1">- Top section: Upload images as cards (existing)</li>
                    <li class="indent-1">- Chat section: Attach images to messages (new)</li>
                    <li><strong>Clear UX:</strong> Different labels and visual separation</li>
                </ul>

                <h4>4. API Key Not Configured</h4>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> User tries to chat without API key</li>
                    <li><strong>Solution:</strong> Show friendly error with link to settings</li>
                    <li><strong>Fallback:</strong> Mock responses in development mode</li>
                </ul>

                <h4>5. Long Conversations</h4>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> Side panel has limited vertical space</li>
                    <li><strong>Solution:</strong> Scrollable message container with max-height</li>
                    <li><strong>UX:</strong> Auto-scroll to latest message</li>
                    <li><strong>Limit:</strong> Suggest saving and clearing after 10-15 exchanges</li>
                </ul>

                <h4>6. Multiple Pages in Same Session</h4>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> User switches tabs, context becomes stale</li>
                    <li><strong>Solution:</strong> Clear chat when active tab changes</li>
                    <li><strong>Alternative:</strong> Track context per tab and restore on switch</li>
                </ul>

                <h3>Performance Considerations</h3>
                <ul class="dense-list">
                    <li><strong>Message Rendering:</strong> Use React.memo for message components</li>
                    <li><strong>Streaming:</strong> Throttle state updates (every 50ms) to avoid flicker</li>
                    <li><strong>Image Handling:</strong> Validate file size (&lt;5MB) before upload</li>
                    <li><strong>Storage:</strong> Clean up old chat history to avoid storage limits</li>
                </ul>

                <h3>Accessibility</h3>
                <ul class="dense-list">
                    <li>Keyboard shortcuts: Enter to send, Escape to collapse chat</li>
                    <li>ARIA labels for buttons and input fields</li>
                    <li>Screen reader announcements for new messages</li>
                    <li>Focus management (auto-focus input when expanded)</li>
                </ul>
            </div>
        </div>

        <!-- Full Width: File Structure -->
        <div class="collapsible secondary full-width" data-collapsible="closed">
            <div class="collapsible-header">
                <span>ğŸ“ Complete File Structure</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>New Files to Create</h3>
                <pre>src/
  shared/
    components/
      Chat/
        BaseChatUI.tsx              â† NEW: Shared chat UI component
        BaseChatUI.test.tsx         â† NEW: Unit tests
    hooks/
      useChatMessages.ts            â† NEW: Chat state management hook
      useChatMessages.test.ts       â† NEW: Hook tests
    types/
      chat.ts                       â† NEW: Shared chat types
  sidepanel/
    SidePanelChat.tsx               â† NEW: Side panel chat component
  services/
    sidePanelChatService.ts         â† NEW (Optional): Persistence service

tests/
  e2e/
    side-panel-chat.spec.ts         â† NEW: Integration tests</pre>

                <h3>Files to Modify</h3>
                <pre>src/
  components/
    FloatingWindowChat.tsx          â† MODIFY: Refactor to use BaseChatUI
    InlineChatWindow.tsx            â† MODIFY: Refactor to use BaseChatUI
  sidepanel/
    SidePanel.tsx                   â† MODIFY: Add chat section</pre>

                <h3>Files Unchanged (Reference Only)</h3>
                <pre>src/
  components/
    FloatingWindow.tsx              â† Keep as-is (parent of FloatingWindowChat)
  services/
    chatService.ts                  â† Keep as-is (used by FloatingWindow)
    claudeAPIService.ts             â† Keep as-is (used by all chats)
    pageContextCapture.ts           â† Keep as-is (used by side panel chat)
  utils/
    storage.ts                      â† Keep as-is (used for saving conversations)</pre>
            </div>
        </div>

        <!-- Full Width: Example Code Snippets -->
        <div class="collapsible secondary full-width" data-collapsible="closed">
            <div class="collapsible-header">
                <span>ğŸ’» Key Code Snippets</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>BaseChatUI Component (Simplified)</h3>
                <pre>/** @jsxImportSource @emotion/react */
import { css } from '@emotion/react';
import React, { useRef, useEffect } from 'react';
import type { Message, ImageAttachment } from '@/shared/types/chat';

export interface BaseChatUIProps {
  messages: Message[];
  currentInput: string;
  isStreaming: boolean;
  streamingContent?: string;
  pendingImages?: ImageAttachment[];
  onSendMessage: () => void;
  onInputChange: (value: string) => void;
  onStopStreaming: () => void;
  onClearChat: () => void;
  onRemoveImage?: (index: number) => void;
  placeholder?: string;
  showSaveControls?: boolean;
  onSaveConversation?: () => void;
  autoSaveOnClose?: boolean;
  onToggleAutoSave?: (enabled: boolean) => void;
}

export const BaseChatUI: React.FC&lt;BaseChatUIProps&gt; = ({
  messages,
  currentInput,
  isStreaming,
  streamingContent,
  pendingImages = [],
  onSendMessage,
  onInputChange,
  onStopStreaming,
  onClearChat,
  onRemoveImage,
  placeholder = "Ask a question...",
  showSaveControls = false,
  onSaveConversation,
  autoSaveOnClose = false,
  onToggleAutoSave
}) => {
  const messagesEndRef = useRef&lt;HTMLDivElement&gt;(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, streamingContent]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!currentInput.trim() || isStreaming) return;
    onSendMessage();
  };

  return (
    &lt;div css={containerStyles}&gt;
      {/* Messages */}
      &lt;div css={messagesContainerStyles}&gt;
        {messages.length === 0 ? (
          &lt;div css={emptyStateStyles}&gt;{placeholder}&lt;/div&gt;
        ) : (
          messages.map((msg) => (
            &lt;div key={msg.id} css={messageStyles(msg.role)}&gt;
              {msg.images && msg.images.map((img, i) => (
                &lt;img key={i} src={img.dataURL} css={messageImageStyles} /&gt;
              ))}
              &lt;div&gt;{msg.content}&lt;/div&gt;
            &lt;/div&gt;
          ))
        )}
        {streamingContent && (
          &lt;div css={messageStyles('assistant')}&gt;
            {streamingContent}&lt;span css={cursorStyles}&gt;â–Š&lt;/span&gt;
          &lt;/div&gt;
        )}
        &lt;div ref={messagesEndRef} /&gt;
      &lt;/div&gt;

      {/* Pending Images */}
      {pendingImages.length &gt; 0 && (
        &lt;div css={imagePreviewStyles}&gt;
          {pendingImages.map((img, i) => (
            &lt;div key={i}&gt;
              &lt;img src={img.dataURL} /&gt;
              &lt;button onClick={() => onRemoveImage?.(i)}&gt;âœ•&lt;/button&gt;
            &lt;/div&gt;
          ))}
        &lt;/div&gt;
      )}

      {/* Save Controls */}
      {showSaveControls && (
        &lt;div css={saveControlsStyles}&gt;
          &lt;button onClick={onSaveConversation} disabled={messages.length === 0}&gt;
            ğŸ’¾ Save Conversation
          &lt;/button&gt;
          &lt;label&gt;
            &lt;input type="checkbox" checked={autoSaveOnClose} onChange={e => onToggleAutoSave?.(e.target.checked)} /&gt;
            Auto-save on close
          &lt;/label&gt;
        &lt;/div&gt;
      )}

      {/* Input Form */}
      &lt;form onSubmit={handleSubmit} css={inputFormStyles}&gt;
        &lt;input
          type="text"
          value={currentInput}
          onChange={e => onInputChange(e.target.value)}
          placeholder={placeholder}
          disabled={isStreaming}
        /&gt;
        &lt;div css={buttonGroupStyles}&gt;
          {isStreaming ? (
            &lt;button type="button" onClick={onStopStreaming}&gt;â¹&lt;/button&gt;
          ) : (
            &lt;button type="submit" disabled={!currentInput.trim()}&gt;â†‘&lt;/button&gt;
          )}
          &lt;button type="button" onClick={onClearChat}&gt;ğŸ—‘ï¸&lt;/button&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  );
};</pre>

                <h3>useChatMessages Hook (Simplified)</h3>
                <pre>import { useState, useCallback } from 'react';
import { claudeAPIService } from '@/services/claudeAPIService';
import type { Message, ImageAttachment } from '@/shared/types/chat';

export function useChatMessages(systemPrompt: string) {
  const [messages, setMessages] = useState&lt;Message[]&gt;([]);
  const [inputValue, setInputValue] = useState('');
  const [isStreaming, setIsStreaming] = useState(false);
  const [streamingContent, setStreamingContent] = useState('');
  const [pendingImages, setPendingImages] = useState&lt;ImageAttachment[]&gt;([]);

  const sendMessage = useCallback(async () => {
    if (!inputValue.trim() && pendingImages.length === 0) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: inputValue.trim() || '(Image attached)',
      timestamp: Date.now(),
      images: pendingImages.length > 0 ? [...pendingImages] : undefined
    };

    const newMessages = [...messages, userMessage];
    setMessages(newMessages);
    setInputValue('');
    setPendingImages([]);
    setIsStreaming(true);

    try {
      if (userMessage.images && userMessage.images.length > 0) {
        // Multimodal message (non-streaming)
        const response = await claudeAPIService.sendMessage(/* ... */);
        setMessages([...newMessages, {
          id: Date.now().toString(),
          role: 'assistant',
          content: response,
          timestamp: Date.now()
        }]);
      } else {
        // Text-only message (streaming)
        const { chatWithPage } = await import('@/services/claudeAPIService');
        let content = '';
        const stream = await chatWithPage(systemPrompt, newMessages);
        for await (const chunk of stream) {
          content += chunk;
          setStreamingContent(content);
        }
        setMessages([...newMessages, {
          id: Date.now().toString(),
          role: 'assistant',
          content,
          timestamp: Date.now()
        }]);
        setStreamingContent('');
      }
    } catch (error) {
      console.error('[useChatMessages] Error:', error);
      setMessages([...newMessages, {
        id: Date.now().toString(),
        role: 'assistant',
        content: 'âŒ Error: Could not connect to API',
        timestamp: Date.now()
      }]);
    } finally {
      setIsStreaming(false);
    }
  }, [messages, inputValue, pendingImages, systemPrompt]);

  const stopStreaming = useCallback(() => {
    setIsStreaming(false);
    setStreamingContent('');
  }, []);

  const clearChat = useCallback(() => {
    if (confirm('Clear conversation?')) {
      setMessages([]);
    }
  }, []);

  const addPendingImage = useCallback((image: ImageAttachment) => {
    setPendingImages(prev => [...prev, image]);
  }, []);

  const removePendingImage = useCallback((index: number) => {
    setPendingImages(prev => prev.filter((_, i) => i !== index));
  }, []);

  return {
    messages,
    inputValue,
    isStreaming,
    streamingContent,
    pendingImages,
    setInputValue,
    sendMessage,
    stopStreaming,
    clearChat,
    addPendingImage,
    removePendingImage
  };
}</pre>

                <h3>SidePanelChat Component (Simplified)</h3>
                <pre>/** @jsxImportSource @emotion/react */
import { css } from '@emotion/react';
import React, { useState, useEffect } from 'react';
import { BaseChatUI } from '@/shared/components/Chat/BaseChatUI';
import { useChatMessages } from '@/shared/hooks/useChatMessages';
import { capturePageContext, formatPageContextAsPrompt } from '@/services/pageContextCapture';
import { ImageUploadZone } from '@/shared/components/ImageUpload';
import type { Message } from '@/shared/types/chat';

interface SidePanelChatProps {
  onSaveToCanvas?: (messages: Message[]) => void;
  onSaveToStash?: (messages: Message[]) => void;
}

export const SidePanelChat: React.FC&lt;SidePanelChatProps&gt; = ({
  onSaveToCanvas,
  onSaveToStash
}) => {
  const [collapsed, setCollapsed] = useState(true);
  const [pageContext, setPageContext] = useState(() => capturePageContext());

  const systemPrompt = formatPageContextAsPrompt(pageContext);

  const {
    messages,
    inputValue,
    isStreaming,
    streamingContent,
    pendingImages,
    setInputValue,
    sendMessage,
    stopStreaming,
    clearChat,
    addPendingImage,
    removePendingImage
  } = useChatMessages(systemPrompt);

  const handleImageDrop = async (file: File) => {
    // Convert file to ImageAttachment
    const dataURL = await fileToBase64(file);
    const dimensions = await getImageDimensions(dataURL);
    addPendingImage({ dataURL, ...dimensions });
  };

  const handleSaveCanvas = () => {
    if (messages.length > 0) {
      onSaveToCanvas?.(messages);
      clearChat();
    }
  };

  const handleSaveStash = () => {
    if (messages.length > 0) {
      onSaveToStash?.(messages);
      clearChat();
    }
  };

  return (
    &lt;ImageUploadZone onImageUpload={handleImageDrop}&gt;
      &lt;div css={containerStyles}&gt;
        &lt;div css={headerStyles} onClick={() => setCollapsed(!collapsed)}&gt;
          &lt;span&gt;ğŸ’¬ Chat with Page&lt;/span&gt;
          &lt;span&gt;{collapsed ? 'â–¼' : 'â–²'}&lt;/span&gt;
        &lt;/div&gt;

        {!collapsed && (
          &lt;div css={contentStyles}&gt;
            &lt;BaseChatUI
              messages={messages}
              currentInput={inputValue}
              isStreaming={isStreaming}
              streamingContent={streamingContent}
              pendingImages={pendingImages}
              onSendMessage={sendMessage}
              onInputChange={setInputValue}
              onStopStreaming={stopStreaming}
              onClearChat={clearChat}
              onRemoveImage={removePendingImage}
              placeholder="Ask about this page..."
            /&gt;
            &lt;div css={saveButtonsStyles}&gt;
              &lt;button onClick={handleSaveCanvas} disabled={messages.length === 0}&gt;
                ğŸ¨ Save to Canvas
              &lt;/button&gt;
              &lt;button onClick={handleSaveStash} disabled={messages.length === 0}&gt;
                ğŸ“¥ Save to Stash
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        )}
      &lt;/div&gt;
    &lt;/ImageUploadZone&gt;
  );
};</pre>

                <h3>SidePanel Integration (Simplified)</h3>
                <pre>// In src/sidepanel/SidePanel.tsx

import { SidePanelChat } from './SidePanelChat';

export const SidePanel: React.FC = () => {
  // ... existing code ...

  const handleSaveChatToCanvas = async (messages: Message[]) => {
    // Format conversation as HTML
    const conversationHTML = messages.map(msg => /* ... */).join('');

    // Create new card
    const newCard: Card = {
      id: generateId(),
      content: conversationHTML,
      cardType: 'generated',
      stashed: false,
      metadata: { /* ... */ },
      tags: ['chat', 'ai-generated'],
      // ... other fields ...
    };

    await saveCard(newCard);
    window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));
    alert('Conversation saved to canvas!');
  };

  const handleSaveChatToStash = async (messages: Message[]) => {
    // Similar to above, but set stashed: true
    const newCard: Card = { /* ... */, stashed: true };
    await saveCard(newCard);
    window.dispatchEvent(new CustomEvent('nabokov:stash-updated'));
    alert('Conversation saved to stash!');
  };

  return (
    &lt;ImageUploadZone onImageUpload={handleImageDrop}&gt;
      &lt;div css={containerStyles}&gt;
        &lt;div css={headerStyles}&gt;
          &lt;h1&gt;ğŸ“¦ Stashed Cards&lt;/h1&gt;
          &lt;button onClick={handleOpenCanvas}&gt;ğŸ—ºï¸ Canvas&lt;/button&gt;
        &lt;/div&gt;

        {/* NEW: Chat Section */}
        &lt;SidePanelChat
          onSaveToCanvas={handleSaveChatToCanvas}
          onSaveToStash={handleSaveChatToStash}
        /&gt;

        &lt;div css={uploadSectionStyles}&gt;
          {/* Existing upload section */}
        &lt;/div&gt;

        &lt;div css={searchBarStyles}&gt;
          {/* Existing search bar */}
        &lt;/div&gt;

        &lt;div css={cardListStyles}&gt;
          {/* Existing card list */}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/ImageUploadZone&gt;
  );
};</pre>
            </div>
        </div>

        <!-- Full Width: Testing Strategy -->
        <div class="collapsible secondary full-width" data-collapsible="closed">
            <div class="collapsible-header">
                <span>âœ“ Comprehensive Testing Strategy</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Unit Tests (Vitest)</h3>
                <table>
                    <tr>
                        <th>Component/Hook</th>
                        <th>Test Cases</th>
                        <th>Coverage Goal</th>
                    </tr>
                    <tr>
                        <td>BaseChatUI</td>
                        <td>
                            â€¢ Renders empty state<br>
                            â€¢ Displays messages<br>
                            â€¢ Handles input changes<br>
                            â€¢ Submits on Enter<br>
                            â€¢ Shows streaming indicator<br>
                            â€¢ Displays pending images<br>
                            â€¢ Removes pending images
                        </td>
                        <td>90%+</td>
                    </tr>
                    <tr>
                        <td>useChatMessages</td>
                        <td>
                            â€¢ Sends text message<br>
                            â€¢ Sends multimodal message<br>
                            â€¢ Handles streaming<br>
                            â€¢ Stops streaming<br>
                            â€¢ Clears chat<br>
                            â€¢ Manages pending images<br>
                            â€¢ Handles API errors
                        </td>
                        <td>90%+</td>
                    </tr>
                    <tr>
                        <td>SidePanelChat</td>
                        <td>
                            â€¢ Renders collapsed by default<br>
                            â€¢ Expands on click<br>
                            â€¢ Captures page context<br>
                            â€¢ Handles image drop<br>
                            â€¢ Saves to canvas<br>
                            â€¢ Saves to stash
                        </td>
                        <td>85%+</td>
                    </tr>
                </table>

                <h3>Integration Tests (Playwright)</h3>
                <table>
                    <tr>
                        <th>Scenario</th>
                        <th>Steps</th>
                        <th>Expected Result</th>
                    </tr>
                    <tr>
                        <td>Side Panel Chat - Basic Flow</td>
                        <td>
                            1. Open side panel<br>
                            2. Expand chat section<br>
                            3. Type message and send<br>
                            4. Wait for response
                        </td>
                        <td>
                            â€¢ Chat expands<br>
                            â€¢ Message appears<br>
                            â€¢ Response streams in<br>
                            â€¢ No errors
                        </td>
                    </tr>
                    <tr>
                        <td>Save Conversation to Canvas</td>
                        <td>
                            1. Have chat conversation<br>
                            2. Click "Save to Canvas"<br>
                            3. Open canvas<br>
                            4. Verify new card exists
                        </td>
                        <td>
                            â€¢ Card created<br>
                            â€¢ Contains conversation<br>
                            â€¢ cardType: 'generated'<br>
                            â€¢ Visible on canvas
                        </td>
                    </tr>
                    <tr>
                        <td>Save Conversation to Stash</td>
                        <td>
                            1. Have chat conversation<br>
                            2. Click "Save to Stash"<br>
                            3. Verify stash list<br>
                            4. Confirm card is stashed
                        </td>
                        <td>
                            â€¢ Card created<br>
                            â€¢ stashed: true<br>
                            â€¢ Appears in stash list<br>
                            â€¢ Not on canvas
                        </td>
                    </tr>
                    <tr>
                        <td>Image Upload in Chat</td>
                        <td>
                            1. Expand chat<br>
                            2. Drag image to chat<br>
                            3. Verify preview<br>
                            4. Send with message
                        </td>
                        <td>
                            â€¢ Image preview shows<br>
                            â€¢ Can remove image<br>
                            â€¢ Message sends with image<br>
                            â€¢ Response considers image
                        </td>
                    </tr>
                    <tr>
                        <td>Floating Window Chat - Regression</td>
                        <td>
                            1. Open canvas<br>
                            2. Open card in floating window<br>
                            3. Chat with card<br>
                            4. Save conversation
                        </td>
                        <td>
                            â€¢ Chat still works<br>
                            â€¢ No visual regressions<br>
                            â€¢ Save functions correctly<br>
                            â€¢ Uses BaseChatUI
                        </td>
                    </tr>
                    <tr>
                        <td>Inline Chat - Regression</td>
                        <td>
                            1. Navigate to any page<br>
                            2. Press Ctrl+Shift+C<br>
                            3. Chat with page<br>
                            4. Save to canvas
                        </td>
                        <td>
                            â€¢ Window opens<br>
                            â€¢ Chat works<br>
                            â€¢ Save works<br>
                            â€¢ Uses BaseChatUI
                        </td>
                    </tr>
                </table>

                <h3>Manual Testing Checklist</h3>
                <div class="two-column-layout">
                    <div>
                        <h4>Side Panel Chat</h4>
                        <ul class="dense-list">
                            <li>âœ“ Chat section expands/collapses</li>
                            <li>âœ“ Messages display correctly</li>
                            <li>âœ“ Streaming shows with cursor animation</li>
                            <li>âœ“ Image drag & drop works</li>
                            <li>âœ“ Pending images show preview</li>
                            <li>âœ“ Can remove pending images</li>
                            <li>âœ“ Send button enabled/disabled correctly</li>
                            <li>âœ“ Clear chat works</li>
                            <li>âœ“ Save to Canvas creates card</li>
                            <li>âœ“ Save to Stash creates stashed card</li>
                            <li>âœ“ Styling matches Chinese aesthetic</li>
                        </ul>
                    </div>
                    <div>
                        <h4>Regression Testing</h4>
                        <ul class="dense-list">
                            <li>âœ“ Floating window chat still works</li>
                            <li>âœ“ Inline chat window still works</li>
                            <li>âœ“ All chats have consistent styling</li>
                            <li>âœ“ No console errors</li>
                            <li>âœ“ No TypeScript errors</li>
                            <li>âœ“ Build completes successfully</li>
                            <li>âœ“ Extension reloads without issues</li>
                            <li>âœ“ No memory leaks (test with long chats)</li>
                            <li>âœ“ Performance is acceptable</li>
                            <li>âœ“ Works with API key configured</li>
                            <li>âœ“ Fallback works without API key</li>
                        </ul>
                    </div>
                </div>

                <h3>Performance Benchmarks</h3>
                <ul class="dense-list">
                    <li><strong>Message Rendering:</strong> &lt;16ms per message (60fps)</li>
                    <li><strong>Streaming Updates:</strong> Throttled to 20fps (50ms intervals)</li>
                    <li><strong>Image Upload:</strong> &lt;1s for files under 5MB</li>
                    <li><strong>Chat Expand/Collapse:</strong> Smooth 300ms animation</li>
                    <li><strong>Side Panel Load:</strong> &lt;2s initial render</li>
                </ul>
            </div>
        </div>

        <!-- Left Column: Success Criteria -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>âœ¨ Success Criteria</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Feature Complete When:</h3>
                <ul class="dense-list">
                    <li>âœ“ Side panel has collapsible chat section</li>
                    <li>âœ“ Can send text messages and receive responses</li>
                    <li>âœ“ Can attach images to messages (drag & drop + file picker)</li>
                    <li>âœ“ Can save conversations to Canvas (as note cards)</li>
                    <li>âœ“ Can save conversations to Stash (hidden from canvas)</li>
                    <li>âœ“ Chat UI is consistent across all three contexts</li>
                    <li>âœ“ Floating window chat uses BaseChatUI</li>
                    <li>âœ“ Inline chat window uses BaseChatUI</li>
                    <li>âœ“ Side panel chat uses BaseChatUI</li>
                    <li>âœ“ All unit tests pass (&gt;85% coverage)</li>
                    <li>âœ“ All E2E tests pass</li>
                    <li>âœ“ No console errors or warnings</li>
                    <li>âœ“ Build completes with zero TypeScript errors</li>
                    <li>âœ“ Manual testing checklist complete</li>
                </ul>

                <h3>Quality Gates</h3>
                <table>
                    <tr>
                        <th>Gate</th>
                        <th>Requirement</th>
                        <th>Status</th>
                    </tr>
                    <tr>
                        <td>Type Safety</td>
                        <td>Zero TypeScript errors</td>
                        <td><span class="warning">Pending</span></td>
                    </tr>
                    <tr>
                        <td>Unit Tests</td>
                        <td>&gt;85% coverage for new code</td>
                        <td><span class="warning">Pending</span></td>
                    </tr>
                    <tr>
                        <td>E2E Tests</td>
                        <td>All scenarios pass</td>
                        <td><span class="warning">Pending</span></td>
                    </tr>
                    <tr>
                        <td>Performance</td>
                        <td>No UI lag or jank</td>
                        <td><span class="warning">Pending</span></td>
                    </tr>
                    <tr>
                        <td>Accessibility</td>
                        <td>Keyboard nav + ARIA labels</td>
                        <td><span class="warning">Pending</span></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Right Column: Follow-Up Tasks -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>ğŸ“Š Follow-Up Tasks & Future Enhancements</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Optional Enhancements (Phase 2)</h3>
                <ul class="dense-list">
                    <li><strong>Chat History Persistence:</strong> Save side panel chat across sessions</li>
                    <li><strong>Context Refresh:</strong> Add button to recapture page state</li>
                    <li><strong>Multiple Conversations:</strong> Support multiple chat threads per page</li>
                    <li><strong>Export Conversations:</strong> Export chat as markdown or JSON</li>
                    <li><strong>Conversation Search:</strong> Search within chat history</li>
                    <li><strong>Voice Input:</strong> Add speech-to-text support</li>
                    <li><strong>Keyboard Shortcuts:</strong> Custom shortcuts for common actions</li>
                    <li><strong>Message Editing:</strong> Edit sent messages and regenerate</li>
                    <li><strong>Code Highlighting:</strong> Syntax highlighting in code blocks</li>
                    <li><strong>Link Preview:</strong> Preview links shared in chat</li>
                </ul>

                <h3>Documentation Needs</h3>
                <ul class="dense-list">
                    <li>Update CLAUDE.md with new chat architecture</li>
                    <li>Add JSDoc comments to BaseChatUI and useChatMessages</li>
                    <li>Create user guide for side panel chat</li>
                    <li>Document shared component usage patterns</li>
                    <li>Add examples to README</li>
                </ul>

                <h3>Potential Refactoring (Future)</h3>
                <ul class="dense-list">
                    <li>Extract message formatting to shared utility</li>
                    <li>Create MessageComponent for individual messages</li>
                    <li>Unify all chat service logic (windowManager, chatService, etc.)</li>
                    <li>Add chat analytics (message counts, response times)</li>
                    <li>Implement chat templates (common prompts)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- JavaScript for Collapsibles -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-create collapsibles
            document.querySelectorAll('[data-collapsible]').forEach(function(section) {
                const isOpen = section.getAttribute('data-collapsible') === 'open';
                section.classList.add('collapsible');
                if (isOpen) section.classList.add('open');
            });

            // Handle clicks
            document.querySelectorAll('.collapsible-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    const collapsible = this.closest('.collapsible');
                    collapsible.classList.toggle('open');
                });
            });

            // Expand/Collapse all
            const expandAllBtn = document.getElementById('expand-all');
            const collapseAllBtn = document.getElementById('collapse-all');

            if (expandAllBtn) {
                expandAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('.collapsible').forEach(function(c) {
                        c.classList.add('open');
                    });
                });
            }

            if (collapseAllBtn) {
                collapseAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('.collapsible').forEach(function(c) {
                        c.classList.remove('open');
                    });
                });
            }
        });
    </script>
</body>
</html>