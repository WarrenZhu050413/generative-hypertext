<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome Extension: Reload vs Remove/Reinstall</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --ink-black: #1a1a1a;
            --paper-beige: #F5F5DC;
            --light-cream: #FFFEF0;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #666;
            --level-4: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 8px;
            width: 100vw;
            max-width: 100%;
            line-height: 1.3;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        h1 {
            font-size: 26px;
            font-weight: 900;
            margin: 8px 0;
            padding: 8px 6px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 10px 0 6px 0;
            padding: 5px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.04);
            color: var(--level-1);
        }

        h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 6px 0 3px 8px;
            color: var(--level-2);
            letter-spacing: 0.3px;
        }

        h4 {
            font-size: 13px;
            font-weight: 500;
            margin: 4px 0 2px 12px;
            color: var(--level-3);
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), white);
            border: 2px solid var(--chinese-gold);
            padding: 10px;
            margin: 12px 0;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(139, 0, 0, 0.1);
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 10px 0;
        }

        .comparison-card {
            background: white;
            border: 2px solid rgba(139, 0, 0, 0.2);
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .comparison-card.reload {
            border-left: 5px solid #4CAF50;
        }

        .comparison-card.reinstall {
            border-left: 5px solid #FF6B6B;
        }

        .comparison-card h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 6px 8px;
        }

        .dense-list li {
            padding: 3px 0 3px 14px;
            border-left: 2px solid transparent;
            position: relative;
            line-height: 1.4;
        }

        .dense-list li:before {
            content: "▸";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 11px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .collapsible {
            margin: 6px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 7px 10px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.06), rgba(255, 215, 0, 0.03));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 14px;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(255, 215, 0, 0.06));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 11px;
            margin-right: 6px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 10px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 10px;
        }

        code {
            background: rgba(245, 245, 220, 0.4);
            border: 1px solid rgba(139, 0, 0, 0.15);
            padding: 2px 5px;
            font-size: 13px;
            border-radius: 2px;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
        }

        pre {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 8px;
            margin: 6px 0;
            overflow-x: auto;
            border-radius: 3px;
        }

        pre code {
            background: none;
            border: none;
            padding: 0;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), white);
            border-left: 4px solid #FF6B6B;
            padding: 8px;
            margin: 8px 0;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), white);
            border-left: 4px solid #4CAF50;
            padding: 8px;
            margin: 8px 0;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), white);
            border-left: 4px solid #2196F3;
            padding: 8px;
            margin: 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 13px;
            background: white;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 6px 8px;
            text-align: left;
            line-height: 1.3;
        }

        th {
            background: rgba(139, 0, 0, 0.08);
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: rgba(245, 245, 220, 0.2);
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        .badge.safe {
            background: #4CAF50;
            color: white;
        }

        .badge.destructive {
            background: #FF6B6B;
            color: white;
        }

        .badge.partial {
            background: #FFA726;
            color: white;
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 12px 0;
        }

        .workflow-step {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.15);
            border-radius: 3px;
            padding: 8px;
            margin: 6px 0;
            position: relative;
            padding-left: 35px;
        }

        .workflow-step:before {
            content: attr(data-step);
            position: absolute;
            left: 8px;
            top: 8px;
            background: var(--chinese-red);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <h1>🔄 Chrome Extension: Reload vs Remove/Reinstall</h1>

    <div class="important-always-visible">
        <h2>Quick Answer</h2>
        <p><strong>Standard reload (🔄)</strong> works for <em>most</em> code changes, but <strong>does NOT</strong>:</p>
        <ul class="dense-list">
            <li><strong>Refresh content scripts</strong> in already-open tabs (must manually refresh those tabs)</li>
            <li><strong>Clear storage data</strong> (chrome.storage.local persists)</li>
            <li><strong>Reset extension ID</strong> (stays the same)</li>
        </ul>
        <p style="margin-top: 8px;"><strong>Remove/reinstall</strong> is needed when you need a <em>complete fresh start</em> or when standard reload doesn't fix the issue.</p>
    </div>

    <div class="divider"></div>

    <h2>Detailed Comparison</h2>

    <div class="two-column-layout">
        <div class="comparison-card reload">
            <h3>🔄 Standard Reload<span class="badge safe">SAFE</span></h3>
            <p style="margin: 6px 0; font-size: 13px;">Click reload button in <code>chrome://extensions</code></p>

            <h4>What it DOES:</h4>
            <ul class="dense-list">
                <li>Reloads extension code from <code>dist/</code></li>
                <li>Re-reads <code>manifest.json</code></li>
                <li>Restarts background service worker</li>
                <li>Applies new UI changes (popup, canvas, side panel)</li>
                <li>Updates permissions and APIs</li>
            </ul>

            <h4>What it DOES NOT do:</h4>
            <ul class="dense-list">
                <li><strong>Clear chrome.storage</strong> (cards, settings persist)</li>
                <li><strong>Update content scripts</strong> in already-injected tabs</li>
                <li><strong>Change extension ID</strong> (stays same)</li>
                <li><strong>Clear extension cache</strong> completely</li>
            </ul>

            <div class="success-box" style="margin-top: 8px;">
                <strong>✅ Use for:</strong> Normal development workflow after <code>npm run build</code>
            </div>
        </div>

        <div class="comparison-card reinstall">
            <h3>🗑️ Remove & Reinstall<span class="badge destructive">DESTRUCTIVE</span></h3>
            <p style="margin: 6px 0; font-size: 13px;">Remove extension, then "Load unpacked" again</p>

            <h4>What it DOES:</h4>
            <ul class="dense-list">
                <li>Completely uninstalls extension</li>
                <li><strong>Clears ALL chrome.storage data</strong></li>
                <li>May generate new extension ID</li>
                <li>Fresh content script injection</li>
                <li>Complete reset of all state</li>
                <li>Clears all caches</li>
            </ul>

            <h4>Side Effects:</h4>
            <ul class="dense-list">
                <li><strong>⚠️ Deletes all cards and settings</strong></li>
                <li>Extension ID may change (breaks bookmarks/links)</li>
                <li>Removes from Chrome toolbar (must re-pin)</li>
                <li>Loses OAuth tokens / API keys</li>
            </ul>

            <div class="warning-box" style="margin-top: 8px;">
                <strong>⚠️ Use ONLY when:</strong> Standard reload fails, need to clear storage, or debugging deep issues
            </div>
        </div>
    </div>

    <div class="divider"></div>

    <h2>When Each Method Works</h2>

    <table>
        <thead>
            <tr>
                <th>Change Type</th>
                <th>Reload (🔄)</th>
                <th>Refresh Tabs</th>
                <th>Remove/Reinstall</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Background worker code</td>
                <td>✅ Works</td>
                <td>❌ Not needed</td>
                <td>✅ Works (overkill)</td>
            </tr>
            <tr>
                <td>Canvas/UI changes</td>
                <td>✅ Works</td>
                <td>✅ Refresh canvas page</td>
                <td>✅ Works (overkill)</td>
            </tr>
            <tr>
                <td>Content script changes</td>
                <td>⚠️ Partial</td>
                <td>✅ <strong>Must refresh all open tabs</strong></td>
                <td>✅ Works</td>
            </tr>
            <tr>
                <td>Manifest.json changes</td>
                <td>✅ Works</td>
                <td>❌ Not needed</td>
                <td>✅ Works</td>
            </tr>
            <tr>
                <td>Clear storage data</td>
                <td>❌ Doesn't clear</td>
                <td>❌ Doesn't clear</td>
                <td>✅ <strong>Clears everything</strong></td>
            </tr>
            <tr>
                <td>Fix deep caching issues</td>
                <td>⚠️ Sometimes</td>
                <td>❌ Not enough</td>
                <td>✅ Always works</td>
            </tr>
            <tr>
                <td>Change extension ID</td>
                <td>❌ Keeps same ID</td>
                <td>❌ Keeps same ID</td>
                <td>✅ May get new ID</td>
            </tr>
        </tbody>
    </table>

    <div class="divider"></div>

    <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span><span class="arrow">▶</span>Typical Development Workflow (Recommended)</span>
        </div>
        <div class="collapsible-content">
            <div class="workflow-step" data-step="1">
                <strong>Make code changes</strong> in <code>src/</code>
            </div>

            <div class="workflow-step" data-step="2">
                <strong>Build extension:</strong>
                <pre><code>npm run build</code></pre>
            </div>

            <div class="workflow-step" data-step="3">
                <strong>Reload extension in Chrome:</strong>
                <ul class="dense-list">
                    <li>Go to <code>chrome://extensions</code></li>
                    <li>Click 🔄 reload button on Nabokov extension</li>
                </ul>
            </div>

            <div class="workflow-step" data-step="4">
                <strong>Refresh affected pages:</strong>
                <ul class="dense-list">
                    <li><strong>Canvas/Side Panel:</strong> Refresh the page (Cmd+R / Ctrl+R)</li>
                    <li><strong>Content scripts:</strong> Refresh ALL tabs where extension is active</li>
                    <li><strong>Background worker:</strong> No action needed (auto-restarted)</li>
                </ul>
            </div>

            <div class="success-box" style="margin-top: 10px;">
                <strong>✅ This workflow preserves:</strong> All cards, settings, API keys, and user data
            </div>
        </div>
    </div>

    <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span><span class="arrow">▶</span>Content Script Refresh Issue (Most Common Problem)</span>
        </div>
        <div class="collapsible-content">
            <div class="info-box">
                <strong>The Problem:</strong> Content scripts (<code>src/content/index.tsx</code>) are injected when a page loads. If you reload the extension, already-open tabs still have the OLD content script code.
            </div>

            <h4>Example Scenario:</h4>
            <ul class="dense-list">
                <li>You have <code>example.com</code> open in Tab 1</li>
                <li>You modify <code>ElementSelector.tsx</code> (used by content script)</li>
                <li>You run <code>npm run build</code> and reload extension (🔄)</li>
                <li>You press <code>Cmd+Shift+E</code> on Tab 1</li>
                <li><strong>❌ You still see the OLD element selector</strong></li>
            </ul>

            <h4>Solution:</h4>
            <div class="workflow-step" data-step="1">
                Reload extension (🔄) in <code>chrome://extensions</code>
            </div>
            <div class="workflow-step" data-step="2">
                <strong>Refresh ALL tabs</strong> where you want to test (Cmd+R / Ctrl+R)
            </div>
            <div class="workflow-step" data-step="3">
                Try the keyboard shortcut again — now you'll see the NEW code
            </div>

            <div class="warning-box" style="margin-top: 10px;">
                <strong>⚠️ Common mistake:</strong> Only reloading extension, forgetting to refresh the tabs
            </div>
        </div>
    </div>

    <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span><span class="arrow">▶</span>When Standard Reload Doesn't Work</span>
        </div>
        <div class="collapsible-content">
            <h4>Signs you need Remove/Reinstall:</h4>
            <ul class="dense-list">
                <li>Extension still shows old behavior after reload + tab refresh</li>
                <li>Console shows errors about missing files/chunks (cache corruption)</li>
                <li>Storage data is corrupted or causing crashes</li>
                <li>You need to test "fresh install" experience</li>
                <li>Extension permissions changed but not applying</li>
                <li>Deep caching issues (very rare with Manifest V3)</li>
            </ul>

            <h4>Procedure for Remove/Reinstall:</h4>
            <div class="workflow-step" data-step="1">
                <strong>Backup data (optional):</strong>
                <ul class="dense-list">
                    <li>Open DevTools on Canvas: <code>chrome-extension://[id]/src/canvas/index.html</code></li>
                    <li>Run: <code>await chrome.storage.local.get()</code></li>
                    <li>Copy output to save cards/settings</li>
                </ul>
            </div>

            <div class="workflow-step" data-step="2">
                <strong>Remove extension:</strong>
                <ul class="dense-list">
                    <li>Go to <code>chrome://extensions</code></li>
                    <li>Click "Remove" on Nabokov extension</li>
                </ul>
            </div>

            <div class="workflow-step" data-step="3">
                <strong>Load unpacked:</strong>
                <ul class="dense-list">
                    <li>Click "Load unpacked"</li>
                    <li>Select <code>/path/to/NabokovsWeb/dist</code></li>
                </ul>
            </div>

            <div class="workflow-step" data-step="4">
                <strong>Restore data (if backed up):</strong>
                <ul class="dense-list">
                    <li>Open DevTools on new Canvas</li>
                    <li>Run: <code>await chrome.storage.local.set(backupData)</code></li>
                </ul>
            </div>

            <div class="warning-box" style="margin-top: 10px;">
                <strong>⚠️ Extension ID may change:</strong> If you have bookmarks to <code>chrome-extension://[old-id]/...</code>, they'll break
            </div>
        </div>
    </div>

    <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span><span class="arrow">▶</span>Storage Persistence Behavior</span>
        </div>
        <div class="collapsible-content">
            <table>
                <thead>
                    <tr>
                        <th>Storage Type</th>
                        <th>Standard Reload (🔄)</th>
                        <th>Remove/Reinstall</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>chrome.storage.local</code></td>
                        <td>✅ Persists</td>
                        <td>❌ Cleared</td>
                    </tr>
                    <tr>
                        <td><code>chrome.storage.sync</code></td>
                        <td>✅ Persists</td>
                        <td>❌ Cleared</td>
                    </tr>
                    <tr>
                        <td><code>localStorage</code> (in extension pages)</td>
                        <td>✅ Persists</td>
                        <td>❌ Cleared</td>
                    </tr>
                    <tr>
                        <td><code>IndexedDB</code></td>
                        <td>✅ Persists</td>
                        <td>❌ Cleared</td>
                    </tr>
                    <tr>
                        <td>Service worker variables</td>
                        <td>❌ Reset (worker restarts)</td>
                        <td>❌ Reset</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box" style="margin-top: 10px;">
                <strong>For Nabokov:</strong> All cards (<code>'cards'</code>), canvas state (<code>'nabokov_canvas_state'</code>), connections, filters, API keys persist through standard reload
            </div>
        </div>
    </div>

    <div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span><span class="arrow">▶</span>Advanced: Manual Storage Clear (Alternative to Reinstall)</span>
        </div>
        <div class="collapsible-content">
            <p>If you want to clear storage without removing the extension:</p>

            <h4>Option 1: DevTools Console</h4>
            <pre><code>// Open DevTools on Canvas page
// Clear all storage:
await chrome.storage.local.clear()

// Or selectively clear:
await chrome.storage.local.remove(['cards', 'nabokov_connections'])

// Verify:
await chrome.storage.local.get()  // Should return {}</code></pre>

            <h4>Option 2: Background Worker DevTools</h4>
            <ul class="dense-list">
                <li>Go to <code>chrome://extensions</code></li>
                <li>Click "service worker" link under Nabokov</li>
                <li>Run same commands in DevTools console</li>
            </ul>

            <div class="success-box" style="margin-top: 10px;">
                <strong>✅ Benefit:</strong> Clears storage while keeping same extension ID and avoiding reinstall
            </div>
        </div>
    </div>

    <div class="divider"></div>

    <h2>Summary Decision Tree</h2>

    <div class="workflow-step" data-step="?">
        <strong>Did you change code?</strong>
        <ul class="dense-list">
            <li><strong>Yes →</strong> Go to Step 2</li>
            <li><strong>No, just testing →</strong> No reload needed</li>
        </ul>
    </div>

    <div class="workflow-step" data-step="?">
        <strong>What did you change?</strong>
        <ul class="dense-list">
            <li><strong>Background worker only →</strong> Reload extension (🔄)</li>
            <li><strong>Canvas/UI only →</strong> Reload extension (🔄) + refresh Canvas page</li>
            <li><strong>Content scripts →</strong> Reload extension (🔄) + refresh ALL open tabs</li>
            <li><strong>Manifest.json →</strong> Reload extension (🔄)</li>
        </ul>
    </div>

    <div class="workflow-step" data-step="?">
        <strong>Did standard reload work?</strong>
        <ul class="dense-list">
            <li><strong>Yes →</strong> Done! ✅</li>
            <li><strong>No →</strong> Check if you refreshed tabs (content scripts)</li>
            <li><strong>Still broken →</strong> Try Remove/Reinstall</li>
        </ul>
    </div>

    <div class="workflow-step" data-step="?">
        <strong>Do you need to clear storage/test fresh install?</strong>
        <ul class="dense-list">
            <li><strong>Yes →</strong> Remove/Reinstall (or manual storage clear)</li>
            <li><strong>No →</strong> Stay with standard reload workflow</li>
        </ul>
    </div>

    <div class="divider"></div>

    <div class="important-always-visible">
        <h2>🎯 Best Practice for Development</h2>
        <ul class="dense-list">
            <li><strong>Default:</strong> Always use standard reload (🔄) + refresh relevant pages</li>
            <li><strong>Content script changes:</strong> Remember to refresh ALL tabs where extension is active</li>
            <li><strong>Storage issues:</strong> Use DevTools to manually clear instead of full reinstall</li>
            <li><strong>Only reinstall when:</strong> Standard reload fails after multiple attempts or you need extension ID reset</li>
            <li><strong>Before reinstall:</strong> Backup storage data if you need to preserve cards/settings</li>
        </ul>

        <div class="success-box" style="margin-top: 10px;">
            <strong>99% of the time, standard reload + tab refresh is sufficient!</strong>
        </div>
    </div>

    <script>
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('open');
        }
    </script>
</body>
</html>