<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nabokov Web Clipper - Architecture Diagram</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --imperial-yellow: #FFDF00;
            --ink-black: #1a1a1a;
            --paper-beige: #F5F5DC;
            --light-cream: #FFFAF0;
            --jade-green: #00A86B;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #555;
            --level-4: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro', Roboto, Arial, sans-serif;
            line-height: 1.3;
            font-size: 13px;
            padding: 0;
            margin: 0;
            width: 100vw;
            max-width: 100%;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            padding: 12px;
        }

        h1 {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0;
            padding: 12px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: -0.5px;
            border-bottom: 3px solid var(--chinese-gold);
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 12px 0 6px 0;
            padding: 8px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 8px 0 4px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 13px;
            font-weight: 600;
            margin: 4px 0 2px 12px;
            color: var(--level-3);
        }

        .hero {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.1));
            border: 2px solid var(--chinese-gold);
            padding: 16px;
            margin: 12px 0;
            text-align: center;
            border-radius: 4px;
        }

        .hero p {
            margin: 6px 0;
            font-size: 14px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 8px 0;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 8px 0;
        }

        .card {
            background: white;
            border: 2px solid rgba(139, 0, 0, 0.2);
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.2);
            border-color: var(--chinese-gold);
        }

        .card.primary {
            border: 3px solid var(--chinese-red);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .card.secondary {
            border: 2px solid var(--chinese-gold);
        }

        .card h3 {
            margin: 0 0 8px 0;
            padding: 6px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card h4 {
            margin: 6px 0 4px 0;
            color: var(--level-2);
        }

        .flow-diagram {
            background: white;
            border: 2px solid var(--chinese-red);
            padding: 16px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .flow-step {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.05));
            border-left: 3px solid var(--chinese-gold);
            padding: 8px 12px;
            margin: 6px 0;
            position: relative;
            padding-left: 32px;
        }

        .flow-step:before {
            content: "‚ñ∏";
            position: absolute;
            left: 12px;
            color: var(--chinese-red);
            font-size: 14px;
            font-weight: 900;
        }

        .flow-arrow {
            text-align: center;
            color: var(--chinese-red);
            font-size: 20px;
            margin: 4px 0;
        }

        .collapsible {
            margin: 8px 0;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.08), rgba(255, 215, 0, 0.05));
            border-left: 4px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
            border-radius: 2px;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(255, 215, 0, 0.08));
            border-left-width: 6px;
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 14px;
            font-weight: 900;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 10000px;
            padding: 12px;
        }

        .code-block {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.4), rgba(255, 255, 255, 0.6));
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 8px 12px;
            margin: 6px 0;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            border-radius: 2px;
        }

        .list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .list li {
            padding: 4px 0 4px 20px;
            position: relative;
            margin: 2px 0;
        }

        .list li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 12px;
            font-weight: 900;
        }

        .list li strong {
            color: var(--level-2);
            font-weight: 700;
        }

        .tech-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            padding: 3px 8px;
            margin: 2px 4px 2px 0;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .storage-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 12px;
            background: white;
        }

        .storage-table th,
        .storage-table td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 6px 10px;
            text-align: left;
        }

        .storage-table th {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.1));
            font-weight: 700;
            color: var(--level-1);
        }

        .storage-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 255, 255, 0.9));
            border: 2px solid var(--chinese-gold);
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.1), rgba(255, 255, 255, 0.9));
            border: 2px solid #FF4500;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 16px 0;
        }

        strong {
            color: var(--level-2);
            font-weight: 700;
        }

        code {
            background: rgba(245, 245, 220, 0.5);
            padding: 2px 5px;
            border-radius: 2px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            color: var(--chinese-red);
        }

        .indent-1 { margin-left: 16px; }
        .indent-2 { margin-left: 32px; }
        .indent-3 { margin-left: 48px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Nabokov Web Clipper - System Architecture</h1>

        <div class="hero">
            <p><strong>Chrome Extension (Manifest V3)</strong> for capturing web content and organizing it on a visual canvas</p>
            <p>Built with React, TypeScript, React Flow, and Claude API integration</p>
            <div style="margin-top: 8px;">
                <span class="tech-badge">React 18.3</span>
                <span class="tech-badge">TypeScript 5.3</span>
                <span class="tech-badge">Vite 5.0</span>
                <span class="tech-badge">React Flow 12.3</span>
                <span class="tech-badge">Manifest V3</span>
                <span class="tech-badge">Claude API</span>
            </div>
        </div>

        <h2>üìê High-Level Architecture</h2>
        <div class="three-column">
            <div class="card primary">
                <h3>üîß Background Service Worker</h3>
                <h4>Purpose:</h4>
                <p>Manifest V3 service worker handling system-level operations</p>
                <h4>Responsibilities:</h4>
                <ul class="list">
                    <li><strong>Keyboard shortcuts</strong> (Cmd+Shift+E)</li>
                    <li><strong>Context menus</strong></li>
                    <li><strong>Screenshot capture</strong> via chrome.tabs API</li>
                    <li><strong>Extension icon</strong> click handler</li>
                </ul>
                <div class="code-block">src/background/index.ts</div>
            </div>

            <div class="card primary">
                <h3>üìÑ Content Script</h3>
                <h4>Purpose:</h4>
                <p>Injected into web pages for element selection</p>
                <h4>Responsibilities:</h4>
                <ul class="list">
                    <li><strong>Element selector UI</strong> in Shadow DOM</li>
                    <li><strong>User interaction</strong> for element picking</li>
                    <li><strong>HTML extraction</strong> and sanitization</li>
                    <li><strong>Screenshot coordination</strong></li>
                </ul>
                <div class="code-block">src/content/index.tsx</div>
            </div>

            <div class="card primary">
                <h3>üé® Canvas App</h3>
                <h4>Purpose:</h4>
                <p>Standalone React app for visual organization</p>
                <h4>Responsibilities:</h4>
                <ul class="list">
                    <li><strong>React Flow canvas</strong> rendering</li>
                    <li><strong>Card management</strong> UI</li>
                    <li><strong>Chat/AI features</strong></li>
                    <li><strong>Search/filter</strong></li>
                </ul>
                <div class="code-block">src/canvas/index.html</div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üîÑ Element Capture Flow</h2>
        <div class="flow-diagram">
            <div class="flow-step">
                <strong>1. User triggers capture</strong> - Presses Cmd+Shift+E or clicks context menu
            </div>
            <div class="flow-arrow">‚¨á</div>
            <div class="flow-step">
                <strong>2. Background worker activates</strong> - Sends ACTIVATE_SELECTOR message to content script
            </div>
            <div class="flow-arrow">‚¨á</div>
            <div class="flow-step">
                <strong>3. Content script mounts UI</strong> - ElementSelector rendered in Shadow DOM
            </div>
            <div class="flow-arrow">‚¨á</div>
            <div class="flow-step">
                <strong>4. User selects element</strong> - Clicks on desired page element
            </div>
            <div class="flow-arrow">‚¨á</div>
            <div class="flow-step">
                <strong>5. Capture pipeline executes:</strong>
                <div class="indent-1">
                    ‚Üí Extract HTML + sanitize with DOMPurify<br>
                    ‚Üí Request screenshot from background worker<br>
                    ‚Üí Compress screenshot (canvas-based)<br>
                    ‚Üí Generate unique ID (timestamp + random)<br>
                    ‚Üí Save Card to chrome.storage.local<br>
                    ‚Üí Save Screenshot to IndexedDB
                </div>
            </div>
            <div class="flow-arrow">‚¨á</div>
            <div class="flow-step">
                <strong>6. Canvas auto-refreshes</strong> - Event-based update shows new card
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üíæ Storage Architecture Details</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <table class="storage-table">
                    <thead>
                        <tr>
                            <th>Storage</th>
                            <th>Key</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Limit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="6"><strong>chrome.storage.local</strong></td>
                            <td><code>'cards'</code></td>
                            <td>Card[]</td>
                            <td>All card metadata (content, tags, positions, etc.)</td>
                            <td rowspan="6">~5MB total after JSON serialization</td>
                        </tr>
                        <tr>
                            <td><code>'nabokov_canvas_state'</code></td>
                            <td>CanvasState</td>
                            <td>Canvas positions, zoom level</td>
                        </tr>
                        <tr>
                            <td><code>'nabokov_filters'</code></td>
                            <td>FilterState</td>
                            <td>Active filters and search queries</td>
                        </tr>
                        <tr>
                            <td><code>'nabokov_connections'</code></td>
                            <td>Connection[]</td>
                            <td>Card relationships and arrows</td>
                        </tr>
                        <tr>
                            <td><code>'nabokov_claude_api_key'</code></td>
                            <td>string</td>
                            <td>Claude API key for LLM features</td>
                        </tr>
                        <tr>
                            <td><code>'nabokov_custom_buttons'</code></td>
                            <td>CustomButton[]</td>
                            <td>User-defined action buttons</td>
                        </tr>
                        <tr>
                            <td><strong>IndexedDB</strong></td>
                            <td>screenshotId</td>
                            <td>Blob</td>
                            <td>Compressed screenshots (separate from metadata)</td>
                            <td>Much larger, browser-dependent (typically 50-100MB+)</td>
                        </tr>
                    </tbody>
                </table>

                <div class="highlight-box">
                    <h4>üéØ Why Two Storage Systems?</h4>
                    <ul class="list">
                        <li><strong>chrome.storage.local</strong> - Fast sync, size-limited, perfect for metadata</li>
                        <li><strong>IndexedDB</strong> - Large capacity, async, ideal for binary data (screenshots)</li>
                        <li>Card references screenshot via <code>screenshotId</code> field</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üì¶ Core Data Type: Card</h2>
        <div class="code-block">
interface Card {
  id: string;                    // Generated by generateId()
  content?: string;              // Sanitized HTML (optional for image-only)
  metadata: ClipMetadata;        // url, title, domain, favicon, etc.
  position?: CardPosition;       // Canvas x, y
  size?: CardSize;               // Canvas width, height
  starred: boolean;
  tags: string[];
  createdAt: number;
  updatedAt: number;
  conversation?: Message[];      // Chat history with Claude
  screenshotId?: string;         // Reference to IndexedDB screenshot
  styles?: RelevantStyles;       // Computed CSS for rendering
  context?: string;              // Parent element HTML
  cardType?: "clipped" | "generated" | "note" | "image";
  parentCardId?: string;         // For generated cards
  generationContext?: {          // Metadata for AI-generated cards
    sourceMessageId: string;
    userPrompt: string;
    timestamp: number;
  };
  imageData?: string;            // Base64 data URL for image cards
  imageDimensions?: {            // Original dimensions
    width: number;
    height: number;
  };
  stashed?: boolean;             // Hidden from canvas (in side panel)
  fillInHistory?: FillInHistoryEntry[];  // Fill-in operations history
}
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üîó Card Relationships & Connections</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="two-column">
                    <div class="card">
                        <h4>Connection Types</h4>
                        <ul class="list">
                            <li><strong>'related'</strong> - General association</li>
                            <li><strong>'generated-from'</strong> - Parent-child AI generation</li>
                            <li><strong>'references'</strong> - Citation/source relationship</li>
                            <li><strong>'contradicts'</strong> - Opposing viewpoints</li>
                            <li><strong>'custom'</strong> - User-defined with label</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Storage & Management</h4>
                        <p>Stored separately in <code>'nabokov_connections'</code> key</p>
                        <div class="code-block">
interface Connection {
  id: string;
  source: string;      // Card ID
  target: string;      // Card ID
  connectionType: string;
  label?: string;
  createdAt: number;
}
                        </div>
                    </div>
                </div>

                <div class="highlight-box">
                    <h4>Visual Rendering</h4>
                    <p>Canvas automatically renders connections as React Flow edges with styled arrows and labels</p>
                    <p>Click edge to edit type/label via <strong>EdgeEditModal</strong></p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>ü§ñ AI Integration Architecture</h2>
        <div class="two-column">
            <div class="card secondary">
                <h3>Claude API Service</h3>
                <h4>Features:</h4>
                <ul class="list">
                    <li><strong>Real Anthropic API</strong> integration</li>
                    <li><strong>Text-only mode</strong> for conversations</li>
                    <li><strong>Vision mode</strong> for screenshot analysis</li>
                    <li><strong>Streaming responses</strong> with SSE</li>
                    <li><strong>API key management</strong> via chrome.storage</li>
                </ul>
                <div class="code-block">src/services/claudeAPIService.ts</div>
                <p><strong>Default Model:</strong> <code>claude-sonnet-4-20250514</code></p>
            </div>

            <div class="card secondary">
                <h3>Card Generation System</h3>
                <h4>Workflow:</h4>
                <ul class="list">
                    <li><strong>Custom buttons</strong> with template prompts</li>
                    <li><strong>Context gathering</strong> from parent card</li>
                    <li><strong>LLM response</strong> via Claude API</li>
                    <li><strong>Child card creation</strong> with metadata</li>
                    <li><strong>Auto-connection</strong> to parent</li>
                </ul>
                <div class="code-block">src/services/cardGenerationService.ts</div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üéõÔ∏è Custom Button System</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="card">
                    <h4>Default Buttons</h4>
                    <div class="two-column">
                        <div>
                            <ul class="list">
                                <li><strong>Learn More</strong> - Deep dive explanation</li>
                                <li><strong>Summarize</strong> - Concise summary</li>
                                <li><strong>Critique</strong> - Critical analysis</li>
                            </ul>
                        </div>
                        <div>
                            <ul class="list">
                                <li><strong>ELI5</strong> - Simple explanation</li>
                                <li><strong>Expand</strong> - Detailed elaboration</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4>Custom Button Configuration</h4>
                    <p>Users can create buttons with:</p>
                    <ul class="list">
                        <li><strong>Custom labels</strong> (e.g., "Translate", "Compare")</li>
                        <li><strong>Template prompts</strong> with variables:
                            <div class="indent-1">
                                <code>{{content}}</code> - Card content<br>
                                <code>{{title}}</code> - Card title<br>
                                <code>{{customContext}}</code> - User-provided context
                            </div>
                        </li>
                        <li><strong>Connection types</strong> - Automatic relationship creation</li>
                        <li><strong>Context prompts</strong> - Optional additional input</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>‚ú® LLM-Generated Hyperlinks & Instant Expansion</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="flow-diagram">
                    <div class="flow-step">
                        <strong>1. Term Detection</strong> - useLLMHyperlinks detects expandable terms in card content
                    </div>
                    <div class="flow-arrow">‚¨á</div>
                    <div class="flow-step">
                        <strong>2. User Clicks</strong> - Underlined term clicked by user
                    </div>
                    <div class="flow-arrow">‚¨á</div>
                    <div class="flow-step">
                        <strong>3. Content Generation</strong> - childCardGenerator creates explanation
                    </div>
                    <div class="flow-arrow">‚¨á</div>
                    <div class="flow-step">
                        <strong>4. Child Card Created</strong> - New card positioned 400px to right
                    </div>
                    <div class="flow-arrow">‚¨á</div>
                    <div class="flow-step">
                        <strong>5. Animation</strong> - Golden glow emanation (800ms cubic-bezier)
                    </div>
                    <div class="flow-arrow">‚¨á</div>
                    <div class="flow-step">
                        <strong>6. Connection Auto-Created</strong> - 'generated-from' relationship established
                    </div>
                </div>

                <div class="highlight-box">
                    <h4>üé® Visual Design</h4>
                    <p>Expandable terms styled with <strong>subtle underline</strong> and <strong>golden glow on hover</strong></p>
                    <p>Emanation animation creates feeling of <strong>knowledge flowing</strong> from parent to child</p>
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üîÑ Fill-In Feature: Knowledge Synthesis</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="card">
                    <h4>Purpose</h4>
                    <p>Synthesize content from connected cards to fill gaps in understanding</p>
                </div>

                <div class="three-column">
                    <div class="card">
                        <h4>Replace Strategy</h4>
                        <p>Generate entirely new content from connected cards</p>
                        <p><strong>Use case:</strong> Complete rewrite based on connections</p>
                    </div>
                    <div class="card">
                        <h4>Append Strategy</h4>
                        <p>Add synthesized content to existing card</p>
                        <p><strong>Use case:</strong> Extend current content</p>
                    </div>
                    <div class="card">
                        <h4>Merge Strategy</h4>
                        <p>Intelligently merge connected content</p>
                        <p><strong>Use case:</strong> Blend perspectives</p>
                    </div>
                </div>

                <div class="code-block">src/services/fillInService.ts</div>
                <p>Builds context from all connected cards via <code>connectionContextService</code></p>
                <p>Stores operation history in <code>fillInHistory</code> for tracking</p>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üé® Beautification Service</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="two-column">
                    <div class="card">
                        <h3>Recreate Design Mode</h3>
                        <p>Uses Claude Vision API to analyze screenshot and recreate visual design</p>
                        <ul class="list">
                            <li>Preserves layout structure</li>
                            <li>Clean, semantic HTML output</li>
                            <li>Removes ads and clutter</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>Organize Content Mode</h3>
                        <p>Restructures content for better readability</p>
                        <ul class="list">
                            <li>Hierarchical organization</li>
                            <li>Improved typography</li>
                            <li>Enhanced scanability</li>
                        </ul>
                    </div>
                </div>
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Security:</strong> All output sanitized with DOMPurify before storage
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üñ•Ô∏è Component Architecture</h2>
        <div class="two-column">
            <div class="card">
                <h3>Canvas Core</h3>
                <h4>Canvas.tsx</h4>
                <ul class="list">
                    <li>React Flow wrapper</li>
                    <li>Card ‚Üí Node conversion</li>
                    <li>Auto-save with debouncing (2s)</li>
                    <li>Keyboard shortcuts</li>
                </ul>

                <h4>CardNode.tsx</h4>
                <ul class="list">
                    <li>Custom React Flow node</li>
                    <li>Content preview with sanitization</li>
                    <li>Inline editing (double-click)</li>
                    <li>Chinese aesthetic styling</li>
                </ul>

                <h4>Toolbar.tsx</h4>
                <ul class="list">
                    <li>Search/filter interface</li>
                    <li>Tag management</li>
                    <li>View controls</li>
                </ul>
            </div>

            <div class="card">
                <h3>Interaction Components</h3>
                <h4>ElementSelector.tsx</h4>
                <ul class="list">
                    <li>Shadow DOM isolation</li>
                    <li>Visual overlay system</li>
                    <li>Element info tooltip</li>
                    <li>Keyboard handling (ESC)</li>
                </ul>

                <h4>ChatModal.tsx</h4>
                <ul class="list">
                    <li>Modal dialog for AI chat</li>
                    <li>Streaming responses</li>
                    <li>Conversation history</li>
                    <li>Keyboard shortcuts</li>
                </ul>

                <h4>FloatingWindow.tsx</h4>
                <ul class="list">
                    <li>Draggable, resizable windows</li>
                    <li>Session persistence</li>
                    <li>Auto-save on close</li>
                </ul>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üì¶ Side Panel System</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="card">
                    <h4>Purpose</h4>
                    <p>Chrome Side Panel for managing stashed cards (hidden from canvas)</p>

                    <h4>Features</h4>
                    <ul class="list">
                        <li><strong>Stash cards</strong> - Hide without deleting</li>
                        <li><strong>Search/filter</strong> - Find stashed cards</li>
                        <li><strong>Restore</strong> - Bring back to canvas</li>
                        <li><strong>Permanent delete</strong> - Remove completely</li>
                        <li><strong>Real-time sync</strong> - Event-based updates</li>
                    </ul>

                    <h4>Implementation</h4>
                    <div class="code-block">
src/sidepanel/SidePanel.tsx       # UI component
src/sidepanel/stashService.ts     # Stash management
chrome.sidePanel.open()           # Access via Chrome API
                    </div>

                    <h4>Event System</h4>
                    <p>Uses <code>'nabokov:stash-updated'</code> custom events for synchronization</p>
                    <p>Canvas filters out <code>card.stashed === true</code> automatically</p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üèóÔ∏è Build System</h2>
        <div class="card">
            <div class="two-column">
                <div>
                    <h4>Build Tools</h4>
                    <ul class="list">
                        <li><strong>Vite 5.0</strong> - Fast build system</li>
                        <li><strong>@crxjs/vite-plugin</strong> - Extension support</li>
                        <li><strong>TypeScript 5.3</strong> - Type checking</li>
                        <li><strong>Emotion CSS-in-JS</strong> - Styling with JSX pragma</li>
                    </ul>
                </div>
                <div>
                    <h4>Path Aliases</h4>
                    <div class="code-block">
@/           ‚Üí src/
@components/ ‚Üí src/components/
@utils/      ‚Üí src/utils/
@types/      ‚Üí src/types/
                    </div>
                </div>
            </div>

            <h4>Build Commands</h4>
            <div class="code-block">
npm run build              # Production build
npm run watch:extension    # Development watch mode
npm run type-check         # TypeScript validation
npm test                   # Vitest unit tests
npm run test:e2e          # Playwright E2E tests
            </div>

            <h4>Build Output</h4>
            <p>Output directory: <code>dist/</code> (git-ignored)</p>
            <p>Manifest copied: <code>src/manifest.json ‚Üí dist/manifest.json</code></p>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>‚ö†Ô∏è Critical Extension Details</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="warning-box">
                    <h4>Extension Reload Requirement</h4>
                    <p>After running <code>npm run build</code>, Chrome caches old code.</p>
                    <p><strong>You MUST reload the extension:</strong></p>
                    <ol class="list">
                        <li>Navigate to <code>chrome://extensions</code></li>
                        <li>Click reload icon (üîÑ) on extension card</li>
                        <li>Refresh any open Canvas pages</li>
                    </ol>
                </div>

                <div class="warning-box">
                    <h4>Screenshot Capture Limitations</h4>
                    <p>Screenshot capture can fail due to:</p>
                    <ul class="list">
                        <li><strong>CORS restrictions</strong> - Cross-origin images</li>
                        <li><strong>Canvas tainting</strong> - Security restrictions</li>
                        <li><strong>Permission issues</strong> - activeTab permission</li>
                    </ul>
                    <p><strong>Solution:</strong> Screenshot capture is optional and non-blocking (fails silently)</p>
                </div>

                <div class="highlight-box">
                    <h4>State Refresh Pattern</h4>
                    <p><strong>Never use</strong> <code>window.location.reload()</code> for state updates!</p>
                    <p><strong>Always use event-based refresh:</strong></p>
                    <div class="code-block">
// Dispatch event after modifying cards
window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));

// Canvas auto-refreshes via listener
window.addEventListener('nabokov:cards-updated', handleCardUpdate);
                    </div>
                    <p>This eliminates race conditions and provides faster UX</p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üß™ Testing Architecture</h2>
        <div class="two-column">
            <div class="card">
                <h3>Unit Tests (Vitest)</h3>
                <ul class="list">
                    <li>Utils and sanitization logic</li>
                    <li>Storage operations</li>
                    <li>Pure functions</li>
                    <li>Component rendering (jsdom)</li>
                </ul>
                <div class="code-block">
tests/unit/
npm test
npm run test:watch
npm run test:coverage
                </div>
            </div>

            <div class="card">
                <h3>E2E Tests (Playwright)</h3>
                <ul class="list">
                    <li>Extension loading verification</li>
                    <li>Element capture flow</li>
                    <li>Canvas rendering</li>
                    <li>Feature integration</li>
                </ul>
                <div class="code-block">
tests/e2e/
npm run test:e2e
npm run test:e2e:headed
npm run test:e2e:debug
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header">
                <span><strong>üî¨ Manual Test Scripts</strong></span>
                <span class="arrow">‚ñ∏</span>
            </div>
            <div class="collapsible-content">
                <div class="card">
                    <h4>Purpose</h4>
                    <p>Playwright-based manual tests that bypass <code>chrome://extensions</code> restrictions</p>

                    <h4>Pattern</h4>
                    <div class="code-block">
const context = await chromium.launchPersistentContext('', {
  args: [
    '--disable-extensions-except=/path/to/dist',
    '--load-extension=/path/to/dist',
  ],
});
                    </div>

                    <h4>Key Scripts</h4>
                    <div class="two-column">
                        <div>
                            <ul class="list">
                                <li><code>test-canvas-direct.mjs</code> - Recommended</li>
                                <li><code>test-card-generation.mjs</code></li>
                                <li><code>test-llm-hyperlinks.mjs</code></li>
                            </ul>
                        </div>
                        <div>
                            <ul class="list">
                                <li><code>test-all-features.mjs</code></li>
                                <li><code>test-api-integration.mjs</code></li>
                                <li><code>test-storage-debug.mjs</code></li>
                            </ul>
                        </div>
                    </div>

                    <p>Located in: <code>test-scripts/tests/</code></p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üìÇ File Organization</h2>
        <div class="code-block">
NabokovsWeb/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ background/           # Service worker (Manifest V3)
‚îÇ   ‚îú‚îÄ‚îÄ content/              # Content scripts for element selection
‚îÇ   ‚îú‚îÄ‚îÄ canvas/               # Canvas React app (React Flow)
‚îÇ   ‚îú‚îÄ‚îÄ sidepanel/            # Chrome Side Panel for stashed cards
‚îÇ   ‚îú‚îÄ‚îÄ components/           # Shared React components
‚îÇ   ‚îú‚îÄ‚îÄ services/             # API services (Claude, card generation, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ claudeAPIService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cardGenerationService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ beautificationService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fillInService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ childCardGenerator.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chatService.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils/                # Utility functions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage.ts        # chrome.storage & IndexedDB
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sanitization.ts   # DOMPurify wrapper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ screenshot.ts     # Screenshot capture & compression
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ instantExpansion.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ imageUpload.ts
‚îÇ   ‚îú‚îÄ‚îÄ types/                # TypeScript definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ card.ts          # Core Card interface (source of truth)
‚îÇ   ‚îú‚îÄ‚îÄ config/               # Configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ defaultButtons.ts
‚îÇ   ‚îî‚îÄ‚îÄ manifest.json         # Extension manifest
‚îú‚îÄ‚îÄ docs/                     # Organized documentation
‚îÇ   ‚îú‚îÄ‚îÄ architecture/         # System design
‚îÇ   ‚îú‚îÄ‚îÄ implementation/       # Dev guides
‚îÇ   ‚îú‚îÄ‚îÄ research/             # User research
‚îÇ   ‚îú‚îÄ‚îÄ testing/              # Test guides
‚îÇ   ‚îî‚îÄ‚îÄ project/              # Status & roadmaps
‚îú‚îÄ‚îÄ test-scripts/
‚îÇ   ‚îú‚îÄ‚îÄ tests/                # Manual test scripts (.mjs)
‚îÇ   ‚îî‚îÄ‚îÄ debug/                # Debug assets (.html, .png)
‚îú‚îÄ‚îÄ tests/                    # Automated tests
‚îÇ   ‚îú‚îÄ‚îÄ unit/                 # Vitest
‚îÇ   ‚îî‚îÄ‚îÄ e2e/                  # Playwright
‚îú‚îÄ‚îÄ scripts/                  # Build utilities
‚îú‚îÄ‚îÄ public/                   # Static assets
‚îú‚îÄ‚îÄ archive/                  # Deprecated code
‚îî‚îÄ‚îÄ dist/                     # Build output (gitignored)
        </div>

        <div class="divider"></div>

        <h2>üéØ Key Design Principles</h2>
        <div class="two-column">
            <div class="card">
                <h3>Security First</h3>
                <ul class="list">
                    <li><strong>DOMPurify sanitization</strong> for all HTML</li>
                    <li><strong>Shadow DOM isolation</strong> for content scripts</li>
                    <li><strong>Secure API key storage</strong> in chrome.storage</li>
                    <li><strong>CORS-aware screenshot</strong> handling</li>
                </ul>
            </div>

            <div class="card">
                <h3>Performance</h3>
                <ul class="list">
                    <li><strong>Debounced auto-save</strong> (2s delay)</li>
                    <li><strong>Event-based updates</strong> instead of reloads</li>
                    <li><strong>Lazy loading</strong> for screenshots</li>
                    <li><strong>IndexedDB</strong> for large binary data</li>
                </ul>
            </div>
        </div>

        <div class="two-column">
            <div class="card">
                <h3>User Experience</h3>
                <ul class="list">
                    <li><strong>Chinese aesthetic</strong> with red/gold palette</li>
                    <li><strong>Smooth animations</strong> (emanation, hover effects)</li>
                    <li><strong>Keyboard shortcuts</strong> for power users</li>
                    <li><strong>Visual feedback</strong> via Toast notifications</li>
                </ul>
            </div>

            <div class="card">
                <h3>Data Integrity</h3>
                <ul class="list">
                    <li><strong>Unique IDs</strong> (timestamp + random)</li>
                    <li><strong>Referential integrity</strong> via parentCardId</li>
                    <li><strong>Connection tracking</strong> separate from cards</li>
                    <li><strong>History tracking</strong> for fill-in operations</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <div class="hero">
            <h3>üéì Research Citation</h3>
            <p>Zhu, F. W., Agrawala, M., & Mysore, G. J. (2024).</p>
            <p><strong>Nabokov: Organize Web Content with LLM-Powered Visual Canvas.</strong></p>
            <p>UIST '24 Companion, Article 42, 1-3.</p>
            <p><a href="https://doi.org/10.1145/3698061.3726916" style="color: var(--chinese-red); font-weight: 700;">https://doi.org/10.1145/3698061.3726916</a></p>
        </div>

    </div>

    <script>
        // Collapsible functionality
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.parentElement;
                collapsible.classList.toggle('open');
            });
        });
    </script>
</body>
</html>