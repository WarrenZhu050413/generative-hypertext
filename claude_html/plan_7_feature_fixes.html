<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Plan: 7 Feature Fixes & Improvements</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #FAF7F2 0%, #F5F0E8 50%, #FAF7F2 100%);
            color: #3E3226;
            padding: 20px;
            line-height: 1.6;
        }

        h1, h2, h3, h4 {
            color: #3E3226;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 28px;
            border-bottom: 3px solid #D4AF37;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 22px;
            color: #8B0000;
            margin-top: 24px;
        }

        h3 {
            font-size: 18px;
            color: #8B7355;
            margin-top: 16px;
        }

        .important-always-visible {
            background: rgba(212, 175, 55, 0.15);
            border: 2px solid #D4AF37;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        @media (max-width: 900px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }

        .collapsible {
            background: rgba(250, 247, 242, 0.95);
            border: 1px solid rgba(184, 156, 130, 0.3);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible.critical {
            border: 2px solid #D4AF37;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2);
        }

        .collapsible.secondary {
            border: 1px solid rgba(139, 115, 85, 0.3);
        }

        .collapsible.full-width {
            grid-column: 1 / -1;
        }

        .collapsible-header {
            background: rgba(212, 175, 55, 0.1);
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #5C4D42;
            border-bottom: 1px solid rgba(184, 156, 130, 0.2);
        }

        .collapsible.critical .collapsible-header {
            background: rgba(212, 175, 55, 0.2);
            color: #3E3226;
        }

        .collapsible-header:hover {
            background: rgba(212, 175, 55, 0.25);
        }

        .collapsible-content {
            padding: 16px;
            display: none;
        }

        .collapsible[data-collapsible="open"] .collapsible-content {
            display: block;
        }

        .collapsible[data-collapsible="open"] .arrow {
            transform: rotate(90deg);
        }

        .arrow {
            transition: transform 0.2s;
            color: #D4AF37;
            font-size: 14px;
        }

        .metric {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(139, 115, 85, 0.1);
            border-radius: 6px;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 600;
        }

        .metric.important {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #D4AF37;
            color: #8B7355;
        }

        .metric.critical {
            background: rgba(139, 0, 0, 0.1);
            border: 1px solid #8B0000;
            color: #8B0000;
        }

        .dense-list {
            margin-left: 20px;
        }

        .dense-list li {
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .dense-list strong {
            color: #8B7355;
        }

        .indent-1 {
            margin-left: 20px;
            font-size: 13px;
            margin-top: 4px;
        }

        .muted {
            color: #8B7355;
            font-style: italic;
        }

        .code {
            background: rgba(139, 115, 85, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #5C4D42;
        }

        .file-path {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #2E7D32;
            display: inline-block;
            margin-top: 4px;
        }

        .warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 4px solid #FF9800;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }

        .info {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196F3;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }

        button {
            background: #D4AF37;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 8px;
            transition: all 0.2s;
        }

        button:hover {
            background: #C19B2E;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(184, 156, 130, 0.2);
        }

        th {
            background: rgba(212, 175, 55, 0.15);
            font-weight: 600;
            color: #5C4D42;
        }

        tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .issue-card {
            background: white;
            border: 1px solid rgba(184, 156, 130, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .issue-number {
            display: inline-block;
            background: #D4AF37;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 8px;
        }

        .complexity-low { color: #4CAF50; }
        .complexity-medium { color: #FF9800; }
        .complexity-high { color: #F44336; }
    </style>
</head>
<body>
    <!-- Expand/Collapse Controls -->
    <div style="margin: 8px 0; text-align: right;">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
    </div>

    <!-- Executive Summary (Always Visible) -->
    <div class="important-always-visible">
        <h1>📋 Implementation Plan: 7 Feature Fixes & Improvements</h1>
        <div class="two-column-layout">
            <div>
                <h3>Objective</h3>
                <p>Fix 7 critical issues and implement UX improvements across the Nabokov Web Clipper extension:</p>
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>Card size preservation bug</li>
                    <li>Skeleton loading for generated cards</li>
                    <li>Auto-beautification toggle</li>
                    <li>Side panel stash improvements</li>
                    <li>Newline preservation in notes</li>
                    <li>Native AI chat integration</li>
                    <li>Remove mock AI responses</li>
                </ul>
            </div>
            <div>
                <h3>Approach</h3>
                <p>Systematic fixes with focus on data integrity, UX consistency, and real API integration.</p>
                <div class="metric important">Overall Complexity: <span class="complexity-medium">MEDIUM-HIGH</span></div>
                <div class="metric">Estimated Time: 3-4 hours</div>
                <div class="metric">Files to Modify: ~15</div>
                <div class="metric">New Tests Required: ~25</div>
            </div>
        </div>
    </div>

    <!-- Issues Overview -->
    <div class="collapsible critical full-width" data-collapsible="open">
        <div class="collapsible-header">
            <span>🎯 Issues Overview & Priority</span>
            <span class="arrow">▶</span>
        </div>
        <div class="collapsible-content">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Issue</th>
                        <th>Priority</th>
                        <th>Complexity</th>
                        <th>Impact</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="issue-number">1</span></td>
                        <td>Card size resets on tick/star</td>
                        <td style="color: #F44336;">HIGH</td>
                        <td class="complexity-low">LOW</td>
                        <td>Data loss, user frustration</td>
                    </tr>
                    <tr>
                        <td><span class="issue-number">2</span></td>
                        <td>Skeleton loading for generated cards</td>
                        <td style="color: #FF9800;">MEDIUM</td>
                        <td class="complexity-medium">MEDIUM</td>
                        <td>UX improvement, perceived performance</td>
                    </tr>
                    <tr>
                        <td><span class="issue-number">3</span></td>
                        <td>Auto-beautification setting</td>
                        <td style="color: #FF9800;">MEDIUM</td>
                        <td class="complexity-low">LOW</td>
                        <td>Optional automation, convenience</td>
                    </tr>
                    <tr>
                        <td><span class="issue-number">4</span></td>
                        <td>Side panel stash + button layout</td>
                        <td style="color: #F44336;">HIGH</td>
                        <td class="complexity-high">HIGH</td>
                        <td>Core feature not working well</td>
                    </tr>
                    <tr>
                        <td><span class="issue-number">5</span></td>
                        <td>Newlines removed in notes</td>
                        <td style="color: #F44336;">HIGH</td>
                        <td class="complexity-medium">MEDIUM</td>
                        <td>Data integrity, formatting loss</td>
                    </tr>
                    <tr>
                        <td><span class="issue-number">6</span></td>
                        <td>AI chat as native feature</td>
                        <td style="color: #FF9800;">MEDIUM</td>
                        <td class="complexity-medium">MEDIUM</td>
                        <td>Discoverability, UX improvement</td>
                    </tr>
                    <tr>
                        <td><span class="issue-number">7</span></td>
                        <td>Remove mock AI responses</td>
                        <td style="color: #4CAF50;">LOW</td>
                        <td class="complexity-low">LOW</td>
                        <td>Production readiness, clarity</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Two-Column Layout for Main Content -->
    <div class="two-column-layout">
        <!-- Left Column: Issue #1 -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>🐛 Issue #1: Card Size Reset on Tick</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>When user clicks "tick" (star) on a card, the card's custom size resets to default instead of preserving the user-adjusted dimensions.</p>

                    <h4 style="margin-top: 12px;">Root Cause</h4>
                    <p>The <span class="code">updateCard</span> function or star toggle handler likely creates a new card object without preserving the <span class="code">size</span> property.</p>

                    <h4 style="margin-top: 12px;">Solution Steps</h4>
                    <ol class="dense-list">
                        <li><strong>Investigate:</strong> Check CardNode.tsx star toggle handler
                            <div class="file-path">src/canvas/CardNode.tsx</div>
                        </li>
                        <li><strong>Fix:</strong> Ensure <span class="code">updateCard</span> spreads existing card properties including size
                            <div class="indent-1 muted">Look for: <span class="code">starred: !card.starred</span></div>
                            <div class="indent-1 muted">Ensure: <span class="code">...card</span> comes first</div>
                        </li>
                        <li><strong>Verify:</strong> Check storage.ts saveCard function preserves all properties
                            <div class="file-path">src/utils/storage.ts</div>
                        </li>
                        <li><strong>Test:</strong> Manually resize card, star it, verify size unchanged</li>
                    </ol>

                    <div class="metric">Complexity: <span class="complexity-low">LOW</span></div>
                    <div class="metric">Time: 15-30 min</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Issue #2 -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>✨ Issue #2: Skeleton Loading for Generated Cards</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>When generating a new card via AI, the card appears only after content is fully generated, making the UI feel unresponsive.</p>

                    <h4 style="margin-top: 12px;">Desired Behavior</h4>
                    <p>Create skeleton/outline card immediately, then stream content in progressively.</p>

                    <h4 style="margin-top: 12px;">Solution Steps</h4>
                    <ol class="dense-list">
                        <li><strong>Create skeleton card type:</strong> Add <span class="code">isLoading</span> flag to Card type
                            <div class="file-path">src/types/card.ts</div>
                        </li>
                        <li><strong>Modify card generation:</strong> Update cardGenerationService
                            <div class="file-path">src/services/cardGenerationService.ts</div>
                            <div class="indent-1 muted">Create card with <span class="code">content: '&lt;p&gt;Generating...&lt;/p&gt;', isLoading: true</span></div>
                        </li>
                        <li><strong>Add skeleton UI:</strong> Update CardNode to show loading state
                            <div class="file-path">src/canvas/CardNode.tsx</div>
                            <div class="indent-1 muted">Render pulsing skeleton when <span class="code">card.isLoading === true</span></div>
                        </li>
                        <li><strong>Stream content:</strong> Update streaming logic to update existing card
                            <div class="indent-1 muted">Use <span class="code">updateCard</span> instead of creating new card</div>
                        </li>
                        <li><strong>Clear loading state:</strong> Set <span class="code">isLoading: false</span> when complete</li>
                    </ol>

                    <div class="metric">Complexity: <span class="complexity-medium">MEDIUM</span></div>
                    <div class="metric">Time: 1-1.5 hours</div>
                </div>
            </div>
        </div>

        <!-- Issue #3 -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>🎨 Issue #3: Auto-Beautification Setting</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>No automatic beautification option for captured cards. User wants toggle to auto-beautify on capture.</p>

                    <h4 style="margin-top: 12px;">Solution Steps</h4>
                    <ol class="dense-list">
                        <li><strong>Add setting:</strong> Create <span class="code">autoBeautify</span> boolean in chrome.storage
                            <div class="file-path">src/components/SettingsPanel.tsx</div>
                        </li>
                        <li><strong>Add UI toggle:</strong> Add checkbox in Settings panel
                            <div class="indent-1 muted">Label: "Auto-beautify captured cards"</div>
                            <div class="indent-1 muted">Default: false (off)</div>
                        </li>
                        <li><strong>Integrate with capture:</strong> Check setting in ElementSelector
                            <div class="file-path">src/components/ElementSelector.tsx</div>
                            <div class="indent-1 muted">After card creation, if autoBeautify enabled, call beautificationService</div>
                        </li>
                        <li><strong>Add feedback:</strong> Show toast notification when auto-beautifying</li>
                    </ol>

                    <div class="metric">Complexity: <span class="complexity-low">LOW</span></div>
                    <div class="metric">Time: 30-45 min</div>
                </div>
            </div>
        </div>

        <!-- Issue #4 -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>🗂️ Issue #4: Side Panel Stash & Button Layout</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>Two issues:</p>
                    <ol style="margin-left: 20px;">
                        <li>Stash to side panel doesn't work well</li>
                        <li>Wants all buttons laid out (not in dropdown panel at top)</li>
                    </ol>

                    <h4 style="margin-top: 12px;">Investigation Needed</h4>
                    <div class="warning">
                        <strong>⚠️ Need Clarification:</strong>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            <li>What specifically doesn't work about stash? (cards not appearing, sync issues, etc.)</li>
                            <li>Which buttons are in dropdown? Card action buttons?</li>
                            <li>Where should buttons be laid out? On card itself? In toolbar?</li>
                        </ul>
                    </div>

                    <h4 style="margin-top: 12px;">Proposed Solution (pending clarification)</h4>
                    <ol class="dense-list">
                        <li><strong>Debug stash:</strong> Test stash functionality
                            <div class="file-path">src/sidepanel/stashService.ts</div>
                            <div class="file-path">src/sidepanel/SidePanel.tsx</div>
                            <div class="indent-1 muted">Check: Card marked with <span class="code">stashed: true</span></div>
                            <div class="indent-1 muted">Check: Event <span class="code">nabokov:stash-updated</span> firing</div>
                            <div class="indent-1 muted">Check: Side panel filtering stashed cards</div>
                        </li>
                        <li><strong>Fix sync issues:</strong> Ensure cross-context events work
                            <div class="indent-1 muted">Use <span class="code">chrome.runtime.sendMessage</span> for broadcast</div>
                        </li>
                        <li><strong>Remove dropdown:</strong> Find and remove dropdown button container
                            <div class="file-path">src/canvas/CardNode.tsx</div>
                            <div class="indent-1 muted">Look for action menu/dropdown component</div>
                        </li>
                        <li><strong>Layout buttons:</strong> Display all action buttons inline
                            <div class="indent-1 muted">Use flexbox layout for button row</div>
                            <div class="indent-1 muted">Consider button size/spacing for multiple buttons</div>
                        </li>
                    </ol>

                    <div class="metric">Complexity: <span class="complexity-high">HIGH</span></div>
                    <div class="metric">Time: 1.5-2 hours</div>
                </div>
            </div>
        </div>

        <!-- Issue #5 -->
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>📝 Issue #5: Newlines Removed in Notes</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>When saving notes, newlines are removed/not preserved, losing formatting structure.</p>

                    <h4 style="margin-top: 12px;">Root Cause</h4>
                    <p>Likely DOMPurify sanitization or <span class="code">contentEditable</span> handling stripping whitespace.</p>

                    <h4 style="margin-top: 12px;">Solution Steps</h4>
                    <ol class="dense-list">
                        <li><strong>Investigate sanitization:</strong> Check DOMPurify config
                            <div class="file-path">src/utils/sanitize.ts</div>
                            <div class="indent-1 muted">Ensure ALLOW_WHITESPACE or preserve <span class="code">&lt;br&gt;</span> tags</div>
                        </li>
                        <li><strong>Check inline editing:</strong> Verify contentEditable preserves structure
                            <div class="file-path">src/canvas/CardNode.tsx</div>
                            <div class="indent-1 muted">When Enter pressed, insert <span class="code">&lt;br&gt;</span> or <span class="code">&lt;p&gt;</span> tag</div>
                        </li>
                        <li><strong>Fix save logic:</strong> Ensure innerHTML preserves newlines
                            <div class="indent-1 muted">Convert newlines to <span class="code">&lt;br&gt;</span> before saving</div>
                            <div class="indent-1 muted">Or use <span class="code">white-space: pre-wrap</span> CSS</div>
                        </li>
                        <li><strong>Test multi-line notes:</strong> Create note with multiple paragraphs
                            <div class="indent-1 muted">Save and reload, verify structure preserved</div>
                        </li>
                    </ol>

                    <div class="warning">
                        <strong>⚠️ Critical Fix:</strong> This is a data integrity issue. Must preserve user input exactly.
                    </div>

                    <div class="metric">Complexity: <span class="complexity-medium">MEDIUM</span></div>
                    <div class="metric">Time: 45 min - 1 hour</div>
                </div>
            </div>
        </div>

        <!-- Issue #6 -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>💬 Issue #6: AI Chat as Native Feature</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>AI chat exists but isn't prominent. User wants it as a native, first-class feature.</p>

                    <h4 style="margin-top: 12px;">Solution Steps</h4>
                    <ol class="dense-list">
                        <li><strong>Add chat button to card:</strong> Display chat icon on every card
                            <div class="file-path">src/canvas/CardNode.tsx</div>
                            <div class="indent-1 muted">Add button to card header/footer</div>
                            <div class="indent-1 muted">Icon: 💬 or chat bubble SVG</div>
                        </li>
                        <li><strong>Open chat modal on click:</strong> Show ChatModal or FloatingWindow
                            <div class="file-path">src/canvas/ChatModal.tsx</div>
                            <div class="indent-1 muted">Pre-populate with card context</div>
                        </li>
                        <li><strong>Show chat indicator:</strong> If card has conversation history, show badge
                            <div class="indent-1 muted">E.g., "3 messages" badge on chat button</div>
                        </li>
                        <li><strong>Keyboard shortcut:</strong> Add shortcut to open chat (e.g., 'M' for message)
                            <div class="file-path">src/canvas/keyboardShortcuts.css</div>
                        </li>
                    </ol>

                    <div class="metric">Complexity: <span class="complexity-medium">MEDIUM</span></div>
                    <div class="metric">Time: 1 hour</div>
                </div>
            </div>
        </div>

        <!-- Issue #7 -->
        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>🚫 Issue #7: Remove Mock AI Responses</span>
                <span class="arrow">▶</span>
            </div>
            <div class="collapsible-content">
                <div class="issue-card">
                    <h4>Problem</h4>
                    <p>Mock AI responses still present. Want to remove all mocks and remind user to start local server if backend not running.</p>

                    <h4 style="margin-top: 12px;">Solution Steps</h4>
                    <ol class="dense-list">
                        <li><strong>Find all mock responses:</strong> Search for mock generators
                            <div class="indent-1 muted">Search: <span class="code">mock</span>, <span class="code">fallback</span></div>
                            <div class="file-path">src/services/claudeAPIService.ts</div>
                            <div class="file-path">src/services/cardGenerationService.ts</div>
                            <div class="file-path">src/services/beautificationService.ts</div>
                            <div class="file-path">src/services/fillInService.ts</div>
                            <div class="file-path">src/services/childCardGenerator.ts</div>
                        </li>
                        <li><strong>Remove mock code:</strong> Delete all fallback/mock response logic
                            <div class="indent-1 muted">Remove: <span class="code">if (!apiKey) return mockResponse()</span></div>
                        </li>
                        <li><strong>Add error handling:</strong> Show clear error when API not available
                            <div class="indent-1 muted">Check: <span class="code">apiConfigService.hasAPIKey()</span></div>
                            <div class="indent-1 muted">Show: "Claude API key not configured. Please add API key in settings."</div>
                        </li>
                        <li><strong>Check backend connection:</strong> For local server features
                            <div class="indent-1 muted">Try fetch to backend, catch error</div>
                            <div class="indent-1 muted">Show: "Local server not running. Please start with: <span class="code">npm run server</span>"</div>
                        </li>
                        <li><strong>Update Toast messages:</strong> Replace mock success toasts
                            <div class="file-path">src/components/Toast.tsx</div>
                        </li>
                    </ol>

                    <div class="info">
                        <strong>ℹ️ Production Readiness:</strong> This ensures users understand when features require backend/API setup.
                    </div>

                    <div class="metric">Complexity: <span class="complexity-low">LOW</span></div>
                    <div class="metric">Time: 30-45 min</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Testing Strategy -->
    <div class="collapsible critical full-width" data-collapsible="open">
        <div class="collapsible-header">
            <span>✅ Testing & Validation Strategy</span>
            <span class="arrow">▶</span>
        </div>
        <div class="collapsible-content">
            <h3>Unit Tests Required (~25 new tests)</h3>
            <ol class="dense-list">
                <li><strong>Issue #1 - Card size preservation:</strong> 3 tests
                    <div class="indent-1 muted">Test: updateCard preserves size property</div>
                    <div class="indent-1 muted">Test: Star toggle doesn't reset size</div>
                    <div class="indent-1 muted">Test: saveCard preserves all properties</div>
                </li>
                <li><strong>Issue #2 - Skeleton loading:</strong> 5 tests
                    <div class="indent-1 muted">Test: Skeleton card created immediately</div>
                    <div class="indent-1 muted">Test: isLoading flag set correctly</div>
                    <div class="indent-1 muted">Test: Content streams into existing card</div>
                    <div class="indent-1 muted">Test: isLoading cleared on completion</div>
                    <div class="indent-1 muted">Test: Error handling clears loading state</div>
                </li>
                <li><strong>Issue #3 - Auto-beautify:</strong> 4 tests
                    <div class="indent-1 muted">Test: Setting saves/loads correctly</div>
                    <div class="indent-1 muted">Test: Beautification triggered when enabled</div>
                    <div class="indent-1 muted">Test: Beautification skipped when disabled</div>
                    <div class="indent-1 muted">Test: Toast shown during auto-beautify</div>
                </li>
                <li><strong>Issue #5 - Newline preservation:</strong> 4 tests
                    <div class="indent-1 muted">Test: DOMPurify preserves &lt;br&gt; tags</div>
                    <div class="indent-1 muted">Test: Multi-line content saves correctly</div>
                    <div class="indent-1 muted">Test: contentEditable preserves structure</div>
                    <div class="indent-1 muted">Test: Loaded content displays with newlines</div>
                </li>
                <li><strong>Issue #7 - Mock removal:</strong> 5 tests
                    <div class="indent-1 muted">Test: API error thrown when no key configured</div>
                    <div class="indent-1 muted">Test: Error message mentions API key</div>
                    <div class="indent-1 muted">Test: Backend connection checked before call</div>
                    <div class="indent-1 muted">Test: Server error message shown correctly</div>
                    <div class="indent-1 muted">Test: All mock code paths removed</div>
                </li>
            </ol>

            <h3 style="margin-top: 24px;">E2E Tests Required (~4 new scenarios)</h3>
            <ol class="dense-list">
                <li><strong>Card size persistence:</strong> Resize card, star it, verify size unchanged</li>
                <li><strong>Skeleton loading:</strong> Generate card, verify skeleton appears immediately</li>
                <li><strong>Newline preservation:</strong> Create multi-line note, save, reload, verify structure</li>
                <li><strong>Error handling:</strong> Trigger AI action without API key, verify error message</li>
            </ol>

            <h3 style="margin-top: 24px;">Manual Testing Checklist</h3>
            <ul class="dense-list">
                <li>✓ Resize card to custom size, star/unstar, verify size preserved</li>
                <li>✓ Generate new card, observe skeleton animation</li>
                <li>✓ Enable auto-beautify, capture card, verify beautification runs</li>
                <li>✓ Stash card, open side panel, verify card appears</li>
                <li>✓ Create note with multiple paragraphs, verify newlines on reload</li>
                <li>✓ Click chat button on card, verify modal opens</li>
                <li>✓ Trigger AI action without API key, verify error message</li>
            </ul>
        </div>
    </div>

    <!-- Implementation Order -->
    <div class="collapsible secondary full-width" data-collapsible="open">
        <div class="collapsible-header">
            <span>📋 Recommended Implementation Order</span>
            <span class="arrow">▶</span>
        </div>
        <div class="collapsible-content">
            <h3>Phase 1: Critical Fixes (Priority HIGH)</h3>
            <ol class="dense-list">
                <li><strong>Issue #1:</strong> Card size reset on tick (15-30 min) - Data integrity issue</li>
                <li><strong>Issue #5:</strong> Newlines removed in notes (45-60 min) - Data integrity issue</li>
                <li><strong>Issue #4:</strong> Side panel stash & button layout (1.5-2 hours) - Core feature broken</li>
            </ol>

            <h3 style="margin-top: 16px;">Phase 2: UX Improvements (Priority MEDIUM)</h3>
            <ol class="dense-list">
                <li><strong>Issue #2:</strong> Skeleton loading (1-1.5 hours) - Perceived performance</li>
                <li><strong>Issue #6:</strong> AI chat as native feature (1 hour) - Discoverability</li>
                <li><strong>Issue #3:</strong> Auto-beautification (30-45 min) - Convenience</li>
            </ol>

            <h3 style="margin-top: 16px;">Phase 3: Production Cleanup (Priority LOW)</h3>
            <ol class="dense-list">
                <li><strong>Issue #7:</strong> Remove mock AI (30-45 min) - Production readiness</li>
            </ol>

            <div class="warning" style="margin-top: 16px;">
                <strong>⚠️ Dependencies:</strong>
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>Issue #7 (remove mocks) should be done LAST after testing other features work with real API</li>
                    <li>Issue #4 needs clarification from user before implementation</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Potential Issues -->
    <div class="collapsible secondary full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>⚠️ Potential Issues & Mitigations</span>
            <span class="arrow">▶</span>
        </div>
        <div class="collapsible-content">
            <h3>Issue #1 - Card Size Reset</h3>
            <ul class="dense-list">
                <li><strong>Risk:</strong> Size property might be stored in React Flow state, not card data
                    <div class="indent-1 muted">Mitigation: Check useCanvasState.ts for position/size sync logic</div>
                </li>
            </ul>

            <h3 style="margin-top: 16px;">Issue #2 - Skeleton Loading</h3>
            <ul class="dense-list">
                <li><strong>Risk:</strong> Streaming API might create new card instead of updating
                    <div class="indent-1 muted">Mitigation: Ensure streaming uses updateCard with same ID</div>
                </li>
                <li><strong>Risk:</strong> Loading state might not trigger React re-render
                    <div class="indent-1 muted">Mitigation: Use state management or event-based updates</div>
                </li>
            </ul>

            <h3 style="margin-top: 16px;">Issue #4 - Side Panel Stash</h3>
            <ul class="dense-list">
                <li><strong>Risk:</strong> Unclear requirements, might need user clarification
                    <div class="indent-1 muted">Mitigation: Ask specific questions before implementation</div>
                </li>
                <li><strong>Risk:</strong> Cross-context messaging might not work in all scenarios
                    <div class="indent-1 muted">Mitigation: Use both runtime messages AND storage events</div>
                </li>
            </ul>

            <h3 style="margin-top: 16px;">Issue #5 - Newline Preservation</h3>
            <ul class="dense-list">
                <li><strong>Risk:</strong> DOMPurify might strip necessary whitespace tags
                    <div class="indent-1 muted">Mitigation: Configure ALLOWED_TAGS to include &lt;br&gt;, &lt;p&gt;</div>
                </li>
                <li><strong>Risk:</strong> Different browsers handle contentEditable differently
                    <div class="indent-1 muted">Mitigation: Test in Chrome (extension target) specifically</div>
                </li>
            </ul>

            <h3 style="margin-top: 16px;">Issue #7 - Remove Mocks</h3>
            <ul class="dense-list">
                <li><strong>Risk:</strong> Breaking existing functionality if mocks removed too early
                    <div class="indent-1 muted">Mitigation: Do this LAST after real API integration verified</div>
                </li>
                <li><strong>Risk:</strong> Users might not understand why features suddenly "don't work"
                    <div class="indent-1 muted">Mitigation: Clear, helpful error messages with setup instructions</div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Post-Implementation -->
    <div class="collapsible secondary full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>📊 Post-Implementation Tasks</span>
            <span class="arrow">▶</span>
        </div>
        <div class="collapsible-content">
            <h3>Documentation Updates</h3>
            <ul class="dense-list">
                <li>Update README with auto-beautify setting</li>
                <li>Document newline handling in CLAUDE.md</li>
                <li>Add API setup instructions for new users</li>
                <li>Update keyboard shortcuts list if chat shortcut added</li>
            </ul>

            <h3 style="margin-top: 16px;">Testing</h3>
            <ul class="dense-list">
                <li>Run full test suite: <span class="code">npm test</span></li>
                <li>Run E2E tests: <span class="code">npm run test:e2e:headed</span></li>
                <li>Add new tests to CI pipeline</li>
                <li>Manual QA of all 7 fixes</li>
            </ul>

            <h3 style="margin-top: 16px;">Build & Deployment</h3>
            <ul class="dense-list">
                <li>Verify clean build: <span class="code">npm run build</span></li>
                <li>Check bundle size impact</li>
                <li>Test in clean Chrome profile</li>
                <li>Update version in manifest.json (0.1.0 → 0.1.1)</li>
            </ul>

            <h3 style="margin-top: 16px;">User Communication</h3>
            <ul class="dense-list">
                <li>Create changelog entry for all 7 fixes</li>
                <li>Note breaking change: Mock AI responses removed</li>
                <li>Provide migration guide if needed</li>
            </ul>
        </div>
    </div>

    <!-- Summary -->
    <div class="important-always-visible" style="margin-top: 24px;">
        <h2>🎯 Summary</h2>
        <p><strong>Total Time Estimate:</strong> 6-8 hours (including testing)</p>
        <p><strong>Files to Modify:</strong> ~15 files</p>
        <p><strong>New Tests:</strong> ~25 unit + 4 E2E</p>
        <p><strong>Priority Order:</strong> Issues #1, #5, #4 (critical) → #2, #6, #3 (UX) → #7 (cleanup)</p>

        <div class="warning" style="margin-top: 16px;">
            <strong>⚠️ Requires User Clarification:</strong>
            <p style="margin-top: 8px;">Issue #4 (side panel stash & button layout) needs more details:</p>
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li>What specifically doesn't work about stash?</li>
                <li>Which buttons are in dropdown panel?</li>
                <li>Where should buttons be displayed instead?</li>
            </ul>
        </div>
    </div>

    <script>
        // Collapsible functionality
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.parentElement;
                const isOpen = collapsible.getAttribute('data-collapsible') === 'open';
                collapsible.setAttribute('data-collapsible', isOpen ? 'closed' : 'open');
            });
        });

        // Expand/Collapse all buttons
        document.getElementById('expand-all').addEventListener('click', () => {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.setAttribute('data-collapsible', 'open');
            });
        });

        document.getElementById('collapse-all').addEventListener('click', () => {
            document.querySelectorAll('.collapsible').forEach(el => {
                // Don't collapse the always-visible sections
                if (!el.classList.contains('important-always-visible')) {
                    el.setAttribute('data-collapsible', 'closed');
                }
            });
        });
    </script>
</body>
</html>
