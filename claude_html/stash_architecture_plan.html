<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stash System Architecture Plan</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #D4AF37;
            --paper-beige: #FAF7F2;
            --light-cream: #F2EBE1;
            --ink-black: #2C1810;
            --level-1: #3E3226;
            --level-2: #5C4D42;
            --level-3: #8B7355;
            --level-4: #A89684;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.5;
            font-size: 14px;
        }

        * {
            box-sizing: border-box;
        }

        h1 {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0 16px 0;
            padding: 12px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 3px solid var(--chinese-gold);
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 20px 0 8px 0;
            padding: 8px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 12px 0 6px 0;
            color: var(--level-2);
        }

        .critical-box {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
            border: 2px solid var(--chinese-red);
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }

        .solution-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }

        .info-box {
            background: rgba(212, 175, 55, 0.08);
            border-left: 3px solid var(--chinese-gold);
            padding: 10px;
            margin: 8px 0;
        }

        code {
            background: rgba(245, 245, 220, 0.5);
            border: 1px solid rgba(139, 0, 0, 0.15);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--chinese-red);
        }

        pre {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 4px;
            padding: 12px;
            overflow-x: auto;
            margin: 8px 0;
        }

        pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--ink-black);
        }

        ul {
            margin: 8px 0;
            padding-left: 24px;
        }

        li {
            margin: 6px 0;
            line-height: 1.6;
        }

        strong {
            color: var(--chinese-red);
            font-weight: 600;
        }

        .step-number {
            display: inline-block;
            background: var(--chinese-gold);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: 700;
            margin-right: 8px;
        }

        .architecture-diagram {
            background: white;
            border: 2px solid var(--chinese-gold);
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.8;
        }

        .arrow {
            color: var(--chinese-red);
            font-weight: 700;
        }

        .context-box {
            display: inline-block;
            background: rgba(139, 0, 0, 0.08);
            border: 1px solid var(--chinese-red);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            color: var(--level-1);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--chinese-gold);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid rgba(184, 156, 130, 0.2);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .priority-high {
            color: var(--chinese-red);
            font-weight: 700;
        }

        .priority-medium {
            color: var(--chinese-gold);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <h1>üèóÔ∏è Stash System Architecture Plan</h1>

    <div class="critical-box">
        <h2>üî¥ Current Problems Identified</h2>

        <h3>Problem 1: Stash Immediately Checkbox Not Working</h3>
        <p><strong>Why:</strong> The checkbox state exists and is passed to the card, but the side panel may not be showing stashed cards correctly because of filtering or event issues.</p>

        <h3>Problem 2: Side Panel Not Reactive</h3>
        <p><strong>Root Cause:</strong> Chrome extension contexts are <strong>isolated</strong>. Events fired in one context don't reach other contexts.</p>

        <div class="architecture-diagram">
<strong>Current (Broken) Event Flow:</strong>

<span class="context-box">ElementSelector</span> (Content Script)
    ‚Üì saves card with stashed:true
    ‚Üì dispatches window.event
    ‚Üì
<span class="context-box">‚ùå Event Lost</span> (different JS context)
    ‚Üì
<span class="context-box">Side Panel</span> (Extension Page) <strong>‚Üê NEVER RECEIVES EVENT</strong>
        </div>

        <div class="info-box">
            <strong>Key Insight:</strong> <code>window.dispatchEvent()</code> only works within the same page context. Side Panel, Canvas, and Content Scripts are all <strong>separate JavaScript contexts</strong> and cannot communicate via DOM events.
        </div>
    </div>

    <div class="solution-box">
        <h2>‚úÖ Solution: Chrome Runtime Messaging</h2>

        <p>Chrome extensions use <code>chrome.runtime.sendMessage()</code> to communicate across contexts. This broadcasts messages to all extension pages and service workers.</p>

        <div class="architecture-diagram">
<strong>Correct Event Flow:</strong>

<span class="context-box">ElementSelector</span> (Content Script)
    ‚Üì saves card
    ‚Üì chrome.runtime.sendMessage({ type: 'STASH_UPDATED' })
    ‚Üì
<span class="context-box">Background Worker</span> (broadcasts to all)
    ‚Üì
    ‚îú‚îÄ<span class="arrow">‚Üí</span> <span class="context-box">Canvas</span> (listens, refreshes)
    ‚îú‚îÄ<span class="arrow">‚Üí</span> <span class="context-box">Side Panel</span> (listens, refreshes) ‚úÖ
    ‚îî‚îÄ<span class="arrow">‚Üí</span> <span class="context-box">Other tabs</span> (sync across tabs)
        </div>
    </div>

    <h2>üìã Implementation Plan</h2>

    <h3><span class="step-number">1</span> Add New Keyboard Command</h3>

    <p>Add Cmd+Shift+Option+E shortcut for instant stash mode.</p>

    <div class="info-box">
        <strong>File:</strong> <code>src/manifest.json</code>
    </div>

    <pre><code>"commands": {
  "activate-selector": {
    "suggested_key": {
      "default": "Ctrl+Shift+E",
      "mac": "Command+Shift+E"
    },
    "description": "Activate element selector"
  },
  <strong>"activate-selector-stash": {
    "suggested_key": {
      "default": "Ctrl+Shift+Alt+E",
      "mac": "Command+Shift+Option+E"
    },
    "description": "Activate element selector (stash immediately)"
  }</strong>
}</code></pre>

    <h3><span class="step-number">2</span> Handle New Command in Background</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/background/index.ts</code>
    </div>

    <pre><code>chrome.commands.onCommand.addListener((command) => {
  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    if (!tabs[0]?.id) return;

    if (command === 'activate-selector') {
      chrome.tabs.sendMessage(tabs[0].id, {
        type: 'ACTIVATE_SELECTOR',
        <strong>stashImmediately: false</strong>
      });
    }
    <strong>else if (command === 'activate-selector-stash') {
      chrome.tabs.sendMessage(tabs[0].id, {
        type: 'ACTIVATE_SELECTOR',
        stashImmediately: true
      });
    }</strong>
  });
});</code></pre>

    <h3><span class="step-number">3</span> Update ElementSelector to Accept Initial Stash State</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/components/ElementSelector.tsx</code>
    </div>

    <pre><code>export interface ElementSelectorProps {
  onCapture?: (card: Card) => void;
  onClose?: () => void;
  <strong>initialStashState?: boolean; // NEW</strong>
}

export const ElementSelector: FC&lt;ElementSelectorProps&gt; = ({
  onCapture,
  onClose,
  <strong>initialStashState = false, // NEW</strong>
}) => {
  const [stashImmediately, setStashImmediately] = useState(<strong>initialStashState</strong>);
  // ...
};</code></pre>

    <h3><span class="step-number">4</span> Update Content Script to Pass Stash State</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/content/index.tsx</code>
    </div>

    <pre><code>chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'ACTIVATE_SELECTOR') {
    // Mount ElementSelector with initial stash state
    mountElementSelector({
      <strong>initialStashState: message.stashImmediately || false,</strong>
    });
  }
  return true;
});</code></pre>

    <h3><span class="step-number">5</span> Broadcast Stash Events via Chrome Runtime</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/components/ElementSelector.tsx</code> (after saving card)
    </div>

    <pre><code>// After saving card
await saveCard(card);

<strong>// Broadcast to all extension contexts
chrome.runtime.sendMessage({
  type: 'CARD_STASHED',
  cardId: card.id,
  stashed: card.stashed
});</strong>

// Also keep local event for same-page updates
window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));</code></pre>

    <h3><span class="step-number">6</span> Add Runtime Message Listener to Side Panel</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/sidepanel/SidePanel.tsx</code>
    </div>

    <pre><code>useEffect(() => {
  loadStashedCards();

  // Listen for local events (same page)
  const handleStashUpdate = () => {
    loadStashedCards();
  };
  window.addEventListener('nabokov:stash-updated', handleStashUpdate);

  <strong>// Listen for runtime messages (cross-context)
  const handleRuntimeMessage = (message: any) => {
    if (message.type === 'CARD_STASHED' || message.type === 'STASH_UPDATED') {
      console.log('[SidePanel] Received stash update via runtime message');
      loadStashedCards();
    }
  };
  chrome.runtime.onMessage.addListener(handleRuntimeMessage);</strong>

  return () => {
    window.removeEventListener('nabokov:stash-updated', handleStashUpdate);
    <strong>chrome.runtime.onMessage.removeListener(handleRuntimeMessage);</strong>
  };
}, []);</code></pre>

    <h3><span class="step-number">7</span> Update stashService to Broadcast</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/sidepanel/stashService.ts</code>
    </div>

    <pre><code>export async function stashCard(cardId: string): Promise&lt;void&gt; {
  // ... existing stash logic ...

  // Dispatch local event
  window.dispatchEvent(new CustomEvent('nabokov:stash-updated'));

  <strong>// Broadcast to all contexts
  chrome.runtime.sendMessage({
    type: 'STASH_UPDATED',
    cardId
  });</strong>
}

export async function restoreCard(cardId: string): Promise&lt;void&gt; {
  // ... existing restore logic ...

  window.dispatchEvent(new CustomEvent('nabokov:stash-updated'));
  <strong>chrome.runtime.sendMessage({
    type: 'STASH_UPDATED',
    cardId
  });</strong>
}</code></pre>

    <h3><span class="step-number">8</span> Update Canvas to Listen for Runtime Messages</h3>

    <div class="info-box">
        <strong>File:</strong> <code>src/canvas/Canvas.tsx</code> or <code>src/canvas/useCanvasState.ts</code>
    </div>

    <pre><code>useEffect(() => {
  loadCards();

  // Local event listener
  const handleCardUpdate = () => loadCards();
  window.addEventListener('nabokov:cards-updated', handleCardUpdate);

  <strong>// Runtime message listener
  const handleRuntimeMessage = (message: any) => {
    if (message.type === 'STASH_UPDATED' || message.type === 'CARD_STASHED') {
      loadCards();
    }
  };
  chrome.runtime.onMessage.addListener(handleRuntimeMessage);</strong>

  return () => {
    window.removeEventListener('nabokov:cards-updated', handleCardUpdate);
    <strong>chrome.runtime.onMessage.removeListener(handleRuntimeMessage);</strong>
  };
}, []);</code></pre>

    <h2>üìä Summary Table</h2>

    <table>
        <thead>
            <tr>
                <th>File</th>
                <th>Change Type</th>
                <th>Priority</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>src/manifest.json</code></td>
                <td>Add new keyboard command</td>
                <td class="priority-high">HIGH</td>
            </tr>
            <tr>
                <td><code>src/background/index.ts</code></td>
                <td>Handle new command</td>
                <td class="priority-high">HIGH</td>
            </tr>
            <tr>
                <td><code>src/components/ElementSelector.tsx</code></td>
                <td>Accept initial stash state, broadcast messages</td>
                <td class="priority-high">HIGH</td>
            </tr>
            <tr>
                <td><code>src/content/index.tsx</code></td>
                <td>Pass stash state to ElementSelector</td>
                <td class="priority-high">HIGH</td>
            </tr>
            <tr>
                <td><code>src/sidepanel/SidePanel.tsx</code></td>
                <td>Listen to runtime messages</td>
                <td class="priority-high">HIGH</td>
            </tr>
            <tr>
                <td><code>src/sidepanel/stashService.ts</code></td>
                <td>Broadcast runtime messages</td>
                <td class="priority-high">HIGH</td>
            </tr>
            <tr>
                <td><code>src/canvas/useCanvasState.ts</code></td>
                <td>Listen to runtime messages</td>
                <td class="priority-medium">MEDIUM</td>
            </tr>
            <tr>
                <td><code>src/canvas/CardNode.tsx</code></td>
                <td>Broadcast on stash button click</td>
                <td class="priority-medium">MEDIUM</td>
            </tr>
        </tbody>
    </table>

    <h2>üéØ Key Architectural Concepts</h2>

    <div class="solution-box">
        <h3>Chrome Extension Context Isolation</h3>
        <ul>
            <li><strong>Content Scripts:</strong> Run in page context, can access DOM, but isolated from extension pages</li>
            <li><strong>Extension Pages:</strong> Canvas, Side Panel - isolated from each other and content scripts</li>
            <li><strong>Background Worker:</strong> Message hub, can communicate with all contexts</li>
        </ul>

        <h3>Communication Patterns</h3>
        <ul>
            <li><strong>Same Context:</strong> Use <code>window.dispatchEvent()</code> - fast, local only</li>
            <li><strong>Cross Context:</strong> Use <code>chrome.runtime.sendMessage()</code> - broadcasts to all</li>
            <li><strong>Best Practice:</strong> Use BOTH for reliability and sync across tabs</li>
        </ul>
    </div>

    <div class="critical-box">
        <h3>‚ö†Ô∏è Important Notes</h3>
        <ul>
            <li>Always remove event listeners in cleanup functions to prevent memory leaks</li>
            <li>Runtime messages are asynchronous - don't rely on immediate delivery</li>
            <li>Test across multiple tabs to ensure sync works correctly</li>
            <li>Background worker must NOT call <code>chrome.runtime.sendMessage</code> on itself (causes loops)</li>
        </ul>
    </div>

    <h2>‚ú® Expected Behavior After Implementation</h2>

    <ol>
        <li><strong>Cmd+Shift+E:</strong> Opens selector with checkbox unchecked (normal mode)</li>
        <li><strong>Cmd+Shift+Option+E:</strong> Opens selector with checkbox pre-checked (stash mode)</li>
        <li><strong>Capture with stash checked:</strong> Card goes directly to side panel, canvas doesn't show it</li>
        <li><strong>Side panel updates:</strong> Instantly shows new stashed cards without reopening</li>
        <li><strong>Cross-tab sync:</strong> Stashing in one tab updates side panel in all tabs</li>
    </ol>

    <div style="text-align: center; margin-top: 32px; padding: 16px; background: rgba(212, 175, 55, 0.1); border-radius: 6px;">
        <p style="margin: 0; color: var(--level-2); font-size: 13px;">
            Plan generated ‚Ä¢ Ready for implementation ‚Ä¢ Estimated time: 1-2 hours
        </p>
    </div>
</body>
</html>