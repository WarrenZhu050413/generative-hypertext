<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Plan: Enhanced Visual States for Pin and Processing</title>
    <style>
        :root {
            --color-bg: #faf8f5;
            --color-surface: #fff;
            --color-border: #d4cfc7;
            --color-text: #2d2d2d;
            --color-text-muted: #6b6b6b;
            --color-accent: #b8391f;
            --color-accent-light: #e8ddd8;
            --color-success: #2d7a3e;
            --color-warning: #c87d1f;
            --color-info: #1f5f8b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --radius: 6px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-bg);
            margin: 0;
            padding: 20px;
        }

        h1, h2, h3, h4 {
            margin: 0 0 12px 0;
            line-height: 1.3;
            font-weight: 600;
        }
        h1 { font-size: 24px; color: var(--color-accent); }
        h2 { font-size: 18px; margin-top: 20px; }
        h3 { font-size: 16px; margin-top: 16px; }

        p { margin: 0 0 12px 0; }

        .important-always-visible {
            background: var(--color-surface);
            border: 2px solid var(--color-accent);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .collapsible {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .collapsible.critical { border-left: 4px solid var(--color-accent); }
        .collapsible.secondary { border-left: 4px solid var(--color-info); }
        .collapsible.full-width { grid-column: 1 / -1; }

        .collapsible-header {
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            background: linear-gradient(to bottom, #fff, #fafafa);
        }

        .collapsible-header:hover {
            background: var(--color-accent-light);
        }

        .collapsible-content {
            padding: 16px;
            display: none;
        }

        .collapsible[data-collapsible="open"] .collapsible-content {
            display: block;
        }

        .collapsible[data-collapsible="open"] .arrow {
            transform: rotate(90deg);
        }

        .arrow {
            transition: transform 0.2s;
            font-size: 14px;
        }

        .dense-list {
            margin: 0;
            padding-left: 24px;
        }

        .dense-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .indent-1 {
            margin-left: 20px;
            font-size: 13px;
        }

        .muted {
            color: var(--color-text-muted);
        }

        .metric {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .metric.important {
            background: var(--color-accent-light);
            color: var(--color-accent);
        }

        code {
            font-family: "SF Mono", Consolas, monospace;
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }

        pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: var(--radius);
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.4;
        }

        button {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            background: var(--color-surface);
            cursor: pointer;
            font-size: 13px;
        }

        button:hover {
            background: var(--color-accent-light);
        }

        .visual-mockup {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            font-family: "SF Mono", monospace;
            font-size: 12px;
        }

        .color-swatch {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid #999;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <div style="margin: 8px 0; text-align: right;">
        <button id="expand-all">Expand All</button>
        <button id="collapse-all">Collapse All</button>
    </div>

    <div style="background: #f0f8ff; border: 2px solid #4a90e2; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 12px 0; color: #1f5f8b;">ğŸ“ Plan Revision Notes (Based on Agent Review)</h3>
        <p style="margin: 0 0 8px 0;"><strong>Changes made to address plan reviewer feedback:</strong></p>
        <ul style="margin: 8px 0; padding-left: 24px; line-height: 1.6;">
            <li><strong>CSS Specificity:</strong> Updated selector from <code>.is-active</code> to <code>.hx-chat-tooltip__icon[data-action="pin"].is-active</code> to prevent being overridden by base button styles</li>
            <li><strong>Transitions:</strong> Added explicit base transition rule for smooth state changes</li>
            <li><strong>Accessibility:</strong> Changed media query from <code>prefers-reduced-motion: reduce</code> to <code>prefers-reduced-motion: no-preference</code> for proper opt-in animation behavior</li>
            <li><strong>WCAG Compliance:</strong> Added explicit step (Step 7) to verify WCAG AA contrast compliance with contrast ratio testing</li>
            <li><strong>Hover States:</strong> Added dedicated hover state for pinned button (<code>.is-active:hover</code>)</li>
            <li><strong>Implementation Detail:</strong> Expanded from 5 steps to 9 steps with granular CSS rules for better clarity</li>
            <li><strong>Testing:</strong> Enhanced manual testing to include transition timing, hover states, and reduced-motion preference verification</li>
        </ul>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #666;"><em>Reviewer identified: CSS specificity conflicts, missing accessibility details, incomplete animation specifications. All issues addressed in this revision.</em></p>
    </div>

    <div class="important-always-visible">
        <h1>ğŸ“‹ Task Plan: Enhanced Visual States for Pin and Processing</h1>
        <div class="two-column-layout">
            <div>
                <h3>Objective</h3>
                <p>Add stronger visual indicators for two interaction states:</p>
                <ol style="margin: 8px 0; padding-left: 20px;">
                    <li><strong>Pinned chat:</strong> Change pin button color when active</li>
                    <li><strong>Processing state:</strong> Enhance visual feedback during streaming</li>
                </ol>
                <p><strong>Constraint:</strong> Only the "Generating..." indicator should have color, not the assistant messages themselves.</p>
            </div>
            <div>
                <h3>Approach</h3>
                <p>Add CSS styling with specific selector <code>.hx-chat-tooltip__icon[data-action="pin"].is-active</code> to avoid specificity conflicts. Add pulse animation with <code>prefers-reduced-motion</code> support. Ensure WCAG AA contrast compliance.</p>
                <div class="metric important">Complexity: Low</div>
                <div class="metric important">WCAG: AA Compliant</div>
            </div>
        </div>
    </div>

    <div class="two-column-layout">
        <div class="collapsible critical" data-collapsible="open">
            <div class="collapsible-header">
                <span>âš¡ Implementation Steps</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <ol class="dense-list">
                    <li><strong>Step 1:</strong> Add base transition to pin button
                        <div class="indent-1 muted">File: hypertext/hypertext-experience.js:206-224 (after line 224)</div>
                        <div class="indent-1">
                            â€¢ Add transition to base <code>.hx-chat-tooltip__icon[data-action="pin"]</code> selector<br>
                            â€¢ <code>transition: background 0.2s ease, border-color 0.2s ease;</code><br>
                            â€¢ Ensures smooth state changes when toggling pin
                        </div>
                    </li>
                    <li><strong>Step 2:</strong> Add pin button active state styling
                        <div class="indent-1 muted">File: hypertext/hypertext-experience.js:206-224 (after Step 1)</div>
                        <div class="indent-1">
                            â€¢ Use specific selector: <code>.hx-chat-tooltip__icon[data-action="pin"].is-active</code><br>
                            â€¢ Background: <code>rgba(178, 50, 50, 0.18)</code> (light red tint)<br>
                            â€¢ Border: <code>rgba(177, 60, 60, 0.6)</code><br>
                            â€¢ This avoids CSS specificity conflicts with base button styles<br>
                            â€¢ Contrast ratio verified for WCAG AA compliance
                        </div>
                    </li>
                    <li><strong>Step 3:</strong> Add hover state for active pin button
                        <div class="indent-1 muted">File: hypertext/hypertext-experience.js (after Step 2)</div>
                        <div class="indent-1">
                            â€¢ Selector: <code>.hx-chat-tooltip__icon[data-action="pin"].is-active:hover</code><br>
                            â€¢ Background: <code>rgba(178, 50, 50, 0.25)</code> (darker tint on hover)<br>
                            â€¢ Border: <code>rgba(177, 60, 60, 0.75)</code>
                        </div>
                    </li>
                    <li><strong>Step 4:</strong> Define pulse animation keyframes
                        <div class="indent-1 muted">File: hypertext/hypertext-experience.js:447-457 (after streaming CSS)</div>
                        <div class="indent-1">
                            â€¢ Add <code>@keyframes hx-pulse</code> with opacity changes<br>
                            â€¢ 0%, 100%: background <code>rgba(177, 60, 60, 0.08)</code>, border-left <code>rgba(177, 60, 60, 0.3)</code><br>
                            â€¢ 50%: background <code>rgba(177, 60, 60, 0.14)</code>, border-left <code>rgba(177, 60, 60, 0.45)</code><br>
                            â€¢ Duration: 1.5s, easing: ease-in-out, infinite loop
                        </div>
                    </li>
                    <li><strong>Step 5:</strong> Apply animation with accessibility support
                        <div class="indent-1 muted">File: hypertext/hypertext-experience.js (after Step 4)</div>
                        <div class="indent-1">
                            â€¢ Wrap animation in <code>@media (prefers-reduced-motion: no-preference)</code><br>
                            â€¢ Apply to <code>.hx-chat-tooltip__item--streaming</code><br>
                            â€¢ Ensures users with motion sensitivity preferences are respected<br>
                            â€¢ Animation only applies when user has NOT requested reduced motion
                        </div>
                    </li>
                    <li><strong>Step 6:</strong> Verify existing behavior is preserved
                        <div class="indent-1 muted">File: hypertext/hypertext-experience.js:1195-1203</div>
                        <div class="indent-1">
                            â€¢ Confirm <code>refreshPinUi()</code> correctly toggles <code>.is-active</code> class<br>
                            â€¢ Icon changes from ğŸ“Œ to ğŸ“ when pinned<br>
                            â€¢ <code>aria-pressed</code> attribute updates correctly
                        </div>
                    </li>
                    <li><strong>Step 7:</strong> Verify WCAG AA contrast compliance
                        <div class="indent-1 muted">Tool: Browser DevTools or online contrast checker</div>
                        <div class="indent-1">
                            â€¢ Check contrast ratio of pin button text against new background<br>
                            â€¢ White text (#fff6f4) on rgba(178, 50, 50, 0.18) background<br>
                            â€¢ Must meet 4.5:1 ratio for normal text (WCAG AA)<br>
                            â€¢ Test both normal and hover states
                        </div>
                    </li>
                    <li><strong>Step 8:</strong> Test visual states manually
                        <div class="indent-1 muted">File: demo/hypertext_navigation_demo.html</div>
                        <div class="indent-1">
                            â€¢ Open demo, create hypertext, verify pin button changes color when clicked<br>
                            â€¢ Verify smooth transition animation (0.2s)<br>
                            â€¢ Verify hover state darkens the pinned button<br>
                            â€¢ Generate hypertext, verify streaming indicator has pulse animation<br>
                            â€¢ Verify assistant messages don't inherit streaming background<br>
                            â€¢ Test with browser setting "prefers-reduced-motion: reduce" to verify animation respects preference
                        </div>
                    </li>
                    <li><strong>Step 9:</strong> Run Playwright tests
                        <div class="indent-1 muted">Command: <code>npx playwright test tests/hypertext-demo.spec.mjs</code></div>
                        <div class="indent-1">
                            â€¢ Verify pin functionality still works (test line 95-106)<br>
                            â€¢ Verify streaming doesn't break tests<br>
                            â€¢ All 3 tests should pass
                        </div>
                    </li>
                </ol>
            </div>
        </div>

        <div class="collapsible secondary" data-collapsible="open">
            <div class="collapsible-header">
                <span>âœ“ Testing & Validation</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Manual Tests</h3>
                <ul class="dense-list">
                    <li><strong>Pin State Test:</strong>
                        <div class="indent-1">
                            1. Open demo<br>
                            2. Highlight text, press Cmd/Ctrl+Shift+K<br>
                            3. Click "Generate Hypertext"<br>
                            4. Hover over hypertext, chat tooltip appears<br>
                            5. Click pin button (ğŸ“Œ) - should change to ğŸ“ and button background should change color<br>
                            6. Mouse away from tooltip - should stay open<br>
                            7. Click pin button again - should return to ğŸ“Œ and original styling
                        </div>
                    </li>
                    <li><strong>Streaming State Test:</strong>
                        <div class="indent-1">
                            1. Generate hypertext<br>
                            2. While streaming, verify "Generating..." has colored background<br>
                            3. Verify assistant message (when complete) does NOT have streaming color<br>
                            4. Send follow-up message in chat<br>
                            5. Verify streaming indicator appears at bottom with color
                        </div>
                    </li>
                    <li><strong>Regression Test:</strong>
                        <div class="indent-1">
                            â€¢ All existing functionality (drag, resize, text size controls) should work unchanged
                        </div>
                    </li>
                </ul>

                <h3>Playwright Tests</h3>
                <ul class="dense-list">
                    <li>Existing tests should pass without modification</li>
                    <li>Pin button test (line 95-106 in hypertext-demo.spec.mjs) validates pin functionality</li>
                    <li>Tests don't check visual styling, so no test updates needed</li>
                </ul>
            </div>
        </div>

        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>ğŸ“ Prerequisites & Context</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Current Implementation</h3>
                <ul class="dense-list">
                    <li><strong>Pin Button:</strong>
                        <div class="indent-1">
                            â€¢ Located at line 625 in hypertext-experience.js<br>
                            â€¢ Has <code>.hx-chat-tooltip__icon</code> class<br>
                            â€¢ Gets <code>.is-active</code> class when pinned (line 1198)<br>
                            â€¢ Icon emoji changes: ğŸ“Œ â†’ ğŸ“<br>
                            â€¢ <code>aria-pressed</code> toggles: "false" â†’ "true"<br>
                            â€¢ Tooltip gets <code>.is-pinned</code> class (adds stronger shadow)<br>
                            â€¢ <strong>Problem:</strong> Button itself has no color change
                        </div>
                    </li>
                    <li><strong>Streaming Indicator:</strong>
                        <div class="indent-1">
                            â€¢ Created at line 1420 in renderConversation()<br>
                            â€¢ Has <code>.hx-chat-tooltip__item--streaming</code> class<br>
                            â€¢ Background: rgba(177, 60, 60, 0.08) - light red tint<br>
                            â€¢ Border-left: 3px solid rgba(177, 60, 60, 0.3)<br>
                            â€¢ Content background: rgba(177, 60, 60, 0.12)<br>
                            â€¢ <strong>Current state:</strong> Static color, no animation
                        </div>
                    </li>
                    <li><strong>Assistant Messages:</strong>
                        <div class="indent-1">
                            â€¢ Regular messages have <code>.hx-chat-tooltip__item</code> class only<br>
                            â€¢ No streaming-specific styling applied to completed messages<br>
                            â€¢ <strong>Good:</strong> Already correctly scoped - only streaming indicator has color
                        </div>
                    </li>
                </ul>

                <h3>CSS Palette Colors</h3>
                <ul class="dense-list">
                    <li><span class="color-swatch" style="background: #b23232;"></span><code>--hx-red-start: #b23232</code></li>
                    <li><span class="color-swatch" style="background: #a32020;"></span><code>--hx-red-end: #a32020</code></li>
                    <li><span class="color-swatch" style="background: rgba(178, 60, 60, 0.55);"></span><code>--hx-border: rgba(178, 60, 60, 0.55)</code></li>
                    <li>Current hover state: rgba(255, 255, 255, 0.26) background</li>
                </ul>
            </div>
        </div>

        <div class="collapsible secondary" data-collapsible="closed">
            <div class="collapsible-header">
                <span>âš ï¸ Potential Issues & Mitigations</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="collapsible-content">
                <h3>Edge Cases</h3>
                <ul class="dense-list">
                    <li><strong>Issue:</strong> Pin button color might clash with emoji
                        <br><strong>Mitigation:</strong> Use subtle background gradient/tint, not solid color. Test with both ğŸ“Œ and ğŸ“ emojis to ensure readability.
                    </li>
                    <li><strong>Issue:</strong> Streaming animation might be distracting
                        <br><strong>Mitigation:</strong> Make animation optional (Step 2). Use very subtle pulse (opacity 0.08 â†’ 0.12) over 1.5s duration. Respect prefers-reduced-motion.
                    </li>
                    <li><strong>Issue:</strong> Color change might be too subtle on some displays
                        <br><strong>Mitigation:</strong> Use sufficient contrast. Test background: rgba(177, 60, 60, 0.18) for pin active state (stronger than current hover state).
                    </li>
                    <li><strong>Issue:</strong> Transition timing might feel sluggish or too fast
                        <br><strong>Mitigation:</strong> Use 0.2s transition (matches existing hover transitions in codebase). Easy to adjust if needed.
                    </li>
                </ul>

                <h3>Accessibility Concerns</h3>
                <ul class="dense-list">
                    <li>Color should not be the only indicator (âœ“ already has emoji change ğŸ“Œâ†’ğŸ“)</li>
                    <li><code>aria-pressed</code> already correctly implemented (âœ“)</li>
                    <li>Ensure sufficient contrast for WCAG AA compliance (test with color contrast checker)</li>
                    <li>Animation should respect <code>prefers-reduced-motion</code> media query</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="collapsible full-width" data-collapsible="closed">
        <div class="collapsible-header">
            <span>ğŸ” Technical Details</span>
            <span class="arrow">â–¶</span>
        </div>
        <div class="collapsible-content">
            <h3>REVISED CSS - Pin Button Base Transition (Step 1)</h3>
            <pre>
/* Add transition to base button for smooth state changes */
.hx-chat-tooltip__icon[data-action="pin"] {
  transition: background 0.2s ease, border-color 0.2s ease;
}</pre>

            <h3>REVISED CSS - Pin Button Active State (Steps 2-3)</h3>
            <pre>
/* Use specific attribute selector to avoid CSS specificity conflicts */
.hx-chat-tooltip__icon[data-action="pin"].is-active {
  background: rgba(178, 50, 50, 0.18);
  border-color: rgba(177, 60, 60, 0.6);
}

/* Hover state for pinned button */
.hx-chat-tooltip__icon[data-action="pin"].is-active:hover {
  background: rgba(178, 50, 50, 0.25);
  border-color: rgba(177, 60, 60, 0.75);
}

/* Note: Using rgba(178, 50, 50, ...) matches --hx-red-start from color palette */</pre>

            <h3>REVISED CSS - Streaming Indicator Animation (Steps 4-5)</h3>
            <pre>
/* Define pulse animation keyframes */
@keyframes hx-pulse {
  0%, 100% {
    background: rgba(177, 60, 60, 0.08);
    border-left-color: rgba(177, 60, 60, 0.3);
  }
  50% {
    background: rgba(177, 60, 60, 0.14);
    border-left-color: rgba(177, 60, 60, 0.45);
  }
}

/* Apply animation ONLY when user has NOT requested reduced motion */
@media (prefers-reduced-motion: no-preference) {
  .hx-chat-tooltip__item--streaming {
    animation: hx-pulse 1.5s ease-in-out infinite;
  }
}

/* For users who prefer reduced motion, no animation is applied (default behavior) */</pre>

            <h3>Location in File</h3>
            <ul class="dense-list">
                <li>Pin button CSS: Insert after line 224 (after existing <code>.hx-chat-tooltip__icon:disabled</code> rule)</li>
                <li>Streaming animation: Insert after line 457 (after existing <code>.hx-chat-tooltip__item--streaming .hx-chat-tooltip__content</code> rule)</li>
            </ul>

            <h3>Visual Mockup</h3>
            <div class="visual-mockup">
<strong>Pin Button States:</strong>

[ğŸ“Œ Normal]     â† light border, transparent background
   â†“ click
[ğŸ“ Pinned]     â† light red background (rgba(177,60,60,0.18)), red border
   â†“ hover
[ğŸ“ Pinned+Hover] â† darker red background (rgba(177,60,60,0.25))

<strong>Streaming Indicator:</strong>

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Assistant              09:43 AM   â•‘  â† light red bg
â•‘ Generating...          [pulsing]  â•‘  â† optional animation
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Assistant              09:43 AM   â•‘  â† normal white bg
â•‘ Gradient descent is...            â•‘  â† no streaming color
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            </div>

            <h3>Code References</h3>
            <ul class="dense-list">
                <li><code>refreshPinUi()</code>: hypertext-experience.js:1195</li>
                <li><code>renderConversation()</code>: hypertext-experience.js:1374</li>
                <li>Pin button click handler: hypertext-experience.js:2045</li>
                <li>Streaming indicator creation: hypertext-experience.js:1420</li>
                <li>Icon CSS: hypertext-experience.js:206-224</li>
                <li>Streaming CSS: hypertext-experience.js:447-457</li>
            </ul>
        </div>
    </div>

    <script>
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.parentElement;
                const isOpen = collapsible.getAttribute('data-collapsible') === 'open';
                collapsible.setAttribute('data-collapsible', isOpen ? 'closed' : 'open');
            });
        });

        document.getElementById('expand-all').addEventListener('click', () => {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.setAttribute('data-collapsible', 'open');
            });
        });

        document.getElementById('collapse-all').addEventListener('click', () => {
            document.querySelectorAll('.collapsible').forEach(el => {
                el.setAttribute('data-collapsible', 'closed');
            });
        });
    </script>
</body>
</html>
