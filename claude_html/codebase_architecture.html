<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nabokov's Hypertext Module - Architecture Documentation</title>
<style>
:root {
  --chinese-red: #8b0000;
  --chinese-gold: #FFD700;
  --ink-black: #1a1a1a;
  --paper-beige: #f5f5dc;
  --light-cream: #fffef0;
  --level-1: #8b0000;
  --level-2: #CD5C5C;
  --level-3: #666;
  --level-4: #999;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
  color: var(--ink-black);
  font-family: "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
  line-height: 1.2;
  font-size: 14px;
  width: 100vw;
  max-width: 100%;
}

.container {
  width: 100%;
  padding: 0;
  margin: 0;
}

h1 {
  font-size: 24px;
  font-weight: 900;
  margin: 4px 0;
  padding: 6px 4px;
  background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

h2 {
  font-size: 18px;
  font-weight: 700;
  margin: 8px 0 4px 0;
  padding: 4px;
  border-left: 4px solid var(--chinese-red);
  background: rgba(139, 0, 0, 0.03);
  color: var(--level-1);
}

h3 {
  font-size: 14px;
  font-weight: 600;
  margin: 4px 0 2px 8px;
  color: var(--level-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

h4 {
  font-size: 12px;
  font-weight: 500;
  margin: 2px 0 1px 16px;
  color: var(--level-3);
}

.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin: 8px 0;
}

.primary-section {
  border: 2px solid var(--chinese-red);
  background: white;
  margin: 6px 0;
  padding: 6px;
}

.secondary-section {
  border-left: 3px solid var(--chinese-gold);
  background: rgba(255, 215, 0, 0.05);
  margin: 4px 0 4px 8px;
  padding: 4px;
}

.tertiary-section {
  margin-left: 16px;
  padding-left: 8px;
  border-left: 1px dashed #ccc;
}

.card {
  background: white;
  border: 1px solid rgba(139, 0, 0, 0.2);
  border-radius: 2px;
  padding: 6px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  margin: 4px 0;
}

.card.priority {
  border: 2px solid var(--chinese-gold);
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
}

.dense-list {
  list-style: none;
  padding: 0;
  margin-left: 8px;
}

.dense-list li {
  padding: 2px 0 2px 12px;
  border-left: 2px solid transparent;
  position: relative;
}

.dense-list li:before {
  content: "▸";
  position: absolute;
  left: 0;
  color: var(--chinese-red);
  font-size: 10px;
}

.dense-list li strong {
  color: var(--level-2);
  font-weight: 600;
}

pre, code {
  background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
  border: 1px solid rgba(139, 0, 0, 0.1);
  padding: 2px 4px;
  margin: 1px 0;
  font-size: 12px;
  line-height: 1.1;
  font-family: "SF Mono", Monaco, Consolas, monospace;
}

pre {
  padding: 4px 6px;
  margin: 2px 0;
  overflow-x: auto;
}

.collapsible {
  margin: 4px 0;
  width: 100%;
}

.collapsible-header {
  cursor: pointer;
  padding: 6px 8px;
  background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
  border-left: 3px solid var(--chinese-gold);
  display: flex;
  align-items: center;
  justify-content: space-between;
  user-select: none;
  transition: all 0.2s ease;
}

.collapsible-header:hover {
  background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
}

.collapsible-header .arrow {
  display: inline-block;
  transition: transform 0.3s ease;
  color: var(--chinese-red);
  font-size: 10px;
}

.collapsible.open .arrow {
  transform: rotate(90deg);
}

.collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  padding: 0 8px;
  margin-left: 12px;
}

.collapsible.open .collapsible-content {
  max-height: 5000px;
  padding: 8px;
}

.collapsible.critical .collapsible-header {
  border-left: 4px solid var(--chinese-red);
  background: rgba(139, 0, 0, 0.08);
  font-weight: 700;
}

.collapsible.secondary .collapsible-header {
  border-left: 2px solid #999;
  background: rgba(0, 0, 0, 0.02);
  font-size: 13px;
}

.important-always-visible {
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
  border: 2px solid var(--chinese-gold);
  padding: 8px;
  margin: 8px 0;
  border-radius: 3px;
}

.important-always-visible h2 {
  color: var(--chinese-red);
  margin-top: 0;
}

.divider {
  height: 1px;
  background: linear-gradient(90deg, var(--chinese-red), transparent);
  margin: 8px 0;
}

.indent-1 { margin-left: 12px; }
.indent-2 { margin-left: 24px; }
.indent-3 { margin-left: 36px; }

table {
  width: 100%;
  border-collapse: collapse;
  margin: 2px 0;
  font-size: 12px;
}

th, td {
  border: 1px solid rgba(139, 0, 0, 0.2);
  padding: 2px 4px;
  text-align: left;
  line-height: 1.1;
}

th {
  background: rgba(139, 0, 0, 0.1);
}
</style>
</head>
<body>
<div class="container">

<h1>NabokovsWeb Hypertext Module - Architecture Documentation</h1>

<div class="important-always-visible">
  <h2>Core Purpose</h2>
  <p>The Hypertext Module enables <strong>inline annotation of selected text</strong> with <strong>AI-generated explanations or reference links</strong>, accessible via hoverable tooltips with multi-turn chat capabilities.</p>
</div>

<h2>Architecture Overview</h2>

<div class="two-column-layout">
  <div class="card priority">
    <h3>Deployment Modes</h3>
    <ul class="dense-list">
      <li><strong>Standalone Demo:</strong> <code>demo/hypertext_navigation_demo.html</code> - Self-contained HTML file</li>
      <li><strong>Chrome Extension:</strong> <code>manifest.json</code> + <code>extension/</code> - Works on any webpage</li>
      <li><strong>Shared Runtime:</strong> Both modes use <code>hypertext/hypertext-experience.js</code></li>
    </ul>
  </div>

  <div class="card priority">
    <h3>Key Files</h3>
    <ul class="dense-list">
      <li><strong>hypertext/hypertext-experience.js</strong> - Core module (1625 lines)</li>
      <li><strong>extension/hypertext-loader.js</strong> - Extension bootstrap</li>
      <li><strong>extension/background.js</strong> - Keyboard command handler</li>
      <li><strong>manifest.json</strong> - Chrome extension config</li>
    </ul>
  </div>
</div>

<h2>Code Architecture</h2>

<div class="collapsible critical open">
  <div class="collapsible-header">
    <span><strong>Core Module: hypertext-experience.js</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <h3>Main Entry Point</h3>
    <div class="secondary-section">
      <p><code>createHypertextExperience(options)</code> - Factory function that initializes the system</p>
      <p><strong>Location:</strong> hypertext/hypertext-experience.js:553</p>

      <h4>Configuration Options</h4>
      <ul class="dense-list">
        <li><strong>document:</strong> Target document (defaults to window.document)</li>
        <li><strong>backendUrl:</strong> API endpoint (default: http://localhost:3100)</li>
        <li><strong>contextProvider:</strong> Function to generate page context for LLM</li>
        <li><strong>hotkey:</strong> Keyboard trigger function (default: Cmd/Ctrl+Shift+K)</li>
        <li><strong>selectionValidator:</strong> Validate text selections</li>
        <li><strong>autoOpenTooltipOnHover:</strong> Auto-show tooltip on highlight hover</li>
        <li><strong>registerExternalTrigger:</strong> Register external activation callback</li>
      </ul>
    </div>

    <h3>DOM Manipulation Flow</h3>
    <div class="two-column-layout">
      <div class="card">
        <h4>1. Text Selection → Palette</h4>
        <ul class="dense-list">
          <li><strong>handleSelectionChange()</strong> - Cache selected text/range</li>
          <li><strong>attemptHypertextFromSelection()</strong> - Show palette if valid</li>
          <li><strong>buildPalette()</strong> - Create UI overlay at selection rect</li>
        </ul>
      </div>

      <div class="card">
        <h4>2. Palette → Hyperlink Creation</h4>
        <ul class="dense-list">
          <li><strong>applyHypertext()</strong> - Extract selection into span wrapper</li>
          <li><strong>createHyperlinkSpan()</strong> - Build interactive highlight element</li>
          <li><strong>Range.extractContents()</strong> - Remove original text from DOM</li>
          <li><strong>Range.insertNode()</strong> - Insert highlight span at position</li>
        </ul>
      </div>
    </div>

    <h3>Session Management</h3>
    <div class="secondary-section">
      <p><strong>Data Structure:</strong> <code>Map&lt;sessionId, SessionObject&gt;</code></p>
      <pre>session = {
  id: 'hyper-N',
  subject: 'selected text',
  context: 'page context for LLM',
  wrapper: HTMLSpanElement,
  messages: [{role, content, display}],
  lastResult: {pillText, mode, explanation, url},
  lastInstructions: string,
  isStreaming: boolean,
  draft: string,
  isPinned: boolean,
  tooltipPosition: {left, top},
  tooltipSize: {width, height}
}</pre>
      <p><strong>Key Functions:</strong></p>
      <ul class="dense-list">
        <li><strong>sessions.set(id, session)</strong> - Store session on hyperlink creation (line 1382)</li>
        <li><strong>openChat(session)</strong> - Activate tooltip for session (line 1211)</li>
        <li><strong>closeChat()</strong> - Hide tooltip (line 1226)</li>
        <li><strong>renderConversation(session)</strong> - Update tooltip DOM with messages (line 999)</li>
      </ul>
    </div>

    <h3>Tooltip (Chat Window) Lifecycle</h3>
    <div class="two-column-layout">
      <div class="card">
        <h4>Creation & Positioning</h4>
        <ul class="dense-list">
          <li><strong>buildTooltip()</strong> - Create tooltip DOM structure (line 408)</li>
          <li><strong>showTooltip(session)</strong> - Display and position (line 1127)</li>
          <li><strong>positionTooltip(anchor)</strong> - Calculate viewport-aware position (line 1082)</li>
          <li><strong>clampToViewport()</strong> - Ensure tooltip stays visible (line 857)</li>
        </ul>
      </div>

      <div class="card">
        <h4>Interaction Management</h4>
        <ul class="dense-list">
          <li><strong>beginDrag/handleDragMove/endDrag</strong> - Drag header to move (lines 878-924)</li>
          <li><strong>beginResize/handleResizeMove/endResize</strong> - Resize via grip (lines 926-983)</li>
          <li><strong>setPinnedState()</strong> - Pin tooltip to prevent auto-close (line 837)</li>
          <li><strong>scheduleTooltipClose()</strong> - Auto-hide on mouse leave (line 1193)</li>
        </ul>
      </div>
    </div>

    <h3>LLM Integration</h3>
    <div class="secondary-section">
      <h4>Request Flow</h4>
      <ul class="dense-list">
        <li><strong>runHypertext(session, mode, instructions)</strong> - Orchestrate LLM request (line 1244)</li>
        <li><strong>buildInitialPrompt()</strong> - First request with full context (line 698)</li>
        <li><strong>buildFollowupPrompt()</strong> - Subsequent chat messages (line 709)</li>
        <li><strong>streamHypertext(messages)</strong> - SSE stream to backend (line 717)</li>
        <li><strong>parseHypertextJson()</strong> - Extract JSON from LLM response (line 498)</li>
        <li><strong>updateWrapperWithResult()</strong> - Apply result to highlight (line 779)</li>
      </ul>

      <h4>Response Schema</h4>
      <pre>{
  "pillText": string,        // Highlight label (<45 chars)
  "mode": "inline" | "reference",
  "explanation"?: string,    // Inline explanation
  "url"?: string            // External reference
}</pre>
    </div>

  </div>
</div>

<div class="collapsible critical open">
  <div class="collapsible-header">
    <span><strong>Extension Integration</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <h3>Chrome Extension Flow</h3>
    <div class="card priority">
      <h4>Manifest Configuration (manifest.json)</h4>
      <ul class="dense-list">
        <li><strong>Command:</strong> "toggle-hypertext" → Cmd/Ctrl+Shift+K</li>
        <li><strong>Background:</strong> extension/background.js (service worker)</li>
        <li><strong>Content Scripts:</strong> Injected in order:
          <ol>
            <li>hypertext/hypertext-experience.js (core module)</li>
            <li>extension/hypertext-loader.js (bootstrap)</li>
          </ol>
        </li>
        <li><strong>Permissions:</strong> storage, &lt;all_urls&gt;</li>
      </ul>
    </div>

    <h3>Communication Architecture</h3>
    <div class="two-column-layout">
      <div class="card">
        <h4>Background Script (background.js)</h4>
        <pre>chrome.commands.onCommand.addListener(
  async (command, tab) => {
    if (command !== 'toggle-hypertext') return;

    await chrome.tabs.sendMessage(tab.id, {
      type: 'HYPERTEXT_TRIGGER'
    });
  }
);</pre>
        <p><strong>Purpose:</strong> Listen for keyboard shortcut → send message to active tab</p>
      </div>

      <div class="card">
        <h4>Content Script (hypertext-loader.js)</h4>
        <pre>chrome.runtime.onMessage.addListener(
  (message) => {
    if (message?.type === 'HYPERTEXT_TRIGGER') {
      triggerFromExternal();
    }
  }
);</pre>
        <p><strong>Purpose:</strong> Receive message → trigger palette via external callback</p>
      </div>
    </div>

    <h3>Initialization Sequence</h3>
    <div class="tertiary-section">
      <ol>
        <li><strong>hypertext-experience.js</strong> executes → exposes <code>window.createHypertextExperience</code></li>
        <li><strong>hypertext-loader.js</strong> executes:
          <ul class="dense-list">
            <li>Checks <code>window.__hypertextInitialized</code> guard</li>
            <li>Calls <code>createHypertextExperience()</code> with extension config</li>
            <li>Stores trigger callback via <code>registerExternalTrigger</code></li>
            <li>Sets up <code>chrome.runtime.onMessage</code> listener</li>
          </ul>
        </li>
        <li><strong>User presses Cmd/Ctrl+Shift+K</strong>:
          <ul class="dense-list">
            <li>background.js → <code>chrome.tabs.sendMessage</code></li>
            <li>hypertext-loader.js → receives message → calls <code>triggerFromExternal()</code></li>
            <li>hypertext-experience.js → <code>attemptHypertextFromSelection()</code></li>
          </ul>
        </li>
      </ol>
    </div>

  </div>
</div>

<div class="collapsible critical open">
  <div class="collapsible-header">
    <span><strong>Key DOM Manipulation Functions</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <div class="two-column-layout">
      <div class="card">
        <h4>Style Injection</h4>
        <p><strong>injectStyles(doc)</strong> - Line 378</p>
        <ul class="dense-list">
          <li>Check if <code>#hx-hypertext-styles</code> exists</li>
          <li>Create <code>&lt;style&gt;</code> element with BASE_STYLES</li>
          <li>Append to <code>document.head</code></li>
        </ul>
      </div>

      <div class="card">
        <h4>Highlight Creation</h4>
        <p><strong>createHyperlinkSpan(doc, subject)</strong> - Line 542</p>
        <pre>&lt;span
  class="hx-highlight loading"
  role="link"
  tabindex="0"
  aria-haspopup="dialog"
  aria-expanded="false"
&gt;subject&lt;/span&gt;</pre>
      </div>
    </div>

    <h3>Selection → DOM Replacement</h3>
    <div class="secondary-section">
      <p><strong>applyHypertext(instructions)</strong> - Line 1321</p>
      <pre>// 1. Extract selected content from DOM
const fragment = activeRange.extractContents();

// 2. Build highlight wrapper
const wrapper = createHyperlinkSpan(doc, subject);
wrapper.dataset.id = sessionId;

// 3. Transfer extracted content into wrapper
if (fragment.childNodes.length) {
  wrapper.appendChild(fragment);
} else {
  wrapper.textContent = subject;
}

// 4. Insert wrapper at original position
activeRange.insertNode(wrapper);

// 5. Clear browser selection
window.getSelection()?.removeAllRanges();</pre>
    </div>

    <h3>Tooltip DOM Structure</h3>
    <div class="secondary-section">
      <p><strong>buildTooltip(doc)</strong> - Line 408</p>
      <pre>&lt;div class="hx-chat-tooltip" role="dialog"&gt;
  &lt;header class="hx-chat-tooltip__header"&gt;
    &lt;div data-role="drag-handle"&gt;
      &lt;span class="hx-chat-tooltip__drag-icon"&gt;&lt;/span&gt;
      &lt;h2 class="hx-chat-tooltip__title"&gt;&lt;/h2&gt;
    &lt;/div&gt;
    &lt;div class="hx-chat-tooltip__header-actions"&gt;
      &lt;button data-action="pin"&gt;📌&lt;/button&gt;
      &lt;button data-action="regenerate"&gt;⟳&lt;/button&gt;
      &lt;button data-action="close"&gt;×&lt;/button&gt;
    &lt;/div&gt;
  &lt;/header&gt;

  &lt;div class="hx-chat-history"&gt;&lt;/div&gt;

  &lt;div class="hx-chat-composer"&gt;
    &lt;textarea data-role="input"&gt;&lt;/textarea&gt;
    &lt;button data-action="send"&gt;Send&lt;/button&gt;
  &lt;/div&gt;

  &lt;div class="hx-chat-tooltip__footer"&gt;
    &lt;span data-role="resize-handle"&gt;&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre>
    </div>

    <h3>Chat History Rendering</h3>
    <div class="secondary-section">
      <p><strong>renderConversation(session)</strong> - Line 999</p>
      <pre>historyEl.textContent = ''; // Clear
const fragment = doc.createDocumentFragment();

session.messages.forEach(msg => {
  const entry = doc.createElement('div');
  entry.className = 'hx-chat-entry';

  // Role indicator
  const role = doc.createElement('div');
  role.className = 'hx-chat-entry__role';
  role.textContent = msg.role === 'user' ? 'User' : 'Assistant';
  entry.appendChild(role);

  // Message content
  const text = doc.createElement('div');
  text.className = 'hx-chat-entry__text';

  if (msg.role === 'assistant' && msg.display) {
    // Render explanation + link
    if (msg.display.explanation) {
      const p = doc.createElement('p');
      p.textContent = msg.display.explanation;
      text.appendChild(p);
    }
    if (msg.display.url) {
      const a = doc.createElement('a');
      a.href = msg.display.url;
      a.target = '_blank';
      a.textContent = msg.display.linkLabel;
      text.appendChild(a);
    }
  } else {
    const p = doc.createElement('p');
    p.textContent = msg.display || msg.content;
    text.appendChild(p);
  }

  entry.appendChild(text);
  fragment.appendChild(entry);
});

historyEl.appendChild(fragment);</pre>
    </div>

  </div>
</div>

<div class="collapsible secondary">
  <div class="collapsible-header">
    <span><strong>State Management</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <h3>Highlight States (Visual Feedback)</h3>
    <div class="secondary-section">
      <p><strong>setPillState(session, state, errorMessage)</strong> - Line 669</p>
      <table>
        <thead>
          <tr>
            <th>State</th>
            <th>CSS Class</th>
            <th>Visual</th>
            <th>Trigger</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>loading</td>
            <td>.loading</td>
            <td>Gray text, aria-busy=true</td>
            <td>LLM request started</td>
          </tr>
          <tr>
            <td>ready-inline</td>
            <td>.ready-inline</td>
            <td>Red underline (#8b0000)</td>
            <td>Has explanation, no URL</td>
          </tr>
          <tr>
            <td>ready-reference</td>
            <td>.ready-reference</td>
            <td>Blue underline (#1a73e8)</td>
            <td>Has URL</td>
          </tr>
          <tr>
            <td>error</td>
            <td>.error</td>
            <td>Dark red (#b22222)</td>
            <td>LLM request failed</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h3>Tooltip Visibility Control</h3>
    <div class="two-column-layout">
      <div class="card">
        <h4>Show Logic</h4>
        <ul class="dense-list">
          <li><strong>openChat()</strong> - Set display: flex, position tooltip</li>
          <li><strong>Auto-open on hover:</strong> wrapper.mouseenter → openChat()</li>
          <li><strong>Manual open:</strong> wrapper.click → openChat()</li>
        </ul>
      </div>

      <div class="card">
        <h4>Hide Logic</h4>
        <ul class="dense-list">
          <li><strong>scheduleTooltipClose()</strong> - 150ms delay after mouseleave</li>
          <li><strong>Pinned bypass:</strong> If isPinned=true, skip auto-close</li>
          <li><strong>Force close:</strong> Escape key or close button</li>
        </ul>
      </div>
    </div>

    <h3>Persistence</h3>
    <div class="secondary-section">
      <p><strong>saveTooltipGeometry(session)</strong> - Line 845</p>
      <ul class="dense-list">
        <li>Captures <code>offsetWidth/Height/Left/Top</code> from tooltip element</li>
        <li>Stores in <code>session.tooltipSize</code> and <code>session.tooltipPosition</code></li>
        <li>Restored on tooltip re-open via <code>showTooltip()</code> (line 1137-1158)</li>
      </ul>
    </div>

  </div>
</div>

<div class="collapsible secondary">
  <div class="collapsible-header">
    <span><strong>Event System</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <h3>Global Event Listeners</h3>
    <div class="secondary-section">
      <table>
        <thead>
          <tr>
            <th>Event</th>
            <th>Handler</th>
            <th>Purpose</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>document.selectionchange</td>
            <td>handleSelectionChange</td>
            <td>Cache selected text/range</td>
            <td>Line 1522</td>
          </tr>
          <tr>
            <td>document.keydown</td>
            <td>handleHotkeyDown</td>
            <td>Trigger palette on Cmd/Ctrl+Shift+K</td>
            <td>Line 1523</td>
          </tr>
          <tr>
            <td>document.keydown</td>
            <td>handleEscapeKey</td>
            <td>Close tooltip/palette on Escape</td>
            <td>Line 1524</td>
          </tr>
          <tr>
            <td>document.mousedown</td>
            <td>handleMouseDown</td>
            <td>Close palette/tooltip on outside click</td>
            <td>Line 1525</td>
          </tr>
          <tr>
            <td>window.scroll</td>
            <td>handleScroll</td>
            <td>Reposition tooltip on scroll</td>
            <td>Line 1526</td>
          </tr>
          <tr>
            <td>window.resize</td>
            <td>handleResize</td>
            <td>Reposition tooltip on viewport change</td>
            <td>Line 1527</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h3>Highlight-Specific Events</h3>
    <div class="secondary-section">
      <p>Attached during <code>applyHypertext()</code> (lines 1390-1430)</p>
      <ul class="dense-list">
        <li><strong>click:</strong>
          <ul class="dense-list indent-1">
            <li>If streaming → open chat (no focus)</li>
            <li>If has URL + Cmd/Ctrl → open URL in new tab</li>
            <li>Else → open chat (with focus)</li>
          </ul>
        </li>
        <li><strong>keydown:</strong>
          <ul class="dense-list indent-1">
            <li>Enter + Cmd/Ctrl → open URL</li>
            <li>Enter/Space → open chat</li>
          </ul>
        </li>
        <li><strong>mouseenter:</strong> Auto-open chat if enabled</li>
        <li><strong>mouseleave:</strong> Schedule auto-close</li>
      </ul>
    </div>

    <h3>Pointer Interaction (Drag/Resize)</h3>
    <div class="two-column-layout">
      <div class="card">
        <h4>Drag Handle Events</h4>
        <ul class="dense-list">
          <li>pointerdown → beginDrag (capture pointer)</li>
          <li>pointermove → handleDragMove (update position)</li>
          <li>pointerup/pointercancel → endDrag (release, save geometry)</li>
        </ul>
      </div>

      <div class="card">
        <h4>Resize Handle Events</h4>
        <ul class="dense-list">
          <li>pointerdown → beginResize (capture pointer)</li>
          <li>pointermove → handleResizeMove (update dimensions)</li>
          <li>pointerup/pointercancel → endResize (release, save geometry)</li>
        </ul>
      </div>
    </div>

  </div>
</div>

<div class="collapsible secondary">
  <div class="collapsible-header">
    <span><strong>Context Providers</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <h3>Default Context Builder</h3>
    <div class="secondary-section">
      <p><strong>buildDefaultContext(doc, session, shouldTruncate)</strong> - Line 350</p>
      <pre>URL: {window.location.href}
Title: {document.title}
--- FULL PAGE TEXT ---
{document.body.innerText} [truncated at 200k chars if enabled]
--- CURRENT SELECTION ---
{session.subject}</pre>
    </div>

    <h3>Custom Context Provider (Extension)</h3>
    <div class="secondary-section">
      <p><strong>extension/hypertext-loader.js</strong> - Lines 28-56</p>
      <pre>contextProvider: (session, options) => {
  const url = window?.location?.href || '';
  const title = document.title || '';
  const bodyText = document.body.innerText.trim();
  const selectionText = session?.subject || '';
  const shouldTruncate = Boolean(options?.truncateContext);

  // Same format as default, but with explicit truncation
}</pre>
    </div>

    <h3>Truncation Control</h3>
    <div class="secondary-section">
      <ul class="dense-list">
        <li><strong>UI Toggle:</strong> Palette button "Enable/Disable truncation"</li>
        <li><strong>State Variable:</strong> <code>truncateContext</code> (boolean)</li>
        <li><strong>Limit:</strong> 200,000 characters</li>
        <li><strong>Applied in:</strong> <code>getContext()</code> → <code>formatContextOutput()</code> (lines 619-627)</li>
      </ul>
    </div>

  </div>
</div>

<h2>Execution Flow Diagrams</h2>

<div class="collapsible critical open">
  <div class="collapsible-header">
    <span><strong>Primary User Flow: Selection → Hypertext</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <div class="card priority">
      <ol>
        <li><strong>User selects text</strong>
          <div class="indent-1">→ <code>document.selectionchange</code> → <code>handleSelectionChange()</code> → <code>cacheSelection()</code></div>
        </li>

        <li><strong>User presses Cmd/Ctrl+Shift+K</strong>
          <div class="indent-1">→ Extension: <code>background.js</code> → <code>chrome.tabs.sendMessage</code> → <code>hypertext-loader.js</code> → <code>triggerFromExternal()</code></div>
          <div class="indent-1">→ Demo: <code>handleHotkeyDown()</code> directly</div>
          <div class="indent-1">→ Both: <code>attemptHypertextFromSelection()</code></div>
        </li>

        <li><strong>Palette appears</strong>
          <div class="indent-1">→ Position calculated from <code>range.getBoundingClientRect()</code></div>
          <div class="indent-1">→ <code>palette.style.left/top</code> set</div>
          <div class="indent-1">→ <code>palette.style.display = 'block'</code></div>
          <div class="indent-1">→ Focus on instruction input</div>
        </li>

        <li><strong>User clicks "Generate Hypertext"</strong>
          <div class="indent-1">→ <code>generateButton.click</code> → <code>applyHypertext(instructions)</code></div>
        </li>

        <li><strong>DOM mutation</strong>
          <div class="indent-1">→ <code>activeRange.extractContents()</code> - Remove original text</div>
          <div class="indent-1">→ <code>createHyperlinkSpan()</code> - Build wrapper</div>
          <div class="indent-1">→ <code>activeRange.insertNode(wrapper)</code> - Insert highlight</div>
        </li>

        <li><strong>Session creation</strong>
          <div class="indent-1">→ Build session object with context</div>
          <div class="indent-1">→ <code>sessions.set(sessionId, session)</code></div>
        </li>

        <li><strong>Tooltip opens</strong>
          <div class="indent-1">→ <code>openChat(session, {autoFocus: false})</code></div>
          <div class="indent-1">→ <code>showTooltip(session)</code> → position near palette</div>
        </li>

        <li><strong>LLM request</strong>
          <div class="indent-1">→ <code>runHypertext(session, 'initial', instructions)</code></div>
          <div class="indent-1">→ <code>buildInitialPrompt()</code> with context</div>
          <div class="indent-1">→ <code>streamHypertext(messages)</code> → POST to /api/stream</div>
          <div class="indent-1">→ SSE chunks → <code>parseHypertextJson()</code></div>
        </li>

        <li><strong>Update highlight & tooltip</strong>
          <div class="indent-1">→ <code>updateWrapperWithResult()</code> → set dataset.pillText, dataset.url, dataset.content</div>
          <div class="indent-1">→ <code>setPillState('ready-inline' | 'ready-reference')</code> → CSS class change</div>
          <div class="indent-1">→ <code>renderConversation()</code> → append assistant message to chat history</div>
        </li>
      </ol>
    </div>

  </div>
</div>

<div class="collapsible secondary">
  <div class="collapsible-header">
    <span><strong>Follow-up Chat Flow</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <div class="card">
      <ol>
        <li><strong>User hovers highlight</strong>
          <div class="indent-1">→ <code>wrapper.mouseenter</code> → <code>openChat(session, {autoFocus: false})</code></div>
        </li>

        <li><strong>Tooltip displays</strong>
          <div class="indent-1">→ <code>renderConversation()</code> - Show existing messages</div>
          <div class="indent-1">→ Focus input area</div>
        </li>

        <li><strong>User types follow-up + clicks Send</strong>
          <div class="indent-1">→ <code>sendButton.click</code> → <code>runHypertext(session, 'append', inputText)</code></div>
        </li>

        <li><strong>LLM request with history</strong>
          <div class="indent-1">→ <code>buildFollowupPrompt()</code> - Lighter prompt (no full context)</div>
          <div class="indent-1">→ <code>session.messages</code> includes all previous exchanges</div>
          <div class="indent-1">→ <code>streamHypertext(session.messages)</code></div>
        </li>

        <li><strong>Update tooltip</strong>
          <div class="indent-1">→ Append new assistant response to <code>session.messages</code></div>
          <div class="indent-1">→ <code>renderConversation()</code> - Re-render history</div>
          <div class="indent-1">→ <code>updateWrapperWithResult()</code> - Update highlight if result changed</div>
        </li>
      </ol>
    </div>

  </div>
</div>

<h2>Critical Implementation Details</h2>

<div class="collapsible critical">
  <div class="collapsible-header">
    <span><strong>Viewport-Aware Positioning</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <h3>Constraint System</h3>
    <div class="secondary-section">
      <p><strong>clampToViewport(left, top, width, height)</strong> - Line 857</p>
      <pre>const scrollX = window.scrollX || 0;
const scrollY = window.scrollY || 0;
const viewportWidth = window.innerWidth;
const viewportHeight = window.innerHeight;

const minLeft = scrollX + VIEWPORT_MARGIN; // 12px
const minTop = scrollY + VIEWPORT_MARGIN;
const maxLeft = scrollX + viewportWidth - width - VIEWPORT_MARGIN;
const maxTop = scrollY + viewportHeight - height - VIEWPORT_MARGIN;

const clampedLeft = Math.min(Math.max(left, minLeft), maxLeft);
const clampedTop = Math.min(Math.max(top, minTop), maxTop);</pre>

      <p><strong>Applied during:</strong></p>
      <ul class="dense-list">
        <li>Tooltip open: <code>positionTooltip()</code> (line 1082)</li>
        <li>Drag: <code>handleDragMove()</code> (line 903)</li>
        <li>Resize: <code>handleResizeMove()</code> (line 959)</li>
        <li>Scroll/resize events: <code>handleScroll()</code>, <code>handleResize()</code></li>
      </ul>
    </div>

    <h3>Size Constraints</h3>
    <div class="secondary-section">
      <table>
        <thead>
          <tr>
            <th>Property</th>
            <th>Min</th>
            <th>Max</th>
            <th>Default</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Width</td>
            <td>260px</td>
            <td>520px</td>
            <td>360px</td>
          </tr>
          <tr>
            <td>Height</td>
            <td>220px</td>
            <td>640px</td>
            <td>320px</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<div class="collapsible critical">
  <div class="collapsible-header">
    <span><strong>Pointer Capture for Smooth Interaction</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <div class="secondary-section">
      <p><strong>shouldHandlePointer(event)</strong> - Line 871</p>
      <pre>if (typeof event.button === 'number' && event.button !== 0) {
  return event.pointerType === 'touch' || event.pointerType === 'pen';
}
return true; // Left click or touch/pen always handled</pre>

      <p><strong>Pointer Capture Pattern:</strong></p>
      <pre>// Start
element.setPointerCapture(event.pointerId);

// Move (only if pointerId matches)
if (event.pointerId !== dragState.pointerId) return;

// End
if (element.hasPointerCapture(event.pointerId)) {
  element.releasePointerCapture(event.pointerId);
}</pre>

      <p><strong>Benefits:</strong></p>
      <ul class="dense-list">
        <li>Pointer events continue even if cursor leaves element</li>
        <li>Prevents accidental selection during drag</li>
        <li>Works across mouse/touch/stylus</li>
      </ul>
    </div>

  </div>
</div>

<div class="collapsible critical">
  <div class="collapsible-header">
    <span><strong>SSE Streaming Parser</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <div class="secondary-section">
      <p><strong>streamHypertext(messages)</strong> - Line 717</p>
      <pre>const reader = response.body.getReader();
const decoder = new TextDecoder();
let buffer = '';
let resultText = '';

while (true) {
  const { value, done } = await reader.read();
  if (done) break;

  buffer += decoder.decode(value, { stream: true });
  const lines = buffer.split('\n');
  buffer = lines.pop() || ''; // Keep incomplete line

  for (const rawLine of lines) {
    const line = rawLine.trim();
    if (!line.startsWith('data:')) continue;

    const data = line.slice(5).trim();
    if (data === '[DONE]') break;

    try {
      const parsed = JSON.parse(data);
      if (parsed.delta?.text) {
        resultText += parsed.delta.text;
      }
    } catch (error) {
      console.warn('Failed to parse SSE chunk:', data);
    }
  }
}

return parseHypertextJson(resultText);</pre>

      <p><strong>Handles:</strong></p>
      <ul class="dense-list">
        <li>Partial chunks (buffering incomplete lines)</li>
        <li>SSE format: <code>data: {...}</code></li>
        <li>Termination: <code>data: [DONE]</code></li>
        <li>Delta streaming: <code>{delta: {text: "..."}}</code></li>
      </ul>
    </div>

  </div>
</div>

<div class="collapsible secondary">
  <div class="collapsible-header">
    <span><strong>JSON Extraction from LLM Output</strong></span>
    <span class="arrow">▶</span>
  </div>
  <div class="collapsible-content">

    <div class="secondary-section">
      <p><strong>parseHypertextJson(rawText)</strong> - Line 498</p>
      <pre>// 1. Strip markdown fences
const cleaned = rawText
  .replace(/^```json/gim, '')
  .replace(/```$/gim, '')
  .trim();

// 2. Find JSON object boundaries
const start = cleaned.indexOf('{');
const end = cleaned.lastIndexOf('}');
const candidate = cleaned.slice(start, end + 1);

// 3. Attempt parse
try {
  return JSON.parse(candidate);
} catch (error) {
  // 4. Normalize smart quotes
  const normalized = candidate
    .replace(/"|"/g, '"')  // Curly quotes
    .replace(/'|'/g, "'")   // Smart apostrophes
    .replace(/\r?\n/g, '\n'); // Line endings
  return JSON.parse(normalized);
}</pre>

      <p><strong>Handles edge cases:</strong></p>
      <ul class="dense-list">
        <li>LLM wrapping JSON in <code>```json...```</code></li>
        <li>Preamble/postamble text around JSON</li>
        <li>Smart quotes from certain LLM outputs</li>
      </ul>
    </div>

  </div>
</div>

<h2>Cleanup & Lifecycle</h2>

<div class="secondary-section">
  <p><strong>destroy()</strong> - Line 1597</p>
  <pre>// Remove all event listeners
doc.removeEventListener('selectionchange', handleSelectionChange);
doc.removeEventListener('keydown', handleHotkeyDown);
doc.removeEventListener('keydown', handleEscapeKey);
doc.removeEventListener('mousedown', handleMouseDown);
win.removeEventListener('scroll', handleScroll, true);
win.removeEventListener('resize', handleResize);

// Remove DOM elements
palette.remove();
tooltip.remove();

// Clear state
sessions.clear();
hidePalette();
hideTooltip();
activeChatSession = null;</pre>

  <p><strong>Usage:</strong> Not currently exposed, but available via returned API object for testing/cleanup</p>
</div>

<div class="divider"></div>

<div class="important-always-visible">
  <h2>Summary: How DOM Manipulation Works</h2>
  <ul class="dense-list">
    <li><strong>Style Injection:</strong> <code>injectStyles()</code> adds global stylesheet to <code>&lt;head&gt;</code></li>
    <li><strong>Palette Display:</strong> Absolutely positioned <code>&lt;div&gt;</code> based on <code>Range.getBoundingClientRect()</code></li>
    <li><strong>Highlight Creation:</strong> <code>Range.extractContents()</code> → wrap in <code>&lt;span class="hx-highlight"&gt;</code> → <code>Range.insertNode()</code></li>
    <li><strong>Tooltip Display:</strong> Absolutely positioned <code>&lt;div role="dialog"&gt;</code> with dynamic content rendering</li>
    <li><strong>State Updates:</strong> CSS class manipulation (<code>classList.add/remove</code>) + dataset attributes</li>
    <li><strong>Event Delegation:</strong> Global listeners on document/window + per-highlight listeners on wrapper elements</li>
    <li><strong>Pointer Capture:</strong> <code>setPointerCapture()</code> ensures smooth drag/resize across element boundaries</li>
  </ul>
</div>

</div>

<script>
// Collapsible functionality
document.querySelectorAll('.collapsible-header').forEach(header => {
  header.addEventListener('click', () => {
    const collapsible = header.parentElement;
    collapsible.classList.toggle('open');
  });
});
</script>

</body>
</html>
