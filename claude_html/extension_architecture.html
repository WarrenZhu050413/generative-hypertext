<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nabokov Extension Architecture Explained</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #F5F5DC;
            --light-cream: #FFFEF0;
            --ink-black: #2C2C2C;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #666;
            --level-4: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 12px;
            width: 100vw;
            max-width: 100%;
            line-height: 1.3;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }

        .container {
            width: 100%;
            padding: 0;
            margin: 0;
        }

        h1 {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0 12px 0;
            padding: 8px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            border-bottom: 3px solid var(--chinese-gold);
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 12px 0 6px 0;
            padding: 6px 8px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 8px 0 4px 0;
            padding: 4px 0 4px 12px;
            color: var(--level-2);
            border-left: 3px solid var(--chinese-gold);
        }

        h4 {
            font-size: 13px;
            font-weight: 600;
            margin: 6px 0 3px 16px;
            color: var(--level-3);
        }

        .important-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), white);
            border: 2px solid var(--chinese-gold);
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.1);
        }

        .important-box h2 {
            color: var(--chinese-red);
            margin-top: 0;
            background: none;
            border: none;
            padding: 0 0 8px 0;
        }

        .execution-context {
            background: white;
            border: 2px solid var(--chinese-red);
            margin: 8px 0;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .execution-context h3 {
            margin-top: 0;
            border: none;
            padding: 0 0 6px 0;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 8px 0;
        }

        .flow-diagram {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.03), rgba(255, 215, 0, 0.03));
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 12px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            border-radius: 3px;
        }

        .flow-step {
            padding: 4px 0;
            padding-left: 12px;
            border-left: 2px solid var(--chinese-gold);
            margin: 4px 0;
        }

        .arrow {
            color: var(--chinese-red);
            font-weight: bold;
            margin: 0 4px;
        }

        code {
            background: rgba(245, 245, 220, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
            border: 1px solid rgba(139, 0, 0, 0.15);
            font-family: 'Monaco', 'Courier New', monospace;
        }

        pre {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.4), rgba(255, 255, 255, 0.6));
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 10px;
            margin: 8px 0;
            overflow-x: auto;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.4;
        }

        ul, ol {
            margin: 6px 0;
            padding-left: 24px;
        }

        li {
            margin: 4px 0;
            line-height: 1.4;
        }

        strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .storage-box {
            background: rgba(255, 215, 0, 0.08);
            border-left: 4px solid var(--chinese-gold);
            padding: 8px 12px;
            margin: 8px 0;
        }

        .key-point {
            background: rgba(139, 0, 0, 0.05);
            border-left: 3px solid var(--chinese-red);
            padding: 8px 12px;
            margin: 6px 0;
            font-weight: 500;
        }

        .communication-path {
            background: white;
            border: 1px dashed var(--chinese-red);
            padding: 8px;
            margin: 6px 0;
            border-radius: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 13px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 6px 10px;
            text-align: left;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
            color: var(--level-1);
        }

        tr:nth-child(even) {
            background: rgba(245, 245, 220, 0.3);
        }

        .myth-vs-reality {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }

        .myth {
            background: rgba(255, 0, 0, 0.05);
            border: 2px solid #CD5C5C;
            padding: 10px;
            border-radius: 4px;
        }

        .reality {
            background: rgba(0, 128, 0, 0.05);
            border: 2px solid #228B22;
            padding: 10px;
            border-radius: 4px;
        }

        .myth h4 {
            color: #CD5C5C;
            margin: 0 0 6px 0;
        }

        .reality h4 {
            color: #228B22;
            margin: 0 0 6px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Nabokov Extension Architecture Explained</h1>

        <div class="important-box">
            <h2>‚ö° Key Concept: They're All Separate!</h2>
            <p><strong>The canvas, side panel, content script, and background worker are FOUR SEPARATE execution contexts.</strong> They don't share workers, memory, or JavaScript variables. They communicate via:</p>
            <ul>
                <li><strong>Chrome Messages</strong> (<code>chrome.runtime.sendMessage</code>)</li>
                <li><strong>Shared Storage</strong> (<code>chrome.storage.local</code> + IndexedDB)</li>
                <li><strong>Custom Events</strong> (<code>window.dispatchEvent</code>)</li>
            </ul>
        </div>

        <h2>üé≠ The Four Execution Contexts</h2>

        <div class="two-column">
            <div class="execution-context">
                <h3>1Ô∏è‚É£ Background Service Worker</h3>
                <p><strong>File:</strong> <code>src/background/index.ts</code></p>
                <p><strong>What it is:</strong> A Manifest V3 service worker that runs in the background</p>
                <p><strong>Lifecycle:</strong> Chrome starts/stops it automatically (not always running!)</p>
                <p><strong>Responsibilities:</strong></p>
                <ul>
                    <li>Listens for keyboard shortcuts (<code>Cmd+Shift+E</code>)</li>
                    <li>Opens canvas when toolbar icon clicked</li>
                    <li>Captures screenshots via <code>chrome.tabs.captureVisibleTab()</code></li>
                    <li>Registers context menus</li>
                    <li>Forwards messages between contexts</li>
                </ul>
            </div>

            <div class="execution-context">
                <h3>2Ô∏è‚É£ Content Script</h3>
                <p><strong>File:</strong> <code>src/content/index.tsx</code></p>
                <p><strong>What it is:</strong> JavaScript injected into every webpage you visit</p>
                <p><strong>Lifecycle:</strong> Runs on every page load (<code>&lt;all_urls&gt;</code>)</p>
                <p><strong>Responsibilities:</strong></p>
                <ul>
                    <li>Listens for <code>ACTIVATE_SELECTOR</code> messages</li>
                    <li>Mounts <code>ElementSelector</code> component in Shadow DOM</li>
                    <li>Handles user clicking on elements to capture</li>
                    <li>Extracts HTML and styles from page</li>
                    <li>Sends captured data to background worker</li>
                </ul>
            </div>

            <div class="execution-context">
                <h3>3Ô∏è‚É£ Canvas Page</h3>
                <p><strong>File:</strong> <code>src/canvas/index.html</code></p>
                <p><strong>What it is:</strong> A standalone React app (separate HTML page)</p>
                <p><strong>URL:</strong> <code>chrome-extension://&lt;id&gt;/src/canvas/index.html</code></p>
                <p><strong>Created by:</strong> <strong>Built by Vite, opened by background worker</strong></p>
                <p><strong>Responsibilities:</strong></p>
                <ul>
                    <li>Displays all cards on React Flow canvas</li>
                    <li>Loads cards from <code>chrome.storage.local</code></li>
                    <li>Loads screenshots from IndexedDB</li>
                    <li>Handles card positioning, editing, connections</li>
                    <li>Listens to <code>nabokov:cards-updated</code> events</li>
                </ul>
            </div>

            <div class="execution-context">
                <h3>4Ô∏è‚É£ Side Panel</h3>
                <p><strong>File:</strong> <code>src/sidepanel/index.html</code></p>
                <p><strong>What it is:</strong> Another standalone React app (separate HTML page)</p>
                <p><strong>Opened via:</strong> <code>chrome.sidePanel.open()</code></p>
                <p><strong>Created by:</strong> <strong>Built by Vite, opened by Chrome Side Panel API</strong></p>
                <p><strong>Responsibilities:</strong></p>
                <ul>
                    <li>Displays stashed cards (cards with <code>stashed: true</code>)</li>
                    <li>Loads cards from <code>chrome.storage.local</code></li>
                    <li>Allows restoring or permanently deleting stashed cards</li>
                    <li>Listens to <code>nabokov:stash-updated</code> events</li>
                </ul>
            </div>
        </div>

        <div class="myth-vs-reality">
            <div class="myth">
                <h4>‚ùå Common Misconception</h4>
                <p>"The canvas is created dynamically by the content script or background worker"</p>
            </div>
            <div class="reality">
                <h4>‚úÖ Reality</h4>
                <p>"The canvas is a <strong>static HTML file</strong> built by Vite. The background worker just <strong>opens</strong> it like opening a new tab."</p>
            </div>
        </div>

        <h2>üîÑ Complete Workflow: Capturing an Element</h2>

        <div class="flow-diagram">
<div class="flow-step">1. User presses <strong>Cmd+Shift+E</strong> on a webpage</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">2. <strong>Background Worker</strong> catches keyboard shortcut</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">3. Background sends <code>ACTIVATE_SELECTOR</code> message to <strong>Content Script</strong></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">4. <strong>Content Script</strong> mounts ElementSelector in Shadow DOM</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">5. User clicks on an element</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">6. Content Script extracts HTML + sanitizes with DOMPurify</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">7. Content Script requests screenshot from <strong>Background Worker</strong></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">8. Background captures screenshot via <code>chrome.tabs.captureVisibleTab()</code></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">9. Screenshot compressed and stored in <strong>IndexedDB</strong></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">10. Card metadata saved to <strong>chrome.storage.local</strong></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">11. <code>nabokov:cards-updated</code> event dispatched</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">12. <strong>Canvas Page</strong> listens to event and refreshes cards from storage</div>
        </div>

        <h2>üíæ Shared Storage: The Communication Hub</h2>

        <p class="key-point">Since contexts don't share memory, they communicate through <strong>shared storage</strong>. Think of it like a shared database.</p>

        <table>
            <thead>
                <tr>
                    <th>Storage Location</th>
                    <th>What's Stored</th>
                    <th>Who Accesses It</th>
                    <th>Size Limit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>chrome.storage.local</code></td>
                    <td>
                        Card metadata<br>
                        Canvas state<br>
                        Connections<br>
                        API keys<br>
                        Custom buttons
                    </td>
                    <td>
                        All contexts<br>
                        (Background, Content, Canvas, Side Panel)
                    </td>
                    <td>~5MB (after JSON serialization)</td>
                </tr>
                <tr>
                    <td><code>IndexedDB</code><br>Database: <code>nabokov-clipper</code></td>
                    <td>
                        Screenshots (compressed images)
                    </td>
                    <td>
                        Canvas Page<br>
                        Content Script (writes)<br>
                        Side Panel
                    </td>
                    <td>Much larger (browser-dependent, typically GBs)</td>
                </tr>
            </tbody>
        </table>

        <h2>üì° Communication Patterns</h2>

        <h3>Pattern 1: Chrome Messages (Cross-Context)</h3>
        <div class="communication-path">
            <p><strong>Used when:</strong> Content script needs to talk to background worker (different execution contexts)</p>
            <pre>// Content script sends message
chrome.runtime.sendMessage({
  action: 'CAPTURE_SCREENSHOT',
  data: elementInfo
});

// Background worker receives message
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'CAPTURE_SCREENSHOT') {
    // Capture screenshot and respond
  }
});</pre>
        </div>

        <h3>Pattern 2: Custom Events (Same-Context)</h3>
        <div class="communication-path">
            <p><strong>Used when:</strong> Canvas needs to refresh when storage changes (within same page/context)</p>
            <pre>// After updating storage
window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));

// Canvas listens for event
useEffect(() => {
  const handleUpdate = () => loadCards();
  window.addEventListener('nabokov:cards-updated', handleUpdate);
  return () => window.removeEventListener('nabokov:cards-updated', handleUpdate);
}, []);</pre>
        </div>

        <h3>Pattern 3: Shared Storage (Async Persistence)</h3>
        <div class="communication-path">
            <p><strong>Used when:</strong> Any context needs to read/write persistent data</p>
            <pre>// Content script saves card
await chrome.storage.local.set({ cards: [...cards, newCard] });

// Canvas reads cards (separate execution context!)
const { cards } = await chrome.storage.local.get('cards');</pre>
        </div>

        <h2>ü§ù How Canvas and Side Panel Relate</h2>

        <div class="two-column">
            <div class="storage-box">
                <h4>Canvas Page</h4>
                <ul>
                    <li>Displays cards where <code>stashed !== true</code></li>
                    <li>Main workspace for organizing cards</li>
                    <li>Can stash cards (sets <code>stashed: true</code>)</li>
                    <li>Listens to <code>nabokov:cards-updated</code></li>
                    <li>Opened by clicking extension icon</li>
                </ul>
            </div>

            <div class="storage-box">
                <h4>Side Panel</h4>
                <ul>
                    <li>Displays cards where <code>stashed === true</code></li>
                    <li>Temporary storage for cards you want to hide</li>
                    <li>Can restore cards (sets <code>stashed: false</code>)</li>
                    <li>Listens to <code>nabokov:stash-updated</code></li>
                    <li>Opened via Chrome Side Panel UI</li>
                </ul>
            </div>
        </div>

        <div class="key-point">
            <strong>Important:</strong> Canvas and Side Panel are <strong>completely separate React apps</strong>. They don't share:
            <ul>
                <li>JavaScript variables or state</li>
                <li>React contexts</li>
                <li>Service workers</li>
                <li>Memory</li>
            </ul>
            <p>They only share data through <code>chrome.storage.local</code> and IndexedDB.</p>
        </div>

        <h2>üìÇ File Creation Process</h2>

        <div class="flow-diagram">
<strong>Development Time (npm run build):</strong>
<div class="flow-step">Vite reads <code>src/canvas/index.html</code></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">Bundles all React code, TypeScript, CSS</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">Outputs to <code>dist/src/canvas/index.html</code> (static file)</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">Same for <code>dist/src/sidepanel/index.html</code></div>

<br>
<strong>Runtime (user clicks extension icon):</strong>
<div class="flow-step">Background worker executes: <code>chrome.tabs.create({ url: 'src/canvas/index.html' })</code></div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">Chrome opens the <strong>already-built static HTML file</strong> from dist/</div>
<div class="flow-step">   <span class="arrow">‚Üì</span></div>
<div class="flow-step">React app initializes and loads cards from storage</div>
        </div>

        <h2>üéØ Quick Reference Table</h2>

        <table>
            <thead>
                <tr>
                    <th>Context</th>
                    <th>How It's Created</th>
                    <th>When It Runs</th>
                    <th>Main Purpose</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Background Worker</strong></td>
                    <td>Chrome starts automatically (Manifest V3)</td>
                    <td>When extension installed, may sleep</td>
                    <td>Orchestrate, capture screenshots, handle shortcuts</td>
                </tr>
                <tr>
                    <td><strong>Content Script</strong></td>
                    <td>Chrome injects into every page</td>
                    <td>Every page load (<code>&lt;all_urls&gt;</code>)</td>
                    <td>Capture elements from webpages</td>
                </tr>
                <tr>
                    <td><strong>Canvas Page</strong></td>
                    <td>Vite builds static HTML, background opens it</td>
                    <td>When user clicks extension icon</td>
                    <td>Display and organize cards</td>
                </tr>
                <tr>
                    <td><strong>Side Panel</strong></td>
                    <td>Vite builds static HTML, Chrome Side Panel API opens it</td>
                    <td>When user opens side panel or calls <code>chrome.sidePanel.open()</code></td>
                    <td>Manage stashed (hidden) cards</td>
                </tr>
            </tbody>
        </table>

        <h2>üß† Mental Model Summary</h2>

        <div class="important-box">
            <h2>Think of it like this:</h2>
            <ul style="font-size: 15px; line-height: 1.6;">
                <li><strong>Background Worker</strong> = The conductor of an orchestra (coordinates everything)</li>
                <li><strong>Content Script</strong> = A spy on every website (captures content)</li>
                <li><strong>Canvas</strong> = A separate desktop app window (manages visual workspace)</li>
                <li><strong>Side Panel</strong> = A separate drawer/sidebar app (manages stash)</li>
                <li><strong>chrome.storage.local</strong> = Shared database (everyone reads/writes to it)</li>
                <li><strong>IndexedDB</strong> = File storage for large images</li>
            </ul>
            <p style="margin-top: 12px; font-weight: 600; color: var(--chinese-red);">They're all separate processes that communicate via messages and shared storage, NOT shared memory or workers.</p>
        </div>

    </div>
</body>
</html>