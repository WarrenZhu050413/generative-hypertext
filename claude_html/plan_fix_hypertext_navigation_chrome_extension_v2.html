<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fix Hypertext Navigation in Chrome Extension (Revised)</title>
<style>
:root {
    --chinese-red: #8B0000;
    --chinese-gold: #FFD700;
    --jade-green: #00A86B;
    --ink-black: #2B2B2B;
    --paper-beige: #F5F5DC;
    --light-cream: #FAFAF0;
    --level-1: #000;
    --level-2: #333;
    --level-3: #666;
    --level-4: #999;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
    color: var(--ink-black);
    width: 100vw;
    max-width: 100%;
    line-height: 1.2;
    font-size: 14px;
    font-family: "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
}

.container { width: 100%; padding: 0; margin: 0; }

h1 {
    font-size: 24px; font-weight: 900; margin: 4px 0; padding: 6px 4px;
    background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
}

h2 {
    font-size: 18px; font-weight: 700; margin: 8px 0 4px 0; padding: 4px;
    border-left: 4px solid var(--chinese-red);
    background: rgba(139, 0, 0, 0.03); color: var(--level-1);
}

h3 {
    font-size: 14px; font-weight: 600; margin: 4px 0 2px 8px;
    color: var(--level-2); text-transform: uppercase; letter-spacing: 0.5px;
}

h4 { font-size: 12px; font-weight: 500; margin: 2px 0 1px 16px; color: var(--level-3); }

.critical-issue {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.15), rgba(255, 215, 0, 0.1));
    border: 3px solid var(--chinese-red);
    padding: 12px; margin: 8px 0; border-radius: 4px;
}

.critical-issue h2 { color: var(--chinese-red); margin-top: 0; }

.primary-section {
    border: 2px solid var(--chinese-red);
    background: white; margin: 6px 0; padding: 6px;
}

.secondary-section {
    border-left: 3px solid var(--chinese-gold);
    background: rgba(255, 215, 0, 0.05);
    margin: 4px 0 4px 8px; padding: 4px;
}

.card {
    background: white;
    border: 1px solid rgba(139, 0, 0, 0.2);
    border-radius: 2px; padding: 6px; margin: 4px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card.priority {
    border: 2px solid var(--chinese-gold);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
}

pre, code {
    background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
    border: 1px solid rgba(139, 0, 0, 0.15);
    padding: 4px 6px; font-size: 12px; font-family: 'SF Mono', Monaco, monospace;
    line-height: 1.3; overflow-x: auto; border-radius: 2px;
}

pre { padding: 8px; margin: 4px 0; }
code { padding: 2px 4px; }

.dense-list { list-style: none; padding: 0; margin-left: 8px; }
.dense-list li {
    padding: 2px 0 2px 12px; border-left: 2px solid transparent; position: relative;
}
.dense-list li:before {
    content: "‚ñ∏"; position: absolute; left: 0;
    color: var(--chinese-red); font-size: 10px;
}

.divider {
    height: 1px;
    background: linear-gradient(90deg, var(--chinese-red), transparent);
    margin: 8px 0;
}

.mermaid-container {
    background: white;
    border: 2px solid var(--chinese-gold);
    border-radius: 4px;
    padding: 12px;
    margin: 8px 0;
}

.status-good { color: var(--jade-green); font-weight: 600; }
.status-bad { color: var(--chinese-red); font-weight: 600; }
.status-warn { color: #ff8c00; font-weight: 600; }

table {
    border-collapse: collapse; width: 100%; margin: 4px 0;
    background: white; font-size: 12px;
}

th, td {
    border: 1px solid rgba(139, 0, 0, 0.2);
    padding: 4px 6px; text-align: left;
}

th {
    background: rgba(139, 0, 0, 0.08);
    font-weight: 600; color: var(--level-1);
}
</style>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
<div class="container">

<h1>Fix Hypertext Navigation in Chrome Extension (Revised)</h1>

<div class="critical-issue">
    <h2>üî¥ Critical Issue Identified by Codex Review</h2>
    <p><strong>The original plan has a fatal flaw:</strong> Even after fixing the URL resolution, the chat page won't work because <code>sessionStorage</code> doesn't cross origins!</p>
    <ul class="dense-list">
        <li>Host page (https://example.com) writes to its own <code>sessionStorage</code></li>
        <li>Extension page (chrome-extension://abc123/...) has a different origin</li>
        <li>Extension page <strong>cannot read</strong> the host page's sessionStorage</li>
        <li>Result: Chat page opens but shows fallback/empty data ‚ùå</li>
    </ul>
    <p><strong>We must fix BOTH the URL resolution AND the payload transport.</strong></p>
</div>

<div class="divider"></div>

<h2>Revised Solution: Background Script with chrome.storage.session</h2>

<div class="card priority">
    <h3>Why This Approach</h3>
    <ul class="dense-list">
        <li><strong>Solves URL resolution:</strong> Background script uses chrome.runtime.getURL()</li>
        <li><strong>Solves payload transport:</strong> Uses chrome.storage.session (cross-context accessible)</li>
        <li><strong>Secure:</strong> No web_accessible_resources needed (chat page not exposed)</li>
        <li><strong>Clean architecture:</strong> Privileged operations isolated in background</li>
        <li><strong>Respects shiftKey:</strong> Can update current tab vs. open new tab</li>
    </ul>
</div>

<div class="mermaid-container">
    <h3>Complete Flow with Payload Transport</h3>
    <div class="mermaid">
sequenceDiagram
    participant User
    participant Content as Content Script<br/>(on example.com)
    participant BG as Background Script
    participant Storage as chrome.storage.session
    participant Chat as Chat Page<br/>(extension tab)

    User->>Content: Click hypertext link
    Content->>Content: Build payload from session
    Content->>BG: chrome.runtime.sendMessage({<br/>type: 'OPEN_CHAT',<br/>payload: {...}})

    BG->>Storage: Set key with unique ID<br/>'chat-${timestamp}': payload
    Storage-->>BG: Stored

    BG->>BG: Build URL with session key<br/>chrome-extension://...?session=chat-123

    BG->>Chat: chrome.tabs.create({url})
    Chat->>Chat: Page loads
    Chat->>Storage: Get key from ?session param
    Storage-->>Chat: Return payload
    Chat->>Chat: Render conversation
    Chat->>Storage: Delete key (cleanup)

    BG->>Content: sendResponse({success: true})
    </div>
</div>

<div class="divider"></div>

<h2>Implementation</h2>

<div class="card priority">
    <h3>Step 1: Update manifest.json</h3>
    <pre>{
  "manifest_version": 3,
  "name": "Hypertext Navigator",
  "description": "Inline hypertext annotations with floating chat tooltips.",
  "version": "0.1.0",

  "permissions": [
    "storage",      <span class="status-good">// Already present</span>
    "tabs"          <span class="status-good">// ADD: Needed for chrome.tabs.create</span>
  ],

  "host_permissions": [
    "&lt;all_urls&gt;"
  ],

  "background": {
    "service_worker": "extension/background.js",
    "type": "module"
  },

  "content_scripts": [
    {
      "matches": ["&lt;all_urls&gt;"],
      "js": [
        "hypertext/hypertext-experience.js",
        "extension/hypertext-loader.js"
      ],
      "run_at": "document_idle"
    }
  ]

  <span class="status-good">// NO web_accessible_resources needed - more secure!</span>
}</pre>
</div>

<div class="card priority">
    <h3>Step 2: Create/Update extension/background.js</h3>
    <pre>// extension/background.js

chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'OPEN_CHAT_PAGE') {
    handleOpenChatPage(message, sender, sendResponse);
    return true; // Keep channel open for async response
  }
});

async function handleOpenChatPage(message, sender, sendResponse) {
  const { payload, shiftKey } = message;

  try {
    // Generate unique session key
    const sessionKey = `hypertext:chat-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Store payload in chrome.storage.session
    await chrome.storage.session.set({ [sessionKey]: payload });

    // Build extension URL with session parameter
    const chatUrl = chrome.runtime.getURL('demo/simple_chat_page.html');
    const fullUrl = `${chatUrl}?session=${encodeURIComponent(sessionKey)}`;

    // Decide tab behavior based on shiftKey
    if (shiftKey && sender.tab) {
      // Update current tab
      await chrome.tabs.update(sender.tab.id, { url: fullUrl });
    } else {
      // Open new tab
      await chrome.tabs.create({ url: fullUrl, active: true });
    }

    sendResponse({ success: true, sessionKey });

  } catch (error) {
    console.error('[Hypertext Background] Failed to open chat page:', error);
    sendResponse({
      success: false,
      error: error.message || 'Unknown error'
    });
  }
}</pre>
</div>

<div class="card priority">
    <h3>Step 3: Update hypertext/hypertext-experience.js</h3>
    <h4>Modify createHypertextExperience options (line ~798)</h4>
    <pre>function createHypertextExperience(options = {}) {
  const {
    document: customDocument,
    backendUrl = 'http://localhost:3100',
    contextProvider,
    hotkey = defaultHotkey,
    selectionValidator,
    autoOpenTooltipOnHover = true,
    registerExternalTrigger,
    chatPageUrl = 'demo/simple_chat_page.html',
    <span class="status-good">openChatPage  // NEW: Optional function to open chat (for extension)</span>
  } = options;

  // ... rest of code
}</pre>

    <h4>Update openChatPageFromSession function (line ~1453)</h4>
    <pre>function openChatPageFromSession(session, event) {
  const payload = buildChatPayload(session);
  if (!payload) return;

  closeChat({ force: true });

  <span class="status-good">// NEW: Use custom opener if provided (for Chrome extension)</span>
  if (typeof openChatPage === 'function') {
    try {
      openChatPage(payload, {
        shiftKey: event?.shiftKey,
        session,
        event
      });
      return;
    } catch (error) {
      console.warn('[Hypertext] Custom openChatPage failed:', error);
      // Fall through to default behavior
    }
  }

  <span class="status-good">// Fallback: Original standalone demo behavior</span>
  try {
    win.sessionStorage?.setItem('hypertext:handoff', JSON.stringify(payload));
  } catch (error) {
    console.warn('[Hypertext] Failed to persist chat payload:', error);
  }

  const target = event?.shiftKey ? '_self' : '_blank';
  let resolvedUrl = chatPageUrl;

  try {
    resolvedUrl = new URL(chatPageUrl, win.location.href).toString();
  } catch (error) {
    /* ignore resolution errors */
  }

  try {
    win.open(resolvedUrl, target, 'noopener,noreferrer');
  } catch (error) {
    console.warn('[Hypertext] Failed to open chat page:', error);
  }
}</pre>
</div>

<div class="card priority">
    <h3>Step 4: Update extension/hypertext-loader.js</h3>
    <pre>// extension/hypertext-loader.js

window.createHypertextExperience({
  backendUrl: 'http://localhost:3100',
  chatPageUrl: 'demo/simple_chat_page.html',

  <span class="status-good">// NEW: Custom chat page opener using background script</span>
  openChatPage: (payload, options) => {
    const { shiftKey } = options || {};

    return new Promise((resolve, reject) => {
      chrome.runtime.sendMessage(
        {
          type: 'OPEN_CHAT_PAGE',
          payload,
          shiftKey: Boolean(shiftKey)
        },
        (response) => {
          if (chrome.runtime.lastError) {
            reject(new Error(chrome.runtime.lastError.message));
            return;
          }

          if (response?.success) {
            resolve(response);
          } else {
            reject(new Error(response?.error || 'Failed to open chat page'));
          }
        }
      );
    });
  }
});</pre>
</div>

<div class="card priority">
    <h3>Step 5: Update demo/simple_chat_page.html</h3>
    <pre>&lt;!-- demo/simple_chat_page.html --&gt;

&lt;script&gt;
const STORAGE_KEY = 'hypertext:handoff';

<span class="status-good">// NEW: Load from chrome.storage.session if available</span>
async function loadPayload() {
  // Check for session parameter (Chrome extension path)
  const params = new URLSearchParams(window.location.search);
  const sessionKey = params.get('session');

  if (sessionKey && typeof chrome !== 'undefined' && chrome.storage?.session) {
    try {
      const result = await chrome.storage.session.get(sessionKey);

      if (result[sessionKey]) {
        const payload = result[sessionKey];

        // Clean up - delete the key after reading
        chrome.storage.session.remove(sessionKey).catch(err => {
          console.warn('Failed to cleanup session key:', err);
        });

        return payload;
      } else {
        console.warn('Session key not found in storage:', sessionKey);
      }
    } catch (error) {
      console.warn('Failed to load from chrome.storage.session:', error);
    }
  }

  // Fallback: Try sessionStorage (standalone demo path)
  try {
    const cached = sessionStorage.getItem(STORAGE_KEY);
    if (cached) {
      return JSON.parse(cached);
    }
  } catch (error) {
    console.warn('Failed to parse cached payload:', error);
  }

  // Final fallback
  return fallbackPayload();
}

function fallbackPayload() {
  return {
    subject: 'Kinbote\'s interventions',
    summary: 'Kinbote commandeers Shade\'s poem...',
    focus: 'Footnotes vs. canto pacing',
    transcript: [
      { role: 'assistant', content: 'Fallback assistant insight...' },
      { role: 'user', content: 'Show me how often Kinbote interrupts...' }
    ],
    sourceUrl: 'demo/simple_tooltip_redirect.html',
    timestamp: new Date().toISOString(),
    textSize: 'normal'
  };
}

// ... rest of existing code ...

<span class="status-good">// Call loadPayload (now async)</span>
loadPayload().then(payload => {
  populatePage(payload);
});
&lt;/script&gt;</pre>
</div>

<div class="divider"></div>

<h2>Security Improvements</h2>

<div class="card">
    <h3>‚úÖ This Approach is More Secure</h3>
    <table>
        <thead>
            <tr>
                <th>Aspect</th>
                <th>Original Plan (web_accessible_resources)</th>
                <th>Revised Plan (Background Script)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Chat page exposure</strong></td>
                <td><span class="status-warn">Accessible to all websites</span></td>
                <td><span class="status-good">Only accessible to extension</span></td>
            </tr>
            <tr>
                <td><strong>Payload transport</strong></td>
                <td><span class="status-bad">Broken (sessionStorage cross-origin)</span></td>
                <td><span class="status-good">Works (chrome.storage.session)</span></td>
            </tr>
            <tr>
                <td><strong>Data leakage</strong></td>
                <td><span class="status-warn">Query params or sessionStorage</span></td>
                <td><span class="status-good">Isolated chrome.storage</span></td>
            </tr>
            <tr>
                <td><strong>Cleanup</strong></td>
                <td><span class="status-warn">Manual sessionStorage clear</span></td>
                <td><span class="status-good">Auto-cleanup after read</span></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Additional Security Measures</h3>
    <ul class="dense-list">
        <li><strong>noopener,noreferrer:</strong> Added to window.open fallback path</li>
        <li><strong>Session key validation:</strong> Chat page checks if key exists before using</li>
        <li><strong>Auto-cleanup:</strong> Session key deleted immediately after reading</li>
        <li><strong>Unique keys:</strong> Timestamp + random string prevents collisions</li>
        <li><strong>Error handling:</strong> All async operations wrapped in try/catch</li>
    </ul>
</div>

<div class="divider"></div>

<h2>Testing Strategy</h2>

<div class="card">
    <h3>Test Case 1: Extension Context - URL Resolution</h3>
    <ol class="dense-list">
        <li>Load extension in Chrome</li>
        <li>Navigate to external site (e.g., news.ycombinator.com)</li>
        <li>Select text and trigger hypertext (Cmd+Shift+K)</li>
        <li>Click on generated hypertext link</li>
        <li><strong>Verify:</strong> New tab opens with chrome-extension://[id]/demo/simple_chat_page.html?session=...</li>
    </ol>
</div>

<div class="card">
    <h3>Test Case 2: Extension Context - Payload Transport</h3>
    <ol class="dense-list">
        <li>After opening chat page (from Test 1)</li>
        <li><strong>Verify:</strong> Chat page shows correct subject from original selection</li>
        <li><strong>Verify:</strong> Conversation history is displayed</li>
        <li><strong>Verify:</strong> Source URL shows original page</li>
        <li><strong>Verify:</strong> Text size preference is applied</li>
        <li>Open DevTools ‚Üí Application ‚Üí Storage</li>
        <li><strong>Verify:</strong> Session key has been deleted (cleanup worked)</li>
    </ol>
</div>

<div class="card">
    <h3>Test Case 3: Shift-Click Behavior</h3>
    <ol class="dense-list">
        <li>Create hypertext link on external site</li>
        <li>Hold Shift and click the link</li>
        <li><strong>Verify:</strong> Current tab navigates to chat page (not new tab)</li>
        <li><strong>Verify:</strong> Payload still loads correctly</li>
    </ol>
</div>

<div class="card">
    <h3>Test Case 4: Standalone Demo Fallback</h3>
    <ol class="dense-list">
        <li>Open demo/hypertext_navigation_demo.html directly (not via extension)</li>
        <li>Select text and generate hypertext</li>
        <li>Click on generated link</li>
        <li><strong>Verify:</strong> Opens demo/simple_chat_page.html in new tab</li>
        <li><strong>Verify:</strong> Payload loads from sessionStorage</li>
        <li><strong>Verify:</strong> No console errors about chrome.storage</li>
    </ol>
</div>

<div class="card">
    <h3>Test Case 5: Error Handling</h3>
    <ol class="dense-list">
        <li>Disable extension (or use incognito without extension)</li>
        <li>Try to click hypertext link</li>
        <li><strong>Verify:</strong> Graceful fallback to sessionStorage path</li>
        <li><strong>Verify:</strong> Console shows warning but doesn't crash</li>
    </ol>
</div>

<div class="divider"></div>

<h2>Implementation Checklist</h2>

<div class="card priority">
    <h3>Required Changes</h3>
    <ul class="dense-list">
        <li>‚òê Add "tabs" permission to manifest.json</li>
        <li>‚òê Create/update extension/background.js with OPEN_CHAT_PAGE handler</li>
        <li>‚òê Add <code>openChatPage</code> parameter to createHypertextExperience options</li>
        <li>‚òê Update openChatPageFromSession to call custom opener first</li>
        <li>‚òê Add noopener,noreferrer to fallback window.open</li>
        <li>‚òê Update extension/hypertext-loader.js to pass openChatPage function</li>
        <li>‚òê Update demo/simple_chat_page.html to check chrome.storage.session first</li>
        <li>‚òê Add session key cleanup in chat page</li>
        <li>‚òê Test all 5 test cases above</li>
        <li>‚òê Update tests/hypertext-demo.spec.mjs for new flow</li>
    </ul>
</div>

<div class="divider"></div>

<h2>Comparison with Original Plan</h2>

<div class="mermaid-container">
    <div class="mermaid">
graph TB
    subgraph "Original Plan (BROKEN)"
        A1[Content Script] -->|sessionStorage.setItem| B1[Host Page Storage]
        A1 -->|window.open| C1[Extension Chat Page]
        C1 -->|sessionStorage.getItem| B1
        B1 -.->|‚ùå Cross-origin blocked| C1
        style C1 fill:#fcc,stroke:#c00
    end

    subgraph "Revised Plan (WORKING)"
        A2[Content Script] -->|chrome.runtime.sendMessage| B2[Background Script]
        B2 -->|chrome.storage.session.set| C2[Extension Storage]
        B2 -->|chrome.tabs.create| D2[Extension Chat Page]
        D2 -->|chrome.storage.session.get| C2
        C2 -->|‚úì Returns payload| D2
        D2 -->|chrome.storage.session.remove| C2
        style D2 fill:#cfc,stroke:#0c0
    end
    </div>
</div>

<div class="card priority">
    <h3>Why Revision is Essential</h3>
    <ul class="dense-list">
        <li><strong>Original Plan:</strong> Only fixed URL, payload still broken</li>
        <li><strong>Revised Plan:</strong> Fixes both URL AND payload transport</li>
        <li><strong>Result:</strong> Actually working chat page with correct data</li>
    </ul>
</div>

</div>

<script>
mermaid.initialize({
    startOnLoad: true,
    theme: 'neutral',
    flowchart: { curve: 'basis' }
});
</script>
</body>
</html>