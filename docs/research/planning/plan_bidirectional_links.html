<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bidirectional Links Implementation Plan - NabokovsWeb</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #F5F5DC;
            --light-cream: #FFFEF0;
            --ink-black: #2C2C2C;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #666;
            --level-4: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.3;
            font-size: 14px;
            width: 100vw;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            padding: 8px;
            margin: 0;
        }

        h1 {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0;
            padding: 12px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 12px 0 6px 0;
            padding: 6px;
            border-left: 5px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 6px 0 3px 12px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 14px;
            font-weight: 500;
            margin: 4px 0 2px 16px;
            color: var(--level-3);
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), white);
            border: 3px solid var(--chinese-gold);
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .collapsible {
            margin: 6px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 12px;
            margin-right: 8px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 12px;
            margin-left: 16px;
        }

        .collapsible.open .collapsible-content {
            max-height: 10000px;
            padding: 12px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 5px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .collapsible.high .collapsible-header {
            border-left: 4px solid var(--chinese-gold);
            background: rgba(255, 215, 0, 0.08);
            font-weight: 600;
        }

        .collapsible.medium .collapsible-header {
            border-left: 3px solid #999;
            background: rgba(0, 0, 0, 0.02);
            font-weight: 500;
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin-left: 12px;
        }

        .dense-list li {
            padding: 3px 0 3px 16px;
            border-left: 2px solid transparent;
            position: relative;
            line-height: 1.4;
        }

        .dense-list li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 11px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 2px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        pre {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 8px;
            margin: 6px 0;
            overflow-x: auto;
            border-radius: 3px;
        }

        pre code {
            background: none;
            border: none;
            padding: 0;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 3px;
            padding: 8px;
            margin: 6px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 12px 0;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 16px 0;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 600;
            margin: 0 4px;
        }

        .badge.critical { background: #ff4444; color: white; }
        .badge.high { background: #ffaa00; color: white; }
        .badge.medium { background: #4CAF50; color: white; }
        .badge.implementation { background: var(--chinese-gold); color: #8B0000; }

        .indent-1 { margin-left: 16px; }
        .indent-2 { margin-left: 32px; }
        .indent-3 { margin-left: 48px; }

        .stat {
            display: inline-block;
            background: var(--chinese-red);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 13px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 4px 8px;
            text-align: left;
            line-height: 1.2;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— Bidirectional Links Implementation Plan</h1>

        <div class="important-always-visible">
            <h2>ğŸ¯ Critical Context</h2>
            <ul class="dense-list">
                <li><strong>Gap Identified:</strong> Missing backlinks panel - universal in Roam, Obsidian, VKB (Pattern 1 from research)</li>
                <li><strong>Priority:</strong> P1 - HIGH (F0.1) <span class="badge high">COMPETITIVE PARITY</span></li>
                <li><strong>Estimated Effort:</strong> <span class="stat">0.5 days</span></li>
                <li><strong>Current State:</strong> Forward links exist (connections system), backlinks need UI exposure</li>
                <li><strong>Impact:</strong> Essential for knowledge graph navigation + competitive table stakes feature</li>
            </ul>
        </div>

        <div class="divider"></div>

        <h2>ğŸ“Š Current State Analysis</h2>

        <div class="card priority">
            <h3>âœ… Existing Infrastructure (Already Built)</h3>
            <ul class="dense-list">
                <li><strong>connectionStorage.ts:</strong> Manages connections in <code>chrome.storage.local</code></li>
                <li><strong>Connection Schema:</strong> <code>{ id, source, target, createdAt, connectionType, label? }</code></li>
                <li><strong>Connection Types:</strong> <code>'related'</code>, <code>'generated-from'</code>, <code>'references'</code>, <code>'contradicts'</code>, <code>'custom'</code></li>
                <li><strong>EdgeEditModal:</strong> UI for editing connection types and labels</li>
                <li><strong>Canvas Rendering:</strong> React Flow automatically renders connections as edges</li>
            </ul>
        </div>

        <div class="card">
            <h3>âŒ Missing Pieces</h3>
            <ul class="dense-list">
                <li>No UI to show <strong>incoming</strong> connections (backlinks) to a card</li>
                <li>No backlinks panel/section in CardNode component</li>
                <li>No utility function to query connections by target (only by source exists)</li>
            </ul>
        </div>

        <div class="divider"></div>

        <h2>ğŸ—ï¸ Implementation Approach</h2>

        <div class="collapsible critical open">
            <div class="collapsible-header">
                <div><span class="arrow">â–¶</span><strong>Phase 1: Backend - Query Layer</strong> <span class="badge critical">FOUNDATIONAL</span></div>
            </div>
            <div class="collapsible-content">
                <h4>File: <code>src/utils/connectionStorage.ts</code></h4>

                <p><strong>Add new function:</strong></p>
                <pre><code>/**
 * Get all connections where the given cardId is the TARGET
 * (i.e., incoming connections / backlinks)
 */
export async function getIncomingConnections(
  cardId: string
): Promise&lt;Connection[]&gt; {
  const connections = await getAllConnections();
  return connections.filter(conn => conn.target === cardId);
}</code></pre>

                <p class="indent-1"><strong>âœ… No breaking changes</strong> - purely additive</p>
            </div>
        </div>

        <div class="collapsible high open">
            <div class="collapsible-header">
                <div><span class="arrow">â–¶</span><strong>Phase 2: UI Component - Backlinks Panel</strong> <span class="badge high">USER-FACING</span></div>
            </div>
            <div class="collapsible-content">
                <h4>New File: <code>src/components/BacklinksPanel.tsx</code></h4>

                <p><strong>Component Specification:</strong></p>
                <ul class="dense-list">
                    <li><strong>Props:</strong> <code>{ cardId: string }</code></li>
                    <li><strong>Hook:</strong> <code>useEffect</code> to load incoming connections on mount</li>
                    <li><strong>State:</strong> <code>backlinks: Connection[]</code></li>
                    <li><strong>Display:</strong> Collapsible section showing linked card titles</li>
                    <li><strong>Interaction:</strong> Click backlink â†’ navigate to source card (React Flow <code>fitView</code>)</li>
                </ul>

                <p><strong>Minimal Implementation:</strong></p>
                <pre><code>/** @jsxImportSource @emotion/react */
import { useState, useEffect } from 'react';
import { getIncomingConnections } from '@/utils/connectionStorage';
import { getCardById } from '@/utils/storage';

interface BacklinksPanelProps {
  cardId: string;
  onNavigateToCard?: (cardId: string) => void;
}

export function BacklinksPanel({ cardId, onNavigateToCard }: BacklinksPanelProps) {
  const [backlinks, setBacklinks] = useState&lt;Array&lt;{
    connection: Connection;
    sourceCard: Card | null;
  }&gt;&gt;([]);
  const [isOpen, setIsOpen] = useState(true);

  useEffect(() => {
    async function loadBacklinks() {
      const connections = await getIncomingConnections(cardId);
      const linksWithCards = await Promise.all(
        connections.map(async (conn) => ({
          connection: conn,
          sourceCard: await getCardById(conn.source)
        }))
      );
      setBacklinks(linksWithCards);
    }
    loadBacklinks();
  }, [cardId]);

  if (backlinks.length === 0) return null;

  return (
    &lt;div css={{ marginTop: 8, borderTop: '1px solid #ddd', paddingTop: 8 }}&gt;
      &lt;div
        onClick={() => setIsOpen(!isOpen)}
        css={{
          cursor: 'pointer',
          fontWeight: 600,
          fontSize: 12,
          color: '#8B0000',
          display: 'flex',
          alignItems: 'center'
        }}
      &gt;
        &lt;span css={{ marginRight: 4 }}&gt;{isOpen ? 'â–¼' : 'â–¶'}&lt;/span&gt;
        Backlinks ({backlinks.length})
      &lt;/div&gt;
      {isOpen && (
        &lt;ul css={{ listStyle: 'none', padding: 0, marginTop: 4 }}&gt;
          {backlinks.map(({ connection, sourceCard }) => (
            &lt;li
              key={connection.id}
              onClick={() => onNavigateToCard?.(connection.source)}
              css={{
                fontSize: 11,
                padding: '2px 0 2px 12px',
                cursor: 'pointer',
                color: '#666',
                '&:hover': { color: '#8B0000', textDecoration: 'underline' }
              }}
            &gt;
              â† {sourceCard?.metadata?.title || 'Untitled'}
              &lt;span css={{ color: '#999', marginLeft: 4 }}&gt;
                ({connection.connectionType})
              &lt;/span&gt;
            &lt;/li&gt;
          ))}
        &lt;/ul&gt;
      )}
    &lt;/div&gt;
  );
}</code></pre>
            </div>
        </div>

        <div class="collapsible high open">
            <div class="collapsible-header">
                <div><span class="arrow">â–¶</span><strong>Phase 3: Integration - CardNode Update</strong> <span class="badge high">INTEGRATION</span></div>
            </div>
            <div class="collapsible-content">
                <h4>File: <code>src/canvas/CardNode.tsx</code></h4>

                <p><strong>Changes Required:</strong></p>
                <ol class="dense-list">
                    <li><strong>Import:</strong> <code>import { BacklinksPanel } from '@/components/BacklinksPanel';</code></li>
                    <li><strong>Add navigation callback:</strong> Use React Flow's <code>useReactFlow()</code> hook</li>
                    <li><strong>Render:</strong> Add <code>&lt;BacklinksPanel /&gt;</code> at bottom of card content</li>
                </ol>

                <p><strong>Code Diff:</strong></p>
                <pre><code>// In CardNode.tsx
import { useReactFlow } from 'reactflow';
import { BacklinksPanel } from '@/components/BacklinksPanel';

export function CardNode({ data }: { data: { card: Card } }) {
  const { fitView, getNode } = useReactFlow();

  const handleNavigateToCard = (targetCardId: string) => {
    const node = getNode(targetCardId);
    if (node) {
      fitView({
        nodes: [node],
        duration: 300,
        padding: 0.2
      });
    }
  };

  return (
    &lt;div className="card-node"&gt;
      {/* ... existing card content ... */}

      {/* Add at bottom, before closing div */}
      &lt;BacklinksPanel
        cardId={data.card.id}
        onNavigateToCard={handleNavigateToCard}
      /&gt;
    &lt;/div&gt;
  );
}</code></pre>
            </div>
        </div>

        <div class="collapsible medium">
            <div class="collapsible-header">
                <div><span class="arrow">â–¶</span><strong>Phase 4: Polish & Edge Cases</strong> <span class="badge medium">REFINEMENT</span></div>
            </div>
            <div class="collapsible-content">
                <h4>Enhancements (Optional, can be deferred):</h4>
                <ul class="dense-list">
                    <li><strong>Empty State:</strong> "No backlinks yet" message with subtle styling</li>
                    <li><strong>Connection Type Filtering:</strong> Group by connection type in UI</li>
                    <li><strong>Visual Indicator:</strong> Show connection direction arrow in backlinks list</li>
                    <li><strong>Real-Time Updates:</strong> Listen to <code>'nabokov:cards-updated'</code> event to refresh backlinks</li>
                    <li><strong>Performance:</strong> Cache backlinks in CardNode state, only reload on connection changes</li>
                </ul>

                <h4>Edge Cases to Handle:</h4>
                <ul class="dense-list">
                    <li><strong>Deleted Source Cards:</strong> Filter out backlinks where <code>sourceCard === null</code></li>
                    <li><strong>Circular References:</strong> No special handling needed (display normally)</li>
                    <li><strong>Stashed Cards:</strong> Option to hide backlinks from stashed cards</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>ğŸ§ª Testing Strategy</h2>

        <div class="two-column">
            <div class="card">
                <h4>Unit Tests (Vitest)</h4>
                <p><strong>File:</strong> <code>tests/unit/connectionStorage.test.ts</code></p>
                <ul class="dense-list">
                    <li>Test <code>getIncomingConnections()</code> returns correct backlinks</li>
                    <li>Test filtering by target card ID</li>
                    <li>Test empty state (no backlinks)</li>
                    <li>Test multiple backlinks from different sources</li>
                </ul>
            </div>

            <div class="card">
                <h4>E2E Tests (Playwright)</h4>
                <p><strong>File:</strong> <code>tests/e2e/backlinks.spec.ts</code></p>
                <ul class="dense-list">
                    <li>Create 2 cards A â†’ B connection</li>
                    <li>Verify backlinks panel appears on card B</li>
                    <li>Click backlink â†’ verify navigation to card A</li>
                    <li>Test collapsible expand/collapse</li>
                </ul>
            </div>
        </div>

        <div class="card priority">
            <h4>Manual Testing Checklist</h4>
            <ol class="dense-list">
                <li>Create card A, then generate child card B from it (auto-creates A â†’ B connection)</li>
                <li>Verify card B shows backlink to card A</li>
                <li>Click backlink â†’ canvas should zoom/pan to card A</li>
                <li>Delete connection â†’ backlink should disappear from card B</li>
                <li>Test with multiple connection types (references, generated-from, etc.)</li>
                <li>Test with stashed cards (backlinks should/shouldn't show?)</li>
            </ol>
        </div>

        <div class="divider"></div>

        <h2>ğŸ“‹ Implementation Checklist</h2>

        <div class="important-always-visible">
            <h3>Task Breakdown (0.5 day estimate)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Time</th>
                        <th>File(s)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Add <code>getIncomingConnections()</code> function</td>
                        <td>15 min</td>
                        <td><code>src/utils/connectionStorage.ts</code></td>
                        <td><span class="badge medium">TODO</span></td>
                    </tr>
                    <tr>
                        <td>Create BacklinksPanel component</td>
                        <td>1 hour</td>
                        <td><code>src/components/BacklinksPanel.tsx</code></td>
                        <td><span class="badge medium">TODO</span></td>
                    </tr>
                    <tr>
                        <td>Integrate into CardNode</td>
                        <td>30 min</td>
                        <td><code>src/canvas/CardNode.tsx</code></td>
                        <td><span class="badge medium">TODO</span></td>
                    </tr>
                    <tr>
                        <td>Add unit tests</td>
                        <td>30 min</td>
                        <td><code>tests/unit/connectionStorage.test.ts</code></td>
                        <td><span class="badge medium">TODO</span></td>
                    </tr>
                    <tr>
                        <td>Add E2E test</td>
                        <td>45 min</td>
                        <td><code>tests/e2e/backlinks.spec.ts</code></td>
                        <td><span class="badge medium">TODO</span></td>
                    </tr>
                    <tr>
                        <td>Manual testing + polish</td>
                        <td>30 min</td>
                        <td>-</td>
                        <td><span class="badge medium">TODO</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="divider"></div>

        <h2>ğŸ¨ UI Design Mockup</h2>

        <div class="card priority">
            <h4>Visual Layout (Bottom of CardNode)</h4>
            <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Card Content Area                   â”‚
â”‚ (existing HTML/image/text)          â”‚
â”‚                                     â”‚
â”‚ Tags: #research #ai                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† divider line
â”‚ â–¼ Backlinks (3)                     â”‚ â† collapsible header (red)
â”‚   â† Research Summary (references)   â”‚ â† clickable link
â”‚   â† Main Thesis (generated-from)    â”‚
â”‚   â† Related Ideas (related)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

            <p class="indent-1"><strong>Color Scheme:</strong> Match Chinese aesthetic (red header, gold hover)</p>
            <p class="indent-1"><strong>Font Size:</strong> 11-12px (smaller than main content)</p>
            <p class="indent-1"><strong>Interaction:</strong> Hover â†’ underline + color change, Click â†’ smooth pan to source card</p>
        </div>

        <div class="divider"></div>

        <h2>ğŸš€ Future Enhancements (Post-MVP)</h2>

        <div class="collapsible medium">
            <div class="collapsible-header">
                <div><span class="arrow">â–¶</span><strong>Advanced Features (Phase 2)</strong></div>
            </div>
            <div class="collapsible-content">
                <ul class="dense-list">
                    <li><strong>Backlink Context Preview:</strong> Show snippet of source card content (like Roam)</li>
                    <li><strong>Grouped by Type:</strong> Collapse/expand by connection type</li>
                    <li><strong>Inline Editing:</strong> Edit connection type directly from backlinks panel</li>
                    <li><strong>Graph View Integration:</strong> Highlight backlink path when hovering (F3.4 dependency)</li>
                    <li><strong>Backlink Count Badge:</strong> Show number on card header before expanding</li>
                    <li><strong>Filter Options:</strong> Hide certain connection types (e.g., hide 'generated-from')</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <div class="important-always-visible">
            <h2>âœ… Success Criteria</h2>
            <ol class="dense-list">
                <li><strong>Functional:</strong> Backlinks panel shows all incoming connections correctly</li>
                <li><strong>Interactive:</strong> Clicking backlink navigates to source card with smooth animation</li>
                <li><strong>Performance:</strong> No noticeable lag when loading cards with many backlinks (&lt;100ms)</li>
                <li><strong>Visual:</strong> Matches Chinese aesthetic, collapsible by default</li>
                <li><strong>Tested:</strong> Unit + E2E tests pass, manual testing complete</li>
                <li><strong>Competitive Parity:</strong> Matches Roam/Obsidian baseline functionality</li>
            </ol>
        </div>

        <div class="divider"></div>

        <footer style="text-align: center; padding: 24px; color: var(--level-3); font-size: 12px;">
            <p><strong>ğŸ“ Implementation Plan for F0.1 - Backlinks Panel</strong></p>
            <p>Estimated: <span class="stat">0.5 days</span> | Priority: <span class="badge high">P1 - HIGH</span></p>
        </footer>
    </div>

    <script>
        // Collapsible functionality
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const collapsible = header.parentElement;
                collapsible.classList.toggle('open');
            });
        });
    </script>
</body>
</html>
