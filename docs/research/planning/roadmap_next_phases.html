<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nabokov's Web - Roadmap: Next Phases (Phase 2+)</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #FAF7F2;
            --light-cream: #F5F0E8;
            --ink-black: #2C2416;
            --level-1: #5C4D42;
            --level-2: #8B7355;
            --level-3: #A89684;
            --level-4: #C4B5A0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.3;
            font-size: 13px;
            width: 100vw;
            max-width: 100%;
        }

        .container { width: 100%; padding: 12px; }

        h1 {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0;
            padding: 10px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 14px 0 6px 0;
            padding: 8px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 10px 0 4px 8px;
            color: var(--level-2);
        }

        h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 6px 0 3px 16px;
            color: var(--level-3);
        }

        .hero {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), white);
            border: 3px solid var(--chinese-gold);
            padding: 16px;
            margin: 16px 0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .hero h2 {
            margin: 0 0 10px 0;
            border: none;
            background: none;
            padding: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .status-completed { background: #e8f5e9; color: #2e7d32; border: 1px solid #66bb6a; }
        .status-next { background: #fff3e0; color: #e65100; border: 1px solid #ff9800; }
        .status-future { background: #e3f2fd; color: #1565c0; border: 1px solid #42a5f5; }

        .phase-card {
            background: white;
            border-left: 4px solid var(--chinese-gold);
            padding: 12px;
            margin: 10px 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .phase-card.priority {
            border-left: 5px solid var(--chinese-red);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), white);
        }

        .phase-card h3 {
            margin: 0 0 8px 0;
            color: var(--chinese-red);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(139, 0, 0, 0.15);
            padding: 10px;
            border-radius: 4px;
        }

        .feature-item strong {
            color: var(--chinese-red);
            display: block;
            margin-bottom: 4px;
        }

        .time-estimate {
            background: rgba(139, 0, 0, 0.1);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 6px;
        }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 3px 6px;
            font-size: 12px;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        pre {
            padding: 10px;
            margin: 8px 0;
            overflow-x: auto;
        }

        ul, ol {
            margin: 6px 0 6px 24px;
        }

        li {
            margin: 4px 0;
            line-height: 1.5;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 20px 0;
        }

        .highlight {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05));
            padding: 10px;
            border-left: 4px solid var(--chinese-gold);
            margin: 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 8px;
            text-align: left;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
        }

        .collapsible {
            margin: 8px 0;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 10px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 12px;
            margin-right: 8px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0;
        }

        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 12px;
        }

        .expand-all-btn {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 8px 16px;
            margin: 8px 6px 8px 0;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .expand-all-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(139, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Nabokov's Web Roadmap: Next Phases</h1>

        <div class="hero">
            <h2>‚úÖ Phase 1 Complete (All 8 Features Shipped!)</h2>
            <p style="margin-bottom: 10px;"><strong>Status:</strong> All foundational canvas features implemented and tested</p>
            <div class="feature-grid">
                <div class="feature-item">
                    <strong>‚úÖ Content Scrolling</strong>
                    Smart scroll inside cards, zoom outside
                </div>
                <div class="feature-item">
                    <strong>‚úÖ Loading States</strong>
                    Toast notifications for all operations
                </div>
                <div class="feature-item">
                    <strong>‚úÖ Image Upload</strong>
                    Drag-drop with base64 storage
                </div>
                <div class="feature-item">
                    <strong>‚úÖ Enhanced Chat</strong>
                    Save conversations, auto-save option
                </div>
                <div class="feature-item">
                    <strong>‚úÖ Edge Annotations</strong>
                    5 connection types with custom labels
                </div>
                <div class="feature-item">
                    <strong>‚úÖ Collapsible Cards</strong>
                    Toggle to minimal header view
                </div>
                <div class="feature-item">
                    <strong>‚úÖ Resizable Cards</strong>
                    S/M/L/XL size presets
                </div>
                <div class="feature-item">
                    <strong>‚úÖ All Builds Pass</strong>
                    TypeScript compilation successful
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üéØ Phase 2: AI-Powered Content Enhancement <span class="status-badge status-next">NEXT UP</span></h2>

        <div class="phase-card priority">
            <h3>Phase 2.1: AI Beautification (Two Modes)</h3>
            <p><strong>Goal:</strong> Transform captured HTML into beautiful, readable content using Claude API</p>
            <div class="time-estimate">‚è±Ô∏è 8-12 hours total</div>

            <h4 style="margin-top: 12px;">Mode 1: Recreate Design üé®</h4>
            <ul>
                <li><strong>Input:</strong> Screenshot + HTML</li>
                <li><strong>Output:</strong> Recreated visual appearance with clean code</li>
                <li><strong>Use Case:</strong> Preserve exact styling of captured elements</li>
                <li><strong>Technology:</strong> Claude vision API with screenshot analysis</li>
            </ul>

            <h4 style="margin-top: 10px;">Mode 2: Organize Information üìã</h4>
            <ul>
                <li><strong>Input:</strong> HTML content</li>
                <li><strong>Output:</strong> Clean, organized content with Chinese aesthetic</li>
                <li><strong>Use Case:</strong> Extract signal from noise (remove ads, navigation)</li>
                <li><strong>Technology:</strong> Claude text API with content extraction</li>
            </ul>

            <div class="highlight" style="margin-top: 12px;">
                <strong>üîê Security Note:</strong> All LLM output is re-sanitized with DOMPurify before rendering
            </div>
        </div>

        <div class="collapsible open">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span> Implementation Breakdown: AI Beautification</span>
            </div>
            <div class="collapsible-content">
                <h4>Phase 2.1.1: Foundation (3-4 hours)</h4>
                <ul>
                    <li>Update Card interface to add <code>originalHTML</code>, <code>beautifiedContent</code> fields</li>
                    <li>Create API key settings page in Canvas</li>
                    <li>Update ElementSelector to save unsanitized HTML (for AI input only)</li>
                    <li>Create <code>src/utils/beautification.ts</code> stub</li>
                </ul>

                <h4 style="margin-top: 10px;">Phase 2.1.2: LLM Integration (3-4 hours)</h4>
                <ul>
                    <li>Implement <code>recreateDesign()</code> with vision API</li>
                    <li>Implement <code>organizeInformation()</code> with text-only API</li>
                    <li>Add DOMPurify re-sanitization to both functions</li>
                    <li>Test prompts with 10+ HTML samples, iterate</li>
                </ul>

                <h4 style="margin-top: 10px;">Phase 2.1.3: UI & UX (2-3 hours)</h4>
                <ul>
                    <li>Add two buttons to CardNode: "üé® Recreate Design" and "üìã Organize Content"</li>
                    <li>Implement view tabs (Original / Beautified / Screenshot)</li>
                    <li>Add loading states and error handling</li>
                    <li>Implement regenerate functionality</li>
                </ul>

                <h4 style="margin-top: 10px;">Critical: DOMPurify-Safe Prompts</h4>
                <pre><code>CRITICAL: Your HTML will be sanitized. Follow these rules EXACTLY:

‚úÖ ALLOWED TAGS: div, span, section, article, h1-h6, p, br, strong, em,
   ul, ol, li, a, img, code, pre, blockquote, table, thead, tbody, tr,
   th, td, style

‚úÖ ALLOWED ATTRIBUTES: style, class, id, href, src, alt
   - href: HTTPS URLs only (NO javascript:)
   - src: HTTPS URLs only (NO data:)

‚ùå FORBIDDEN (will be REMOVED):
   - Tags: script, iframe, svg, canvas, form, input, button
   - Attributes: onclick, on*, data-*, aria-*
   - URLs: javascript:, data:

OUTPUT: Use &lt;style&gt; tag for CSS. NO external resources.</code></pre>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üîó Phase 3: Multi-Card Context Queries <span class="status-badge status-next">HIGH VALUE</span></h2>

        <div class="phase-card priority">
            <h3>Phase 3.1: Cross-Card Analysis System</h3>
            <p><strong>Goal:</strong> Select multiple cards and ask questions spanning all their content</p>
            <div class="time-estimate">‚è±Ô∏è 5-6 hours total</div>

            <h4 style="margin-top: 12px;">User Workflow</h4>
            <ol>
                <li>User clips 5 articles on "AI safety"</li>
                <li>Arranges them spatially on canvas</li>
                <li>Box-selects all 5 cards (drag selection or Cmd+click)</li>
                <li>Clicks "üí¨ Ask across 5 cards" button</li>
                <li>Types: "What are the main disagreements between these sources?"</li>
                <li>LLM analyzes all 5 articles, identifies contradictions</li>
                <li>User follows up: "Which source is most recent?"</li>
                <li>LLM references specific card metadata</li>
            </ol>

            <h4 style="margin-top: 10px;">Key Features</h4>
            <ul>
                <li><strong>React Flow Selection:</strong> Built-in multi-selection via box select and Cmd+click</li>
                <li><strong>Context Merging:</strong> Combine card titles, URLs, tags, and content</li>
                <li><strong>Streaming Responses:</strong> Reuse existing ChatService infrastructure</li>
                <li><strong>Visual Feedback:</strong> Floating action button appears when 2+ cards selected</li>
            </ul>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span> Implementation Breakdown: Multi-Card Queries</span>
            </div>
            <div class="collapsible-content">
                <h4>Phase 3.1.1: Selection Tracking (30 minutes)</h4>
                <ul>
                    <li>Add <code>onSelectionChange</code> handler to Canvas ReactFlow</li>
                    <li>Track selected nodes in state</li>
                    <li>Extract Card objects from selected nodes</li>
                </ul>

                <h4 style="margin-top: 10px;">Phase 3.1.2: Context Merging (45 minutes)</h4>
                <ul>
                    <li>Create <code>src/utils/multiCardContext.ts</code></li>
                    <li>Implement <code>mergeCardContexts()</code> - combine all card contents</li>
                    <li>Implement <code>createMultiCardSummary()</code> - generate metadata summary</li>
                </ul>

                <h4 style="margin-top: 10px;">Phase 3.1.3: UI Components (3 hours)</h4>
                <ul>
                    <li>Create <code>MultiCardQueryButton.tsx</code> - floating action button (appears when 2+ selected)</li>
                    <li>Create <code>MultiCardChatModal.tsx</code> - modal with merged context display</li>
                    <li>Integrate streaming chat with existing ChatService</li>
                    <li>Add card chips showing selected cards in modal header</li>
                </ul>

                <h4 style="margin-top: 10px;">Phase 3.1.4: Integration (30 minutes)</h4>
                <ul>
                    <li>Wire components into Canvas.tsx</li>
                    <li>Handle open/close modal state</li>
                    <li>Test multi-selection workflows</li>
                </ul>

                <h4 style="margin-top: 10px;">Phase 3.1.5: Testing (1 hour)</h4>
                <ul>
                    <li>Test box selection (drag), Cmd+click multi-select</li>
                    <li>Verify context merging includes all card data</li>
                    <li>Test streaming responses with multi-card context</li>
                    <li>Verify button appears/disappears correctly</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üß™ Phase 4: Test Infrastructure & Polish <span class="status-badge status-future">FUTURE</span></h2>

        <div class="phase-card">
            <h3>Phase 4.1: E2E Test Fixes</h3>
            <p><strong>Issue:</strong> Phase 1.1 tests fail in Playwright but work in manual browser testing</p>
            <div class="time-estimate">‚è±Ô∏è 4-6 hours</div>

            <h4 style="margin-top: 10px;">Known Test Issues</h4>
            <ul>
                <li>Card generation tests expect 2 cards, get 1 (storage or event timing issue)</li>
                <li>Card positioning incorrect in test environment</li>
                <li><code>chrome.storage.local</code> behaves differently in Playwright vs real browser</li>
            </ul>

            <h4 style="margin-top: 10px;">Debugging Strategy</h4>
            <ol>
                <li>Add extensive logging to cardGenerationService</li>
                <li>Check storage state before/after each operation</li>
                <li>Verify custom event system triggers in test environment</li>
                <li>Compare Playwright chrome.storage API vs real browser</li>
            </ol>
        </div>

        <div class="divider"></div>

        <h2>üìä Priority Matrix</h2>

        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Phase</th>
                    <th style="width: 15%;">Priority</th>
                    <th style="width: 15%;">Effort</th>
                    <th style="width: 40%;">Value Proposition</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: rgba(255, 215, 0, 0.15);">
                    <td><strong>Phase 2.1: AI Beautification</strong></td>
                    <td><span class="status-badge status-next">HIGH</span></td>
                    <td>8-12h</td>
                    <td>Transform messy web content into readable, beautiful cards</td>
                </tr>
                <tr style="background: rgba(255, 215, 0, 0.1);">
                    <td><strong>Phase 3.1: Multi-Card Queries</strong></td>
                    <td><span class="status-badge status-next">HIGH</span></td>
                    <td>5-6h</td>
                    <td>Research synthesis across multiple sources (core IR principle)</td>
                </tr>
                <tr>
                    <td><strong>Phase 4.1: Test Fixes</strong></td>
                    <td><span class="status-badge status-future">LOW</span></td>
                    <td>4-6h</td>
                    <td>Improve test coverage, but features work in production</td>
                </tr>
            </tbody>
        </table>

        <div class="divider"></div>

        <h2>‚úÖ Recommended Implementation Order</h2>

        <div class="highlight">
            <h3 style="margin: 0 0 10px 0;">Session 1: AI Beautification (8-12 hours)</h3>
            <ol>
                <li><strong>Day 1:</strong> Foundation - Card interface, API keys, originalHTML storage (3-4h)</li>
                <li><strong>Day 2:</strong> LLM Integration - recreateDesign() and organizeInformation() (3-4h)</li>
                <li><strong>Day 3:</strong> UI & Testing - Buttons, view tabs, prompt iteration (2-3h)</li>
            </ol>

            <h3 style="margin: 16px 0 10px 0;">Session 2: Multi-Card Context (5-6 hours)</h3>
            <ol>
                <li>Selection tracking and context merging (1-1.5h)</li>
                <li>UI components (MultiCardQueryButton, Modal) (3h)</li>
                <li>Integration and testing (1-1.5h)</li>
            </ol>

            <h3 style="margin: 16px 0 10px 0;">Future: Test Infrastructure (4-6 hours)</h3>
            <ol>
                <li>Debug Playwright environment storage issues</li>
                <li>Fix card generation test failures</li>
                <li>Improve test reliability</li>
            </ol>
        </div>

        <div class="divider"></div>

        <h2>üéØ Next Immediate Actions</h2>

        <div class="phase-card priority">
            <h3>Start Here: Phase 2.1 Foundation</h3>
            <p style="margin: 8px 0;"><strong>First Step:</strong> Update Card interface to support AI beautification</p>

            <pre style="margin-top: 10px;"><code>// src/types/card.ts - Add new fields

interface Card {
  id: string;
  content: string;              // Sanitized HTML (for display)
  originalHTML?: string;         // NEW: Unsanitized HTML (for AI only)
  beautifiedContent?: string;    // NEW: AI-generated HTML (re-sanitized)

  beautificationMode?: 'recreate' | 'organize';  // NEW
  beautificationDate?: number;                    // NEW
  displayMode?: 'original' | 'beautified' | 'screenshot';  // NEW

  // ... existing fields
}</code></pre>

            <p style="margin-top: 12px;"><strong>Next:</strong> Create API key settings page, then implement beautification utilities</p>
        </div>

        <div class="divider"></div>

        <p style="text-align: center; color: var(--level-3); font-size: 11px; margin-top: 20px;">
            <strong>Total Estimated Time for Phase 2-3:</strong> 13-18 hours | <strong>Phase 1 Completed:</strong> 2025-10-01
        </p>
    </div>

    <script>
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('open');
        }

        // Auto-expand important sections
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.collapsible.open').forEach(el => {
                el.classList.add('open');
            });
        });
    </script>
</body>
</html>
