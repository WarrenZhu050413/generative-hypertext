<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expandable Parent-Child Cards: Interactive Hypertext Implementation</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #F5F5DC;
            --light-cream: #FFF8DC;
            --ink-black: #2C2C2C;
            --level-1: #8B0000;
            --level-2: #B71C1C;
            --level-3: #666;
            --level-4: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.2;
            font-size: 14px;
            width: 100vw;
            max-width: 100%;
        }

        .container {
            width: 100%;
            padding: 0;
            margin: 0;
        }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 4px 0;
            padding: 6px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0 2px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 12px;
            font-weight: 500;
            margin: 2px 0 1px 16px;
            color: var(--level-3);
        }

        .hero {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), white);
            border: 3px solid var(--chinese-gold);
            padding: 12px;
            margin: 12px 0;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);
        }

        .hero h2 {
            color: var(--chinese-red);
            margin: 0 0 8px 0;
            border: none;
            background: none;
            padding: 0;
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
            border-radius: 3px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 8px 0;
        }

        .collapsible {
            margin: 4px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 10px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 8px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 15000px;
            padding: 8px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 12px;
            line-height: 1.3;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        pre {
            padding: 6px 8px;
            margin: 4px 0;
            overflow-x: auto;
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin-left: 8px;
        }

        .dense-list li {
            padding: 2px 0 2px 12px;
            border-left: 2px solid transparent;
            position: relative;
        }

        .dense-list li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 10px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 8px 0;
        }

        .demo-visual {
            background: white;
            border: 2px solid var(--chinese-red);
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .expand-link {
            color: var(--chinese-red);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 700;
            padding: 0 2px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 2px;
        }

        .expand-link:hover {
            background: rgba(255, 215, 0, 0.4);
        }

        .workflow {
            background: rgba(255, 215, 0, 0.05);
            border-left: 3px solid var(--chinese-gold);
            padding: 8px;
            margin: 4px 0;
        }

        .workflow-step {
            margin: 4px 0;
            padding-left: 16px;
            position: relative;
        }

        .workflow-step:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 12px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 2px 4px;
            text-align: left;
            line-height: 1.1;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ³ Expandable Parent-Child Cards: Interactive Hypertext</h1>

        <div class="hero">
            <h2>Core Vision: Embedded Menus & StretchText</h2>
            <p><strong>Concept:</strong> Parent cards contain summaries with clickable words/buttons that spatially expand to reveal child cards on the canvas.</p>
            <p style="margin-top: 6px;"><strong>Inspiration:</strong> Ted Nelson's StretchText + Ben Shneiderman's "embedded menus" + modern transclusion</p>
            <p style="margin-top: 6px; background: rgba(255, 215, 0, 0.2); padding: 6px; border-radius: 3px;"><strong>â±ï¸ Time Estimate:</strong> 8-12 hours for complete implementation with animations</p>
        </div>

        <div class="divider"></div>

        <h2>Visual Demo: How It Works</h2>

        <div class="demo-visual">
<strong>COLLAPSED STATE:</strong>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Parent Card: AI Safety Overview â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AI safety involves multiple        â”‚
â”‚ challenges including <span class="expand-link">alignment</span>,  â”‚
â”‚ <span class="expand-link">robustness</span>, and <span class="expand-link">interpretability</span>. â”‚
â”‚                                     â”‚
â”‚ [â–¸ Expand All (3 children)]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


<strong>AFTER CLICKING "alignment":</strong>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Parent Card: AI Safety Overview â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AI safety involves multiple        â”‚
â”‚ challenges including <span style="background: rgba(255,215,0,0.5)">alignment</span>,  â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â”‚ <span class="expand-link">robustness</span>, and <span class="expand-link">interpretability</span>. â”‚â”€â”€â–¶â•‘ ğŸ“ Child: Alignment    â•‘
â”‚                                     â”‚  â•‘                          â•‘
â”‚ [â–¾ Collapse All (3 children)]      â”‚  â•‘ Ensuring AI systems     â•‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ behave according to     â•‘
                                          â•‘ human values...         â•‘
                                          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


<strong>FULLY EXPANDED (Manual or "Expand All"):</strong>

                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘ ğŸ“ Child: Alignment    â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Parent Card: AI Safety Overview â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â”‚ AI safety involves multiple        â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â•‘ ğŸ“ Child: Robustness   â•‘
â”‚ challenges including alignment,     â”‚        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”‚ robustness, and interpretability.   â”‚
â”‚                                     â”‚
â”‚ [â–¾ Collapse All (3 children)]      â”‚        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â–¶â•‘ ğŸ“ Interpretability    â•‘
                    â†“                           â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        </div>

        <div class="divider"></div>

        <h2>Data Model: Expandable Links</h2>

        <div class="collapsible critical open">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <strong>1. Card Type Extensions</strong>
                <span class="arrow">â–¸</span>
            </div>
            <div class="collapsible-content">
                <h4>Add Expansion State to Card</h4>
                <pre><code>// src/types/card.ts - Extend Card interface
interface Card {
  // ... existing fields

  // NEW: Expansion state
  isExpanded?: boolean;  // Whether children are currently visible

  // NEW: Child card references
  childCardIds?: string[];  // IDs of child cards

  // EXISTING: Parent reference (already exists!)
  parentCardId?: string;

  // NEW: Expansion layout
  expansionLayout?: {
    type: 'radial' | 'grid' | 'tree' | 'list';
    spacing: number;  // Distance from parent
    angleOffset?: number;  // For radial layout
  };
}</code></pre>

                <h4>Expandable Link Markup</h4>
                <pre><code>// NEW type: src/types/expandableLink.ts
interface ExpandableLink {
  id: string;
  parentCardId: string;
  childCardId: string;

  // The anchor text in parent card
  anchorText: string;

  // Position in parent content (for highlighting)
  startOffset: number;
  endOffset: number;

  // Visual metadata
  color?: string;
  icon?: string;

  createdAt: number;
}

// Store in chrome.storage.local
const EXPANDABLE_LINKS_KEY = 'nabokov_expandable_links';</code></pre>

                <h4>Example Data</h4>
                <pre><code>// Parent card content with special markup
const parentCard: Card = {
  id: 'parent-1',
  content: `
    &lt;p&gt;AI safety involves multiple challenges including
    &lt;span class="expand-link" data-child-id="child-1"&gt;alignment&lt;/span&gt;,
    &lt;span class="expand-link" data-child-id="child-2"&gt;robustness&lt;/span&gt;, and
    &lt;span class="expand-link" data-child-id="child-3"&gt;interpretability&lt;/span&gt;.&lt;/p&gt;
  `,
  isExpanded: false,
  childCardIds: ['child-1', 'child-2', 'child-3'],
  expansionLayout: {
    type: 'radial',
    spacing: 400,
    angleOffset: 0,
  },
};</code></pre>
            </div>
        </div>

        <div class="collapsible critical open">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <strong>2. Creating Expandable Links</strong>
                <span class="arrow">â–¸</span>
            </div>
            <div class="collapsible-content">
                <h4>Manual Link Creation</h4>
                <pre><code>// src/utils/expandableLinks.ts

/**
 * Create expandable link between parent and child
 */
export async function createExpandableLink(
  parentCard: Card,
  childCard: Card,
  anchorText: string,
  insertPosition?: number  // Optional: where to insert in parent content
): Promise&lt;ExpandableLink&gt; {
  const link: ExpandableLink = {
    id: generateId(),
    parentCardId: parentCard.id,
    childCardId: childCard.id,
    anchorText,
    startOffset: insertPosition || parentCard.content.length,
    endOffset: (insertPosition || parentCard.content.length) + anchorText.length,
    createdAt: Date.now(),
  };

  // Update parent card content with link markup
  const updatedContent = insertExpandableLinkMarkup(
    parentCard.content,
    anchorText,
    childCard.id,
    insertPosition
  );

  // Update parent card
  const updatedParent: Card = {
    ...parentCard,
    content: updatedContent,
    childCardIds: [...(parentCard.childCardIds || []), childCard.id],
  };

  // Update child card
  const updatedChild: Card = {
    ...childCard,
    parentCardId: parentCard.id,
  };

  // Save link
  const links = await loadExpandableLinks();
  links.push(link);
  await saveExpandableLinks(links);

  // Save cards
  await saveCard(updatedParent);
  await saveCard(updatedChild);

  // Create visual connection (arrow)
  await addConnection(parentCard.id, childCard.id, 'references', anchorText);

  return link;
}

/**
 * Insert link markup into parent content
 */
function insertExpandableLinkMarkup(
  content: string,
  anchorText: string,
  childId: string,
  position?: number
): string {
  const linkHTML = `&lt;span class="expand-link" data-child-id="${childId}"&gt;${anchorText}&lt;/span&gt;`;

  if (position !== undefined) {
    return content.slice(0, position) + linkHTML + content.slice(position);
  }

  // Auto-replace first occurrence of anchor text
  return content.replace(
    new RegExp(escapeRegex(anchorText), 'i'),
    linkHTML
  );
}</code></pre>

                <h4>AI-Assisted Link Creation</h4>
                <pre><code>/**
 * Use LLM to suggest expandable links for a parent card
 */
export async function suggestExpandableLinks(
  parentCard: Card
): Promise&lt;{ anchorText: string; childSummary: string }[]&gt; {
  const prompt = `
Analyze this text and identify key concepts that could be expanded into child cards:

${stripHtml(parentCard.content)}

For each concept, provide:
1. The exact phrase to make clickable (2-4 words)
2. A brief description of what the child card should contain

Return as JSON array: [{ anchorText: "...", childSummary: "..." }]
  `;

  const response = await mockClaudeAPI.generateText(prompt);
  return JSON.parse(response);
}</code></pre>
            </div>
        </div>

        <div class="divider"></div>

        <h2>Expansion Logic & Animations</h2>

        <div class="collapsible critical open">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <strong>3. Spatial Layout Algorithms</strong>
                <span class="arrow">â–¸</span>
            </div>
            <div class="collapsible-content">
                <h4>Calculate Child Positions</h4>
                <pre><code>// src/utils/cardExpansion.ts

interface ChildPosition {
  cardId: string;
  x: number;
  y: number;
}

/**
 * Calculate positions for expanded child cards
 */
export function calculateChildPositions(
  parentCard: Card,
  childCards: Card[],
  layout: Card['expansionLayout'] = { type: 'radial', spacing: 400 }
): ChildPosition[] {
  const parentPos = parentCard.position || { x: 0, y: 0 };

  switch (layout.type) {
    case 'radial':
      return calculateRadialPositions(parentPos, childCards, layout.spacing);

    case 'grid':
      return calculateGridPositions(parentPos, childCards, layout.spacing);

    case 'tree':
      return calculateTreePositions(parentPos, childCards, layout.spacing);

    case 'list':
      return calculateListPositions(parentPos, childCards, layout.spacing);

    default:
      return calculateRadialPositions(parentPos, childCards, layout.spacing);
  }
}

/**
 * Radial layout: Children arranged in circle around parent
 */
function calculateRadialPositions(
  parentPos: CardPosition,
  children: Card[],
  spacing: number
): ChildPosition[] {
  const count = children.length;
  const angleStep = (2 * Math.PI) / count;

  return children.map((child, index) => {
    const angle = angleStep * index - Math.PI / 2;  // Start from top
    return {
      cardId: child.id,
      x: parentPos.x + Math.cos(angle) * spacing,
      y: parentPos.y + Math.sin(angle) * spacing,
    };
  });
}

/**
 * Tree layout: Children below parent in horizontal row
 */
function calculateTreePositions(
  parentPos: CardPosition,
  children: Card[],
  spacing: number
): ChildPosition[] {
  const cardWidth = 320;  // Standard card width
  const totalWidth = children.length * (cardWidth + 40);
  const startX = parentPos.x - totalWidth / 2;

  return children.map((child, index) => ({
    cardId: child.id,
    x: startX + index * (cardWidth + 40),
    y: parentPos.y + spacing,
  }));
}

/**
 * Grid layout: Children in 2D grid
 */
function calculateGridPositions(
  parentPos: CardPosition,
  children: Card[],
  spacing: number
): ChildPosition[] {
  const cols = Math.ceil(Math.sqrt(children.length));
  const cardWidth = 320;
  const cardHeight = 240;

  return children.map((child, index) => {
    const row = Math.floor(index / cols);
    const col = index % cols;

    return {
      cardId: child.id,
      x: parentPos.x + (col - cols / 2) * (cardWidth + 40),
      y: parentPos.y + spacing + row * (cardHeight + 40),
    };
  });
}

/**
 * List layout: Children stacked vertically
 */
function calculateListPositions(
  parentPos: CardPosition,
  children: Card[],
  spacing: number
): ChildPosition[] {
  const cardHeight = 240;

  return children.map((child, index) => ({
    cardId: child.id,
    x: parentPos.x + spacing,
    y: parentPos.y + index * (cardHeight + 40),
  }));
}</code></pre>
            </div>
        </div>

        <div class="collapsible critical open">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <strong>4. Expand/Collapse Actions</strong>
                <span class="arrow">â–¸</span>
            </div>
            <div class="collapsible-content">
                <h4>Expansion Manager</h4>
                <pre><code>// src/services/expansionManager.ts

export class ExpansionManager {
  /**
   * Expand single child (when clicking link)
   */
  async expandChild(
    parentCardId: string,
    childCardId: string,
    animate = true
  ): Promise&lt;void&gt; {
    const parent = await getCardById(parentCardId);
    const child = await getCardById(childCardId);

    if (!parent || !child) return;

    // Calculate position
    const layout = parent.expansionLayout || { type: 'radial', spacing: 400 };
    const positions = calculateChildPositions(parent, [child], layout);
    const targetPos = positions[0];

    // Update child card position
    const updatedChild: Card = {
      ...child,
      position: targetPos,
    };

    await saveCard(updatedChild);

    // Animate card appearance
    if (animate) {
      await animateCardExpansion(child.id, parent.position!, targetPos);
    }

    // Trigger canvas refresh
    window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));
  }

  /**
   * Expand all children
   */
  async expandAll(parentCardId: string): Promise&lt;void&gt; {
    const parent = await getCardById(parentCardId);
    if (!parent || !parent.childCardIds) return;

    const children = await Promise.all(
      parent.childCardIds.map(id => getCardById(id))
    );
    const validChildren = children.filter(Boolean) as Card[];

    // Calculate all positions
    const layout = parent.expansionLayout || { type: 'radial', spacing: 400 };
    const positions = calculateChildPositions(parent, validChildren, layout);

    // Update all child positions
    for (let i = 0; i < validChildren.length; i++) {
      const child = validChildren[i];
      const pos = positions[i];

      await saveCard({
        ...child,
        position: pos,
      });
    }

    // Update parent state
    await saveCard({
      ...parent,
      isExpanded: true,
    });

    // Animate expansion
    await animateAllExpansion(parent.id, positions);

    window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));
  }

  /**
   * Collapse all children
   */
  async collapseAll(parentCardId: string): Promise&lt;void&gt; {
    const parent = await getCardById(parentCardId);
    if (!parent || !parent.childCardIds) return;

    // Animate children collapsing into parent
    await animateCollapse(parentCardId, parent.childCardIds);

    // Hide children (move offscreen or mark as hidden)
    for (const childId of parent.childCardIds) {
      const child = await getCardById(childId);
      if (child) {
        await saveCard({
          ...child,
          position: { x: -10000, y: -10000 },  // Offscreen
        });
      }
    }

    // Update parent state
    await saveCard({
      ...parent,
      isExpanded: false,
    });

    window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));
  }
}

export const expansionManager = new ExpansionManager();</code></pre>

                <h4>Animation Utilities</h4>
                <pre><code>/**
 * Animate card expansion from parent to final position
 */
async function animateCardExpansion(
  cardId: string,
  fromPos: CardPosition,
  toPos: CardPosition,
  duration = 600
): Promise&lt;void&gt; {
  const cardElement = document.querySelector(`[data-id="${cardId}"]`) as HTMLElement;
  if (!cardElement) return;

  // Start from parent position (invisible)
  cardElement.style.transform = `translate(${fromPos.x - toPos.x}px, ${fromPos.y - toPos.y}px)`;
  cardElement.style.opacity = '0';
  cardElement.style.scale = '0.5';

  // Animate to final position
  requestAnimationFrame(() => {
    cardElement.style.transition = `all ${duration}ms cubic-bezier(0.34, 1.56, 0.64, 1)`;
    cardElement.style.transform = 'translate(0, 0)';
    cardElement.style.opacity = '1';
    cardElement.style.scale = '1';
  });

  await new Promise(resolve => setTimeout(resolve, duration));

  // Clean up
  cardElement.style.transition = '';
  cardElement.style.transform = '';
}

/**
 * Animate all children expanding
 */
async function animateAllExpansion(
  parentId: string,
  positions: ChildPosition[],
  duration = 800
): Promise&lt;void&gt; {
  const parent = document.querySelector(`[data-id="${parentId}"]`) as HTMLElement;
  if (!parent) return;

  const parentRect = parent.getBoundingClientRect();

  // Stagger animations
  for (let i = 0; i < positions.length; i++) {
    const delay = i * 100;  // 100ms stagger
    setTimeout(() => {
      animateCardExpansion(
        positions[i].cardId,
        { x: parentRect.left, y: parentRect.top },
        positions[i],
        duration
      );
    }, delay);
  }

  await new Promise(resolve => setTimeout(resolve, duration + positions.length * 100));
}

/**
 * Animate children collapsing back into parent
 */
async function animateCollapse(
  parentId: string,
  childIds: string[],
  duration = 500
): Promise&lt;void&gt; {
  const parent = document.querySelector(`[data-id="${parentId}"]`) as HTMLElement;
  if (!parent) return;

  const parentRect = parent.getBoundingClientRect();

  // Animate all children to parent position
  for (let i = 0; i < childIds.length; i++) {
    const cardElement = document.querySelector(`[data-id="${childIds[i]}"]`) as HTMLElement;
    if (!cardElement) continue;

    const cardRect = cardElement.getBoundingClientRect();
    const deltaX = parentRect.left - cardRect.left;
    const deltaY = parentRect.top - cardRect.top;

    cardElement.style.transition = `all ${duration}ms cubic-bezier(0.5, 0, 0.75, 0)`;
    cardElement.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    cardElement.style.opacity = '0';
    cardElement.style.scale = '0.3';
  }

  await new Promise(resolve => setTimeout(resolve, duration));
}</code></pre>
            </div>
        </div>

        <div class="divider"></div>

        <h2>UI Components</h2>

        <div class="collapsible critical open">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <strong>5. Parent Card Enhancements</strong>
                <span class="arrow">â–¸</span>
            </div>
            <div class="collapsible-content">
                <h4>Clickable Links in Content</h4>
                <pre><code>// In CardNode.tsx

const CardNode = ({ data }: { data: { card: Card } }) => {
  const { card } = data;
  const contentRef = useRef&lt;HTMLDivElement&gt;(null);

  useEffect(() => {
    if (!contentRef.current) return;

    // Attach click handlers to all expand-link elements
    const links = contentRef.current.querySelectorAll('.expand-link');

    const handleLinkClick = (e: Event) => {
      const target = e.target as HTMLElement;
      const childId = target.dataset.childId;

      if (!childId) return;

      // Toggle child visibility
      expansionManager.expandChild(card.id, childId);

      // Highlight clicked link
      target.style.background = 'rgba(255, 215, 0, 0.5)';
      setTimeout(() => {
        target.style.background = '';
      }, 2000);
    };

    links.forEach(link => {
      link.addEventListener('click', handleLinkClick);
    });

    return () => {
      links.forEach(link => {
        link.removeEventListener('click', handleLinkClick);
      });
    };
  }, [card.id]);

  return (
    &lt;div className="card-node"&gt;
      &lt;div
        ref={contentRef}
        dangerouslySetInnerHTML={{ __html: card.content }}
      /&gt;

      {/* Expand/Collapse controls */}
      {card.childCardIds && card.childCardIds.length > 0 && (
        &lt;div className="expansion-controls"&gt;
          &lt;button
            onClick={() =>
              card.isExpanded
                ? expansionManager.collapseAll(card.id)
                : expansionManager.expandAll(card.id)
            }
          &gt;
            {card.isExpanded ? 'â–¾' : 'â–¸'} {card.isExpanded ? 'Collapse' : 'Expand'} All
            ({card.childCardIds.length} {card.childCardIds.length === 1 ? 'child' : 'children'})
          &lt;/button&gt;
        &lt;/div&gt;
      )}
    &lt;/div&gt;
  );
};</code></pre>

                <h4>CSS for Expandable Links</h4>
                <pre><code>/* In CardNode.css or global styles */

.expand-link {
  color: #8B0000;
  background: rgba(255, 215, 0, 0.15);
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  text-decoration: underline;
  text-decoration-style: dotted;
  text-underline-offset: 2px;
  font-weight: 600;
  transition: all 0.2s ease;
  position: relative;
}

.expand-link:hover {
  background: rgba(255, 215, 0, 0.4);
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(139, 0, 0, 0.2);
}

.expand-link:active {
  transform: scale(0.98);
}

/* Icon indicating expandable */
.expand-link::after {
  content: 'âŠ•';
  margin-left: 3px;
  font-size: 10px;
  opacity: 0.7;
}

.expand-link.expanded::after {
  content: 'âŠ–';
}

/* Expansion controls */
.expansion-controls {
  margin-top: 12px;
  padding: 8px;
  background: rgba(255, 215, 0, 0.05);
  border-top: 1px solid rgba(255, 215, 0, 0.3);
  display: flex;
  gap: 8px;
  align-items: center;
}

.expansion-controls button {
  background: linear-gradient(135deg, #8B0000, #CD5C5C);
  color: #FFF8DC;
  border: 1px solid #FFD700;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.expansion-controls button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
}</code></pre>
            </div>
        </div>

        <div class="collapsible critical open">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <strong>6. Link Creation UI</strong>
                <span class="arrow">â–¸</span>
            </div>
            <div class="collapsible-content">
                <h4>Context Menu for Link Creation</h4>
                <pre><code>// src/components/ExpandableLinkCreator.tsx

interface ExpandableLinkCreatorProps {
  parentCard: Card;
  onLinkCreated: (link: ExpandableLink) => void;
}

export const ExpandableLinkCreator: React.FC&lt;ExpandableLinkCreatorProps&gt; = ({
  parentCard,
  onLinkCreated,
}) => {
  const [showDialog, setShowDialog] = useState(false);
  const [anchorText, setAnchorText] = useState('');
  const [selectedChildId, setSelectedChildId] = useState('');
  const [allCards, setAllCards] = useState&lt;Card[]&gt;([]);

  useEffect(() => {
    loadCards().then(setAllCards);
  }, []);

  const handleCreate = async () => {
    if (!anchorText || !selectedChildId) return;

    const childCard = allCards.find(c => c.id === selectedChildId);
    if (!childCard) return;

    const link = await createExpandableLink(
      parentCard,
      childCard,
      anchorText
    );

    onLinkCreated(link);
    setShowDialog(false);
    setAnchorText('');
    setSelectedChildId('');
  };

  return (
    &lt;&gt;
      &lt;button onClick={() => setShowDialog(true)}&gt;
        ğŸ”— Add Expandable Link
      &lt;/button&gt;

      {showDialog && (
        &lt;dialog open&gt;
          &lt;h3&gt;Create Expandable Link&lt;/h3&gt;

          &lt;label&gt;
            Anchor Text (text to make clickable):
            &lt;input
              type="text"
              value={anchorText}
              onChange={e => setAnchorText(e.target.value)}
              placeholder="e.g., 'alignment'"
            /&gt;
          &lt;/label&gt;

          &lt;label&gt;
            Child Card to Link:
            &lt;select
              value={selectedChildId}
              onChange={e => setSelectedChildId(e.target.value)}
            &gt;
              &lt;option value=""&gt;Select a card...&lt;/option&gt;
              {allCards.map(card => (
                &lt;option key={card.id} value={card.id}&gt;
                  {card.metadata.title}
                &lt;/option&gt;
              ))}
            &lt;/select&gt;
          &lt;/label&gt;

          &lt;div className="dialog-actions"&gt;
            &lt;button onClick={handleCreate}&gt;Create Link&lt;/button&gt;
            &lt;button onClick={() => setShowDialog(false)}&gt;Cancel&lt;/button&gt;
          &lt;/div&gt;
        &lt;/dialog&gt;
      )}
    &lt;/&gt;
  );
};</code></pre>
            </div>
        </div>

        <div class="divider"></div>

        <h2>User Workflows</h2>

        <div class="card priority">
            <h3>Workflow 1: Manual Link Creation</h3>
            <div class="workflow">
                <div class="workflow-step">User creates parent card with summary</div>
                <div class="workflow-step">Creates 3 child cards with detailed explanations</div>
                <div class="workflow-step">Clicks "Add Expandable Link" on parent card</div>
                <div class="workflow-step">Types anchor text: "alignment"</div>
                <div class="workflow-step">Selects child card from dropdown</div>
                <div class="workflow-step">Link appears in parent card content (clickable, highlighted)</div>
                <div class="workflow-step">Repeats for other children</div>
                <div class="workflow-step">Parent now has 3 clickable terms</div>
            </div>
        </div>

        <div class="card priority" style="margin-top: 8px;">
            <h3>Workflow 2: AI-Assisted Creation</h3>
            <div class="workflow">
                <div class="workflow-step">User pastes long article into card</div>
                <div class="workflow-step">Clicks "Auto-generate child cards"</div>
                <div class="workflow-step">LLM identifies 5 key concepts</div>
                <div class="workflow-step">System creates 5 child cards (one per concept)</div>
                <div class="workflow-step">System generates summary parent card with expandable links</div>
                <div class="workflow-step">User reviews and edits as needed</div>
                <div class="workflow-step">Parent card now has 5 clickable concepts</div>
            </div>
        </div>

        <div class="card priority" style="margin-top: 8px;">
            <h3>Workflow 3: Exploration & Navigation</h3>
            <div class="workflow">
                <div class="workflow-step">User views parent card (collapsed)</div>
                <div class="workflow-step">Sees "AI safety involves challenges including <span class="expand-link">alignment</span>, <span class="expand-link">robustness</span>..."</div>
                <div class="workflow-step">Clicks "alignment" link</div>
                <div class="workflow-step">Child card animates from parent, expands to right side</div>
                <div class="workflow-step">User reads detailed alignment explanation</div>
                <div class="workflow-step">Clicks "robustness" link</div>
                <div class="workflow-step">Second child card expands below first</div>
                <div class="workflow-step">User clicks "Expand All" button</div>
                <div class="workflow-step">All 5 children expand radially around parent</div>
                <div class="workflow-step">User zooms out, sees entire hierarchy at once</div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>Implementation Checklist</h2>

        <table>
            <thead>
                <tr>
                    <th>Step</th>
                    <th>Component</th>
                    <th>Time Est.</th>
                    <th>Priority</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1. Extend Card type</td>
                    <td>src/types/card.ts</td>
                    <td>30 min</td>
                    <td>ğŸ”´ Critical</td>
                </tr>
                <tr>
                    <td>2. Create ExpandableLink type</td>
                    <td>src/types/expandableLink.ts</td>
                    <td>30 min</td>
                    <td>ğŸ”´ Critical</td>
                </tr>
                <tr>
                    <td>3. Storage functions</td>
                    <td>src/utils/expandableLinks.ts</td>
                    <td>1-1.5h</td>
                    <td>ğŸ”´ Critical</td>
                </tr>
                <tr>
                    <td>4. Layout algorithms</td>
                    <td>src/utils/cardExpansion.ts</td>
                    <td>2-3h</td>
                    <td>ğŸ”´ Critical</td>
                </tr>
                <tr>
                    <td>5. ExpansionManager</td>
                    <td>src/services/expansionManager.ts</td>
                    <td>2-3h</td>
                    <td>ğŸ”´ Critical</td>
                </tr>
                <tr>
                    <td>6. CardNode click handlers</td>
                    <td>src/canvas/CardNode.tsx</td>
                    <td>1h</td>
                    <td>ğŸ”´ Critical</td>
                </tr>
                <tr>
                    <td>7. Expansion animations</td>
                    <td>src/utils/animations.ts</td>
                    <td>2-3h</td>
                    <td>ğŸŸ¡ High</td>
                </tr>
                <tr>
                    <td>8. Link creator UI</td>
                    <td>src/components/ExpandableLinkCreator.tsx</td>
                    <td>1-2h</td>
                    <td>ğŸŸ¡ High</td>
                </tr>
                <tr>
                    <td>9. CSS styling</td>
                    <td>Global styles</td>
                    <td>1h</td>
                    <td>ğŸŸ¡ High</td>
                </tr>
                <tr>
                    <td>10. AI auto-generation</td>
                    <td>src/utils/aiLinkGeneration.ts</td>
                    <td>2-3h</td>
                    <td>ğŸŸ¢ Nice-to-have</td>
                </tr>
                <tr>
                    <td>11. Testing & polish</td>
                    <td>E2E tests</td>
                    <td>2h</td>
                    <td>ğŸŸ¡ High</td>
                </tr>
            </tbody>
        </table>

        <div class="card priority" style="margin-top: 12px;">
            <h3>â±ï¸ Total Time Estimate</h3>
            <p><strong>Core Features (Steps 1-6):</strong> 6-9 hours</p>
            <p><strong>With Animations (Steps 1-7):</strong> 8-12 hours</p>
            <p><strong>Full MVP (Steps 1-9):</strong> 10-15 hours</p>
            <p><strong>With AI Generation (Steps 1-11):</strong> 14-20 hours</p>
        </div>

        <div class="divider"></div>

        <div class="important-always-visible">
            <h2>Key Benefits</h2>
            <ul class="dense-list">
                <li><strong>Serendipitous Discovery:</strong> Users explore concepts naturally by clicking what interests them</li>
                <li><strong>Progressive Disclosure:</strong> Start with summary, expand details on demand</li>
                <li><strong>Spatial Context:</strong> Visual layout reinforces conceptual relationships</li>
                <li><strong>Embedded Menus:</strong> Content itself becomes navigation (Shneiderman's vision)</li>
                <li><strong>StretchText:</strong> Text expands spatially, not just linearly (Ted Nelson's vision)</li>
                <li><strong>Incidental Learning:</strong> Browse by following interesting links, accumulate understanding</li>
            </ul>
        </div>

        <div class="hero" style="margin-top: 12px;">
            <h2>This IS the Hypertext Dream</h2>
            <p>Combining clickable embedded links with spatial canvas expansion creates the interactive, exploratory knowledge system that hypertext pioneers envisioned but browsers never fully realized.</p>
        </div>
    </div>

    <script>
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                this.parentElement.classList.toggle('open');
            });
        });

        // Auto-open critical sections
        document.querySelectorAll('.collapsible.critical').forEach(el => {
            el.classList.add('open');
        });
    </script>
</body>
</html>