<!DOCTYPE html>
<html>
<head>
  <title>Nabokov Storage Debug</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #d32f2f; }
    h2 { color: #c62828; margin-top: 30px; }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .card {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    button {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #b71c1c; }
  </style>
</head>
<body>
  <h1>üîç Nabokov Storage Debug Tool</h1>

  <button onclick="loadData()">Refresh Data</button>
  <button onclick="clearAll()">Clear All Data</button>

  <h2>Cards in chrome.storage.local</h2>
  <div id="cards-output">Loading...</div>

  <h2>Screenshots in IndexedDB</h2>
  <div id="screenshots-output">Loading...</div>

  <script>
    async function loadData() {
      // Load cards from chrome.storage.local
      chrome.storage.local.get('cards', (result) => {
        const cards = result.cards || [];
        const cardsDiv = document.getElementById('cards-output');

        if (cards.length === 0) {
          cardsDiv.innerHTML = '<p>No cards saved yet.</p>';
        } else {
          cardsDiv.innerHTML = `<p>Found ${cards.length} card(s):</p>`;
          cards.forEach((card, i) => {
            cardsDiv.innerHTML += `
              <div class="card">
                <h3>Card ${i + 1}: ${card.title || 'Untitled'}</h3>
                <p><strong>URL:</strong> ${card.url}</p>
                <p><strong>Created:</strong> ${new Date(card.timestamp).toLocaleString()}</p>
                <p><strong>Tag:</strong> ${card.tagName}</p>
                <p><strong>Has Screenshot:</strong> ${card.screenshotId ? 'Yes' : 'No'}</p>
                <details>
                  <summary>Full Data</summary>
                  <pre>${JSON.stringify(card, null, 2)}</pre>
                </details>
              </div>
            `;
          });
        }
      });

      // Load screenshots from IndexedDB
      const request = indexedDB.open('nabokov-clipper', 1);

      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(['screenshots'], 'readonly');
        const store = transaction.objectStore('screenshots');
        const getAllRequest = store.getAll();

        getAllRequest.onsuccess = () => {
          const screenshots = getAllRequest.result || [];
          const screenshotsDiv = document.getElementById('screenshots-output');

          if (screenshots.length === 0) {
            screenshotsDiv.innerHTML = '<p>No screenshots saved yet.</p>';
          } else {
            screenshotsDiv.innerHTML = `<p>Found ${screenshots.length} screenshot(s):</p>`;
            screenshots.forEach((screenshot, i) => {
              screenshotsDiv.innerHTML += `
                <div class="card">
                  <h3>Screenshot ${i + 1}</h3>
                  <p><strong>ID:</strong> ${screenshot.id}</p>
                  <p><strong>Created:</strong> ${new Date(screenshot.timestamp).toLocaleString()}</p>
                  <p><strong>Size:</strong> ${(screenshot.dataUrl.length / 1024).toFixed(2)} KB</p>
                  <img src="${screenshot.dataUrl}" style="max-width: 300px; border: 1px solid #ddd;" />
                </div>
              `;
            });
          }
        };
      };

      request.onerror = () => {
        document.getElementById('screenshots-output').innerHTML =
          '<p>Error accessing IndexedDB</p>';
      };
    }

    async function clearAll() {
      if (!confirm('Clear all saved data? This cannot be undone!')) return;

      // Clear chrome.storage.local
      chrome.storage.local.remove('cards', () => {
        console.log('Cards cleared');
      });

      // Clear IndexedDB
      const request = indexedDB.open('nabokov-clipper', 1);
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(['screenshots'], 'readwrite');
        const store = transaction.objectStore('screenshots');
        store.clear();

        transaction.oncomplete = () => {
          alert('All data cleared!');
          loadData();
        };
      };
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>