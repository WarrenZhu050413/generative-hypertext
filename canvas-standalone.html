<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nabokov Canvas - Standalone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            background: #f5f5f5;
        }

        #root {
            width: 100%;
            height: 100%;
        }

        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }

        .error {
            padding: 20px;
            background: #ffebee;
            border: 2px solid #d32f2f;
            border-radius: 4px;
            margin: 20px;
            color: #c62828;
        }

        .card-list {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-item h3 {
            color: #d32f2f;
            margin-bottom: 10px;
        }

        .card-item img {
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }

        .card-meta {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading">Loading Nabokov Canvas...</div>
    </div>

    <script>
        // Check if we're running in a Chrome extension context
        const isExtension = typeof chrome !== 'undefined' && chrome.storage;

        async function loadCards() {
            const rootEl = document.getElementById('root');

            if (!isExtension) {
                rootEl.innerHTML = `
                    <div class="error">
                        <h2>‚ö†Ô∏è Not Running in Extension Context</h2>
                        <p>This page needs to be opened from the Chrome extension to access stored data.</p>
                        <p><strong>How to use:</strong></p>
                        <ol style="margin-top: 10px; margin-left: 20px;">
                            <li>Install the Nabokov Web Clipper extension</li>
                            <li>Click the extension icon in Chrome toolbar</li>
                            <li>The Canvas page will open with your clipped cards</li>
                        </ol>
                        <p style="margin-top: 15px;"><em>For development: Serve this from the extension's dist folder</em></p>
                    </div>
                `;
                return;
            }

            try {
                // Load cards from chrome.storage.local
                chrome.storage.local.get('cards', async (result) => {
                    const cards = result.cards || [];

                    if (cards.length === 0) {
                        rootEl.innerHTML = `
                            <div class="card-list">
                                <h1 style="color: #d32f2f; margin-bottom: 20px;">üìã Nabokov Canvas</h1>
                                <p style="color: #666; font-size: 16px;">No cards clipped yet. Press <strong>Cmd+Shift+E</strong> on any webpage to start clipping!</p>
                            </div>
                        `;
                        return;
                    }

                    // Load screenshots from IndexedDB
                    const db = await openDB();
                    const screenshots = await getAllScreenshots(db);
                    const screenshotMap = new Map(screenshots.map(s => [s.id, s.dataUrl]));

                    // Render cards
                    let html = `
                        <div class="card-list">
                            <h1 style="color: #d32f2f; margin-bottom: 20px;">üìã Nabokov Canvas</h1>
                            <p style="margin-bottom: 20px; color: #666;">You have ${cards.length} clipped card${cards.length === 1 ? '' : 's'}</p>
                    `;

                    cards.forEach((card, i) => {
                        const screenshot = screenshotMap.get(card.screenshotId);
                        html += `
                            <div class="card-item">
                                <h3>${i + 1}. ${card.title || 'Untitled'}</h3>
                                <div class="card-meta"><strong>Tag:</strong> ${card.tagName}</div>
                                <div class="card-meta"><strong>URL:</strong> <a href="${card.url}" target="_blank">${card.url}</a></div>
                                <div class="card-meta"><strong>Captured:</strong> ${new Date(card.timestamp).toLocaleString()}</div>
                                <div class="card-meta"><strong>Text:</strong> ${card.textContent.substring(0, 100)}${card.textContent.length > 100 ? '...' : ''}</div>
                                ${screenshot ? `<img src="${screenshot}" alt="Screenshot">` : '<p><em>No screenshot</em></p>'}
                            </div>
                        `;
                    });

                    html += '</div>';
                    rootEl.innerHTML = html;
                });

            } catch (error) {
                rootEl.innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error Loading Cards</h2>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('nabokov-clipper', 1);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllScreenshots(db) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['screenshots'], 'readonly');
                const store = transaction.objectStore('screenshots');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Load cards when page loads
        loadCards();
    </script>
</body>
</html>