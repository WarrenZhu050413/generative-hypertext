<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nabokov Extension Test Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 { color: #8B0000; }
        .test-element {
            background: #F5F5DC;
            border: 2px solid #FFD700;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        button {
            background: #8B0000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #A52A2A;
        }
        .status {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>🧪 Nabokov Web Clipper Test Page</h1>

    <div class="status">
        <h3>✅ Testing Instructions</h3>
        <ol>
            <li>Make sure the extension is loaded in Chrome</li>
            <li>Press <kbd>Cmd+Shift+E</kbd> (Mac) or <kbd>Ctrl+Shift+E</kbd> (Windows/Linux)</li>
            <li>Hover over elements to see them highlight</li>
            <li>Click an element to clip it</li>
            <li>Check the browser console (F12) for any errors</li>
        </ol>
    </div>

    <div class="test-element" data-test="element-1">
        <h2>Test Element 1: Simple Paragraph</h2>
        <p>This is a simple paragraph that you can try to clip. It contains some text that should be captured when you select this element.</p>
    </div>

    <div class="test-element" data-test="element-2">
        <h2>Test Element 2: List</h2>
        <ul>
            <li>Item one with some content</li>
            <li>Item two with more content</li>
            <li>Item three with even more content</li>
        </ul>
    </div>

    <div class="test-element" data-test="element-3">
        <h2>Test Element 3: Code Block</h2>
        <div class="code-block">
function greet(name) {
    return `Hello, ${name}!`;
}

console.log(greet('World'));
        </div>
    </div>

    <div class="test-element" data-test="element-4">
        <h2>Test Element 4: Image</h2>
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100'%3E%3Crect fill='%238B0000' width='200' height='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23FFD700' font-size='20'%3ENabokov%3C/text%3E%3C/svg%3E" alt="Test Image" style="max-width: 100%;">
        <p>Try clipping this element that contains an image.</p>
    </div>

    <h2>Debug Controls</h2>
    <button onclick="checkExtension()">Check Extension Status</button>
    <button onclick="testMessageSending()">Test Message to Background</button>
    <button onclick="clearConsole()">Clear Console</button>

    <div id="debug-output"></div>

    <script>
        function log(message, isError = false) {
            const output = document.getElementById('debug-output');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'status';
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function checkExtension() {
            log('Checking extension status...');

            // Check if chrome.runtime is available
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                log('✅ Chrome runtime API is available');
                log(`Extension ID: ${chrome.runtime.id}`);

                // Try to send a ping message
                chrome.runtime.sendMessage({ type: 'PING' }, (response) => {
                    if (chrome.runtime.lastError) {
                        log(`❌ Error: ${chrome.runtime.lastError.message}`, true);
                    } else {
                        log(`✅ Got response from background: ${JSON.stringify(response)}`);
                    }
                });
            } else {
                log('❌ Chrome runtime API not available', true);
            }

            // Check for content script injection
            if (typeof window.__nabokobClipper__ !== 'undefined') {
                log('✅ Content script is injected (__nabokobClipper__ found)');
            } else {
                log('⚠️ Content script marker not found (might be stripped in prod build)');
            }
        }

        function testMessageSending() {
            log('Testing message sending to background script...');

            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({
                    type: 'TEST_MESSAGE',
                    payload: { test: true, timestamp: Date.now() }
                }, (response) => {
                    if (chrome.runtime.lastError) {
                        log(`❌ Message failed: ${chrome.runtime.lastError.message}`, true);
                    } else {
                        log(`✅ Message sent successfully. Response: ${JSON.stringify(response)}`);
                    }
                });
            } else {
                log('❌ Cannot send message - Chrome runtime not available', true);
            }
        }

        function clearConsole() {
            document.getElementById('debug-output').innerHTML = '';
            console.clear();
            log('Console cleared');
        }

        // Listen for messages from the extension
        window.addEventListener('message', (event) => {
            if (event.data.source === 'nabokov-extension') {
                log(`📨 Received message from extension: ${JSON.stringify(event.data)}`);
            }
        });

        // Log when page loads
        window.addEventListener('load', () => {
            log('✅ Test page loaded successfully');
            log('Press Cmd/Ctrl+Shift+E to activate element selector');
        });

        // Monitor for shadow DOM creation
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.shadowRoot) {
                        log(`✅ Shadow DOM detected on element: ${node.tagName}`);
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>