# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Nabokov Web Clipper is a Chrome extension (Manifest V3) for capturing web content and organizing it on a visual canvas. Built with React, TypeScript, and React Flow.

Research citation: Zhu, F. W., Agrawala, M., & Mysore, G. J. (2024). Nabokov: Organize Web Content with LLM-Powered Visual Canvas. UIST '24 Companion, Article 42, 1-3. https://doi.org/10.1145/3698061.3726916

## Development Commands

```bash
# Install dependencies
npm install

# Build extension (TypeScript + Vite)
npm run build

# Watch mode for development
npm run watch:extension

# Type checking (always run before committing)
npm run type-check

# Unit tests (Vitest)
npm test                  # Run once
npm run test:watch        # Watch mode
npm run test:coverage     # With coverage

# E2E tests (Playwright) - requires built extension
npm run test:e2e          # Headless
npm run test:e2e:headed   # With browser UI
npm run test:e2e:debug    # Debug mode

# Manual testing with Playwright (bypasses chrome://extensions)
node test-scripts/test-canvas-direct.mjs
```

## Architecture

### Chrome Extension Structure

**Three execution contexts:**

1. **Background Service Worker** (`src/background/index.ts`)
   - Manifest V3 service worker
   - Handles keyboard commands (`Cmd+Shift+E`)
   - Context menu registration
   - Screenshot capture via `chrome.tabs.captureVisibleTab()`
   - Opens canvas on toolbar icon click

2. **Content Script** (`src/content/index.tsx`)
   - Injected into all pages (`<all_urls>`)
   - Listens for `ACTIVATE_SELECTOR` messages
   - Mounts `ElementSelector` component into Shadow DOM
   - Shadow DOM isolation prevents CSS conflicts

3. **Canvas Page** (`src/canvas/index.html`)
   - Standalone React app
   - React Flow for node-based canvas
   - Accessed via `chrome-extension://<id>/src/canvas/index.html`

### Data Flow

**Element Capture Flow:**
```
User presses Cmd+Shift+E
â†’ Background worker sends ACTIVATE_SELECTOR message
â†’ Content script mounts ElementSelector in Shadow DOM
â†’ User clicks element
â†’ Capture pipeline:
  1. Extract HTML + sanitize (DOMPurify)
  2. Capture screenshot via background worker
  3. Compress screenshot (canvas-based compression)
  4. Generate unique ID (timestamp + random)
  5. Save Card to chrome.storage.local
  6. Save Screenshot to IndexedDB
â†’ Canvas auto-refreshes to show new card
```

**Storage Architecture:**
- **chrome.storage.local**: Card metadata (limit: ~5MB after JSON serialization)
  - Key: `'cards'` â†’ `Card[]`
  - Key: `'nabokov_canvas_state'` â†’ `CanvasState` (positions, zoom)
  - Key: `'nabokov_filters'` â†’ `FilterState`
- **IndexedDB**: Screenshots (limit: much larger, browser-dependent)
  - Database: `'nabokov-clipper'`
  - Store: `'screenshots'`
  - Key: `screenshotId` (matches `Card.screenshotId`)

### Core Type: Card

```typescript
interface Card {
  id: string;                    // Generated by generateId()
  content: string;               // Sanitized HTML
  metadata: ClipMetadata;        // url, title, domain, favicon, etc.
  position?: CardPosition;       // Canvas x, y
  size?: CardSize;              // Canvas width, height
  starred: boolean;
  tags: string[];
  createdAt: number;
  updatedAt: number;
  conversation?: Message[];      // Chat history with Claude (future)
  screenshotId?: string;        // Reference to IndexedDB screenshot
  styles?: RelevantStyles;      // Computed CSS for rendering
  context?: string;             // Parent element HTML
}
```

### Build System

- **Vite** with `@crxjs/vite-plugin` for Chrome extension support
- **Path aliases**: `@/`, `@components/`, `@utils/`, `@types/`
- **Emotion CSS-in-JS**: Uses `@emotion/react` with JSX pragma
- Build output: `dist/` (git-ignored)
- Manifest copied from `src/manifest.json` â†’ `dist/manifest.json`

### Key Components

**ElementSelector** (`src/components/ElementSelector.tsx`)
- Renders in Shadow DOM to isolate styles
- Visual overlay with Chinese aesthetic (red/gold colors)
- Element info tooltip (tag, classes, dimensions)
- Handles keyboard (ESC to exit)
- Screenshot capture is **optional and non-blocking** (fails silently if blocked by CORS)

**Canvas** (`src/canvas/Canvas.tsx`)
- React Flow wrapper
- Loads cards via `useCanvasState` hook
- Converts Card[] â†’ ReactFlow Node[]
- Debounced auto-save (2 seconds) for position/size changes
- Filter/search bar (Toolbar component)
- Keyboard shortcuts system

**CardNode** (`src/canvas/CardNode.tsx`)
- Custom React Flow node type
- **Critical**: Always check `card.tags && card.tags.length` (tags may be undefined on old cards)
- Displays sanitized content preview, metadata, tags
- Chinese aesthetic styling

## Critical Implementation Details

### Screenshot Capture

Screenshot capture can fail due to:
- CORS restrictions (cross-origin images)
- Canvas tainting
- Missing activeTab permission

**Always make screenshot capture optional:**
```typescript
let compressionResult = null;
try {
  const screenshot = await captureElementScreenshot(element);
  compressionResult = await compressScreenshot(screenshot);
} catch (error) {
  console.warn('Screenshot failed (non-blocking):', error);
  // Continue without screenshot
}

const card: Card = {
  // ...
  screenshotId: compressionResult ? screenshotId : undefined,
};
```

### Extension Reload Requirement

After running `npm run build`, Chrome caches the old code. **You must reload the extension:**
1. Navigate to `chrome://extensions`
2. Click the reload icon (ðŸ”„) on the extension card
3. Refresh any open Canvas pages

### Testing Chrome Extensions

**Standard Playwright cannot load Chrome extensions.** Use persistent context with extension loading:

```javascript
import { chromium } from 'playwright';
const ctx = await chromium.launchPersistentContext('', {
  args: [
    '--disable-extensions-except=/path/to/dist',
    '--load-extension=/path/to/dist'
  ]
});
```

Test scripts in `test-scripts/` use this pattern to test the extension without navigating to `chrome://extensions`.

### Path Resolution in Test Scripts

Test scripts moved to `test-scripts/` must use `path.join(__dirname, '..', 'dist')` not `path.join(__dirname, 'dist')`.

## Common Issues

**"Cannot read properties of undefined (reading 'length')"** in Canvas
- Usually `card.tags.length` when `tags` is undefined
- Always use `card.tags && card.tags.length` or `card.tags?.length`

**"Tainted canvases may not be exported"**
- CORS issue with screenshot capture
- Already handled with try-catch wrapper (non-blocking)

**Extension not updating after build**
- Must manually reload extension in `chrome://extensions`
- Playwright tests always load fresh code

**Content script not responding**
- Check manifest: `"matches": ["<all_urls>"]`
- Check `run_at: "document_idle"` (waits for DOM)
- Background worker timing issue (expected, non-critical)

## File Organization

```
src/
  background/       # Service worker
  content/          # Content script injection
  components/       # React components (ElementSelector, etc.)
  canvas/           # Canvas app (separate React app)
  utils/            # Storage, screenshot, sanitization
  types/            # TypeScript types (card.ts is source of truth)
  manifest.json     # Extension manifest

test-scripts/       # Manual Playwright tests (bypass chrome://extensions)
tests/              # Vitest unit tests, Playwright E2E
docs/               # Documentation
archive/            # Old implementations (nabokov-clipper/, deprecated tests)
```

## Code Style Notes

- Use `console.log` with prefixes: `[Canvas]`, `[storage]`, `[ElementSelector]`
- Shadow DOM components need `/** @jsxImportSource @emotion/react */` pragma
- Always sanitize HTML with DOMPurify before storing
- Use `generateId()` from `@/utils/storage` for all IDs
- Error handling: Fail gracefully, log warnings for non-critical failures

## Testing Strategy

**Unit tests**: Utils, sanitization, storage logic (Vitest + jsdom)
**E2E tests**: Extension loading, element capture, canvas rendering (Playwright)
**Manual tests**: `test-scripts/*.mjs` for quick verification without test harness
