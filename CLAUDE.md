# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Nabokov Web Clipper is a Chrome extension (Manifest V3) for capturing web content and organizing it on a visual canvas. Built with React, TypeScript, and React Flow.

Research citation: Zhu, F. W., Agrawala, M., & Mysore, G. J. (2024). Nabokov: Organize Web Content with LLM-Powered Visual Canvas. UIST '24 Companion, Article 42, 1-3. https://doi.org/10.1145/3698061.3726916

## Development Commands

```bash
# Install dependencies
npm install

# Build extension (TypeScript + Vite)
npm run build

# Watch mode for development
npm run watch:extension

# Type checking (always run before committing)
npm run type-check

# Backend server (Agent SDK for subscription auth)
npm run backend           # Start backend server
npm run backend:dev       # With auto-reload

# Unit tests (Vitest)
npm test                  # Run once
npm run test:watch        # Watch mode
npm run test:coverage     # With coverage

# E2E tests (Playwright) - requires built extension
npm run test:e2e          # Headless
npm run test:e2e:headed   # With browser UI
npm run test:e2e:debug    # Debug mode

# Manual testing with Playwright (bypasses chrome://extensions)
node test-scripts/test-canvas-direct.mjs
```

## Architecture

### Chrome Extension Structure

**Three execution contexts:**

1. **Background Service Worker** (`src/background/index.ts`)
   - Manifest V3 service worker
   - Handles keyboard commands (Mac):
     - `Command+Shift+E` (Stash mode)
     - `Control+Shift+E` (Canvas mode)
     - `Control+Shift+C` (Inline chat)
   - Context menu registration
   - Opens canvas on toolbar icon click

2. **Content Script** (`src/content/index.tsx`)
   - Injected into all pages (`<all_urls>`)
   - Listens for `ACTIVATE_SELECTOR` and `OPEN_INLINE_CHAT` messages
   - Mounts `ElementSelector` component into Shadow DOM
   - Mounts `InlineChatWindow` for page conversations
   - Shadow DOM isolation prevents CSS conflicts

3. **Canvas Page** (`src/canvas/index.html`)
   - Standalone React app
   - React Flow for node-based canvas
   - Accessed via `chrome-extension://<id>/src/canvas/index.html`

4. **Side Panel** (`src/sidepanel/index.html`)
   - Chrome Side Panel UI for stashed cards
   - Accessed via `chrome.sidePanel.open()`
   - Features:
     - Image upload (drag & drop + file picker)
     - Restore or permanently delete stashed cards
     - Search and filter functionality
     - Uses shared hooks and components

### Data Flow

**Element Capture Flow:**

```
User presses Cmd+Shift+E
→ Background worker sends ACTIVATE_SELECTOR message
→ Content script mounts ElementSelector in Shadow DOM
→ User clicks element
→ Capture pipeline:
  1. Extract HTML + sanitize (DOMPurify)
  2. Generate unique ID (timestamp + random)
  3. Save Card to chrome.storage.local
→ Canvas auto-refreshes to show new card
```

**Storage Architecture:**

- **chrome.storage.local**: All card data and metadata (limit: ~5MB after JSON serialization)
  - Key: `'cards'` → `Card[]`
  - Key: `'nabokov_canvas_state'` → `CanvasState` (positions, zoom)
  - Key: `'nabokov_filters'` → `FilterState`
  - Key: `'nabokov_connections'` → `Connection[]` (card relationships/arrows)
  - Key: `'nabokov_claude_api_key'` → `string` (Claude API key for LLM features)
  - Key: `'nabokov_custom_buttons'` → `CustomButton[]` (user-defined action buttons)
  - Key: `'nabokov_font_size'` → `FontSize` ('small' | 'medium' | 'large')

### Core Type: Card

```typescript
interface Card {
  id: string; // Generated by generateId()
  content?: string; // Sanitized HTML (optional for image-only cards)
  metadata: ClipMetadata; // url, title, domain, favicon, etc.
  position?: CardPosition; // Canvas x, y
  size?: CardSize; // Canvas width, height
  starred: boolean;
  tags: string[];
  createdAt: number;
  updatedAt: number;
  conversation?: Message[]; // Chat history with Claude
  styles?: RelevantStyles; // Computed CSS for rendering
  context?: string; // Parent element HTML
  cardType?: "clipped" | "generated" | "note" | "image"; // Source type
  parentCardId?: string; // For generated cards (parent relationship)
  generationContext?: {
    // Metadata for AI-generated cards
    sourceMessageId: string;
    userPrompt: string;
    timestamp: number;
  };
  imageData?: string; // Base64 data URL for image cards
  imageDimensions?: {
    // Original dimensions for image cards
    width: number;
    height: number;
  };
  stashed?: boolean; // If true, card hidden from canvas (in side panel stash)
  fillInHistory?: FillInHistoryEntry[]; // History of fill-in operations
}
```

### Build System

- **Vite** with `@crxjs/vite-plugin` for Chrome extension support
- **Path aliases**: `@/`, `@components/`, `@utils/`, `@types/` (configured in both `vite.config.ts` and `tsconfig.json`)
- **Emotion CSS-in-JS**: Uses `@emotion/react` with JSX pragma (`jsxImportSource: '@emotion/react'` in Vite config)
- Build output: `dist/` (git-ignored)
- Manifest copied from `src/manifest.json` → `dist/manifest.json`
- Dev server runs on port 5173 with HMR

### Shared Architecture (NEW)

**Code Sharing Between Canvas and Side Panel:**

To eliminate duplication and maintain consistency, shared code is organized in `src/shared/`:

```
src/shared/
  services/
    cardService.ts        - Unified CRUD operations with cross-context messaging
    filterService.ts      - Card filtering logic (search, domains, tags, dates)
    imageService.ts       - Image upload and processing

  hooks/
    useCards.ts          - Load cards with auto-refresh on storage changes
    useFilters.ts        - Filtering state management with optional persistence
    useImageUpload.ts    - Image upload handling with validation
    useCardOperations.ts - Card operations (stash/restore/delete/update/duplicate)
    useFontSize.ts       - Font size state management with cross-context sync

  components/
    FilterBar/           - Unified filtering UI (search, domains, tags, dates)
    ImageUpload/
      ImageUploadZone.tsx       - Drag & drop zone for images
      FilePickerButton.tsx      - File picker button
```

**Cross-Context Synchronization:**

All card operations broadcast updates via **dual event system**:
1. **Local events** (`window.dispatchEvent`) for same-context listeners
2. **Runtime messages** (`chrome.runtime.sendMessage`) for cross-context listeners

Example:
```typescript
// In cardService.ts
function broadcastCardUpdate(type: string, cardId: string) {
  window.dispatchEvent(new CustomEvent('nabokov:cards-updated'));
  chrome.runtime.sendMessage({ type, cardId });
}
```

This ensures Canvas and Side Panel stay synchronized in real-time without page reloads.

**Keyboard Shortcuts & Mode Indicators (Mac):**

- **Command+Shift+E**: Activate element selector (Stash mode)
  - Mode indicator: 📥 **STASH MODE** (blue gradient)
  - Cards saved to Side Panel stash

- **Control+Shift+E**: Activate element selector (Canvas mode)
  - Mode indicator: 🎨 **CANVAS MODE** (red/gold gradient)
  - Cards saved directly to canvas

- **Control+Shift+C**: Toggle inline chat with page
  - Opens chat window for page conversations
  - Can save conversation to canvas as note card

Mode indicators replaced the old checkbox approach with prominent banners at the top of the screen.

### Key Components

**ElementSelector** (`src/components/ElementSelector.tsx`)

- Renders in Shadow DOM to isolate styles
- Visual overlay with Chinese aesthetic (red/gold colors)
- Element info tooltip (tag, classes, dimensions)
- Handles keyboard (ESC to exit)

**Canvas** (`src/canvas/Canvas.tsx`)

- React Flow wrapper
- Loads cards via `useCanvasState` hook
- Converts Card[] → ReactFlow Node[]
- Debounced auto-save (2 seconds) for position/size changes
- Filter/search bar (Toolbar component)
- Keyboard shortcuts system:
  - `Cmd/Ctrl+N`: Create new note card
  - `Delete/Backspace`: Delete selected cards
  - Arrow keys: Navigate between cards
  - Other shortcuts defined in `src/canvas/keyboardShortcuts.css`

**CardNode** (`src/canvas/CardNode.tsx`)

- Custom React Flow node type
- **Critical**: Always check `card.tags && card.tags.length` (tags may be undefined on old cards)
- Displays sanitized content preview, metadata, tags
- **Image cards**: Displays `card.imageData` inline with proper aspect ratio preservation
- **ReactMarkdown**: Renders beautified content with custom component styling
- Supports inline editing (double-click content to edit)
- Chinese aesthetic styling (gradient backgrounds, multi-layer shadows)
- Resizable with NodeResizer (min: 200x150px)
- Collapsible to save canvas space

**ChatModal** (`src/canvas/ChatModal.tsx`)

- Modal dialog for conversations with cards
- Maintains chat history in `Card.conversation` array
- Streaming LLM responses (via `mockClaudeAPI`)
- Keyboard: Enter to send, Shift+Enter for newline, Escape to close

**FloatingWindow** (`src/components/FloatingWindow.tsx`)

- **Draggable & Resizable**: Uses `react-rnd` for drag + resize (min: 300×200px)
- **Collapsible**: Collapse to header-only (40px) or expand to full size
- **Z-index Management**: Click window brings it to front
- **State Persistence**: Position, size, collapsed state saved to storage
- **Chat Integration**: Embedded chat with `FloatingWindowChat` component
- **Save Options**: Save conversations to Canvas (🎨) or Stash (📥)
- **Window Controls**:
  - Collapse/Expand (▲/▼)
  - Minimize (−) - hides completely
  - Close (×) - removes window
- **Managed by WindowManager**: Centralized state, cascade positioning, debounced saves

**InlineChatWindow** (`src/components/InlineChatWindow.tsx`)

- **Content Script Window**: Floating chat window in web pages (not Canvas)
- **Draggable & Resizable**: Uses `react-rnd` for drag + resize (min: 300×200px)
- **Collapsible**: Collapse to header-only or expand to full size
- **Context Types**: Supports both page context and element-specific context
- **Save to Canvas**: Can save conversation as note card to Canvas
- **Window Controls**:
  - Refresh context (📋) - recapture page state
  - Save to Canvas (📌) - create note card from conversation
  - Collapse/Expand (▲/▼)
  - Close (✕)
- **Keyboard**: ESC to close, Enter to send, Shift+Enter for newline
- **Positioning**: Auto-positions near element (if element chat) or screen edge

**Toast** (`src/components/Toast.tsx`)

- Notification system for user feedback
- Types: `'loading'`, `'success'`, `'error'`, `'info'`
- Auto-dismiss with configurable duration (0 = no auto-dismiss)
- Used for API calls, card generation, beautification feedback

**FontSizeSelector** (`src/components/FontSizeSelector.tsx`)

- UI component for adjusting card text size
- Three size options: Small (A⁻), Medium (A), Large (A⁺)
- **Font Size Values**:
  - Small: 11-12px (content, headings, code)
  - Medium: 13-14px (default)
  - Large: 15-16px
- **Integration**: Used in both Canvas Toolbar and Side Panel header
- **State Management**: Uses `useFontSize` hook for cross-context synchronization
- **Storage**: User preference persists in `chrome.storage.local` under `'nabokov_font_size'`
- **Cross-Context Sync**: Changes in Canvas or Side Panel sync in real-time via `chrome.storage.onChanged`
- **Implementation Details**:
  - CardNode: Dynamic styles via function wrapper accepting `fontSizeValues`
  - SidePanel: Emotion CSS with function wrappers for dynamic font sizes
  - All text elements (titles, content, markdown, code) adjust proportionally
- **Service Layer**: `fontSizeService.ts` provides get/set/getFontSizeValues functions

**Card Generation System**

- **ContextInputModal** (`src/components/ContextInputModal.tsx`): Prompts for context before generating cards
- **cardGenerationService** (`src/services/cardGenerationService.ts`): Generates new cards from button actions
- **Custom Buttons**: Configurable action buttons with template-based prompts
  - Default buttons: Learn More, Summarize, Critique, ELI5, Expand (see `src/config/defaultButtons.ts`)
  - Template variables: `{{content}}`, `{{title}}`, `{{customContext}}`
  - Each button specifies connection type: `'references'`, `'generated-from'`, `'related'`
- Generated cards linked to parent via `parentCardId` and visual arrows
- Auto-creates connections between parent and generated cards
- Uses real Claude API when configured, falls back to mock responses for development

**Claude API Integration**

- **claudeAPIService** (`src/services/claudeAPIService.ts`): Multi-tier Claude API integration with fallbacks
- **Backend Server** (`backend/server.mjs`): Local Node.js server using Agent SDK for subscription auth
- **apiConfigService** (`src/services/apiConfig.ts`): Secure API key management
- **APISettings** (`src/components/APISettings.tsx`): UI for API key configuration

**Authentication Priority Order:**
1. **Local Backend** (http://localhost:3100) - Uses Claude Agent SDK
   - Start with: `npm run backend` (or `npm run backend:dev` for auto-reload)
   - ✅ Works with Claude.ai subscription (no API key needed)
   - ✅ Works with API key from environment variable
   - ✅ Best option - no separate billing required
2. **Direct API** (api.anthropic.com) - Direct fetch to Anthropic API
   - ⚠️ Requires separate Claude API key and billing
   - ✅ Vision API support (screenshot analysis)
3. **Mock Fallback** - Development mock responses
   - 📝 Always works, but not real AI

**Key Features:**
- Supports text-only and vision (screenshot analysis) modes
- Default model: `claude-sonnet-4-20250514`
- API key stored securely in chrome.storage.local
- Backend enables subscription-based auth (see `backend/README.md`)

**Beautification System**

- **beautificationService** (`src/services/beautificationService.ts`): AI-powered card content enhancement
- Mode:
  - `'organize-content'`: Restructure content for better readability with clean, semantic HTML
- Uses Claude API for text-based content analysis
- Always sanitizes output with DOMPurify before storing
- Falls back to mock content in development mode

**Side Panel Stash System**

- **stashService** (`src/sidepanel/stashService.ts`): Manages stashed cards
- **SidePanel** (`src/sidepanel/SidePanel.tsx`): Compact UI for viewing/managing stashed cards
- **Canvas-like Card Design**:
  - Cards match CardNode styling with gradient backgrounds and box-shadows
  - **Inline image display** for image cards (max-height 250px, object-fit: contain)
  - **ReactMarkdown rendering** for beautified content
  - **Card type badges** (📷 Image, 📝 Note, ✨ Generated, 🌐 Clipped)
  - **Compact layout** with header, title, tags inline, and action buttons
  - Expand/collapse for long content (collapsed: 150px, expanded: 500px)
- **Features**:
  - **Image Upload**: Drag & drop or file picker for uploading images directly to stash
  - **Shared Hooks**: Uses `useCards`, `useCardOperations`, `useImageUpload` from `src/shared/`
  - **Real-time Sync**: Updates instantly via runtime messages (no reload needed)
- Cards marked with `stashed: true` are hidden from canvas but not deleted
- Side panel provides search, restore, and permanent delete functionality
- Access via Chrome Side Panel API or toolbar button in Canvas

**Fill-In Feature**

- **fillInService** (`src/services/fillInService.ts`): Connection-based knowledge synthesis
- **FillInModal** (`src/components/FillInModal.tsx`): UI for triggering fill-in operations
- Three strategies:
  - `'replace'`: Generate entirely new content from connected cards
  - `'append'`: Add synthesized content to existing card
  - `'merge'`: Intelligently merge connected content with existing
- Builds context from all connected cards (via `connectionContextService`)
- Stores fill-in history for tracking synthesis operations
- Uses Claude API with fallback to mock generator

**LLM-Generated Hyperlinks and Instant Expansion**

- **useLLMHyperlinks** (`src/canvas/useLLMHyperlinks.ts`): Detects expandable terms in card content
- **instantExpansion** (`src/utils/instantExpansion.ts`): Creates child cards with emanation animation
- **childCardGenerator** (`src/services/childCardGenerator.ts`): Generates child card content
- Workflow:
  1. User clicks underlined expandable link in card
  2. System detects selection and generates child card content
  3. Child card created at position 400px to right of parent
  4. Connection auto-created with `'generated-from'` type
  5. Golden glow emanation animation (800ms cubic-bezier)
- Uses text selection service for link detection
- Collision detection with fallback positioning

**Custom Button System**

- **ButtonSettings** (`src/components/ButtonSettings.tsx`): UI for creating/editing custom buttons
- **useButtons** (`src/canvas/useButtons.ts`): Hook for managing button configuration
- Users can create custom action buttons with:
  - Custom labels (e.g., "Translate", "Compare")
  - Template-based prompts with variables: `{{content}}`, `{{title}}`, `{{customContext}}`
  - Connection types: `'references'`, `'generated-from'`, `'related'`, `'contradicts'`
  - Optional context input prompts
- Buttons stored in `chrome.storage.local` under `'nabokov_custom_buttons'`
- Default buttons defined in `src/config/defaultButtons.ts`
- Generated cards automatically linked to parent via connections

## Critical Implementation Details

### Extension Reload Requirement

After running `npm run build`, Chrome caches the old code. **You must reload the extension:**

1. Navigate to `chrome://extensions`
2. Click the reload icon (🔄) on the extension card
3. Refresh any open Canvas pages

### Testing Chrome Extensions

**Standard Playwright cannot load Chrome extensions.** Use persistent context with extension loading:

```javascript
import { chromium } from "playwright";
const ctx = await chromium.launchPersistentContext("", {
  args: [
    "--disable-extensions-except=/path/to/dist",
    "--load-extension=/path/to/dist",
  ],
});
```

Test scripts in `test-scripts/` use this pattern to test the extension without navigating to `chrome://extensions`.

### Path Resolution in Test Scripts

Test scripts moved to `test-scripts/` must use `path.join(__dirname, '..', 'dist')` not `path.join(__dirname, 'dist')`.

### Card Relationships and Connections

**Connection storage** (`src/utils/connectionStorage.ts`):

- Arrows between cards stored in `chrome.storage.local` under key `'nabokov_connections'`
- Each connection has: `id`, `source` (card ID), `target` (card ID), `createdAt`, `connectionType`, optional `label`
- Use `addConnection(sourceId, targetId, connectionType)` to create relationships
- Canvas automatically renders connections as React Flow edges
- Connection types: `'related'`, `'generated-from'`, `'references'`, `'contradicts'`, `'custom'`
- **EdgeEditModal**: UI for editing connection type and custom labels (click on edge to edit)

**Card types and workflows**:

- `'clipped'`: User-captured content via element selector
- `'note'`: Manual note creation (Cmd+N)
- `'generated'`: AI-generated from button actions or instant expansion (linked via `parentCardId`)
- `'image'`: Drag-and-drop image upload (stored as base64 in `imageData`)

**Stashed cards**:

- Cards with `stashed: true` are hidden from canvas
- Accessible via Chrome Side Panel (`chrome.sidePanel.open()`)
- Can be restored (unhides from canvas) or permanently deleted
- Uses separate event system: `'nabokov:stash-updated'`

### Inline Editing

Cards support inline editing on the canvas:

- **Trigger**: Double-click card content area
- **Implementation**: Uses `contentEditable` div with DOMPurify sanitization
- **Save**: Auto-saves on blur or Cmd/Ctrl+Enter
- **Cancel**: Escape key to revert
- **Critical**: Always sanitize edited content before saving to storage

### Image Upload

Drag-and-drop image upload to canvas:

- **Implementation**: `src/utils/imageUpload.ts`
- **Trigger**: Drag image file onto canvas
- **Storage**: Images converted to base64 data URLs and stored in `Card.imageData`
- **Validation**: Only accepts files with `image/*` MIME type
- **Dimensions**: Original dimensions preserved in `Card.imageDimensions`
- **Card type**: Created as `cardType: 'image'` with optional `content`

### State Refresh Pattern

**Critical**: Never use `window.location.reload()` for state updates. Use event-based refresh:

```typescript
// After modifying cards/connections
window.dispatchEvent(new CustomEvent("nabokov:cards-updated"));

// In useCanvasState.ts, listener auto-refreshes canvas
useEffect(() => {
  const handleCardUpdate = () => {
    loadCards(); // Refresh from storage
  };
  window.addEventListener("nabokov:cards-updated", handleCardUpdate);
  return () =>
    window.removeEventListener("nabokov:cards-updated", handleCardUpdate);
}, []);
```

This pattern eliminates race conditions and provides faster UX than full page reloads.

## Common Issues

**"Cannot read properties of undefined (reading 'length')"** in Canvas

- Usually `card.tags.length` when `tags` is undefined
- Always use `card.tags && card.tags.length` or `card.tags?.length`
- Similarly check `card.content` (optional for image-only cards)

**"Tainted canvases may not be exported"**

- CORS issue with screenshot capture
- Already handled with try-catch wrapper (non-blocking)

**"Claude API key not configured"**

- User must set API key via APISettings component
- Check `apiConfigService.hasAPIKey()` before making API calls
- Service automatically falls back to mock responses in development

**Extension not updating after build**

- Must manually reload extension in `chrome://extensions`
- Playwright tests always load fresh code

**Content script not responding**

- Check manifest: `"matches": ["<all_urls>"]`
- Check `run_at: "document_idle"` (waits for DOM)
- Background worker timing issue (expected, non-critical)

**Cards not appearing after creation in tests**

- Likely storage timing issue with chrome.storage.local
- Use `waitForTimeout(3000)` for async storage operations
- Check console for `[cardGenerationService]` debug logs

**Stashed cards still visible on canvas**

- Check that card filter properly excludes `card.stashed === true`
- Ensure `useCanvasState` hook filters stashed cards: `cards.filter(c => !c.stashed)`
- Side panel and canvas both listen to `'nabokov:stash-updated'` events

## File Organization

```
src/
  background/       # Service worker
  content/          # Content script injection
  components/       # React components (ElementSelector, FloatingWindow, modals)
  canvas/           # Canvas app (separate React app)
  sidepanel/        # Side Panel app for stashed cards
  shared/           # NEW: Shared code between Canvas and Side Panel
    services/       #   - cardService, filterService, imageService
    hooks/          #   - useCards, useFilters, useImageUpload, useCardOperations
    components/     #   - FilterBar, ImageUpload (drag & drop, file picker)
  services/         # API services (Claude, beautification, fill-in, card generation)
  config/           # Configuration (default buttons, etc.)
  utils/            # Storage, screenshot, sanitization, image upload, instant expansion
  types/            # TypeScript types (card.ts is source of truth)
  manifest.json     # Extension manifest

test-scripts/       # Manual Playwright tests (bypass chrome://extensions)
tests/              # Vitest unit tests, Playwright E2E
docs/               # Documentation
archive/            # Old implementations (nabokov-clipper/, deprecated tests)
```

## Testing Plan & Regression Prevention

**CRITICAL**: Run these tests after EVERY feature implementation or significant change to prevent regressions.

### Pre-Commit Checklist

**Always run before committing**:
```bash
# 1. Type check (MUST pass)
npm run type-check

# 2. Build verification (MUST complete with zero warnings)
npm run build

# 3. Unit tests (all MUST pass)
npm test

# 4. E2E tests for affected features
npm run test:e2e:headed  # Run relevant spec files
```

### Testing Strategy by Feature Type

#### **1. UI Component Changes**

When modifying UI components (Toolbar, Canvas, SidePanel, etc.):

**Unit Tests**:
- Test component renders without errors
- Test props are correctly typed
- Test event handlers are called
- Test conditional rendering logic

**E2E Tests**:
- Test component appears in DOM
- Test button clicks trigger correct actions
- Test styling is applied correctly
- Test responsive behavior

**Example**: After adding FilePickerButton to Canvas
```bash
# Unit test (if applicable)
npm test src/shared/components/ImageUpload

# E2E test
npm run test:e2e:headed tests/e2e/phase-1-2-refinements.spec.ts
```

#### **2. Shared Service Changes**

When modifying shared services (cardService, filterService, imageService):

**Unit Tests** (REQUIRED):
- Test all CRUD operations
- Test error handling
- Test event broadcasting
- Test edge cases (empty arrays, undefined values)
- Test cross-context synchronization

**E2E Tests**:
- Test service integration in Canvas
- Test service integration in Side Panel
- Test data persistence
- Test real-time updates

**Example**: After modifying cardService.ts
```bash
# Unit tests (MUST pass)
npm test tests/unit/shared/services/cardService.test.ts

# E2E tests
npm run test:e2e:headed tests/e2e/element-capture.spec.ts
```

#### **3. Storage/State Changes**

When modifying storage logic, hooks, or state management:

**Unit Tests**:
- Test data persistence
- Test data retrieval
- Test storage limits
- Test concurrent access

**E2E Tests**:
- Test cards persist across page reloads
- Test filters persist (if applicable)
- Test no data loss
- Test cross-context updates

**Verification**:
```bash
# Build and test storage
npm run build
npm run test:e2e:headed tests/e2e/element-capture.spec.ts

# Manual verification
# 1. Open Canvas
# 2. Create card
# 3. Refresh page
# 4. Verify card still exists
```

#### **4. Build System Changes**

When modifying Vite config, TypeScript config, or dependencies:

**Checks**:
- Verify clean build (zero warnings)
- Verify all imports resolve
- Verify extension loads in Chrome
- Verify no dynamic import warnings

**Commands**:
```bash
# Full build verification
npm run build 2>&1 | grep -i "warning\|error"
# Should output nothing if clean

# Type check
npm run type-check
# Should complete with zero errors

# Extension reload test
# 1. npm run build
# 2. Go to chrome://extensions
# 3. Click reload on extension
# 4. Open Canvas - should load without errors
```

### Test Coverage Requirements

**Shared Services**: 100% coverage (REQUIRED)
- cardService.ts ✅ 24 tests
- filterService.ts ✅ 37 tests
- imageService.ts ✅ 21 tests
- fontSizeService.ts ✅ 18 tests

**Shared Hooks**: 80%+ coverage (target)
- useCards.ts
- useFilters.ts
- useCardOperations.ts
- useImageUpload.ts

**Components**: Critical paths covered
- FilterBar ✅ (via integration tests)
- FilePickerButton ✅ (via integration tests)
- ImageUploadZone ✅ (via integration tests)

### E2E Test Organization

**Comprehensive Test Coverage** (215 total tests across 16 files):

**Core Feature Tests** (130 new tests):
```
tests/e2e/
├── card-operations.spec.ts       # 20 tests - Card CRUD operations
│   ├── Deletion (single, multiple, keyboard shortcuts)
│   ├── Duplication and positioning
│   ├── Starring/unstarring
│   ├── Tag management (add, remove, display)
│   ├── Inline editing with sanitization
│   └── Collapse/expand states
│
├── connection-editing.spec.ts    # 17 tests - Graph relationships
│   ├── Edge creation via drag-and-drop
│   ├── Connection type editing (references, generated-from, contradicts, etc.)
│   ├── Custom labels on edges
│   ├── Visual rendering
│   └── Edge deletion
│
├── stash-operations.spec.ts      # 25 tests - Side panel stash system
│   ├── Stashing cards from canvas
│   ├── Side panel display and metadata
│   ├── Restore to canvas
│   ├── Permanent deletion
│   ├── Cross-context synchronization
│   ├── Image upload to stash
│   └── Filter and search in stash
│
├── filtering.spec.ts             # 26 tests - Search and filters
│   ├── Text search (title, content, domain)
│   ├── Domain filters
│   ├── Tag filters (single and multi-select)
│   ├── Date range filters
│   ├── Combined filters
│   ├── Filter persistence across sessions
│   └── UI feedback (count, active states)
│
├── beautification.spec.ts        # 18 tests - AI content enhancement
│   ├── Triggering beautification
│   ├── Organize content mode
│   ├── Loading states and feedback
│   ├── Content transformation and sanitization
│   ├── API integration (backend/direct/mock)
│   └── Edge cases (empty, unicode, long content)
│
└── custom-buttons.spec.ts        # 24 tests - Action buttons
    ├── Button creation and configuration
    ├── Template variable substitution ({{content}}, {{title}}, {{customContext}})
    ├── Card generation from buttons
    ├── Connection creation with proper types
    ├── Default buttons (Learn More, Summarize, ELI5, Critique, Expand)
    └── Button management (edit, delete, reorder)
```

**Existing Feature Tests** (85 tests):
```
tests/e2e/
├── element-capture.spec.ts       # 15 tests - Element selector and capture
├── image-upload.spec.ts          # 5 tests  - Drag-drop image upload
├── phase-1-2-refinements.spec.ts # 19 tests - FilePickerButton, sync, etc.
├── font-size-controls.spec.ts    # 9 tests  - Font size selector and text size adjustments
├── keyboard-shortcuts.spec.ts    # 8 tests  - Keyboard shortcuts (Cmd+Shift+E, Ctrl+Shift+E, Ctrl+Shift+C)
├── context-input.spec.ts         # 8 tests  - Context input modal
├── floating-windows.spec.ts      # 7 tests  - Floating chat windows
├── card-scrolling.spec.ts        # 6 tests  - Canvas navigation
├── loading-states.spec.ts        # 4 tests  - Loading and feedback
└── extension-load.spec.ts        # 4 tests  - Extension initialization
```

**When to Add New Test Files**:
- New major feature (e.g., "fill-in-feature.spec.ts", "agent-subscriptions.spec.ts")
- New user workflow (e.g., "export-import.spec.ts")
- Complex interaction (e.g., "llm-hyperlinks.spec.ts")

**Test Infrastructure**:
- **Extension helpers** (`tests/fixtures/extension.ts`):
  - `getExtensionStorage()` - Read chrome.storage.local
  - `setExtensionStorage()` - Write chrome.storage.local
  - `clearExtensionStorage()` - Clear storage between tests
  - All helpers properly navigate to extension pages for chrome API access
- **Service worker handling**: Auto-waits for background worker before API calls
- **Data helpers**: Create test cards, connections, buttons programmatically

**Keyboard Shortcuts Testing**:
- Tests in `keyboard-shortcuts.spec.ts` send messages directly to content script
- Cannot trigger actual Chrome keyboard shortcuts via Playwright
- Simulates shortcut behavior by calling `chrome.tabs.sendMessage()` from background worker
- Tests verify content script message handlers work correctly
- Covers: Stash mode (Cmd+Shift+E), Canvas mode (Ctrl+Shift+E), Inline chat (Ctrl+Shift+C)

### Regression Prevention Workflow

**After implementing ANY feature**:

1. **Write unit tests first** (if modifying services/hooks)
   ```bash
   # Create test file
   touch tests/unit/shared/services/myService.test.ts

   # Write tests covering all functionality
   # Run tests
   npm test tests/unit/shared/services/myService.test.ts
   ```

2. **Write E2E tests** (if adding UI or user-facing features)
   ```bash
   # Add tests to existing spec or create new one
   # Run tests
   npm run test:e2e:headed tests/e2e/my-feature.spec.ts
   ```

3. **Run full test suite**
   ```bash
   npm run type-check
   npm run build
   npm test
   npm run test:e2e
   ```

4. **Manual verification** (checklist)
   - [ ] Extension loads in Chrome without errors
   - [ ] Feature works as expected
   - [ ] No console errors in Canvas
   - [ ] No console warnings in Canvas
   - [ ] Existing features still work (spot check)
   - [ ] Cross-context sync works (if applicable)

5. **Document in commit message**
   ```
   feat: Add FilePickerButton to Canvas toolbar

   - Added file picker upload alongside drag-drop
   - Used shared FilePickerButton component
   - Feature parity with Side Panel achieved

   Tests:
   - Added 15 E2E tests in phase-1-2-refinements.spec.ts
   - All tests passing
   - Zero build warnings
   - Zero TypeScript errors
   ```

### Quick Test Commands

```bash
# Fast verification (< 1 minute)
npm run type-check && npm run build

# Medium verification (< 5 minutes)
npm run type-check && npm run build && npm test

# Full verification (< 10 minutes)
npm run type-check && npm run build && npm test && npm run test:e2e

# Specific feature test
npm run test:e2e:headed tests/e2e/phase-1-2-refinements.spec.ts

# Test specific feature suites
npm run test:e2e:headed tests/e2e/card-operations.spec.ts       # Card CRUD
npm run test:e2e:headed tests/e2e/connection-editing.spec.ts    # Graph edges
npm run test:e2e:headed tests/e2e/stash-operations.spec.ts      # Stash system
npm run test:e2e:headed tests/e2e/filtering.spec.ts             # Search/filters
npm run test:e2e:headed tests/e2e/beautification.spec.ts        # AI enhancement
npm run test:e2e:headed tests/e2e/custom-buttons.spec.ts        # Action buttons
npm run test:e2e:headed tests/e2e/font-size-controls.spec.ts    # Font size controls

# Watch mode for development
npm run test:watch
```

### Detailed Test Suite Descriptions

**card-operations.spec.ts** (20 tests):
- **Deletion**: Delete single cards via button/keyboard (Delete/Backspace), delete multiple selected cards
- **Duplication**: Duplicate cards with offset positioning, preserve content/metadata
- **Starring**: Star/unstar cards, visual indicators
- **Tagging**: Display existing tags, add new tags, remove tags
- **Inline Editing**: Double-click to edit, save on blur/Cmd+Enter, cancel on Escape, XSS sanitization
- **Collapse/Expand**: Toggle card size, persist state

**connection-editing.spec.ts** (17 tests):
- **Creation**: Drag from card handle to create edges
- **Type Editing**: Change connection types (related, references, generated-from, contradicts, custom)
- **Custom Labels**: Add/edit/remove custom text labels on edges
- **Visual Rendering**: Verify edges render with correct styles for each type
- **Deletion**: Remove connections via edit modal

**stash-operations.spec.ts** (25 tests):
- **Stashing**: Stash cards via button/context menu, hide from canvas
- **Display**: Show stashed cards in side panel with metadata/tags/badges
- **Restoration**: Restore cards to canvas, remove from stash
- **Deletion**: Permanently delete stashed cards with confirmation
- **Sync**: Cross-context updates between canvas and side panel
- **Image Upload**: Upload images directly to stash via drag-drop/file picker
- **Filtering**: Search and filter stashed cards by text/domain/tags

**filtering.spec.ts** (26 tests):
- **Search**: Filter by text in title, content, or domain (case-insensitive)
- **Domain Filter**: Filter cards by domain with dropdown
- **Tag Filter**: Single and multi-tag filtering
- **Date Range**: Filter by last 7/30 days or custom date range
- **Combined Filters**: Test multiple filters working together
- **Persistence**: Filters persist across page reloads
- **UI Feedback**: Show result counts, active filter indicators, clear all button

**beautification.spec.ts** (18 tests):
- **Triggering**: Beautify button on cards, options menu
- **Organize Mode**: Restructure content with headings/lists
- **Loading States**: Loading indicators, disabled buttons during processing
- **Transformation**: Restructure unorganized content, preserve important HTML
- **Sanitization**: Remove scripts/dangerous elements from beautified content
- **API Integration**: Use Claude API when configured, fallback to mock
- **Edge Cases**: Handle empty content, very long content, unicode/special characters

**custom-buttons.spec.ts** (24 tests):
- **Creation**: Create custom buttons via settings modal
- **Configuration**: Set label, prompt template, connection type, context input option
- **Templates**: Variable substitution ({{content}}, {{title}}, {{customContext}})
- **Actions**: Trigger button actions, open context input modal when configured
- **Card Generation**: Generate new cards from button actions with proper positioning
- **Connections**: Auto-create connections with configured type
- **Default Buttons**: Test Learn More, Summarize, Critique, ELI5, Expand
- **Management**: Edit, delete, reorder buttons

**font-size-controls.spec.ts** (9 tests):
- **Canvas Selector**: Display in toolbar, three size buttons (A⁻ A A⁺), default medium
- **Side Panel Selector**: Display in header, sync with Canvas settings
- **Active State**: Visual indicators for selected size, state changes on click
- **Font Size Application**: Verify font size changes in card content (small < medium < large)
- **Persistence**: Font size selection persists across page reloads
- **Cross-Context Sync**: Changes in Canvas reflect in Side Panel and vice versa
- **Accessibility**: Tooltips on buttons, keyboard accessible (focus + Enter)

### Known Testing Limitations

**Playwright + Chrome Extensions**:
- ❌ Cannot run headless (extensions need headed mode)
- ❌ Cannot test actual file uploads (security restriction)
- ❌ Cannot simulate drag-drop events reliably
- ✅ Can test UI presence and state
- ✅ Can test storage operations
- ✅ Can test cross-context messaging

**Workarounds**:
- UI presence tests instead of interaction tests
- Storage verification instead of upload simulation
- Manual testing checklist for complex interactions

### CI/CD Integration (Future)

**Recommended GitHub Actions workflow**:
```yaml
name: Test Suite
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - run: npm run type-check
      - run: npm run build
      - run: npm test
      # E2E tests would need Xvfb for headed mode
```

## Code Style Notes

- Use `console.log` with prefixes: `[Canvas]`, `[storage]`, `[ElementSelector]`, `[cardGenerationService]`, `[ClaudeAPI]`, `[beautificationService]`, `[SidePanel]`, `[stashService]`, `[fillInService]`, `[instantExpansion]`
- Shadow DOM components need `/** @jsxImportSource @emotion/react */` pragma
- Always sanitize HTML with DOMPurify before storing (especially for `contentEditable` input, LLM responses, beautified content)
- Use `generateId()` from `@/utils/storage` for all IDs
- Error handling: Fail gracefully, log warnings for non-critical failures
- LLM integration:
  - Real API via `claudeAPIService` when API key configured
  - Falls back to mock responses in development mode
  - Always check `apiConfigService.hasAPIKey()` before API calls
- Visual consistency:
  - Side Panel cards should match CardNode styling (gradients, shadows, borders)
  - Use ReactMarkdown for beautified content rendering
  - Image cards should render `card.imageData` inline with `object-fit: contain`
  - Card type badges provide visual indicators for different card types

## Testing Strategy

**Unit tests**: Utils, sanitization, storage logic (Vitest + jsdom)
- Test setup: `tests/setup.ts`
- Globals enabled for describe/it/expect
- Coverage reports via `npm run test:coverage`

**E2E tests**: Extension loading, element capture, canvas rendering (Playwright)
- Always run `npm run build` before E2E tests (tests load from `dist/`)
- Persistent context required for Chrome extension testing

**Manual tests**: `test-scripts/*.mjs` for quick verification without test harness
- Use Node.js to run: `node test-scripts/test-canvas-direct.mjs`
- Update the local CLAUDE.md after new feature changes
- Add a regression test whenever you fix an issue.