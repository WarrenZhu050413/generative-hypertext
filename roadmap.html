<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Implementation Roadmap - Nabokov's Web</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #FAF7F2;
            --light-cream: #F5F0E8;
            --ink-black: #3E3226;
            --level-1: #8B0000;
            --level-2: #8B7355;
            --level-3: #5C4D42;
            --level-4: #A89684;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 13px;
            line-height: 1.3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        .container { max-width: 1800px; margin: 0 auto; padding: 12px; }

        h1 {
            font-size: 32px;
            font-weight: 900;
            margin: 12px 0;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
        }

        h2 {
            font-size: 22px;
            font-weight: 700;
            margin: 16px 0 8px 0;
            padding: 10px 12px;
            border-left: 5px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 17px;
            font-weight: 600;
            margin: 12px 0 6px 0;
            color: var(--level-2);
        }

        h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0 4px 0;
            color: var(--level-3);
        }

        .collapsible {
            margin: 8px 0;
            border: 1px solid rgba(139, 0, 0, 0.15);
            border-radius: 4px;
            background: white;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.06), rgba(255, 215, 0, 0.03));
            border-left: 4px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(255, 215, 0, 0.06));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 14px;
            margin-right: 10px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            padding: 0 14px;
        }

        .collapsible.open .collapsible-content {
            max-height: 12000px;
            padding: 14px;
        }

        .critical { border-left-color: var(--chinese-red) !important; border-left-width: 5px !important; }
        .phase1 { border-left-color: #FF0000 !important; }
        .phase2 { border-left-color: #FF8C00 !important; }
        .phase3 { border-left-color: #FFD700 !important; }

        .hero-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 255, 255, 0.95));
            border: 4px solid var(--chinese-gold);
            padding: 20px;
            margin: 16px 0;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
        }

        .critical-box {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), white);
            border: 3px solid var(--chinese-red);
            padding: 16px;
            margin: 12px 0;
            border-radius: 6px;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), white);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 12px 0;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.4), rgba(255, 255, 255, 0.6));
            border: 1px solid rgba(139, 0, 0, 0.15);
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        pre {
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            line-height: 1.5;
        }

        ul, ol {
            margin: 8px 0 8px 24px;
        }

        li {
            margin: 4px 0;
        }

        strong {
            color: var(--level-2);
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin: 0 4px;
            text-transform: uppercase;
        }

        .badge.week1 { background: rgba(255, 0, 0, 0.15); color: #8B0000; }
        .badge.week2 { background: rgba(255, 140, 0, 0.15); color: #FF8C00; }
        .badge.week3 { background: rgba(255, 215, 0, 0.15); color: #B8860B; }
        .badge.week4 { background: rgba(0, 128, 0, 0.15); color: #006400; }
        .badge.easy { background: rgba(0, 200, 0, 0.2); color: #006400; }
        .badge.medium { background: rgba(255, 165, 0, 0.2); color: #FF8C00; }
        .badge.hard { background: rgba(255, 0, 0, 0.2); color: #8B0000; }
        .badge.new { background: rgba(138, 43, 226, 0.2); color: #4B0082; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 12px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 8px;
            text-align: left;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
        }

        .timeline {
            position: relative;
            margin: 20px 0;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--chinese-red), var(--chinese-gold));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 16px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--chinese-gold);
            border: 2px solid var(--chinese-red);
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 24px 0;
        }

        .dependency-graph {
            background: rgba(255, 215, 0, 0.05);
            border: 2px dashed rgba(139, 0, 0, 0.3);
            padding: 16px;
            margin: 12px 0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .feature-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-done { background: #00AA00; }
        .status-progress { background: #FF8C00; }
        .status-planned { background: #999; }

        .mockup {
            border: 2px solid rgba(139, 0, 0, 0.3);
            border-radius: 6px;
            padding: 16px;
            background: white;
            margin: 12px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const headers = document.querySelectorAll('.collapsible-header');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    this.parentElement.classList.toggle('open');
                });
            });

            // Auto-open critical sections
            document.querySelectorAll('.collapsible.critical').forEach(el => {
                el.classList.add('open');
            });
        });
    </script>
</head>
<body>

<div class="container">

<h1>üó∫Ô∏è Comprehensive Implementation Roadmap</h1>

<div class="hero-box">
    <h2 style="margin-top: 0;">Vision: Card-Centric Distributed Cognition System</h2>
    <p style="font-size: 15px; line-height: 1.6; margin: 8px 0;">Transform Nabokov's Web into a flexible, extensible card-based workspace where every action generates explorable artifacts, conversations are preserved as cards, and the Chrome Side Panel provides instant access to your stashed ideas.</p>

    <div class="three-column" style="margin-top: 12px;">
        <div class="card">
            <strong>‚úÖ Completed (4 features)</strong>
            <ul style="margin-left: 16px; font-size: 12px;">
                <li>Custom note cards</li>
                <li>Card connections</li>
                <li>Inline editing</li>
                <li>Save chats as cards</li>
            </ul>
        </div>
        <div class="card">
            <strong>üöß In Progress (0)</strong>
            <ul style="margin-left: 16px; font-size: 12px;">
                <li style="color: #999;">Ready to begin...</li>
            </ul>
        </div>
        <div class="card priority">
            <strong>üìã Planned (11 features)</strong>
            <ul style="margin-left: 16px; font-size: 12px;">
                <li>Inline context input</li>
                <li>Custom button system</li>
                <li>Chrome Side Panel stash</li>
                <li>Collapsible/resizable cards</li>
                <li>+7 more...</li>
            </ul>
        </div>
    </div>
</div>

<div class="divider"></div>

<h2>üìä Executive Summary & Timeline</h2>

<table>
    <thead>
        <tr>
            <th style="width: 15%;">Phase</th>
            <th style="width: 20%;">Timeline</th>
            <th style="width: 35%;">Features</th>
            <th style="width: 15%;">Total Hours</th>
            <th style="width: 15%;">Dependencies</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Phase 1</strong><br><span class="badge week1">Week 1-2</span></td>
            <td>Days 1-14</td>
            <td>Inline Context Input, Enhanced Chat Cards, Collapsible/Resizable Cards</td>
            <td><strong>20-28h</strong></td>
            <td>None</td>
        </tr>
        <tr>
            <td><strong>Phase 2</strong><br><span class="badge week2">Week 3-4</span></td>
            <td>Days 15-28</td>
            <td>Chrome Side Panel Stash, Custom Button System, Markdown Support</td>
            <td><strong>28-38h</strong></td>
            <td>Phase 1</td>
        </tr>
        <tr>
            <td><strong>Phase 3</strong><br><span class="badge week3">Week 5-6</span></td>
            <td>Days 29-42</td>
            <td>Structured Cards, Button Config UI, Advanced Features</td>
            <td><strong>24-32h</strong></td>
            <td>Phase 2</td>
        </tr>
        <tr>
            <td><strong>Phase 4</strong><br><span class="badge week4">Week 7-8</span></td>
            <td>Days 43-56</td>
            <td>Polish, Testing, Documentation, Performance</td>
            <td><strong>16-24h</strong></td>
            <td>Phase 3</td>
        </tr>
    </tbody>
</table>

<p style="margin: 12px 0;"><strong>Total Estimated Time:</strong> 88-122 hours (~2 months at 10-15 hours/week)</p>

<div class="divider"></div>

<div class="collapsible critical open">
    <div class="collapsible-header">
        <div><span class="arrow">‚ñ∂</span>Phase 1: Foundation (Week 1-2) <span class="badge week1">20-28 HOURS</span></div>
    </div>
    <div class="collapsible-content">

<h3>Overview: Quick Wins + Critical Infrastructure</h3>

<p><strong>Goal:</strong> Implement highest-impact features that enable all future work. Focus on inline context input (enables custom actions) and card flexibility (enables better organization).</p>

<div class="timeline">
    <div class="timeline-item">
        <strong>Days 1-3:</strong> Inline Context Input System (10-12h)
    </div>
    <div class="timeline-item">
        <strong>Days 4-5:</strong> Enhanced Chat Cards (4-5h)
    </div>
    <div class="timeline-item">
        <strong>Days 6-7:</strong> Collapsible Cards (2-3h)
    </div>
    <div class="timeline-item">
        <strong>Days 8-10:</strong> Resizable Cards (4-6h)
    </div>
    <div class="timeline-item">
        <strong>Days 11-14:</strong> Testing & Refinement (4h)
    </div>
</div>

<h3>Feature 1.1: Inline Context Input System <span class="badge hard">HARD</span> <span class="badge week1">10-12h</span></h3>

<div class="card priority">
    <h4>Why This Is First</h4>
    <p>This is the foundation for ALL custom button actions. Without it, "Learn More", "Summarize", "Critique" buttons can't be personalized. It unblocks the entire custom action ecosystem.</p>
</div>

<h4>Implementation Steps</h4>

<table>
    <thead>
        <tr>
            <th>Step</th>
            <th>File</th>
            <th>Action</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td><code>src/components/ContextInputModal.tsx</code></td>
            <td>Create modal component with input field, skip/submit buttons</td>
            <td>2-3h</td>
        </tr>
        <tr>
            <td>2</td>
            <td><code>src/config/defaultButtons.ts</code></td>
            <td>Define 5 default buttons (Learn More, Summarize, Critique, ELI5, Expand)</td>
            <td>1h</td>
        </tr>
        <tr>
            <td>3</td>
            <td><code>src/services/cardGenerationService.ts</code></td>
            <td>Create service for LLM-based card generation</td>
            <td>3-4h</td>
        </tr>
        <tr>
            <td>4</td>
            <td><code>src/canvas/CardNode.tsx</code></td>
            <td>Add action buttons row to card footer</td>
            <td>2h</td>
        </tr>
        <tr>
            <td>5</td>
            <td>Testing</td>
            <td>Test modal, button clicks, card generation workflow</td>
            <td>2-3h</td>
        </tr>
    </tbody>
</table>

<h4>Code: ContextInputModal Component</h4>

<pre><code>// src/components/ContextInputModal.tsx
/** @jsxImportSource @emotion/react */
import { css } from '@emotion/react';
import React, { useState, useRef, useEffect } from 'react';

export interface ContextInputModalProps {
  buttonLabel: string;
  buttonIcon: string;
  onSubmit: (context: string) => void;
  onCancel: () => void;
}

export const ContextInputModal: React.FC&lt;ContextInputModalProps&gt; = ({
  buttonLabel,
  buttonIcon,
  onSubmit,
  onCancel,
}) => {
  const [context, setContext] = useState('');
  const inputRef = useRef&lt;HTMLInputElement&gt;(null);

  useEffect(() => {
    inputRef.current?.focus();
  }, []);

  const handleSubmit = () => {
    onSubmit(context.trim());
  };

  const handleSkip = () => {
    onSubmit(''); // Empty = use default prompt
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') handleSubmit();
    if (e.key === 'Escape') onCancel();
  };

  return (
    &lt;div css={overlayStyles} onClick={onCancel}&gt;
      &lt;div css={modalStyles} onClick={e => e.stopPropagation()}&gt;
        &lt;h3 css={titleStyles}&gt;
          {buttonIcon} {buttonLabel}
        &lt;/h3&gt;
        &lt;p css={descStyles}&gt;
          Add optional context to refine your request:
        &lt;/p&gt;
        &lt;input
          ref={inputRef}
          type="text"
          value={context}
          onChange={e => setContext(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="e.g., 'the historical context', 'technical details'"
          css={inputStyles}
        /&gt;
        &lt;div css={buttonRowStyles}&gt;
          &lt;button onClick={handleSkip} css={skipButtonStyles}&gt;Skip&lt;/button&gt;
          &lt;button onClick={handleSubmit} css={submitButtonStyles}&gt;Generate ‚Üí&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
};

// Styles omitted for brevity - see focused plan
</code></pre>

<h4>Code: Card Generation Service</h4>

<pre><code>// src/services/cardGenerationService.ts
import type { Card, CardButton } from '@/types/card';
import { generateId, saveCard } from '@/utils/storage';
import { addConnection } from '@/utils/connectionStorage';
import { chatService } from './chatService';

export class CardGenerationService {
  async generateCardFromButton(
    sourceCard: Card,
    button: CardButton,
    customContext?: string
  ): Promise&lt;Card&gt; {
    // Build prompt from template
    const prompt = this.buildPrompt(button.prompt, {
      content: sourceCard.content,
      title: sourceCard.metadata.title,
      customContext: customContext || '',
    });

    // Call LLM (reuse chatService)
    const messages = await chatService.sendMessageAndWait(
      sourceCard.id,
      prompt,
      sourceCard.content
    );

    const response = messages[messages.length - 1].content;

    // Create new card
    const newCard: Card = {
      id: generateId(),
      content: response,
      contentFormat: 'html',
      cardType: 'generated',
      parentCardId: sourceCard.id,
      metadata: {
        title: `${button.label}: ${sourceCard.metadata.title}`,
        domain: 'ai-generated',
        favicon: button.icon,
        url: '',
        timestamp: Date.now(),
      },
      position: this.calculatePosition(sourceCard),
      size: { width: 400, height: 300 },
      starred: false,
      tags: ['ai-generated', button.label.toLowerCase()],
      createdAt: Date.now(),
      updatedAt: Date.now(),
      conversation: messages,
      chatEnabled: true,
      visualState: {
        collapsed: false,
        size: 'medium',
        renderMode: 'full',
      },
      stashed: false,
      generationContext: {
        sourceMessageId: messages[0].id,
        userPrompt: prompt,
        timestamp: Date.now(),
      },
    };

    // Save card
    await saveCard(newCard);

    // Create connection
    await addConnection({
      id: generateId(),
      source: sourceCard.id,
      target: newCard.id,
      type: button.connectionType,
      label: customContext ? `${button.label}: ${customContext}` : button.label,
      metadata: {
        createdAt: Date.now(),
        createdBy: 'user',
      },
    });

    return newCard;
  }

  private buildPrompt(template: string, context: any): string {
    let result = template;
    Object.entries(context).forEach(([key, value]) => {
      result = result.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), String(value));
    });
    return result;
  }

  private calculatePosition(sourceCard: Card): { x: number; y: number } {
    return {
      x: (sourceCard.position?.x || 0) + 380,
      y: sourceCard.position?.y || 0,
    };
  }
}

export const cardGenerationService = new CardGenerationService();
</code></pre>

<h3>Feature 1.2: Enhanced Chat Cards <span class="badge easy">EASY</span> <span class="badge week1">4-5h</span></h3>

<h4>Changes to FloatingWindow.tsx</h4>

<pre><code>// Make save button more prominent
&lt;button
  onClick={handleSaveConversation}
  css={saveConversationButtonStyles}
  disabled={!hasMessages}
  style={{
    background: 'linear-gradient(135deg, #FFD700, #FFA500)',
    color: '#000',
    fontSize: '14px',
    padding: '6px 16px',
    fontWeight: 700,
    marginRight: '8px',
  }}
&gt;
  üíæ Save Chat
&lt;/button&gt;

// Add auto-save checkbox
const [autoSaveOnClose, setAutoSaveOnClose] = useState(false);

&lt;label style={{ fontSize: '11px', display: 'flex', alignItems: 'center' }}&gt;
  &lt;input
    type="checkbox"
    checked={autoSaveOnClose}
    onChange={e => setAutoSaveOnClose(e.target.checked)}
  /&gt;
  Auto-save on close
&lt;/label&gt;
</code></pre>

<h4>Add "Continue Chat" Button to Generated Cards</h4>

<pre><code>// In CardNode.tsx - for cards with cardType === 'generated'
{card.cardType === 'generated' && card.conversation && (
  &lt;button
    onClick={() => windowManager.openWindow(card)}
    style={styles.continueChatButton}
  &gt;
    üí¨ Continue Chat
  &lt;/button&gt;
)}
</code></pre>

<h3>Feature 1.3: Collapsible Cards <span class="badge easy">EASY</span> <span class="badge week1">2-3h</span></h3>

<h4>Add to Card Interface</h4>

<pre><code>// Extend Card type in src/types/card.ts
interface Card {
  // ... existing fields
  visualState: {
    collapsed: boolean;
    size: 'small' | 'medium' | 'large';
    renderMode: 'preview' | 'full';
  };
}</code></pre>

<h4>Update CardNode.tsx</h4>

<pre><code>const [collapsed, setCollapsed] = useState(card.visualState?.collapsed || false);

const handleToggleCollapse = async () => {
  const newCollapsed = !collapsed;
  setCollapsed(newCollapsed);

  // Save state
  await saveCard({
    ...card,
    visualState: { ...card.visualState, collapsed: newCollapsed },
  });
};

return (
  &lt;div style={{ ...styles.card, height: collapsed ? '60px' : 'auto' }}&gt;
    &lt;div style={styles.header}&gt;
      &lt;button
        onClick={handleToggleCollapse}
        style={styles.collapseButton}
        title={collapsed ? 'Expand' : 'Collapse'}
      &gt;
        {collapsed ? '‚ñ∂' : '‚ñº'}
      &lt;/button&gt;
      {/* ... rest of header ... */}
    &lt;/div&gt;

    {!collapsed && (
      &lt;&gt;
        {/* Title, content, footer */}
      &lt;/&gt;
    )}
  &lt;/div&gt;
);
</code></pre>

<h3>Feature 1.4: Resizable Cards <span class="badge medium">MEDIUM</span> <span class="badge week1">4-6h</span></h3>

<h4>Size Presets</h4>

<pre><code>// src/config/cardSizes.ts
export const CARD_SIZES = {
  small: { width: 240, height: 180 },
  medium: { width: 320, height: 240 },
  large: { width: 480, height: 360 },
  xlarge: { width: 640, height: 480 },
};

// In CardNode.tsx
const handleResize = async (size: 'small' | 'medium' | 'large' | 'xlarge') => {
  const newSize = CARD_SIZES[size];

  await saveCard({
    ...card,
    size: newSize,
    visualState: { ...card.visualState, size },
  });

  // Force re-render
  window.location.reload();
};

// Size control buttons in header
&lt;div style={styles.sizeControls}&gt;
  &lt;button onClick={() => handleResize('small')} title="Small"&gt;S&lt;/button&gt;
  &lt;button onClick={() => handleResize('medium')} title="Medium"&gt;M&lt;/button&gt;
  &lt;button onClick={() => handleResize('large')} title="Large"&gt;L&lt;/button&gt;
  &lt;button onClick={() => handleResize('xlarge')} title="Extra Large"&gt;XL&lt;/button&gt;
&lt;/div&gt;
</code></pre>

    </div>
</div>

<div class="collapsible phase2">
    <div class="collapsible-header">
        <div><span class="arrow">‚ñ∂</span>Phase 2: Chrome Side Panel & Custom Actions (Week 3-4) <span class="badge week2">28-38 HOURS</span> <span class="badge new">NEW!</span></div>
    </div>
    <div class="collapsible-content">

<h3>Overview: Browser Integration + Extensibility</h3>

<p><strong>Goal:</strong> Add Chrome Side Panel for stashing (always-accessible UI) and complete the custom button system for user-defined actions.</p>

<div class="critical-box">
    <h4>üÜï Chrome Side Panel for Stash</h4>
    <p><strong>Why This Is Game-Changing:</strong> Chrome's native Side Panel API provides a persistent, always-accessible UI that doesn't clutter the canvas. Perfect for quick access to stashed cards, similar to browser bookmarks or reading list.</p>
</div>

<h3>Feature 2.1: Chrome Side Panel Stash <span class="badge new">NEW!</span> <span class="badge medium">MEDIUM</span> <span class="badge week2">8-12h</span></h3>

<h4>Step 1: Update Manifest (10 minutes)</h4>

<pre><code>// src/manifest.json
{
  "manifest_version": 3,
  "name": "Nabokov's Web Clipper",
  // ... existing fields

  "side_panel": {
    "default_path": "src/sidepanel/index.html"
  },

  "permissions": [
    "sidePanel",  // NEW: Enable side panel
    "storage",
    "activeTab",
    // ... existing permissions
  ]
}</code></pre>

<h4>Step 2: Create Side Panel HTML (1-2 hours)</h4>

<pre><code>&lt;!-- src/sidepanel/index.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Nabokov Stash&lt;/title&gt;
  &lt;style&gt;
    body {
      margin: 0;
      padding: 8px;
      font-family: system-ui, sans-serif;
      background: #FAF7F2;
      font-size: 13px;
    }
    .stash-header {
      padding: 12px;
      background: linear-gradient(135deg, #8B0000, #CD5C5C);
      color: white;
      border-radius: 6px;
      margin-bottom: 12px;
    }
    .stash-card {
      background: white;
      border: 1px solid rgba(139, 0, 0, 0.2);
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .stash-card:hover {
      border-color: #FFD700;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="stash-header"&gt;
    &lt;h2 style="margin: 0; font-size: 16px;"&gt;üì¶ Stashed Cards&lt;/h2&gt;
    &lt;p style="margin: 4px 0 0 0; font-size: 11px; opacity: 0.9;"&gt;
      Click to restore, right-click for options
    &lt;/p&gt;
  &lt;/div&gt;
  &lt;div id="stash-list"&gt;&lt;/div&gt;
  &lt;script src="sidepanel.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

<h4>Step 3: Side Panel Logic (4-6 hours)</h4>

<pre><code>// src/sidepanel/sidepanel.ts
import type { Card } from '@/types/card';

const CARDS_KEY = 'cards';

async function loadStashedCards(): Promise&lt;Card[]&gt; {
  const result = await chrome.storage.local.get(CARDS_KEY);
  const cards: Card[] = result[CARDS_KEY] || [];
  return cards.filter(c => c.stashed);
}

async function renderStashList() {
  const stashedCards = await loadStashedCards();
  const container = document.getElementById('stash-list');

  if (!container) return;

  if (stashedCards.length === 0) {
    container.innerHTML = `
      &lt;div style="text-align: center; padding: 40px; color: #999;"&gt;
        &lt;p&gt;No stashed cards&lt;/p&gt;
        &lt;p style="font-size: 11px;"&gt;Click the stash button (üì¶) on any card to add it here&lt;/p&gt;
      &lt;/div&gt;
    `;
    return;
  }

  container.innerHTML = stashedCards.map(card => `
    &lt;div class="stash-card" data-card-id="${card.id}"&gt;
      &lt;div style="display: flex; justify-content: space-between; align-items: start;"&gt;
        &lt;div style="flex: 1; min-width: 0;"&gt;
          &lt;div style="font-weight: 600; font-size: 13px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"&gt;
            ${card.metadata.favicon || 'üìÑ'} ${card.metadata.title}
          &lt;/div&gt;
          &lt;div style="font-size: 11px; color: #666;"&gt;
            Stashed ${new Date(card.stashMetadata?.stashedAt || 0).toLocaleDateString()}
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div style="display: flex; gap: 4px;"&gt;
          &lt;button class="restore-btn" data-card-id="${card.id}" title="Restore to canvas"&gt;
            ‚Ü©Ô∏è
          &lt;/button&gt;
          &lt;button class="delete-btn" data-card-id="${card.id}" title="Delete permanently"&gt;
            üóëÔ∏è
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  `).join('');

  // Add event listeners
  container.querySelectorAll('.restore-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const cardId = (e.target as HTMLElement).getAttribute('data-card-id');
      if (cardId) await restoreCard(cardId);
    });
  });

  container.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const cardId = (e.target as HTMLElement).getAttribute('data-card-id');
      if (cardId && confirm('Permanently delete this card?')) {
        await deleteCard(cardId);
      }
    });
  });

  // Click card to open canvas
  container.querySelectorAll('.stash-card').forEach(card => {
    card.addEventListener('click', () => {
      const cardId = card.getAttribute('data-card-id');
      openCanvas(cardId);
    });
  });
}

async function restoreCard(cardId: string) {
  const result = await chrome.storage.local.get(CARDS_KEY);
  const cards: Card[] = result[CARDS_KEY] || [];

  const updatedCards = cards.map(c =>
    c.id === cardId
      ? { ...c, stashed: false, stashMetadata: undefined }
      : c
  );

  await chrome.storage.local.set({ [CARDS_KEY]: updatedCards });
  await renderStashList();
}

async function deleteCard(cardId: string) {
  const result = await chrome.storage.local.get(CARDS_KEY);
  const cards: Card[] = result[CARDS_KEY] || [];

  const updatedCards = cards.filter(c => c.id !== cardId);
  await chrome.storage.local.set({ [CARDS_KEY]: updatedCards });
  await renderStashList();
}

function openCanvas(cardId?: string) {
  const canvasUrl = chrome.runtime.getURL('src/canvas/index.html');
  const url = cardId ? `${canvasUrl}?focus=${cardId}` : canvasUrl;
  chrome.tabs.create({ url });
}

// Initialize
document.addEventListener('DOMContentLoaded', renderStashList);

// Listen for storage changes
chrome.storage.onChanged.addListener((changes, area) => {
  if (area === 'local' && changes[CARDS_KEY]) {
    renderStashList();
  }
});
</code></pre>

<h4>Step 4: Add Stash Button to Cards (2 hours)</h4>

<pre><code>// In CardNode.tsx header
&lt;button
  onClick={handleStash}
  style={styles.stashButton}
  title="Stash card (accessible via side panel)"
&gt;
  üì¶
&lt;/button&gt;

const handleStash = async () => {
  await saveCard({
    ...card,
    stashed: true,
    stashMetadata: {
      stashedAt: Date.now(),
      stashReason: '',
      originalPosition: card.position,
    },
  });

  // Refresh canvas
  window.location.reload();
};
</code></pre>

<h4>Step 5: Enable Side Panel via Extension Icon (1 hour)</h4>

<pre><code>// In background/index.ts
chrome.sidePanel
  .setPanelBehavior({ openPanelOnActionClick: true })
  .catch((error) => console.error(error));

// Or programmatic open
chrome.action.onClicked.addListener(async (tab) => {
  await chrome.sidePanel.open({ windowId: tab.windowId });
});
</code></pre>

<h3>Feature 2.2: Custom Button System <span class="badge hard">HARD</span> <span class="badge week2">12-16h</span></h3>

<h4>Button Configuration Storage</h4>

<pre><code>// src/types/card.ts - Add to Card interface
interface Card {
  // ... existing
  buttons?: CardButton[]; // Per-card custom buttons
}

// src/config/buttonStorage.ts
const BUTTON_CONFIG_KEY = 'global_button_configs';

export async function loadGlobalButtons(): Promise&lt;CardButton[]&gt; {
  const result = await chrome.storage.local.get(BUTTON_CONFIG_KEY);
  return result[BUTTON_CONFIG_KEY] || DEFAULT_BUTTONS;
}

export async function saveGlobalButtons(buttons: CardButton[]): Promise&lt;void&gt; {
  await chrome.storage.local.set({ [BUTTON_CONFIG_KEY]: buttons });
}

export async function addCustomButton(button: Omit&lt;CardButton, 'id'&gt;): Promise&lt;CardButton&gt; {
  const buttons = await loadGlobalButtons();
  const newButton: CardButton = {
    ...button,
    id: `custom-${Date.now()}`,
  };
  await saveGlobalButtons([...buttons, newButton]);
  return newButton;
}
</code></pre>

<h4>Button Management UI in Settings</h4>

<pre><code>// Add to SettingsPanel.tsx
const [buttons, setButtons] = useState&lt;CardButton[]&gt;([]);

useEffect(() => {
  loadGlobalButtons().then(setButtons);
}, []);

&lt;div className="button-management-section"&gt;
  &lt;h3&gt;Card Action Buttons&lt;/h3&gt;
  &lt;p style={{ fontSize: '12px', color: '#666' }}&gt;
    Customize buttons that appear on all cards
  &lt;/p&gt;

  {buttons.map((button, index) => (
    &lt;div key={button.id} className="button-config-row"&gt;
      &lt;input
        type="checkbox"
        checked={button.enabled !== false}
        onChange={e => updateButton(index, { enabled: e.target.checked })}
      /&gt;
      &lt;input
        type="text"
        value={button.icon}
        placeholder="Icon"
        style={{ width: '40px' }}
      /&gt;
      &lt;input
        type="text"
        value={button.label}
        onChange={e => updateButton(index, { label: e.target.value })}
        style={{ flex: 1 }}
      /&gt;
      &lt;button onClick={() => editPrompt(button)}&gt;Edit Prompt&lt;/button&gt;
      &lt;button onClick={() => deleteButton(index)}&gt;üóëÔ∏è&lt;/button&gt;
    &lt;/div&gt;
  ))}

  &lt;button onClick={addNewButton}&gt;+ Add Custom Button&lt;/button&gt;
&lt;/div&gt;
</code></pre>

<h3>Feature 2.3: Markdown Support <span class="badge medium">MEDIUM</span> <span class="badge week2">8-10h</span></h3>

<h4>Install Dependencies</h4>

<pre><code>npm install marked dompurify
npm install --save-dev @types/marked</code></pre>

<h4>Render Markdown Content</h4>

<pre><code>// src/utils/contentRenderer.tsx
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';
import type { Card } from '@/types/card';

export function renderCardContent(card: Card): string {
  let html = card.content;

  if (card.contentFormat === 'markdown') {
    html = marked.parse(card.content, {
      breaks: true,
      gfm: true,
    }) as string;
  }

  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: [
      'p', 'br', 'strong', 'em', 'u', 'a', 'h1', 'h2', 'h3', 'h4',
      'ul', 'ol', 'li', 'code', 'pre', 'blockquote', 'img',
    ],
    ALLOWED_ATTR: ['href', 'target', 'rel', 'class', 'src', 'alt'],
  });
}

// In CardNode.tsx
const sanitizedContent = renderCardContent(card);

&lt;div
  dangerouslySetInnerHTML={{ __html: sanitizedContent }}
  style={styles.content}
/&gt;
</code></pre>

    </div>
</div>

<div class="collapsible phase3">
    <div class="collapsible-header">
        <div><span class="arrow">‚ñ∂</span>Phase 3: Advanced Features (Week 5-6) <span class="badge week3">24-32 HOURS</span></div>
    </div>
    <div class="collapsible-content">

<h3>Feature 3.1: Structured Card Components <span class="badge medium">MEDIUM</span> <span class="badge week3">12-16h</span></h3>

<p>Allow cards to have multiple collapsible sections, header/footer, metadata panels.</p>

<h3>Feature 3.2: Prompt Template Editor <span class="badge medium">MEDIUM</span> <span class="badge week3">8-12h</span></h3>

<p>Rich text editor for creating/editing button prompts with template variable support.</p>

<h3>Feature 3.3: Card Templates <span class="badge easy">EASY</span> <span class="badge week3">4-6h</span></h3>

<p>Predefined card structures (e.g., "Research Note", "Meeting Summary", "Code Review").</p>

    </div>
</div>

<div class="collapsible">
    <div class="collapsible-header">
        <div><span class="arrow">‚ñ∂</span>Phase 4: Polish & Optimization (Week 7-8) <span class="badge week4">16-24 HOURS</span></div>
    </div>
    <div class="collapsible-content">

<h3>Testing Strategy</h3>

<ul>
    <li><strong>Unit tests:</strong> Button config, card generation, stash operations</li>
    <li><strong>E2E tests:</strong> Complete workflows (create note ‚Üí add context ‚Üí generate ‚Üí stash)</li>
    <li><strong>Performance:</strong> Loading 1000+ cards, markdown rendering speed</li>
    <li><strong>Browser compatibility:</strong> Chrome Side Panel across Chrome versions</li>
</ul>

<h3>Documentation</h3>

<ul>
    <li>User guide for custom buttons</li>
    <li>Button template library</li>
    <li>Developer API docs</li>
    <li>Video tutorials</li>
</ul>

<h3>Performance Optimization</h3>

<ul>
    <li>Lazy load card content</li>
    <li>Virtual scrolling for large canvases</li>
    <li>Debounce save operations</li>
    <li>Cache markdown renders</li>
</ul>

    </div>
</div>

<div class="divider"></div>

<h2>üì¶ Feature Dependency Graph</h2>

<div class="dependency-graph">
<pre>
Phase 1 Foundation
‚îú‚îÄ Inline Context Input ‚Üê <strong>BLOCKS</strong> Custom Buttons
‚îÇ  ‚îî‚îÄ ContextInputModal
‚îÇ  ‚îî‚îÄ cardGenerationService
‚îÇ
‚îú‚îÄ Enhanced Chat Cards ‚Üê Independent
‚îÇ
‚îú‚îÄ Collapsible Cards ‚Üê Independent
‚îÇ
‚îî‚îÄ Resizable Cards ‚Üê Independent

Phase 2 Integration
‚îú‚îÄ Chrome Side Panel ‚Üê Requires: Collapsible (for preview)
‚îÇ  ‚îî‚îÄ manifest.json updates
‚îÇ  ‚îî‚îÄ sidepanel/ directory
‚îÇ
‚îú‚îÄ Custom Button System ‚Üê Requires: Inline Context Input
‚îÇ  ‚îî‚îÄ Button config storage
‚îÇ  ‚îî‚îÄ Settings UI
‚îÇ
‚îî‚îÄ Markdown Support ‚Üê Independent

Phase 3 Advanced
‚îú‚îÄ Structured Cards ‚Üê Requires: Collapsible, Markdown
‚îÇ
‚îú‚îÄ Prompt Editor ‚Üê Requires: Custom Button System
‚îÇ
‚îî‚îÄ Card Templates ‚Üê Requires: Structured Cards

Phase 4 Polish
‚îî‚îÄ Testing, Docs, Performance ‚Üê Requires: All above
</pre>
</div>

<div class="divider"></div>

<h2>üéØ Quick Start Guide</h2>

<div class="hero-box">
    <h3 style="margin-top: 0;">Recommended Starting Point</h3>
    <ol style="font-size: 14px; line-height: 1.8;">
        <li><strong>Day 1:</strong> Create <code>ContextInputModal.tsx</code> - The foundation component</li>
        <li><strong>Day 2:</strong> Implement <code>cardGenerationService.ts</code> - LLM integration</li>
        <li><strong>Day 3:</strong> Add action buttons to <code>CardNode.tsx</code> - Wire it all together</li>
        <li><strong>Day 4:</strong> Test the "Learn More" workflow end-to-end</li>
        <li><strong>Day 5-7:</strong> Quick wins (collapsible, resizable, enhanced chat)</li>
        <li><strong>Week 2:</strong> Tackle Chrome Side Panel - game-changing feature</li>
    </ol>
</div>

<div class="divider"></div>

<h2>üìã Implementation Checklist</h2>

<table>
    <thead>
        <tr>
            <th style="width: 5%;">‚úì</th>
            <th style="width: 40%;">Feature</th>
            <th style="width: 15%;">Phase</th>
            <th style="width: 10%;">Hours</th>
            <th style="width: 15%;">Priority</th>
            <th style="width: 15%;">Status</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>‚òê</td>
            <td><strong>Inline Context Input System</strong></td>
            <td>Phase 1</td>
            <td>10-12h</td>
            <td><span class="badge week1">CRITICAL</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Enhanced Chat Cards (save button, auto-save, continue)</td>
            <td>Phase 1</td>
            <td>4-5h</td>
            <td><span class="badge easy">EASY</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Collapsible Cards</td>
            <td>Phase 1</td>
            <td>2-3h</td>
            <td><span class="badge easy">EASY</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Resizable Cards (S/M/L/XL presets)</td>
            <td>Phase 1</td>
            <td>4-6h</td>
            <td><span class="badge medium">MEDIUM</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td><strong>Chrome Side Panel Stash</strong></td>
            <td>Phase 2</td>
            <td>8-12h</td>
            <td><span class="badge new">NEW!</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Custom Button System</td>
            <td>Phase 2</td>
            <td>12-16h</td>
            <td><span class="badge hard">HARD</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Markdown Support</td>
            <td>Phase 2</td>
            <td>8-10h</td>
            <td><span class="badge medium">MEDIUM</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Structured Card Components</td>
            <td>Phase 3</td>
            <td>12-16h</td>
            <td><span class="badge medium">MEDIUM</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Prompt Template Editor</td>
            <td>Phase 3</td>
            <td>8-12h</td>
            <td><span class="badge medium">MEDIUM</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Card Templates</td>
            <td>Phase 3</td>
            <td>4-6h</td>
            <td><span class="badge easy">EASY</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
        <tr>
            <td>‚òê</td>
            <td>Testing & Documentation</td>
            <td>Phase 4</td>
            <td>16-24h</td>
            <td><span class="badge week4">FINAL</span></td>
            <td><span class="feature-status status-planned"></span> Planned</td>
        </tr>
    </tbody>
</table>

<div class="divider"></div>

<h2>üöÄ Ready to Begin?</h2>

<div class="critical-box">
    <h3>First Task: Create ContextInputModal</h3>
    <p><strong>File:</strong> <code>src/components/ContextInputModal.tsx</code></p>
    <p><strong>Time:</strong> 2-3 hours</p>
    <p><strong>Why:</strong> This component is the foundation for all custom button actions. Get this right, and everything else falls into place.</p>
    <p><strong>Test:</strong> Create a simple "Learn More" button that opens the modal, enter context, see it log to console</p>
</div>

</div>

</body>
</html>
