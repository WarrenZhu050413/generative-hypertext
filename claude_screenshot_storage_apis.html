<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenshot Storage & Capture APIs - Nabokov Web Clipper</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --paper-beige: #F5F5DC;
            --light-cream: #FFFAF0;
            --ink-black: #2C2C2C;
            --level-1: #8B0000;
            --level-2: #CD5C5C;
            --level-3: #B8860B;
            --level-4: #666;
        }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 0;
            width: 100vw;
            max-width: 100%;
            line-height: 1.2;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro', Roboto, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            padding: 12px;
            margin: 0;
        }

        h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 4px 0;
            padding: 6px 4px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px 0;
            padding: 4px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.03);
            color: var(--level-1);
        }

        h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0 2px 8px;
            color: var(--level-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h4 {
            font-size: 12px;
            font-weight: 500;
            margin: 2px 0 1px 16px;
            color: var(--level-3);
        }

        .important-always-visible {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 8px;
            margin: 8px 0;
            border-radius: 3px;
        }

        .important-always-visible h2 {
            color: var(--chinese-red);
            margin-top: 0;
        }

        .primary-section {
            border: 2px solid var(--chinese-red);
            background: white;
            margin: 6px 0;
            padding: 6px;
        }

        .secondary-section {
            border-left: 3px solid var(--chinese-gold);
            background: rgba(255, 215, 0, 0.05);
            margin: 4px 0 4px 8px;
            padding: 4px;
        }

        .tertiary-section {
            margin-left: 16px;
            padding-left: 8px;
            border-left: 1px dashed #ccc;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .dense-list {
            list-style: none;
            padding: 0;
            margin-left: 8px;
        }

        .dense-list li {
            padding: 2px 0 2px 12px;
            border-left: 2px solid transparent;
            position: relative;
        }

        .dense-list li:before {
            content: "▸";
            position: absolute;
            left: 0;
            color: var(--chinese-red);
            font-size: 10px;
        }

        .dense-list li strong {
            color: var(--level-2);
            font-weight: 600;
        }

        pre, code {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            border: 1px solid rgba(139, 0, 0, 0.1);
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 12px;
            line-height: 1.3;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
        }

        pre {
            padding: 6px 8px;
            margin: 4px 0;
            overflow-x: auto;
            border-radius: 2px;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 8px 0;
        }

        .full-width {
            grid-column: span 2;
        }

        .collapsible {
            margin: 4px 0;
            width: 100%;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 3px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 10px;
            margin-right: 6px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 8px;
            margin-left: 12px;
        }

        .collapsible.open .collapsible-content {
            max-height: 5000px;
            padding: 8px;
        }

        .collapsible.critical .collapsible-header {
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.08);
            font-weight: 700;
        }

        .collapsible.secondary .collapsible-header {
            border-left: 2px solid #999;
            background: rgba(0, 0, 0, 0.02);
            font-size: 13px;
        }

        .indent-1 { margin-left: 12px; }
        .indent-2 { margin-left: 24px; }
        .indent-3 { margin-left: 36px; }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 12px;
        }

        th, td {
            border: 1px solid rgba(139, 0, 0, 0.2);
            padding: 4px 6px;
            text-align: left;
            line-height: 1.2;
        }

        th {
            background: rgba(139, 0, 0, 0.1);
            font-weight: 600;
        }

        .warning {
            background: rgba(255, 165, 0, 0.1);
            border-left: 3px solid orange;
            padding: 4px 8px;
            margin: 4px 0;
        }

        .success {
            background: rgba(0, 128, 0, 0.05);
            border-left: 3px solid green;
            padding: 4px 8px;
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📸 Screenshot Storage & Capture APIs</h1>

        <div class="important-always-visible">
            <h2>Quick Answer</h2>
            <ul class="dense-list">
                <li><strong>Storage Location:</strong> IndexedDB (<code>'nabokov-clipper'</code> database, <code>'screenshots'</code> store)</li>
                <li><strong>Primary API:</strong> <code>chrome.tabs.captureVisibleTab()</code></li>
                <li><strong>Optional & Non-Blocking:</strong> Screenshot capture fails silently if CORS-blocked</li>
                <li><strong>Reference:</strong> Cards store <code>screenshotId</code> that maps to IndexedDB entry</li>
            </ul>
        </div>

        <div class="divider"></div>

        <h2>1. Storage Architecture</h2>

        <div class="two-column-layout">
            <div class="card priority">
                <h3>IndexedDB (Screenshots)</h3>
                <ul class="dense-list">
                    <li><strong>Database:</strong> <code>'nabokov-clipper'</code></li>
                    <li><strong>Store:</strong> <code>'screenshots'</code></li>
                    <li><strong>Key:</strong> <code>screenshotId</code> (string)</li>
                    <li><strong>Limit:</strong> Much larger than chrome.storage (browser-dependent, typically 50MB+)</li>
                    <li><strong>Reason:</strong> Binary data (compressed images) too large for chrome.storage</li>
                </ul>
            </div>

            <div class="card">
                <h3>chrome.storage.local (Metadata)</h3>
                <ul class="dense-list">
                    <li><strong>Key:</strong> <code>'cards'</code> → <code>Card[]</code></li>
                    <li><strong>Card.screenshotId:</strong> Reference to IndexedDB entry</li>
                    <li><strong>Limit:</strong> ~5MB after JSON serialization</li>
                    <li><strong>Stores:</strong> HTML content, metadata, positions, tags</li>
                </ul>
            </div>
        </div>

        <div class="secondary-section">
            <h4>Why Two Storage Systems?</h4>
            <p class="indent-1"><strong>chrome.storage.local</strong> has a ~5MB limit and is optimized for JSON. Binary image data would quickly exceed this limit.</p>
            <p class="indent-1"><strong>IndexedDB</strong> is designed for larger data and can store binary blobs efficiently. Browsers typically allow 50MB+ per origin.</p>
        </div>

        <div class="divider"></div>

        <h2>2. Screenshot Capture Flow</h2>

        <div class="primary-section">
            <h3>Complete Capture Pipeline</h3>
            <ol style="margin-left: 24px; line-height: 1.4;">
                <li><strong>Trigger:</strong> User presses <code>Cmd+Shift+E</code></li>
                <li><strong>Background Worker:</strong> Sends <code>ACTIVATE_SELECTOR</code> message to content script</li>
                <li><strong>Content Script:</strong> Mounts <code>ElementSelector</code> component in Shadow DOM</li>
                <li><strong>User Interaction:</strong> User clicks target element</li>
                <li><strong>Capture Process:</strong>
                    <ul class="dense-list indent-1">
                        <li>Extract HTML + sanitize with DOMPurify</li>
                        <li>Capture screenshot via background worker (<code>chrome.tabs.captureVisibleTab()</code>)</li>
                        <li>Compress screenshot (canvas-based compression)</li>
                        <li>Generate unique ID (timestamp + random)</li>
                        <li>Save Card to chrome.storage.local</li>
                        <li>Save Screenshot to IndexedDB</li>
                    </ul>
                </li>
                <li><strong>Result:</strong> Canvas auto-refreshes to show new card</li>
            </ol>
        </div>

        <div class="collapsible critical">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span><strong>Critical Implementation Detail: Optional Screenshot</strong></span>
            </div>
            <div class="collapsible-content">
                <div class="warning">
                    <strong>⚠️ Screenshot capture is OPTIONAL and NON-BLOCKING</strong>
                    <p style="margin-top: 4px;">Screenshot can fail due to CORS restrictions, canvas tainting, or missing permissions. The system continues without screenshot.</p>
                </div>

                <h4>Proper Implementation Pattern</h4>
                <pre><code>let compressionResult = null;
try {
  const screenshot = await captureElementScreenshot(element);
  compressionResult = await compressScreenshot(screenshot);
} catch (error) {
  console.warn('Screenshot failed (non-blocking):', error);
  // Continue without screenshot - DO NOT throw
}

const card: Card = {
  // ... other properties
  screenshotId: compressionResult ? screenshotId : undefined,
};</code></pre>

                <h4>Common Failure Scenarios</h4>
                <ul class="dense-list">
                    <li><strong>CORS Restrictions:</strong> Cross-origin images block canvas export</li>
                    <li><strong>Canvas Tainting:</strong> "Tainted canvases may not be exported" error</li>
                    <li><strong>Missing Permissions:</strong> activeTab permission not granted</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>3. Chrome Extension APIs Used</h2>

        <div class="card priority full-width">
            <h3>Primary API: chrome.tabs.captureVisibleTab()</h3>
            <p><strong>Location:</strong> Background Service Worker (<code>src/background/index.ts</code>)</p>
            <p><strong>Purpose:</strong> Captures visible area of the currently active tab</p>

            <h4>Signature</h4>
            <pre><code>chrome.tabs.captureVisibleTab(
  windowId?: number,
  options?: ImageDetails,
  callback?: (dataUrl: string) => void
): Promise&lt;string&gt;</code></pre>

            <h4>Usage in Nabokov</h4>
            <pre><code>// In background worker
const dataUrl = await chrome.tabs.captureVisibleTab(null, {
  format: 'png'  // or 'jpeg'
});
// Returns data URL: "data:image/png;base64,..."</code></pre>
        </div>

        <div class="two-column-layout">
            <div class="collapsible secondary">
                <div class="collapsible-header">
                    <span><span class="arrow">▶</span>captureElementScreenshot()</span>
                </div>
                <div class="collapsible-content">
                    <p><strong>Type:</strong> Custom utility function</p>
                    <p><strong>Location:</strong> Likely in <code>src/utils/</code></p>
                    <p><strong>Purpose:</strong> Wrapper around Chrome API</p>
                    <pre><code>async function captureElementScreenshot(
  element: HTMLElement
): Promise&lt;string&gt; {
  // Calls chrome.tabs.captureVisibleTab()
  // May crop to element bounds
}</code></pre>
                </div>
            </div>

            <div class="collapsible secondary">
                <div class="collapsible-header">
                    <span><span class="arrow">▶</span>compressScreenshot()</span>
                </div>
                <div class="collapsible-content">
                    <p><strong>Type:</strong> Custom utility function</p>
                    <p><strong>Location:</strong> Likely in <code>src/utils/</code></p>
                    <p><strong>Method:</strong> Canvas-based compression</p>
                    <pre><code>async function compressScreenshot(
  dataUrl: string
): Promise&lt;CompressedImage&gt; {
  // Uses HTML Canvas API
  // Reduces file size before IndexedDB storage
}</code></pre>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>4. Execution Contexts</h2>

        <table>
            <thead>
                <tr>
                    <th>Context</th>
                    <th>File</th>
                    <th>Role in Screenshot</th>
                    <th>APIs Available</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Background Worker</strong></td>
                    <td><code>src/background/index.ts</code></td>
                    <td>Captures screenshot via chrome.tabs API</td>
                    <td>✅ <code>chrome.tabs.captureVisibleTab()</code></td>
                </tr>
                <tr>
                    <td><strong>Content Script</strong></td>
                    <td><code>src/content/index.tsx</code></td>
                    <td>Requests screenshot from background worker</td>
                    <td>❌ No direct access to capture API</td>
                </tr>
                <tr>
                    <td><strong>Canvas Page</strong></td>
                    <td><code>src/canvas/index.html</code></td>
                    <td>Displays screenshots from IndexedDB</td>
                    <td>✅ IndexedDB read access</td>
                </tr>
            </tbody>
        </table>

        <div class="secondary-section">
            <h4>Why Background Worker?</h4>
            <p class="indent-1"><code>chrome.tabs.captureVisibleTab()</code> requires special permissions only available to background scripts. Content scripts cannot directly capture tabs.</p>
        </div>

        <div class="divider"></div>

        <h2>5. Data Structure</h2>

        <div class="collapsible critical">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span><strong>Card Interface (TypeScript)</strong></span>
            </div>
            <div class="collapsible-content">
                <pre><code>interface Card {
  id: string;                    // Generated by generateId()
  content: string;               // Sanitized HTML
  metadata: ClipMetadata;        // url, title, domain, favicon
  position?: CardPosition;       // Canvas x, y
  size?: CardSize;              // Canvas width, height
  starred: boolean;
  tags: string[];
  createdAt: number;
  updatedAt: number;
  conversation?: Message[];      // Chat history with Claude
  <strong>screenshotId?: string;        // ← Reference to IndexedDB</strong>
  styles?: RelevantStyles;      // Computed CSS
  context?: string;             // Parent element HTML
}</code></pre>
                <p class="indent-1"><strong>Key Point:</strong> <code>screenshotId</code> is optional (<code>?</code>) because screenshot may fail</p>
            </div>
        </div>

        <div class="collapsible secondary">
            <div class="collapsible-header">
                <span><span class="arrow">▶</span>IndexedDB Schema</span>
            </div>
            <div class="collapsible-content">
                <pre><code>Database: 'nabokov-clipper'
  Store: 'screenshots'
    Key: screenshotId (string)
    Value: {
      data: Blob | string,      // Compressed image data
      timestamp: number,
      format: 'png' | 'jpeg'
    }</code></pre>
            </div>
        </div>

        <div class="divider"></div>

        <h2>6. File Locations</h2>

        <div class="two-column-layout">
            <div class="card">
                <h4>Screenshot Capture Logic</h4>
                <ul class="dense-list">
                    <li><code>src/background/index.ts</code> - Chrome API calls</li>
                    <li><code>src/utils/screenshot.ts</code> - Likely location of utilities</li>
                    <li><code>src/content/index.tsx</code> - Trigger from content script</li>
                    <li><code>src/components/ElementSelector.tsx</code> - User interaction</li>
                </ul>
            </div>

            <div class="card">
                <h4>Storage Operations</h4>
                <ul class="dense-list">
                    <li><code>src/utils/storage.ts</code> - Card storage utilities</li>
                    <li><code>src/utils/indexedDB.ts</code> - Likely IndexedDB wrapper</li>
                    <li><code>src/types/card.ts</code> - Card interface definition</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <div class="success">
            <h3>✅ Summary</h3>
            <ul class="dense-list">
                <li><strong>Storage:</strong> IndexedDB stores binary screenshot data, chrome.storage.local stores card metadata with <code>screenshotId</code> reference</li>
                <li><strong>Capture API:</strong> <code>chrome.tabs.captureVisibleTab()</code> in background worker</li>
                <li><strong>Flow:</strong> User clicks element → Background captures tab → Compress → Save to IndexedDB + chrome.storage</li>
                <li><strong>Critical:</strong> Screenshot is optional/non-blocking - system works without it</li>
            </ul>
        </div>
    </div>

    <script>
        // Collapsible functionality
        document.addEventListener('DOMContentLoaded', () => {
            const collapsibles = document.querySelectorAll('.collapsible-header');

            collapsibles.forEach(header => {
                header.addEventListener('click', () => {
                    const collapsible = header.parentElement;
                    collapsible.classList.toggle('open');
                });
            });

            // Auto-open critical sections
            document.querySelectorAll('.collapsible.critical').forEach(el => {
                el.classList.add('open');
            });
        });
    </script>
</body>
</html>